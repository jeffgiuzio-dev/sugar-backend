<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="/favicon.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Portal - Kenna Giuzio Cake</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500&family=Montserrat:wght@300;400;500&display=swap" rel="stylesheet">
    <!-- Flatpickr Date Picker -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script>
        // Run immediately before any rendering - check if we need fade
        if (window.location.search.includes('fade=true')) {
            document.write('<style id="fadeStyle">html{background:#000}body{opacity:0}</style>');
        }
    </script>
    <style>
        :root {
            --bg-primary: #faf8f5;
            --bg-secondary: #fff;
            --bg-tertiary: #fafafa;
            --bg-hover: #f5f3f0;
            --text-primary: #1a1a1a;
            --text-secondary: #666;
            --text-muted: #999;
            --border-color: #eee;
            --border-light: #f0f0f0;
            --accent-gold: #b5956a;
            --accent-gold-hover: #a08050;
            --modal-bg: #fff;
            --input-bg: #fff;
            --shadow: rgba(0,0,0,0.1);
            --overlay: rgba(0,0,0,0.5);
        }

        body.dark-mode {
            --bg-primary: #1a1a1a;
            --bg-secondary: #252525;
            --bg-tertiary: #2d2d2d;
            --bg-hover: #333;
            --text-primary: #e0e0e0;
            --text-secondary: #aaa;
            --text-muted: #777;
            --border-color: #3a3a3a;
            --border-light: #333;
            --accent-gold: #c9a66a;
            --accent-gold-hover: #d4b87a;
            --modal-bg: #252525;
            --input-bg: #2d2d2d;
            --shadow: rgba(0,0,0,0.3);
            --overlay: rgba(0,0,0,0.7);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            font-weight: 300;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Prevent body scroll when modal is open */
        body.modal-open {
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 260px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            padding: 30px 0;
            display: flex;
            flex-direction: column;
            z-index: 100;
        }

        .sidebar.admin-only {
            display: none;
        }

        body.admin-mode .sidebar.admin-only {
            display: flex;
        }

        .logo {
            text-align: center;
            padding: 30px 30px 30px;
            border-bottom: 1px solid var(--border-color);
        }

        .logo img {
            width: 160px;
            height: auto;
        }

        /* Dark mode logo invert */
        body.dark-mode .logo img {
            filter: invert(0.85);
        }

        .nav-menu {
            padding: 30px 0;
            flex: 1;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 30px;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-left-color: var(--accent-gold);
        }

        .nav-item svg {
            width: 18px;
            height: 18px;
            opacity: 0.7;
        }

        .nav-divider {
            height: 1px;
            background: var(--border-color);
            margin: 15px 30px;
        }

        /* Main wrapper for sidebar layout */
        .main-wrapper {
            margin-left: 0;
            transition: margin-left 0.2s;
        }

        body.admin-mode .main-wrapper {
            margin-left: 260px;
        }

        /* Header */
        .header {
            background: url('../images/header-flowers.jpg') center center / cover no-repeat;
            padding: 24px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .header > * {
            position: relative;
            z-index: 1;
        }

        .header h1, .header .header-title {
            font-family: 'Cormorant Garamond', serif;
            font-weight: 300;
            font-size: 2rem;
            color: #fff;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
            cursor: pointer;
        }

        .header-subtitle {
            font-size: 0.85rem;
            color: rgba(255,255,255,0.9);
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .admin-badge {
            background: rgba(255,255,255,0.2);
            color: #fff;
            font-size: 0.65rem;
            padding: 4px 10px;
            letter-spacing: 1px;
            text-transform: uppercase;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 12px 24px;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.8rem;
            font-weight: 400;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--accent-gold);
            color: #fff;
        }

        .btn-primary:hover {
            background: var(--accent-gold-hover);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            border-color: var(--text-muted);
            color: var(--text-primary);
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.75rem;
        }

        /* Main Layout */
        .main {
            max-width: 1000px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        /* Status Tracker */
        .status-tracker {
            background: var(--bg-secondary);
            padding: 32px;
            margin-bottom: 24px;
            border: 1px solid var(--border-color);
        }

        .status-tracker-title {
            font-size: 0.65rem;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 16px;
        }

        /* Progress Bar (matches In Studio style) */
        .progress-wrapper {
            position: relative;
            padding-bottom: 18px;
        }

        .progress-bar {
            display: flex;
            gap: 4px;
            margin-bottom: 6px;
        }

        .progress-step {
            flex: 1;
            height: 6px;
            background: var(--border-color);
            border-radius: 3px;
        }

        .progress-step.complete {
            background: var(--accent-gold);
        }

        .progress-step.current {
            background: #dfc89f;
        }

        .progress-step.skipped {
            background: var(--border-color);
            opacity: 0.5;
        }

        .progress-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .progress-label.current {
            color: var(--accent-gold);
            font-weight: 500;
        }

        /* Cards */
        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            margin-bottom: 24px;
        }

        .card-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.2rem;
            font-weight: 400;
        }

        .card-body {
            padding: 24px;
        }

        /* Collapsible Cards */
        .card.collapsible .card-header {
            cursor: pointer;
            user-select: none;
        }

        .card.collapsible .card-header:hover {
            background: var(--bg-tertiary);
        }

        .collapse-icon {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.8rem;
            font-weight: 300;
            color: var(--text-muted);
            margin-right: 10px;
            width: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            vertical-align: middle;
            position: relative;
            top: -4px;
        }

        .collapse-icon .icon-minus {
            display: inline;
        }

        .collapse-icon .icon-plus {
            display: none;
        }

        .card.collapsed .collapse-icon .icon-minus {
            display: none;
        }

        .card.collapsed .collapse-icon .icon-plus {
            display: inline;
        }

        .card.collapsed .card-body {
            display: none;
        }

        .card.collapsed .card-header {
            border-bottom: none;
        }

        /* Event Details */
        .details-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            font-size: 0.65rem;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 6px;
        }

        .detail-value {
            font-size: 0.95rem;
        }

        .detail-value.editable {
            cursor: pointer;
            padding: 8px 12px;
            margin: -8px -12px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .detail-value.editable:hover {
            background: #f5f5f5;
        }

        /* Documents */
        .documents-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .document-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
        }

        .document-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .document-icon {
            width: 40px;
            height: 40px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .document-name {
            font-weight: 400;
        }

        .document-meta {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .document-status {
            font-size: 0.75rem;
            padding: 6px 12px;
            border-radius: 20px;
        }

        .document-status.pending {
            background: #fff3e0;
            color: #e65100;
        }

        .document-status.paid {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .document-status.signed {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .document-status.draft {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        /* Accounting */
        .accounting-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .accounting-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
        }

        .accounting-item.paid {
            background: #f0fff0;
            border-color: #c8e6c9;
        }

        .accounting-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .accounting-name {
            font-weight: 400;
        }

        .accounting-meta {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .accounting-amount {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.3rem;
            color: var(--text-primary);
        }

        .accounting-amount.paid {
            color: #4caf50;
        }

        .accounting-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .accounting-summary {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid var(--text-primary);
            display: flex;
            justify-content: space-between;
        }

        .summary-item {
            text-align: center;
        }

        .summary-label {
            font-size: 0.65rem;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .summary-value {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.5rem;
        }

        .summary-value.due {
            color: #e65100;
        }

        .summary-value.paid {
            color: #4caf50;
        }

        /* Confirm Modal */
        .confirm-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--overlay);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .confirm-modal-content {
            background: var(--modal-bg);
            padding: 32px 40px;
            max-width: 360px;
            text-align: center;
            box-shadow: 0 4px 24px var(--shadow);
        }

        .confirm-modal-content p {
            font-size: 0.95rem;
            margin-bottom: 24px;
            line-height: 1.6;
        }

        .confirm-modal-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        /* Notes Section */
        .notes-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
            max-height: 400px;
            overflow-y: auto;
        }

        .note-item {
            padding: 16px 20px;
            background: var(--bg-tertiary);
            border-left: 3px solid var(--border-color);
        }

        .note-item.internal {
            background: #fff8e7;
            border-left-color: #f5c518;
        }

        .note-item.client-visible {
            border-left-color: var(--accent-gold);
        }

        .note-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .note-date {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .note-visibility {
            font-size: 0.65rem;
            padding: 3px 8px;
            border-radius: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .note-visibility.internal {
            background: #fff3cd;
            color: #856404;
        }

        .note-visibility.client {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .note-content {
            font-size: 0.9rem;
            line-height: 1.7;
        }

        /* Add Note Form */
        .add-note-form {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        /* Communication Log */
        .comm-log {
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        .comm-log-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-light);
        }

        .comm-log-item:last-child {
            border-bottom: none;
        }

        .comm-log-icon {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            flex-shrink: 0;
        }

        .comm-log-icon.sent {
            background: #f5f0fa;
            color: #6b5b7a;
        }

        .comm-log-icon.paid {
            background: #f0f7f2;
            color: #5a6b52;
        }

        .comm-log-icon.signed {
            background: #fdf8f3;
            color: #8b7355;
        }

        .comm-log-content {
            flex: 1;
        }

        .comm-log-title {
            font-size: 0.85rem;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .comm-log-date {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .comm-log-empty {
            font-size: 0.85rem;
            color: var(--text-muted);
            font-style: italic;
            padding: 20px 0;
        }

        /* Communication Quick Actions */
        .comm-quick-actions {
            display: flex;
            gap: 6px;
        }

        .comm-action-btn {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border: 1px solid var(--border-color);
            border-radius: 3px;
            background: transparent;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.65rem;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s;
        }

        .comm-action-btn:hover {
            border-color: var(--accent-gold);
            color: var(--accent-gold);
        }

        .comm-action-btn span {
            font-size: 0.7rem;
        }

        /* Communication Log - Tight Data Style */
        .comm-log {
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        .comm-log-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-light);
            font-size: 0.8rem;
        }

        .comm-log-item:last-child {
            border-bottom: none;
        }

        .comm-log-icon {
            min-width: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            flex-shrink: 0;
            color: var(--accent-gold);
            white-space: nowrap;
        }

        .comm-reply-btn {
            padding: 4px 10px;
            font-size: 0.75rem;
            background: var(--accent-gold);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .comm-log-item:hover .comm-reply-btn {
            opacity: 1;
        }

        .comm-reply-btn:hover {
            background: #9a7d5a;
        }

        .comm-log-date {
            font-size: 0.7rem;
            color: var(--text-muted);
            width: 90px;
            flex-shrink: 0;
        }

        .comm-log-content {
            flex: 1;
            min-width: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .comm-log-title {
            font-size: 0.8rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .comm-log-preview {
            font-size: 0.75rem;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
        }

        .comm-log-preview::before {
            content: "â€” ";
        }

        .comm-log-expanded {
            max-height: 200px;
            overflow-y: auto;
        }

        .comm-log-view-more {
            padding: 10px 0 4px;
            text-align: center;
        }

        .comm-log-view-more button {
            background: none;
            border: none;
            color: var(--accent-gold);
            font-family: 'Montserrat', sans-serif;
            font-size: 0.75rem;
            cursor: pointer;
            padding: 4px 12px;
        }

        .comm-log-view-more button:hover {
            text-decoration: underline;
        }

        .comm-log-item.expandable {
            cursor: pointer;
        }

        .comm-log-item.expandable:hover {
            background: var(--bg-primary);
        }

        .comm-log-expanded-content {
            padding: 0 0 12px 32px;
            margin-bottom: 8px;
            border-bottom: 1px solid var(--border-light);
        }

        .comm-full-message {
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.6;
            background: var(--bg-primary);
            padding: 12px 16px;
            border-radius: 4px;
            white-space: pre-wrap;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            font-size: 0.65rem;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 8px;
            display: block;
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid var(--border-color);
            background: var(--input-bg);
            color: var(--text-primary);
            font-family: 'Montserrat', sans-serif;
            font-size: 0.9rem;
            font-weight: 300;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--accent-gold);
        }

        .form-row {
            display: flex;
            gap: 16px;
            align-items: flex-end;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        /* Project Notes Card */
        .card.internal {
            border-color: #b5956a;
            border-width: 2px;
        }

        .card.internal .card-header {
            background: #faf6f0;
        }

        /* Files Section */
        .files-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
        }

        .file-item {
            border: 1px solid var(--border-color);
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .file-item:hover {
            border-color: var(--accent-gold);
        }

        .file-thumbnail {
            width: 100%;
            height: 80px;
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
            font-size: 2rem;
            color: var(--text-muted);
        }

        .file-thumbnail img {
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
        }

        .file-name {
            font-size: 0.75rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-upload {
            border: 2px dashed var(--border-color);
            background: var(--bg-tertiary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 110px;
        }

        .file-upload:hover,
        .file-upload.dragover {
            border-color: var(--accent-gold);
            background: var(--bg-hover);
        }

        .files-grid.dragover {
            background: var(--bg-hover);
            outline: 2px dashed var(--accent-gold);
            outline-offset: -2px;
        }

        .file-upload-icon {
            font-size: 1.5rem;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .file-upload-text {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .details-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .files-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Team drag and drop */
        .team-member-row.dragging {
            opacity: 0.5;
            background: #e0e0e0 !important;
        }

        .team-member-row {
            user-select: none;
        }

        .drag-handle {
            font-size: 1rem;
            letter-spacing: -2px;
        }

        .team-member-row.drop-above {
            border-top: 3px solid var(--text-primary) !important;
            margin-top: -2px;
        }

        .team-member-row.drop-below {
            border-bottom: 3px solid var(--text-primary) !important;
            margin-bottom: -2px;
        }

        /* Admin-only elements */
        .admin-only {
            display: none;
        }

        body.admin-mode .admin-only {
            display: block;
        }

        body.admin-mode .admin-only-flex {
            display: flex;
        }

        body.admin-mode .admin-only-grid {
            display: grid;
        }

        /* Date Input with Calendar Button */
        .date-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .date-input-wrapper input,
        .date-input-wrapper input.flatpickr-input,
        .date-input-wrapper .flatpickr-input {
            flex: 1;
            width: 100%;
            padding: 12px;
            padding-right: 40px;
            border: 1px solid var(--border-color);
            font-family: 'Montserrat', sans-serif;
            font-size: 0.9rem;
            cursor: pointer;
            background: var(--input-bg);
            color: var(--text-primary);
        }

        .calendar-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            padding: 4px;
            cursor: pointer;
            color: var(--text-muted);
            transition: color 0.3s;
        }

        .calendar-btn:hover {
            color: var(--accent-gold);
        }

        /* Flatpickr Custom Styling */
        .flatpickr-calendar {
            font-family: 'Montserrat', sans-serif;
            border: none;
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
            border-radius: 0;
        }

        .flatpickr-calendar.arrowTop:before,
        .flatpickr-calendar.arrowTop:after {
            display: none;
        }

        .flatpickr-months {
            padding: 12px 0;
        }

        .flatpickr-months .flatpickr-month {
            height: 40px;
        }

        .flatpickr-current-month {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.1rem;
            font-weight: 400;
            letter-spacing: 1px;
        }

        .flatpickr-current-month .flatpickr-monthDropdown-months {
            font-family: 'Cormorant Garamond', serif;
        }

        .flatpickr-months .flatpickr-prev-month,
        .flatpickr-months .flatpickr-next-month {
            padding: 12px;
        }

        .flatpickr-months .flatpickr-prev-month:hover svg,
        .flatpickr-months .flatpickr-next-month:hover svg {
            fill: var(--accent-gold);
        }

        .flatpickr-weekdays {
            background: transparent;
        }

        span.flatpickr-weekday {
            font-family: 'Montserrat', sans-serif;
            font-size: 0.65rem;
            font-weight: 400;
            letter-spacing: 1px;
            color: var(--text-muted);
        }

        .flatpickr-day {
            font-family: 'Montserrat', sans-serif;
            font-weight: 300;
            color: var(--text-primary);
            border-radius: 0;
        }

        .flatpickr-day:hover {
            background: var(--bg-tertiary);
            border-color: transparent;
        }

        .flatpickr-day.selected,
        .flatpickr-day.selected:hover {
            background: var(--accent-gold);
            border-color: var(--accent-gold);
            color: #fff;
        }

        .flatpickr-day.today {
            border-color: var(--accent-gold);
        }

        .flatpickr-day.today:hover {
            background: var(--accent-gold);
            color: #fff;
        }

        .flatpickr-day.prevMonthDay,
        .flatpickr-day.nextMonthDay {
            color: #ccc;
        }

        /* Time picker styles */
        .flatpickr-time {
            border-top: 1px solid var(--border-color);
            background: var(--bg-primary);
        }

        .flatpickr-time input {
            font-family: 'Montserrat', sans-serif;
            font-size: 14px;
        }

        .flatpickr-time .numInputWrapper:hover {
            background: rgba(181, 149, 106, 0.1);
        }

        .flatpickr-time .numInputWrapper span.arrowUp:after {
            border-bottom-color: var(--accent-gold);
        }

        .flatpickr-time .numInputWrapper span.arrowDown:after {
            border-top-color: var(--accent-gold);
        }

        .flatpickr-am-pm {
            font-family: 'Montserrat', sans-serif;
            color: #333;
        }

        .flatpickr-am-pm:hover {
            background: rgba(181, 149, 106, 0.15);
        }

        /* Calendar Popup Styles (for tasting options) */
        .calendar-popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--overlay);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .calendar-popup-overlay.active {
            display: flex;
        }

        .calendar-popup {
            background: var(--modal-bg);
            width: 700px;
            max-width: 95vw;
            min-width: 500px;
            min-height: 400px;
            resize: both;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 40px var(--shadow);
        }

        .calendar-popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            cursor: move;
            user-select: none;
        }

        .calendar-popup-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.2rem;
        }

        .calendar-popup-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-muted);
            padding: 4px;
        }

        .calendar-popup-close:hover {
            color: var(--text-primary);
        }

        .calendar-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            background: var(--bg-tertiary);
        }

        .calendar-nav-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px 12px;
            font-size: 1.2rem;
            color: var(--text-secondary);
        }

        .calendar-nav-btn:hover {
            color: var(--accent-gold);
        }

        .calendar-month-year {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.1rem;
        }

        .calendar-popup .calendar-grid {
            flex: 1;
            overflow: auto;
            padding: 20px;
        }

        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
            font-size: 0.7rem;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }

        .calendar-day {
            min-height: 70px;
            padding: 6px;
            border: 1px solid var(--border-light);
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            display: flex;
            flex-direction: column;
            background: var(--bg-secondary);
            overflow: hidden;
        }

        .calendar-day:hover:not(.other-month):not(.past) {
            border-color: var(--accent-gold);
            background: var(--bg-primary);
        }

        .calendar-day.other-month {
            background: var(--bg-tertiary);
            color: var(--text-muted);
            cursor: default;
        }

        .calendar-day.past {
            background: var(--bg-tertiary);
            color: var(--text-muted);
            cursor: not-allowed;
        }

        .calendar-day.today {
            border-color: var(--accent-gold);
        }

        .calendar-day.today .day-number {
            background: var(--accent-gold);
            color: #fff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .calendar-day.selected {
            background: var(--bg-hover);
            border-color: var(--accent-gold);
            border-width: 2px;
        }

        .day-number {
            font-size: 0.85rem;
            font-weight: 400;
            margin-bottom: 4px;
        }

        .day-events {
            flex: 1;
            overflow: visible;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .day-event {
            font-size: 0.65rem;
            padding: 2px 4px;
            border-radius: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Multi-day bar spanning styles */
        .day-event.span-start {
            border-radius: 3px 0 0 3px;
            margin-right: -7px;
        }

        .day-event.span-mid {
            border-radius: 0;
            margin-left: -7px;
            margin-right: -7px;
            padding-left: 7px;
            min-height: 15px;
        }

        .day-event.span-end {
            border-radius: 0 3px 3px 0;
            margin-left: -7px;
            padding-left: 7px;
        }

        .day-event.tasting {
            background: #f5eee3;
            color: #8b7355;
        }

        .day-event.event {
            background: #e8ede5;
            color: #5a6b52;
        }

        .day-event.personal {
            background: #fae5e1;
            color: #a05a4a;
        }

        .day-event.inquiry {
            background: #e8e3f0;
            color: #6b5b7a;
        }

        .day-event-more {
            font-size: 0.6rem;
            color: var(--text-muted);
            padding: 2px 4px;
        }

        .calendar-legend {
            padding: 12px 20px;
            border-top: 1px solid var(--border-color);
            font-size: 0.75rem;
            color: var(--text-secondary);
            display: flex;
            gap: 20px;
            background: var(--bg-tertiary);
        }

        .calendar-legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .calendar-legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 3px;
        }

        .calendar-legend-dot.tasting { background: #f5eee3; border: 1px solid #dfc89f; }
        .calendar-legend-dot.event { background: #e8ede5; border: 1px solid #a8b5a0; }
        .calendar-legend-dot.personal { background: #fae5e1; border: 1px solid #e6a89c; }

        /* Time picker for tasting options */
        .time-picker-section {
            padding: 16px 20px;
            border-top: 1px solid var(--border-color);
            background: var(--bg-secondary);
        }

        .time-picker-label {
            font-size: 0.7rem;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .time-picker-select {
            padding: 10px 14px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.9rem;
            width: 150px;
            cursor: pointer;
            background: var(--input-bg);
            color: var(--text-primary);
        }

        .time-picker-select:focus {
            outline: none;
            border-color: var(--accent-gold);
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            padding: 14px 20px;
            border-radius: 6px;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.85rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            animation: toastSlideIn 0.3s ease;
            max-width: 350px;
        }

        .toast.info {
            background: var(--bg-hover);
            border-left: 4px solid var(--accent-gold);
            color: var(--text-secondary);
        }

        .toast.success {
            background: #e8f0e8;
            border-left: 4px solid #6a9b6a;
            color: #3a5a3a;
        }

        .toast.error {
            background: #f5e8e8;
            border-left: 4px solid #c47070;
            color: #6a3a3a;
        }

        .toast.warning {
            background: #faf5e8;
            border-left: 4px solid #c4a060;
            color: #5a4a2a;
        }

        .toast-close {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: inherit;
            opacity: 0.6;
            padding: 0;
            margin-left: auto;
        }

        .toast-close:hover {
            opacity: 1;
        }

        @keyframes toastSlideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes toastSlideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    </style>
</head>
<body class="admin-mode">
    <!-- Toast Notifications Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Sidebar (Admin Only) -->
    <aside class="sidebar admin-only">
        <div class="logo">
            <img src="../images/logo.png" alt="Kenna Giuzio Cake">
        </div>

        <nav class="nav-menu">
            <a href="/admin/in-studio.html" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                    <path d="M2 17l10 5 10-5"/>
                    <path d="M2 12l10 5 10-5"/>
                </svg>
                In Studio
            </a>
            <a href="/admin/calendar.html" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                    <line x1="16" y1="2" x2="16" y2="6"/>
                    <line x1="8" y1="2" x2="8" y2="6"/>
                    <line x1="3" y1="10" x2="21" y2="10"/>
                </svg>
                Calendar
            </a>
            <a href="/admin/contacts.html" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
                Contacts
            </a>
            <a href="/admin/communications.html" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                </svg>
                Communications
            </a>
            <a href="/admin/templates.html" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                    <line x1="16" y1="13" x2="8" y2="13"/>
                    <line x1="16" y1="17" x2="8" y2="17"/>
                    <polyline points="10 9 9 9 8 9"/>
                </svg>
                Templates
            </a>

            <div class="nav-divider"></div>

            <a href="/admin/finances.html" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <line x1="18" y1="20" x2="18" y2="10"/>
                    <line x1="12" y1="20" x2="12" y2="4"/>
                    <line x1="6" y1="20" x2="6" y2="14"/>
                </svg>
                Finances
            </a>
            <a href="/admin/media.html" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                    <circle cx="8.5" cy="8.5" r="1.5"/>
                    <polyline points="21 15 16 10 5 21"/>
                </svg>
                Media
            </a>

            <div class="nav-divider"></div>

            <a href="/admin/settings.html" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                </svg>
                Settings
            </a>
            <a href="/admin/archive.html" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <polyline points="21 8 21 21 3 21 3 8"/>
                    <rect x="1" y="3" width="22" height="5"/>
                    <line x1="10" y1="12" x2="14" y2="12"/>
                </svg>
                Archive
            </a>
            <a href="/admin/dev-tools.html" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <polyline points="16 18 22 12 16 6"/>
                    <polyline points="8 6 2 12 8 18"/>
                </svg>
                Dev Tools
            </a>

            <!-- Dark Mode Toggle -->
            <div style="padding: 14px 30px; margin-top: auto;">
                <button onclick="toggleDarkMode()" id="darkModeBtn" style="display: flex; align-items: center; gap: 10px; width: 100%; padding: 10px 14px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; font-family: 'Montserrat', sans-serif; font-size: 0.8rem; color: var(--text-secondary); transition: all 0.2s;">
                    <span id="darkModeIcon">ðŸŒ™</span>
                    <span id="darkModeText">Night Mode</span>
                </button>
            </div>
        </nav>
    </aside>

    <!-- Main Content Wrapper -->
    <div class="main-wrapper">
    <header class="header">
        <div class="header-left">
            <div>
                <div style="display: flex; align-items: center; gap: 16px;">
                    <h1 class="header-title" id="pageTitle" onclick="editPortalTitle()">Event Portal</h1>
                    <span class="admin-badge admin-only">Admin View</span>
                </div>
                <p class="header-subtitle" id="headerEventDate"></p>
            </div>
        </div>
    </header>

    <main class="main">
        <!-- Status Tracker (Progress Bar) -->
        <div class="status-tracker">
            <div class="status-tracker-title">Status</div>
            <div id="progressBarContainer">
                <!-- Rendered by JavaScript -->
            </div>
        </div>

        <!-- Event Details -->
        <div class="card collapsible" id="eventCard">
            <div class="card-header" onclick="toggleCard('eventCard')">
                <div style="display: flex; align-items: center;">
                    <span class="collapse-icon"><span class="icon-minus">âˆ’</span><span class="icon-plus">+</span></span>
                    <h2 class="card-title" id="eventDetailsTitle">Event Details</h2>
                </div>
                <button class="btn btn-secondary btn-small admin-only" onclick="event.stopPropagation(); openEditEventModal()">Edit</button>
            </div>
            <div class="card-body">
                <!-- Client Info Group -->
                <div style="margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid #eee;">
                    <div class="detail-value" id="clientName" style="font-weight: 400;">-</div>
                    <div class="detail-value" id="clientEmail" style="color: #666;">-</div>
                    <div class="detail-value" id="clientPhone" style="color: #666;">-</div>
                    <div class="detail-value" id="clientAddress" style="color: #666;">-</div>
                </div>

                <!-- Stacked Info -->
                <div class="detail-label">Event</div>
                <div class="detail-value" id="eventType">-</div>
                <div class="detail-value" id="eventDate">-</div>
                <div class="detail-value" id="eventTime" style="color: #666;">-</div>
                <div class="detail-value" id="venue" style="margin-top: 8px;">-</div>
                <div class="detail-value" id="venueAddress" style="color: #666;">-</div>
                <div class="detail-value" id="guestCount" style="color: #666; margin-top: 8px;">-</div>

                <div class="detail-label" style="margin-top: 12px;">Tasting</div>
                <div class="detail-value" id="tastingDate">-</div>
                <div class="detail-value" id="tastingTime" style="color: #666;">-</div>
                <div class="detail-value" id="tastingGuests" style="color: #666;">-</div>

                <div class="detail-label" style="margin-top: 12px;">Inquiry</div>
                <div class="detail-value" id="inquiryDate">-</div>
                <div class="detail-value" id="source" style="color: #666;">-</div>
                <!-- Initial Inquiry Message -->
                <div id="inquiryMessageSection" style="display: none; margin-top: 24px; padding-top: 24px; border-top: 1px solid #eee;">
                    <div class="detail-label" style="margin-bottom: 12px;">Initial Inquiry Message</div>
                    <div id="inquiryMessage" style="background: #fafafa; padding: 16px 20px; border-left: 3px solid #b5956a; font-size: 0.9rem; line-height: 1.7; color: #444;"></div>
                </div>
            </div>
        </div>

        <!-- Team -->
        <div class="card collapsible admin-only" id="teamCard">
            <div class="card-header" onclick="toggleCard('teamCard')">
                <div style="display: flex; align-items: center;">
                    <span class="collapse-icon"><span class="icon-minus">âˆ’</span><span class="icon-plus">+</span></span>
                    <h2 class="card-title">Team</h2>
                </div>
                <button class="btn btn-secondary btn-small" onclick="event.stopPropagation(); openTeamModal()">+ Add Member</button>
                <!-- TEMP: Remove this button later -->
                <button class="btn btn-small" onclick="event.stopPropagation(); addTestTeam()" style="margin-left:8px; background:#f0f0f0; color:#666; border:1px dashed #ccc;">+ Test Team</button>
            </div>
            <div class="card-body">
                <!-- Primary Contact -->
                <div id="primaryContact" style="margin-bottom: 16px;">
                    <!-- Populated by JS -->
                </div>
                <div id="teamList">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>

        <!-- Accounting (Admin Only) -->
        <div class="card collapsible admin-only" id="accountingCard">
            <div class="card-header" onclick="toggleCard('accountingCard')">
                <div style="display: flex; align-items: center;">
                    <span class="collapse-icon"><span class="icon-minus">âˆ’</span><span class="icon-plus">+</span></span>
                    <h2 class="card-title">Accounting</h2>
                </div>
            </div>
            <div class="card-body">
                <div class="accounting-list" id="accountingList">
                    <!-- Populated by JS -->
                </div>
                <div class="accounting-summary" id="accountingSummary">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>

        <!-- Communication Log -->
        <div class="card collapsible" id="logCard">
            <div class="card-header" onclick="toggleCard('logCard')">
                <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                    <div style="display: flex; align-items: center;">
                        <span class="collapse-icon"><span class="icon-minus">âˆ’</span><span class="icon-plus">+</span></span>
                        <h2 class="card-title">Communication Log</h2>
                    </div>
                    <div class="admin-only comm-quick-actions" onclick="event.stopPropagation();" style="display: flex; gap: 6px;">
                        <button onclick="openQuickComm('email')" class="comm-action-btn" title="Send Email">Email</button>
                        <button onclick="openQuickComm('text')" class="comm-action-btn" title="Log Text">Text</button>
                        <button onclick="openQuickComm('call')" class="comm-action-btn" title="Log Call">Call</button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="comm-log" id="commLog">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>

        <!-- General Communication removed â€” clients don't use the portal -->

        <!-- Day of Instructions (Visible to Client & Team) -->
        <div class="card collapsible" id="dayOfCard">
            <div class="card-header" onclick="toggleCard('dayOfCard')">
                <div style="display: flex; align-items: center;">
                    <span class="collapse-icon"><span class="icon-minus">âˆ’</span><span class="icon-plus">+</span></span>
                    <h2 class="card-title">Day of Instructions</h2>
                </div>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label class="form-label">Instructions & Notes</label>
                    <textarea class="form-textarea" id="dayOfInstructions" placeholder="Delivery time, setup location, parking instructions, contact on-site, special notes..." style="min-height: 120px;"></textarea>
                </div>

                <!-- Day of Files -->
                <div style="margin-top: 16px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <span style="font-size: 0.75rem; letter-spacing: 1px; text-transform: uppercase; color: #999;">Attachments</span>
                        <button class="btn btn-secondary btn-small" onclick="event.stopPropagation(); document.getElementById('dayOfFileUpload').click()">+ Upload</button>
                    </div>
                    <div class="files-grid" id="dayOfFilesGrid">
                        <div class="file-upload" onclick="document.getElementById('dayOfFileUpload').click()">
                            <div class="file-upload-icon">+</div>
                            <div class="file-upload-text">Add File</div>
                        </div>
                    </div>
                    <input type="file" id="dayOfFileUpload" style="display:none" multiple accept=".pdf,.doc,.docx,.txt,.xls,.xlsx,image/*" onchange="handleDayOfFileUpload(this)">
                    <p style="font-size: 0.7rem; color: #999; margin-top: 8px;">Venue maps, parking passes, delivery instructions, etc.</p>
                </div>

                <div style="display: flex; justify-content: flex-end; margin-top: 16px;">
                    <button class="btn btn-primary btn-small" onclick="saveDayOfInstructions()">Save Instructions</button>
                </div>
            </div>
        </div>

        <!-- Project Notes, Files, Sketches & Photos -->
        <div class="card collapsible internal admin-only" id="internalCard">
            <div class="card-header" onclick="toggleCard('internalCard')">
                <div style="display: flex; align-items: center;">
                    <span class="collapse-icon"><span class="icon-minus">âˆ’</span><span class="icon-plus">+</span></span>
                    <h2 class="card-title">Project Notes, Files, Sketches & Photos</h2>
                </div>
            </div>
            <div class="card-body">
                <textarea class="form-textarea" id="internalNotes" placeholder="Private notes about this client (preferences, concerns, reminders...)"></textarea>

                <!-- Internal Documents Section -->
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <span style="font-size: 0.75rem; letter-spacing: 1px; text-transform: uppercase; color: #999;">Internal Documents</span>
                        <button class="btn btn-secondary btn-small" onclick="event.stopPropagation(); document.getElementById('internalDocUpload').click()">+ Upload</button>
                    </div>
                    <div class="files-grid" id="internalDocsGrid">
                        <div class="file-upload" onclick="document.getElementById('internalDocUpload').click()">
                            <div class="file-upload-icon">+</div>
                            <div class="file-upload-text">Add Document</div>
                        </div>
                    </div>
                    <input type="file" id="internalDocUpload" style="display:none" multiple accept=".pdf,.doc,.docx,.txt,.xls,.xlsx,image/*" onchange="handleInternalDocUpload(this)">
                </div>
            </div>
        </div>

        <!-- Archive Section (Admin Only) -->
        <div class="admin-only" style="margin-top: 60px; padding: 30px; border-top: 2px solid #eee; text-align: center;">
            <p style="font-size: 0.8rem; color: #999; margin-bottom: 16px;">Client Status</p>
            <div id="archiveToggle" style="display: inline-flex; border: 1px solid #ddd; border-radius: 6px; overflow: hidden;">
                <button id="activeBtn" onclick="setClientActive()" style="padding: 10px 24px; border: none; background: #b5956a; color: #fff; font-family: 'Montserrat', sans-serif; font-size: 0.8rem; cursor: pointer; transition: all 0.2s;">Active</button>
                <button id="archivedBtn" onclick="setClientArchived()" style="padding: 10px 24px; border: none; background: #fff; color: #666; font-family: 'Montserrat', sans-serif; font-size: 0.8rem; cursor: pointer; border-left: 1px solid #ddd; transition: all 0.2s;">Archive</button>
            </div>
            <p style="font-size: 0.7rem; color: #bbb; margin-top: 12px;">Archived clients are moved to the Archived section on the dashboard</p>
            <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;">
                <button onclick="deleteClient()" style="padding: 8px 20px; border: 1px solid #e74c3c; background: #fff; color: #e74c3c; font-family: 'Montserrat', sans-serif; font-size: 0.7rem; cursor: pointer; border-radius: 4px; letter-spacing: 0.5px; text-transform: uppercase; transition: all 0.2s;" onmouseover="this.style.background='#e74c3c';this.style.color='#fff'" onmouseout="this.style.background='#fff';this.style.color='#e74c3c'">Delete Client</button>
                <p style="font-size: 0.65rem; color: #ccc; margin-top: 8px;">Permanently removes this client and all their proposals, invoices, and payments</p>
            </div>
        </div>
    </main>

    <!-- Add Team Member Modal -->
    <div class="modal-overlay" id="teamModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.4); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:#fff; width:100%; max-width:500px; max-height:90vh; overflow-y:auto;">
            <div style="padding:24px 28px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                <h2 style="font-family:'Cormorant Garamond',serif; font-size:1.4rem; font-weight:400;">Add Team Member</h2>
                <button onclick="closeTeamModal()" style="background:none; border:none; cursor:pointer; font-size:1.5rem; color:#999;">&times;</button>
            </div>
            <div style="padding:24px 28px;">
                <!-- Toggle: New or From Contacts -->
                <div style="display:flex; gap:0; margin-bottom:20px;">
                    <button id="tabNewMember" onclick="setTeamTab('new')" style="flex:1; padding:10px; background:#1a1a1a; color:#fff; border:1px solid #1a1a1a; font-family:'Montserrat',sans-serif; font-size:0.8rem; cursor:pointer;">New Member</button>
                    <button id="tabFromContacts" onclick="setTeamTab('contacts')" style="flex:1; padding:10px; background:#fff; color:#666; border:1px solid #ddd; border-left:none; font-family:'Montserrat',sans-serif; font-size:0.8rem; cursor:pointer;">From Contacts</button>
                </div>

                <!-- From Contacts Section -->
                <div id="fromContactsSection" style="display:none;">
                    <div style="margin-bottom:16px;">
                        <input type="text" id="contactSearch" placeholder="Search contacts..." oninput="filterContactsList()" style="width:100%; padding:12px; border:1px solid #ddd; font-family:'Montserrat',sans-serif; font-size:0.9rem;">
                    </div>
                    <div id="contactsList" style="max-height:250px; overflow-y:auto; border:1px solid #eee;">
                        <!-- Populated by JS -->
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-top:16px;">
                        <div>
                            <label style="font-size:0.65rem; letter-spacing:1px; text-transform:uppercase; color:#999; display:block; margin-bottom:6px;">Type</label>
                            <select id="teamTypeFromContact" onchange="updateRoleOptions('contact')" style="width:100%; padding:12px; border:1px solid #ddd; font-family:'Montserrat',sans-serif; font-size:0.9rem;">
                                <option value="Vendor">Vendor</option>
                                <option value="Family">Family</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size:0.65rem; letter-spacing:1px; text-transform:uppercase; color:#999; display:block; margin-bottom:6px;">Role</label>
                            <select id="teamRoleFromContact" style="width:100%; padding:12px; border:1px solid #ddd; font-family:'Montserrat',sans-serif; font-size:0.9rem;">
                                <option value="Wedding Planner">Wedding Planner</option>
                                <option value="Venue Contact">Venue Contact</option>
                                <option value="Photographer">Photographer</option>
                                <option value="Videographer">Videographer</option>
                                <option value="Florist">Florist</option>
                                <option value="Caterer">Caterer</option>
                                <option value="DJ">DJ</option>
                                <option value="Band">Band</option>
                            </select>
                            <input type="text" id="teamRoleFromContactCustom" placeholder="Enter role..." style="display:none; width:100%; padding:12px; border:1px solid #ddd; font-family:'Montserrat',sans-serif; font-size:0.9rem;">
                        </div>
                    </div>
                </div>

                <!-- New Member Form -->
                <div id="newMemberSection">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:16px;">
                        <div>
                            <label style="font-size:0.65rem; letter-spacing:1px; text-transform:uppercase; color:#999; display:block; margin-bottom:6px;">Type</label>
                            <select id="teamType" onchange="updateRoleOptions('new')" style="width:100%; padding:12px; border:1px solid #ddd; font-family:'Montserrat',sans-serif; font-size:0.9rem;">
                                <option value="Vendor">Vendor</option>
                                <option value="Family">Family</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size:0.65rem; letter-spacing:1px; text-transform:uppercase; color:#999; display:block; margin-bottom:6px;">Role</label>
                            <select id="teamRole" style="width:100%; padding:12px; border:1px solid #ddd; font-family:'Montserrat',sans-serif; font-size:0.9rem;">
                                <option value="Wedding Planner">Wedding Planner</option>
                                <option value="Venue Contact">Venue Contact</option>
                                <option value="Photographer">Photographer</option>
                                <option value="Videographer">Videographer</option>
                                <option value="Florist">Florist</option>
                                <option value="Caterer">Caterer</option>
                                <option value="DJ">DJ</option>
                                <option value="Band">Band</option>
                            </select>
                            <input type="text" id="teamRoleCustom" placeholder="Enter role..." style="display:none; width:100%; padding:12px; border:1px solid #ddd; font-family:'Montserrat',sans-serif; font-size:0.9rem;">
                        </div>
                    </div>
                    <div style="margin-bottom:16px;">
                        <label style="font-size:0.65rem; letter-spacing:1px; text-transform:uppercase; color:#999; display:block; margin-bottom:6px;">Name</label>
                        <input type="text" id="teamName" placeholder="Name" style="width:100%; padding:12px; border:1px solid #ddd; font-family:'Montserrat',sans-serif; font-size:0.9rem;">
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:16px;">
                        <div>
                            <label style="font-size:0.65rem; letter-spacing:1px; text-transform:uppercase; color:#999; display:block; margin-bottom:6px;">Phone</label>
                            <input type="tel" id="teamPhone" placeholder="(206) 555-0123" onblur="formatPhone(this)" style="width:100%; padding:12px; border:1px solid #ddd; font-family:'Montserrat',sans-serif; font-size:0.9rem;">
                        </div>
                        <div>
                            <label style="font-size:0.65rem; letter-spacing:1px; text-transform:uppercase; color:#999; display:block; margin-bottom:6px;">Email</label>
                            <input type="email" id="teamEmail" placeholder="email@example.com" style="width:100%; padding:12px; border:1px solid #ddd; font-family:'Montserrat',sans-serif; font-size:0.9rem;">
                        </div>
                    </div>
                    <div style="margin-bottom:16px;">
                        <label style="font-size:0.65rem; letter-spacing:1px; text-transform:uppercase; color:#999; display:block; margin-bottom:6px;">Company</label>
                        <input type="text" id="teamCompany" placeholder="Company name" style="width:100%; padding:12px; border:1px solid #ddd; font-family:'Montserrat',sans-serif; font-size:0.9rem;">
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:16px;">
                        <div>
                            <label style="font-size:0.65rem; letter-spacing:1px; text-transform:uppercase; color:#999; display:block; margin-bottom:6px;">Instagram</label>
                            <input type="text" id="teamInstagram" placeholder="@handle" style="width:100%; padding:12px; border:1px solid #ddd; font-family:'Montserrat',sans-serif; font-size:0.9rem;">
                        </div>
                        <div>
                            <label style="font-size:0.65rem; letter-spacing:1px; text-transform:uppercase; color:#999; display:block; margin-bottom:6px;">Website</label>
                            <input type="text" id="teamWebsite" placeholder="website.com" style="width:100%; padding:12px; border:1px solid #ddd; font-family:'Montserrat',sans-serif; font-size:0.9rem;">
                        </div>
                    </div>
                    <div style="margin-bottom:16px;">
                        <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                            <input type="checkbox" id="teamAddToContacts" checked>
                            <span style="font-size:0.85rem; color:#666;">Also add to All Contacts</span>
                        </label>
                    </div>
                </div>
            </div>
            <div style="padding:20px 28px; border-top:1px solid #eee; display:flex; justify-content:flex-end; gap:12px;">
                <button onclick="closeTeamModal()" style="padding:10px 20px; background:#fff; border:1px solid #ddd; font-family:'Montserrat',sans-serif; font-size:0.8rem; cursor:pointer;">Cancel</button>
                <button onclick="saveTeamMember()" style="padding:10px 20px; background:#b5956a; color:#fff; border:none; font-family:'Montserrat',sans-serif; font-size:0.8rem; cursor:pointer;">Add Member</button>
            </div>
        </div>
    </div>

    <!-- Edit Primary Contact Modal -->
    <div class="modal-overlay" id="editPrimaryModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.4); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:#fff; width:100%; max-width:500px; max-height:90vh; overflow-y:auto;">
            <div style="padding:24px 28px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                <h2 style="font-family:'Cormorant Garamond',serif; font-size:1.4rem; font-weight:400;">Edit Primary Contact</h2>
                <button onclick="closeEditPrimaryModal()" style="background:none; border:none; cursor:pointer; font-size:1.5rem; color:#999;">&times;</button>
            </div>
            <div style="padding:24px 28px;">
                <div style="margin-bottom:16px;">
                    <label style="font-size:0.65rem; letter-spacing:1px; text-transform:uppercase; color:#999; display:block; margin-bottom:6px;">Name</label>
                    <input type="text" id="editPrimaryName" placeholder="Name" style="width:100%; padding:12px; border:1px solid #ddd; font-family:'Montserrat',sans-serif; font-size:0.9rem;">
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:16px;">
                    <div>
                        <label style="font-size:0.65rem; letter-spacing:1px; text-transform:uppercase; color:#999; display:block; margin-bottom:6px;">Phone</label>
                        <input type="tel" id="editPrimaryPhone" placeholder="(206) 555-0123" onblur="formatPhone(this)" style="width:100%; padding:12px; border:1px solid #ddd; font-family:'Montserrat',sans-serif; font-size:0.9rem;">
                    </div>
                    <div>
                        <label style="font-size:0.65rem; letter-spacing:1px; text-transform:uppercase; color:#999; display:block; margin-bottom:6px;">Email</label>
                        <input type="email" id="editPrimaryEmail" placeholder="email@example.com" style="width:100%; padding:12px; border:1px solid #ddd; font-family:'Montserrat',sans-serif; font-size:0.9rem;">
                    </div>
                </div>
                <div style="margin-bottom:16px;">
                    <label style="font-size:0.65rem; letter-spacing:1px; text-transform:uppercase; color:#999; display:block; margin-bottom:6px;">Client Address</label>
                    <input type="text" id="editPrimaryAddress" placeholder="Full mailing address" style="width:100%; padding:12px; border:1px solid #ddd; font-family:'Montserrat',sans-serif; font-size:0.9rem;">
                </div>
            </div>
            <div style="padding:20px 28px; border-top:1px solid #eee; display:flex; justify-content:flex-end; gap:12px;">
                <button onclick="closeEditPrimaryModal()" style="padding:10px 20px; background:#fff; border:1px solid #ddd; font-family:'Montserrat',sans-serif; font-size:0.8rem; cursor:pointer;">Cancel</button>
                <button onclick="savePrimaryContact()" style="padding:10px 20px; background:#b5956a; color:#fff; border:none; font-family:'Montserrat',sans-serif; font-size:0.8rem; cursor:pointer;">Save</button>
            </div>
        </div>
    </div>

    <!-- Switch Primary Contact Modal -->
    <div class="modal-overlay" id="switchPrimaryModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.4); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:#fff; width:100%; max-width:450px; max-height:90vh; overflow-y:auto;">
            <div style="padding:24px 28px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                <h2 style="font-family:'Cormorant Garamond',serif; font-size:1.4rem; font-weight:400;">Switch Primary Contact</h2>
                <button onclick="closeSwitchPrimaryModal()" style="background:none; border:none; cursor:pointer; font-size:1.5rem; color:#999;">&times;</button>
            </div>
            <div style="padding:24px 28px;">
                <p style="font-size:0.85rem; color:#666; margin-bottom:16px;">Select a team member to make them the primary contact. The current primary will become a team member.</p>
                <div id="switchPrimaryList" style="max-height:300px; overflow-y:auto;">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Team Member Modal -->
    <div class="modal-overlay" id="editTeamModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.4); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:#fff; width:100%; max-width:500px; max-height:90vh; overflow-y:auto;">
            <div style="padding:24px 28px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                <h2 style="font-family:'Cormorant Garamond',serif; font-size:1.4rem; font-weight:400;">Edit Team Member</h2>
                <button onclick="closeEditTeamModal()" style="background:none; border:none; cursor:pointer; font-size:1.5rem; color:#999;">&times;</button>
            </div>
            <div style="padding:24px 28px;">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:16px;">
                    <div>
                        <label style="font-size:0.65rem; letter-spacing:1px; text-transform:uppercase; color:#999; display:block; margin-bottom:6px;">Type</label>
                        <select id="editTeamType" onchange="updateRoleOptions('edit')" style="width:100%; padding:12px; border:1px solid #ddd; font-family:'Montserrat',sans-serif; font-size:0.9rem;">
                            <option value="Vendor">Vendor</option>
                            <option value="Family">Family</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size:0.65rem; letter-spacing:1px; text-transform:uppercase; color:#999; display:block; margin-bottom:6px;">Role</label>
                        <select id="editTeamRole" style="width:100%; padding:12px; border:1px solid #ddd; font-family:'Montserrat',sans-serif; font-size:0.9rem;">
                            <option value="Wedding Planner">Wedding Planner</option>
                            <option value="Venue Contact">Venue Contact</option>
                            <option value="Photographer">Photographer</option>
                            <option value="Videographer">Videographer</option>
                            <option value="Florist">Florist</option>
                            <option value="Caterer">Caterer</option>
                            <option value="DJ">DJ</option>
                            <option value="Band">Band</option>
                        </select>
                        <input type="text" id="editTeamRoleCustom" placeholder="Enter role..." style="display:none; width:100%; padding:12px; border:1px solid #ddd; font-family:'Montserrat',sans-serif; font-size:0.9rem;">
                    </div>
                </div>
                <div style="margin-bottom:16px;">
                    <label style="font-size:0.65rem; letter-spacing:1px; text-transform:uppercase; color:#999; display:block; margin-bottom:6px;">Name</label>
                    <input type="text" id="editTeamName" placeholder="Name" style="width:100%; padding:12px; border:1px solid #ddd; font-family:'Montserrat',sans-serif; font-size:0.9rem;">
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:16px;">
                    <div>
                        <label style="font-size:0.65rem; letter-spacing:1px; text-transform:uppercase; color:#999; display:block; margin-bottom:6px;">Phone</label>
                        <input type="tel" id="editTeamPhone" placeholder="(206) 555-0123" onblur="formatPhone(this)" style="width:100%; padding:12px; border:1px solid #ddd; font-family:'Montserrat',sans-serif; font-size:0.9rem;">
                    </div>
                    <div>
                        <label style="font-size:0.65rem; letter-spacing:1px; text-transform:uppercase; color:#999; display:block; margin-bottom:6px;">Email</label>
                        <input type="email" id="editTeamEmail" placeholder="email@example.com" style="width:100%; padding:12px; border:1px solid #ddd; font-family:'Montserrat',sans-serif; font-size:0.9rem;">
                    </div>
                </div>
                <div style="margin-bottom:16px;">
                    <label style="font-size:0.65rem; letter-spacing:1px; text-transform:uppercase; color:#999; display:block; margin-bottom:6px;">Company</label>
                    <input type="text" id="editTeamCompany" placeholder="Company name" style="width:100%; padding:12px; border:1px solid #ddd; font-family:'Montserrat',sans-serif; font-size:0.9rem;">
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:16px;">
                    <div>
                        <label style="font-size:0.65rem; letter-spacing:1px; text-transform:uppercase; color:#999; display:block; margin-bottom:6px;">Instagram</label>
                        <input type="text" id="editTeamInstagram" placeholder="@handle" style="width:100%; padding:12px; border:1px solid #ddd; font-family:'Montserrat',sans-serif; font-size:0.9rem;">
                    </div>
                    <div>
                        <label style="font-size:0.65rem; letter-spacing:1px; text-transform:uppercase; color:#999; display:block; margin-bottom:6px;">Website</label>
                        <input type="text" id="editTeamWebsite" placeholder="website.com" style="width:100%; padding:12px; border:1px solid #ddd; font-family:'Montserrat',sans-serif; font-size:0.9rem;">
                    </div>
                </div>
            </div>
            <div style="padding:20px 28px; border-top:1px solid #eee; display:flex; justify-content:flex-end; gap:12px;">
                <button onclick="closeEditTeamModal()" style="padding:10px 20px; background:#fff; border:1px solid #ddd; font-family:'Montserrat',sans-serif; font-size:0.8rem; cursor:pointer;">Cancel</button>
                <button onclick="saveEditTeamMember()" style="padding:10px 20px; background:#b5956a; color:#fff; border:none; font-family:'Montserrat',sans-serif; font-size:0.8rem; cursor:pointer;">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Edit Event Details Modal -->
    <div class="modal-overlay" id="editEventModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.4); z-index:1000; align-items:center; justify-content:center;">
        <div id="editEventModalContent" style="background:#fff; width:100%; max-width:550px; max-height:90vh; position:relative; display:flex; flex-direction:column;">
            <div id="editEventModalHeader" style="padding:24px 28px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; cursor:move; user-select:none; flex-shrink:0;">
                <h2 style="font-family:'Cormorant Garamond',serif; font-size:1.4rem; font-weight:400;">Edit Event Details</h2>
                <button onclick="closeEditEventModal()" style="background:none; border:none; cursor:pointer; font-size:1.5rem; color:#999;">&times;</button>
            </div>
            <div style="padding:24px 28px; overflow-y:auto; flex:1;">
                <!-- Client Information Section -->
                <div style="margin-bottom:20px; padding-bottom:20px; border-bottom:1px solid #eee;">
                    <div style="font-size:0.7rem; letter-spacing:1px; text-transform:uppercase; color:#b5956a; margin-bottom:12px; font-weight:500;">Client Information</div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:16px;">
                        <div>
                            <label style="font-size:0.65rem; letter-spacing:1px; text-transform:uppercase; color:#999; display:block; margin-bottom:6px;">Client Name</label>
                            <input type="text" id="editClientName" placeholder="Client name" style="width:100%; padding:12px; border:1px solid #ddd; font-family:'Montserrat',sans-serif; font-size:0.9rem;">
                        </div>
                        <div>
                            <label style="font-size:0.65rem; letter-spacing:1px; text-transform:uppercase; color:#999; display:block; margin-bottom:6px;">Email</label>
                            <input type="email" id="editClientEmail" placeholder="email@example.com" style="width:100%; padding:12px; border:1px solid #ddd; font-family:'Montserrat',sans-serif; font-size:0.9rem;">
                        </div>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:16px;">
                        <div>
                            <label style="font-size:0.65rem; letter-spacing:1px; text-transform:uppercase; color:#999; display:block; margin-bottom:6px;">Phone</label>
                            <input type="tel" id="editClientPhone" placeholder="(206) 555-0123" onblur="formatPhone(this)" style="width:100%; padding:12px; border:1px solid #ddd; font-family:'Montserrat',sans-serif; font-size:0.9rem;">
                        </div>
                        <div>
                            <label style="font-size:0.65rem; letter-spacing:1px; text-transform:uppercase; color:#999; display:block; margin-bottom:6px;">Client Address</label>
                            <input type="text" id="editClientAddress" placeholder="Mailing address" style="width:100%; padding:12px; border:1px solid #ddd; font-family:'Montserrat',sans-serif; font-size:0.9rem;">
                        </div>
                    </div>
                </div>

                <!-- Event Information Section -->
                <div style="font-size:0.7rem; letter-spacing:1px; text-transform:uppercase; color:#b5956a; margin-bottom:12px; font-weight:500;">Event Information</div>
                <div style="margin-bottom:16px;">
                    <label style="font-size:0.65rem; letter-spacing:1px; text-transform:uppercase; color:#999; display:block; margin-bottom:6px;">Event Title</label>
                    <input type="text" id="editEventTitle" placeholder="e.g., Harper Johnson Wedding" style="width:100%; padding:12px; border:1px solid #ddd; font-family:'Montserrat',sans-serif; font-size:0.9rem;">
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:16px;">
                    <div>
                        <label style="font-size:0.65rem; letter-spacing:1px; text-transform:uppercase; color:#999; display:block; margin-bottom:6px;">Event Type</label>
                        <select id="editEventType" style="width:100%; padding:12px; border:1px solid #ddd; font-family:'Montserrat',sans-serif; font-size:0.9rem;">
                            <option value="Wedding">Wedding</option>
                            <option value="Birthday">Birthday</option>
                            <option value="Anniversary">Anniversary</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size:0.65rem; letter-spacing:1px; text-transform:uppercase; color:#999; display:block; margin-bottom:6px;">Event Date</label>
                        <div class="date-input-wrapper">
                            <input type="text" id="editEventDate" readonly>
                            <button type="button" class="calendar-btn" id="editEventDateBtn">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                    <line x1="16" y1="2" x2="16" y2="6"></line>
                                    <line x1="8" y1="2" x2="8" y2="6"></line>
                                    <line x1="3" y1="10" x2="21" y2="10"></line>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:16px;">
                    <div>
                        <label style="font-size:0.65rem; letter-spacing:1px; text-transform:uppercase; color:#999; display:block; margin-bottom:6px;">Event Time (optional)</label>
                        <select id="editEventTime" style="width:100%; padding:12px; border:1px solid #ddd; font-family:'Montserrat',sans-serif; font-size:0.9rem;">
                            <option value="">No time set</option>
                            <option value="06:00">6:00 AM</option>
                            <option value="06:30">6:30 AM</option>
                            <option value="07:00">7:00 AM</option>
                            <option value="07:30">7:30 AM</option>
                            <option value="08:00">8:00 AM</option>
                            <option value="08:30">8:30 AM</option>
                            <option value="09:00">9:00 AM</option>
                            <option value="09:30">9:30 AM</option>
                            <option value="10:00">10:00 AM</option>
                            <option value="10:30">10:30 AM</option>
                            <option value="11:00">11:00 AM</option>
                            <option value="11:30">11:30 AM</option>
                            <option value="12:00">12:00 PM</option>
                            <option value="12:30">12:30 PM</option>
                            <option value="13:00">1:00 PM</option>
                            <option value="13:30">1:30 PM</option>
                            <option value="14:00">2:00 PM</option>
                            <option value="14:30">2:30 PM</option>
                            <option value="15:00">3:00 PM</option>
                            <option value="15:30">3:30 PM</option>
                            <option value="16:00">4:00 PM</option>
                            <option value="16:30">4:30 PM</option>
                            <option value="17:00">5:00 PM</option>
                            <option value="17:30">5:30 PM</option>
                            <option value="18:00">6:00 PM</option>
                            <option value="18:30">6:30 PM</option>
                            <option value="19:00">7:00 PM</option>
                            <option value="19:30">7:30 PM</option>
                            <option value="20:00">8:00 PM</option>
                            <option value="20:30">8:30 PM</option>
                            <option value="21:00">9:00 PM</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size:0.65rem; letter-spacing:1px; text-transform:uppercase; color:#999; display:block; margin-bottom:6px;">Venue / Location</label>
                        <input type="text" id="editEventVenue" placeholder="City, State or Venue name" style="width:100%; padding:12px; border:1px solid #ddd; font-family:'Montserrat',sans-serif; font-size:0.9rem;">
                    </div>
                </div>
                <div style="margin-bottom:16px;">
                    <label style="font-size:0.65rem; letter-spacing:1px; text-transform:uppercase; color:#999; display:block; margin-bottom:6px;">Venue Address</label>
                    <input type="text" id="editEventVenueAddress" placeholder="Full street address for delivery" style="width:100%; padding:12px; border:1px solid #ddd; font-family:'Montserrat',sans-serif; font-size:0.9rem;">
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:16px;">
                    <div>
                        <label style="font-size:0.65rem; letter-spacing:1px; text-transform:uppercase; color:#999; display:block; margin-bottom:6px;">Guest Count</label>
                        <input type="text" id="editEventGuestCount" placeholder="Approximate" style="width:100%; padding:12px; border:1px solid #ddd; font-family:'Montserrat',sans-serif; font-size:0.9rem;">
                    </div>
                    <div>
                        <label style="font-size:0.65rem; letter-spacing:1px; text-transform:uppercase; color:#999; display:block; margin-bottom:6px;">Source</label>
                        <select id="editEventSource" style="width:100%; padding:12px; border:1px solid #ddd; font-family:'Montserrat',sans-serif; font-size:0.9rem;">
                            <option value="">Not specified</option>
                            <option value="Website">Website Form</option>
                            <option value="Instagram">Instagram</option>
                            <option value="Referral">Referral</option>
                            <option value="Vendor">Vendor Referral</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>
                <p style="font-size:0.75rem; color:#999; margin-top:16px;">Note: Changes to the event date and time will also update the calendar.</p>
            </div>
            <div style="padding:20px 28px; border-top:1px solid #eee; display:flex; justify-content:flex-end; gap:12px; flex-shrink:0;">
                <button onclick="closeEditEventModal()" style="padding:10px 20px; background:#fff; border:1px solid #ddd; font-family:'Montserrat',sans-serif; font-size:0.8rem; cursor:pointer;">Cancel</button>
                <button onclick="saveEventDetails()" style="padding:10px 20px; background:#b5956a; color:#fff; border:none; font-family:'Montserrat',sans-serif; font-size:0.8rem; cursor:pointer;">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- API Client -->
    <!-- Reply Email Modal -->
    <div class="modal-overlay" id="replyEmailModal" onclick="if(event.target===this) closeReplyModal()" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.4); z-index:1000; align-items:center; justify-content:center;">
        <div id="composeModalInner" style="background:#fff; width:720px; height:80vh; min-width:400px; min-height:300px; border-radius:8px; overflow:hidden; box-shadow:0 4px 20px rgba(0,0,0,0.15); display:flex; flex-direction:column; position:absolute; resize:both;">
            <div id="composeModalHeader" style="padding:20px 24px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; cursor:move; user-select:none; flex-shrink:0;">
                <h2 id="composeModalTitle" style="font-family:'Cormorant Garamond',serif; font-size:1.3rem; font-weight:400; color:#1a1a1a;">Compose Email</h2>
                <button onclick="closeReplyModal()" style="background:none; border:none; cursor:pointer; font-size:1.5rem; color:#999;">&times;</button>
            </div>

            <!-- To / Subject fields -->
            <div style="padding:16px 24px; border-bottom:1px solid #eee; flex-shrink:0;">
                <div style="display:flex; align-items:center; gap:12px; margin-bottom:12px;">
                    <label style="font-family:'Montserrat',sans-serif; font-size:0.65rem; letter-spacing:1.5px; text-transform:uppercase; color:#999; min-width:55px;">TO</label>
                    <div id="replyTo" style="flex:1; padding:8px 12px; background:#fafafa; border:1px solid #eee; border-radius:4px; font-family:'Montserrat',sans-serif; font-size:0.85rem; color:#333;"></div>
                </div>
                <div style="display:flex; align-items:center; gap:12px;">
                    <label style="font-family:'Montserrat',sans-serif; font-size:0.65rem; letter-spacing:1.5px; text-transform:uppercase; color:#999; min-width:55px;">SUBJECT</label>
                    <input type="text" id="replySubject" style="flex:1; padding:8px 12px; border:1px solid #ddd; font-family:'Montserrat',sans-serif; font-size:0.85rem; font-weight:300; color:#333; border-radius:4px;">
                </div>
            </div>

            <!-- Content area: flex row to allow sidebar alongside either mode -->
            <div id="composeContentArea" style="flex:1; display:flex; min-height:0; overflow:hidden;">

                <!-- Plain text compose (for replies / non-branded) -->
                <div id="plainTextCompose" style="padding:24px; overflow-y:auto; flex:1; display:flex; flex-direction:column; overscroll-behavior:contain;">
                    <div id="messageAreaWrapper" style="flex:1; display:flex; gap:16px; min-height:0;">
                        <div style="flex:1; display:flex; flex-direction:column; min-height:0;">
                            <label style="font-size:0.7rem; letter-spacing:1px; text-transform:uppercase; color:#999; display:block; margin-bottom:6px; flex-shrink:0;">Message</label>
                            <textarea id="replyMessage" style="width:100%; padding:10px 12px; border:1px solid #ddd; border-radius:4px; font-family:'Montserrat',sans-serif; font-size:0.9rem; resize:none; flex:1; min-height:150px;" placeholder="Type your message..."></textarea>
                        </div>
                    </div>
                    <div id="originalMessageSection" style="padding-top:12px; border-top:1px solid #eee; margin-top:16px; flex-shrink:0;">
                        <div style="font-size:0.7rem; letter-spacing:1px; text-transform:uppercase; color:#999; margin-bottom:8px;">Original Message</div>
                        <div id="replyOriginal" style="padding:12px; background:#f9f7f4; border-radius:4px; font-size:0.85rem; color:#666; max-height:120px; overflow-y:auto; white-space:pre-wrap;"></div>
                    </div>
                </div>

                <!-- Branded HTML preview (for template emails) -->
                <div id="brandedPreviewSection" style="display:none; flex:1; overflow-y:auto; padding:24px; background:#f0eeeb; min-height:300px;">
                    <div id="brandedPreviewFrame" style="background:#fff; max-width:600px; margin:0 auto; box-shadow:0 1px 8px rgba(0,0,0,0.08); border-radius:2px;"></div>
                </div>

                <!-- Date slots side panel for tasting options template (shared, sits alongside either mode) -->
                <div id="tastingDateSlots" style="display:none; width:180px; flex-shrink:0; padding:12px; background:#faf8f5; border-right:1px solid #e8e0d5; border-left:1px solid #e8e0d5; overflow-y:auto;">
                    <div style="font-size:0.6rem; letter-spacing:1px; text-transform:uppercase; color:#b5956a; margin-bottom:10px; font-weight:500;">Tasting Dates</div>
                    <div id="dateSlotsList" style="display:flex; flex-direction:column; gap:6px;"></div>
                    <button onclick="addTastingDateSlot()" style="margin-top:8px; width:100%; padding:6px 8px; background:transparent; border:1px dashed #cbb896; border-radius:4px; cursor:pointer; font-family:'Montserrat',sans-serif; font-size:0.65rem; color:#b5956a;">+ Add Option</button>
                </div>

            </div>

            <!-- Body editor for branded mode (toggled) -->
            <div id="brandedBodyEditor" style="display:none; padding:16px 24px; border-top:1px solid #eee; background:#fafafa; flex-shrink:0;">
                <label style="font-family:'Montserrat',sans-serif; font-size:0.65rem; letter-spacing:1.5px; text-transform:uppercase; color:#999;">EDIT EMAIL BODY</label>
                <textarea id="brandedBodyText" style="width:100%; min-height:180px; padding:12px; border:1px solid #ddd; font-family:'Montserrat',sans-serif; font-size:0.85rem; font-weight:300; margin-top:8px; resize:vertical; border-radius:4px; box-sizing:border-box;"></textarea>
                <button onclick="updateBrandedPreview()" style="margin-top:8px; padding:6px 16px; background:#b5956a; color:#fff; border:none; border-radius:4px; font-family:'Montserrat',sans-serif; font-size:0.75rem; letter-spacing:1px; text-transform:uppercase; cursor:pointer;">Update Preview</button>
            </div>

            <!-- Footer -->
            <div style="padding:16px 24px; border-top:1px solid #eee; display:flex; justify-content:space-between; align-items:center; background:#faf8f5; flex-shrink:0;">
                <button id="editBodyToggleBtn" onclick="toggleBrandedBodyEditor()" style="display:none; padding:6px 16px; background:none; border:1px solid #ddd; border-radius:4px; font-family:'Montserrat',sans-serif; font-size:0.7rem; letter-spacing:1px; text-transform:uppercase; color:#666; cursor:pointer;">Edit Body</button>
                <div style="display:flex; gap:12px; align-items:center; margin-left:auto;">
                    <span id="composeSendStatus" style="font-family:'Montserrat',sans-serif; font-size:0.8rem; color:#666;"></span>
                    <button onclick="closeReplyModal()" style="padding:10px 20px; background:#fff; border:1px solid #ddd; border-radius:4px; cursor:pointer; font-family:'Montserrat',sans-serif;">Cancel</button>
                    <button id="composeSendBtn" onclick="sendReplyEmail()" style="padding:10px 20px; background:#b5956a; color:#fff; border:none; border-radius:4px; cursor:pointer; font-family:'Montserrat',sans-serif;">Send</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Email View Modal - Thread View -->
    <div class="modal-overlay" id="emailViewModal" onclick="if(event.target===this) closeEmailViewModal()" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.4); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:#fff; width:100%; max-width:550px; margin:20px; border-radius:8px; overflow:hidden; box-shadow:0 4px 20px rgba(0,0,0,0.15); max-height:80vh; display:flex; flex-direction:column;">
            <div style="padding:20px 24px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; flex-shrink:0;">
                <h2 id="emailViewTitle" style="font-family:'Cormorant Garamond',serif; font-size:1.3rem; font-weight:400; color:#1a1a1a;">Email History</h2>
                <button onclick="closeEmailViewModal()" style="background:none; border:none; cursor:pointer; font-size:1.5rem; color:#999;">&times;</button>
            </div>
            <div id="emailViewBody" style="padding:20px; overflow-y:auto; flex:1; overscroll-behavior:contain;"></div>
            <div style="padding:16px 24px; border-top:1px solid #eee; display:flex; justify-content:flex-end; gap:12px; background:#faf8f5; flex-shrink:0;">
                <button onclick="closeEmailViewModal()" style="padding:10px 20px; background:#fff; border:1px solid #ddd; border-radius:4px; cursor:pointer; font-family:'Montserrat',sans-serif;">Close</button>
                <button id="emailViewReplyBtn" onclick="replyFromViewModal()" style="padding:10px 20px; background:#b5956a; color:#fff; border:none; border-radius:4px; cursor:pointer; font-family:'Montserrat',sans-serif;">Reply</button>
            </div>
        </div>
    </div>

    <!-- Email Template Modal -->
    <div class="modal-overlay" id="templateModal" onclick="if(event.target===this) closeTemplateModal()" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.4); z-index:1000; align-items:center; justify-content:center;">
        <div style="background:#fff; width:100%; max-width:450px; margin:20px; border-radius:8px; overflow:hidden; box-shadow:0 4px 20px rgba(0,0,0,0.15);">
            <div style="padding:20px 24px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                <h2 style="font-family:'Cormorant Garamond',serif; font-size:1.3rem; font-weight:400; color:#1a1a1a;">Email Templates</h2>
                <button onclick="closeTemplateModal()" style="background:none; border:none; cursor:pointer; font-size:1.5rem; color:#999;">&times;</button>
            </div>
            <div style="padding:16px;">
                <div id="templateList" style="display:flex; flex-direction:column; gap:8px;">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- Calendar Popup for Tasting Options -->
    <div class="calendar-popup-overlay" id="tastingCalendarPopup">
        <div class="calendar-popup">
            <div class="calendar-popup-header">
                <h3 class="calendar-popup-title">Select Tasting Date & Time</h3>
                <button class="calendar-popup-close" onclick="closeTastingCalendarPopup()">&times;</button>
            </div>
            <div class="calendar-nav">
                <button class="calendar-nav-btn" onclick="changeTastingMonth(-1)">â€¹</button>
                <span class="calendar-month-year" id="tastingCalendarMonthYear">February 2026</span>
                <button class="calendar-nav-btn" onclick="changeTastingMonth(1)">â€º</button>
            </div>
            <div class="calendar-grid">
                <div class="calendar-weekdays">
                    <div>Sun</div>
                    <div>Mon</div>
                    <div>Tue</div>
                    <div>Wed</div>
                    <div>Thu</div>
                    <div>Fri</div>
                    <div>Sat</div>
                </div>
                <div class="calendar-days" id="tastingCalendarDays">
                    <!-- Days populated by JS -->
                </div>
            </div>
            <div class="time-picker-section" style="display:flex; gap:12px; align-items:flex-end; flex-wrap:wrap;">
                <div style="flex:1; min-width:140px;">
                    <div class="time-picker-label">Start Time</div>
                    <select id="tastingTimePicker" class="time-picker-select" onchange="autoSetTastingEndTime()">
                        <option value="">Choose a time...</option>
                        <option value="09:00">9:00 AM</option>
                        <option value="09:30">9:30 AM</option>
                        <option value="10:00">10:00 AM</option>
                        <option value="10:30">10:30 AM</option>
                        <option value="11:00">11:00 AM</option>
                        <option value="11:30">11:30 AM</option>
                        <option value="12:00">12:00 PM</option>
                        <option value="12:30">12:30 PM</option>
                        <option value="13:00">1:00 PM</option>
                        <option value="13:30">1:30 PM</option>
                        <option value="14:00">2:00 PM</option>
                        <option value="14:30">2:30 PM</option>
                        <option value="15:00">3:00 PM</option>
                        <option value="15:30">3:30 PM</option>
                        <option value="16:00">4:00 PM</option>
                        <option value="16:30">4:30 PM</option>
                        <option value="17:00">5:00 PM</option>
                    </select>
                </div>
                <div style="flex:1; min-width:140px;">
                    <div class="time-picker-label">End Time</div>
                    <select id="tastingEndTimePicker" class="time-picker-select">
                        <option value="">No end time</option>
                        <option value="09:00">9:00 AM</option>
                        <option value="09:30">9:30 AM</option>
                        <option value="10:00">10:00 AM</option>
                        <option value="10:30">10:30 AM</option>
                        <option value="11:00">11:00 AM</option>
                        <option value="11:30">11:30 AM</option>
                        <option value="12:00">12:00 PM</option>
                        <option value="12:30">12:30 PM</option>
                        <option value="13:00">1:00 PM</option>
                        <option value="13:30">1:30 PM</option>
                        <option value="14:00">2:00 PM</option>
                        <option value="14:30">2:30 PM</option>
                        <option value="15:00">3:00 PM</option>
                        <option value="15:30">3:30 PM</option>
                        <option value="16:00">4:00 PM</option>
                        <option value="16:30">4:30 PM</option>
                        <option value="17:00">5:00 PM</option>
                        <option value="18:00">6:00 PM</option>
                    </select>
                </div>
                <button onclick="confirmTastingDateTime()" style="padding:10px 20px; background:#b5956a; color:#fff; border:none; border-radius:4px; cursor:pointer; font-family:'Montserrat',sans-serif;">Select</button>
            </div>
            <div class="calendar-legend">
                <div class="calendar-legend-item">
                    <span class="calendar-legend-dot tasting"></span>
                    <span>Tasting</span>
                </div>
                <div class="calendar-legend-item">
                    <span class="calendar-legend-dot event"></span>
                    <span>Client Event</span>
                </div>
                <div class="calendar-legend-item">
                    <span class="calendar-legend-dot personal"></span>
                    <span>Personal</span>
                </div>
            </div>
        </div>
    </div>

    <script src="/js/api.js"></script>
    <script>
        // Dark Mode - check saved preference on load
        (function() {
            const darkMode = localStorage.getItem('kgc_dark_mode') === 'true';
            if (darkMode) {
                document.body.classList.add('dark-mode');
            }
            document.addEventListener('DOMContentLoaded', updateDarkModeButton);
        })();

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('kgc_dark_mode', isDark);
            updateDarkModeButton();
        }

        function updateDarkModeButton() {
            const isDark = document.body.classList.contains('dark-mode');
            const icon = document.getElementById('darkModeIcon');
            const text = document.getElementById('darkModeText');
            if (icon && text) {
                icon.textContent = isDark ? 'â˜€ï¸' : 'ðŸŒ™';
                text.textContent = isDark ? 'Day Mode' : 'Night Mode';
            }
        }

        // Toast Notification System
        function showToast(message, type = 'info', duration = 4000) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span>${message}</span>
                <button class="toast-close" onclick="this.parentElement.remove()">&times;</button>
            `;
            container.appendChild(toast);

            // Auto-remove after duration
            setTimeout(() => {
                toast.style.animation = 'toastSlideOut 0.3s ease forwards';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // Email Templates
        const emailTemplates = [
            {
                id: 'inquiry-response',
                name: 'Inquiry Response',
                description: 'Thank them for reaching out, confirm date availability, explain tasting process',
                subject: 'Thank You for Your Inquiry - {eventType}',
                body: `Hi {firstName},

Thank you so much for reaching out about your {eventType}! I'm excited to hear about your vision for {eventDate}.

Great news - your date is currently available!

Here's how my process works:

1. TASTING CONSULTATION
We'll schedule a tasting where you can sample flavors and we'll discuss your design vision in detail. Tastings are complimentary and typically last about an hour.

2. CUSTOM PROPOSAL
After our tasting, I'll create a detailed proposal with pricing based on your specific design, guest count, and any special requirements.

3. BOOKING
A 50% deposit locks in your date. The remaining balance is due two weeks before your event.

I'd love to learn more about your event! Are there other team members (planner, florist, venue coordinator) I should connect with?

Looking forward to creating something beautiful for your celebration!

Warmly,
Kenna`
            },
            {
                id: 'tasting-options',
                name: 'Tasting Options',
                description: 'Offer available tasting dates and times',
                subject: 'Tasting Options for Your {eventType}',
                body: `Hi {firstName},

I'd love to schedule your tasting consultation! Here is a date and time that works for me:

[Click to select date/time]

Tastings typically last about an hour. We'll sample flavors, discuss your design vision, and I'll answer any questions you have.

Please let me know if this works for you, or if you'd prefer a different time, share a few times that fit your schedule and I'll do my best to accommodate.

Looking forward to meeting you!

Warmly,
Kenna`
            },
            {
                id: 'tasting-confirmation',
                name: 'Tasting Confirmation',
                description: 'Confirm tasting appointment details',
                subject: 'Tasting Confirmed - {tastingDate}',
                body: `Hi {firstName},

Your tasting is confirmed for {tastingDate} at {tastingTime}!

WHAT TO EXPECT:
- Sample a variety of cake flavors and fillings
- Discuss your design vision and inspiration
- Review timeline and logistics
- Duration: approximately 1 hour

LOCATION:
[Studio Address]

Feel free to bring any inspiration photos, color swatches, or your event team members. I'm looking forward to meeting you!

See you soon,
Kenna`
            },
            {
                id: 'proposal-delivery',
                name: 'Proposal Ready',
                description: 'Let them know their custom proposal is ready',
                subject: 'Your Custom Proposal is Ready!',
                body: `Hi {firstName},

It was wonderful meeting you at your tasting! I've put together a custom proposal for your {eventType}.

You can view your proposal here:
[PROPOSAL LINK]

The proposal includes:
- Design details based on our conversation
- Itemized pricing
- Timeline and delivery information

To secure your date, a 50% deposit is required. Once received, your {eventDate} date will be officially booked!

Please let me know if you have any questions or would like to make any adjustments.

Excited to create this for you!

Warmly,
Kenna`
            },
            {
                id: 'booking-confirmation',
                name: 'Booking Confirmation',
                description: 'Thank them for booking, confirm next steps',
                subject: 'You\'re Booked! - {eventDate}',
                body: `Hi {firstName},

Wonderful news - your date is officially booked! Thank you so much for trusting me with your {eventType}.

WHAT'S NEXT:
- Your remaining balance will be due two weeks before your event ({balanceDueDate})
- I'll reach out closer to your date to confirm final details
- If anything changes with your event, just let me know

I'm so excited to create something beautiful for your celebration!

Warmly,
Kenna`
            },
            {
                id: 'one-month-reminder',
                name: 'One Month Reminder',
                description: 'Friendly reminder about upcoming balance due',
                subject: 'One Month Until Your {eventType}!',
                body: `Hi {firstName},

Can you believe your {eventType} is just one month away?! I'm getting excited to deliver your cake!

Just a friendly reminder that your remaining balance of {balanceAmount} will be due on {balanceDueDate} (two weeks before your event).

If you have any last-minute questions or changes, now is the perfect time to let me know.

Counting down with you!

Warmly,
Kenna`
            },
            {
                id: 'two-week-reminder',
                name: 'Final Balance Due',
                description: 'Balance due reminder two weeks before event',
                subject: 'Final Balance Due - {eventType}',
                body: `Hi {firstName},

Your {eventType} is just two weeks away!

This is a friendly reminder that your final balance of {balanceAmount} is now due.

DELIVERY DETAILS:
- Date: {eventDate}
- Time: [DELIVERY TIME]
- Location: {venue}

Please let me know if any details have changed. I'll reach out a few days before to confirm everything.

So excited for your big day!

Warmly,
Kenna`
            }
        ];

        // Sync client to API in background
        async function syncClientToAPI(client) {
            try {
                await saveClient(client);
                console.log('Client synced to API:', client.name || client.id);
            } catch (error) {
                console.log('API sync failed:', error.message);
            }
        }

        // Handle fade from black if coming from welcome page
        if (window.location.search.includes('fade=true')) {
            setTimeout(() => {
                const fadeStyle = document.getElementById('fadeStyle');
                if (fadeStyle) fadeStyle.remove();
                document.documentElement.style.cssText = 'background: #000; transition: background 3s ease-in-out;';
                document.body.style.cssText = document.body.style.cssText + '; opacity: 0; transition: opacity 3s ease-in-out;';
                document.body.offsetHeight;
                document.documentElement.style.background = '#faf8f5';
                document.body.style.opacity = '1';
            }, 500);
        }

        // Get event colors from secondary accent colors
        function getEventColors(palette) {
            const accents = (palette?.secondary || []).filter(c => c.isAccent);
            return {
                event: accents[0]?.hex || '#a8b5a0',
                tasting: accents[1]?.hex || '#dfc89f',
                inquiry: accents[4]?.hex || '#b8a9c9',
                proposal: accents[3]?.hex || '#a5c4d4',
                signed: accents[2]?.hex || '#d4a5a5',
                custom: accents[5]?.hex || '#c9b99a'
            };
        }

        // Lighten a hex color for backgrounds
        function lightenColor(hex, percent = 0.7) {
            const num = parseInt(hex.replace('#', ''), 16);
            const r = Math.min(255, Math.floor((num >> 16) + (255 - (num >> 16)) * percent));
            const g = Math.min(255, Math.floor(((num >> 8) & 0x00FF) + (255 - ((num >> 8) & 0x00FF)) * percent));
            const b = Math.min(255, Math.floor((num & 0x0000FF) + (255 - (num & 0x0000FF)) * percent));
            return `rgb(${r}, ${g}, ${b})`;
        }

        // Darken a hex color for text
        function darkenColor(hex, percent = 0.3) {
            const num = parseInt(hex.replace('#', ''), 16);
            const r = Math.floor((num >> 16) * (1 - percent));
            const g = Math.floor(((num >> 8) & 0x00FF) * (1 - percent));
            const b = Math.floor((num & 0x0000FF) * (1 - percent));
            return `rgb(${r}, ${g}, ${b})`;
        }

        // Apply active palette colors dynamically
        function applyActivePalette() {
            const activePalette = JSON.parse(localStorage.getItem('kgc_active_palette'));
            if (!activePalette) return;

            const primary = activePalette.primary || [];
            const colors = getEventColors(activePalette);

            let css = '';

            // Primary brand gold
            if (primary[0]) {
                css += `.nav-item.active { border-left-color: ${primary[0].hex}; }\n`;
                css += `.section-tab.active { border-bottom-color: ${primary[0].hex}; color: ${primary[0].hex}; }\n`;
            }

            // Document status colors (using accent colors with lighten/darken)
            const paidBg = lightenColor(colors.event, 0.6);
            const paidText = darkenColor(colors.event, 0.3);
            const pendingBg = lightenColor(colors.tasting, 0.6);
            const pendingText = darkenColor(colors.tasting, 0.3);
            const draftBg = lightenColor(colors.inquiry, 0.6);
            const draftText = darkenColor(colors.inquiry, 0.3);

            css += `.document-status.paid, .document-status.signed { background: ${paidBg}; color: ${paidText}; }\n`;
            css += `.document-status.pending { background: ${pendingBg}; color: ${pendingText}; }\n`;
            css += `.document-status.draft { background: ${draftBg}; color: ${draftText}; }\n`;

            let styleEl = document.getElementById('dynamic-palette-styles');
            if (!styleEl) {
                styleEl = document.createElement('style');
                styleEl.id = 'dynamic-palette-styles';
                document.head.appendChild(styleEl);
            }
            styleEl.textContent = css;
        }
        applyActivePalette();

        // Get client ID and mode from URL
        const params = new URLSearchParams(window.location.search);
        const clientIdParam = params.get('id');
        const clientId = clientIdParam ? parseInt(clientIdParam) || clientIdParam : null;
        const isAdmin = params.get('mode') === 'admin' || !params.has('mode'); // Default to admin if no mode specified

        console.log('Client ID from URL:', clientIdParam, '-> parsed:', clientId);

        // Set admin mode
        if (!isAdmin) {
            document.body.classList.remove('admin-mode');
        }

        // Load clients from API and sync to localStorage
        async function loadClientsFromAPI() {
            try {
                const clients = await getClients();
                localStorage.setItem('kgc_clients', JSON.stringify(clients));
                loadClient(); // Reload with API data
                loadTeam();   // Re-render team in case client data changed
                console.log('Client view: Loaded', clients.length, 'clients from API');
            } catch (error) {
                console.log('Client view: Using localStorage fallback:', error.message);
            }
        }

        // Load client data
        function loadClient() {
            const clients = JSON.parse(localStorage.getItem('kgc_clients') || '[]');
            console.log('All clients:', clients.map(c => ({ id: c.id, name: c.name })));
            console.log('Looking for ID:', clientId, 'type:', typeof clientId);

            const client = clients.find(c => {
                const match = c.id == clientId || String(c.id) === String(clientId) || c.id === parseInt(clientId);
                console.log('Comparing', c.id, '==', clientId, ':', match);
                return match;
            });

            if (!client) {
                document.getElementById('pageTitle').textContent = 'Client Not Found';
                console.log('No matching client found!');
                return;
            }

            window.currentClient = client;

            // Update archive toggle state
            updateArchiveToggle(client.archived);

            // Update page title and event title - use custom title or generate from name + event type
            const portalData = JSON.parse(localStorage.getItem('kgc_portal_' + clientId) || '{}');
            const defaultTitle = (client.name || 'Client') + ' ' + (client.eventType || 'Event');
            // Only use saved title if it was explicitly customized (not an old default)
            const oldDefaults = ['Client Portal', client.name, client.name + ' Event'];
            const hasCustomTitle = portalData.portalTitle && !oldDefaults.includes(portalData.portalTitle);
            const eventTitle = hasCustomTitle ? portalData.portalTitle : defaultTitle;
            document.getElementById('pageTitle').textContent = eventTitle;
            document.getElementById('eventDetailsTitle').textContent = eventTitle + ' Event Details';

            // Update details
            document.getElementById('clientName').textContent = client.name || '-';
            document.getElementById('clientEmail').textContent = client.email || '-';
            document.getElementById('clientPhone').textContent = client.phone || '-';
            document.getElementById('clientAddress').textContent = client.address || '-';
            document.getElementById('eventType').textContent = client.eventType || '-';
            if (isAdmin && client.eventDate) {
                document.getElementById('eventDate').innerHTML = `<a href="/admin/calendar?date=${client.eventDate}" style="color: inherit; text-decoration: none;" onmouseover="this.style.color='#b5956a'" onmouseout="this.style.color='inherit'">${formatDate(client.eventDate)}</a>`;
            } else {
                document.getElementById('eventDate').textContent = formatDate(client.eventDate);
            }
            // Update header subtitle with event date
            if (client.eventDate) {
                document.getElementById('headerEventDate').textContent = formatDate(client.eventDate);
            }
            document.getElementById('eventTime').textContent = formatTime(client.eventTime);
            document.getElementById('venue').textContent = client.venue || '-';
            document.getElementById('venueAddress').textContent = client.venueAddress || '-';
            document.getElementById('guestCount').textContent = client.guestCount ? client.guestCount + ' guests' : '-';
            document.getElementById('source').textContent = client.source || '-';
            document.getElementById('inquiryDate').textContent = formatDate(client.createdAt);

            // Tasting date/time - check tasting drafts first, then client record
            const tastingDrafts = JSON.parse(localStorage.getItem('kgc_tasting_drafts') || '{}');
            const tastingDraft = tastingDrafts[clientId] || tastingDrafts[String(clientId)];
            const tastingDate = tastingDraft?.date || client.tastingDate;
            const tastingTime = tastingDraft?.time || client.tastingTime;
            const tastingEndTime = tastingDraft?.endTime || client.tastingEndTime;
            document.getElementById('tastingDate').textContent = tastingDate ? formatDate(tastingDate) : '-';
            let tastingTimeDisplay = tastingTime ? formatTime(tastingTime) : '-';
            if (tastingTime && tastingEndTime) tastingTimeDisplay += ' - ' + formatTime(tastingEndTime);
            document.getElementById('tastingTime').textContent = tastingTimeDisplay;
            const tastingGuests = tastingDraft?.guests || client.tastingGuests;
            document.getElementById('tastingGuests').textContent = tastingGuests ? tastingGuests + ' guests' : '-';

            // Show inquiry message if exists
            if (client.notes && client.notes.trim()) {
                document.getElementById('inquiryMessageSection').style.display = 'block';
                document.getElementById('inquiryMessage').textContent = client.notes;
            }

            // Update status tracker
            updateStatusTracker();

            // Load accounting
            loadAccounting();

            // General Communication section removed (clients don't use portal)

            // Load internal notes (portalData already loaded above)
            document.getElementById('internalNotes').value = portalData.internalNotes || '';

            // Load internal documents
            loadInternalDocs();

            // Load day of instructions
            document.getElementById('dayOfInstructions').value = portalData.dayOfInstructions || '';
            loadDayOfFiles();
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            // Always strip time/timezone to avoid UTCâ†’local shift (-1 day in PT)
            const clean = String(dateStr).split('T')[0];
            const date = new Date(clean + 'T00:00:00');
            if (isNaN(date.getTime())) return '-';
            return date.toLocaleDateString('en-US', {
                month: 'long', day: 'numeric', year: 'numeric'
            });
        }

        function formatTime(time) {
            if (!time) return '-';
            const [hours, minutes] = time.split(':');
            const h = parseInt(hours);
            const ampm = h >= 12 ? 'PM' : 'AM';
            const hour12 = h % 12 || 12;
            return `${hour12}:${minutes} ${ampm}`;
        }

        // Phone number formatting - converts 10 digits to (xxx) xxx-xxxx
        function formatPhone(input) {
            // Get just the digits
            const digits = input.value.replace(/\D/g, '');

            // If exactly 10 digits, format it
            if (digits.length === 10) {
                input.value = `(${digits.slice(0,3)}) ${digits.slice(3,6)}-${digits.slice(6)}`;
            }
        }

        // Progress info calculation (same logic as In Studio)
        function getProgressInfo(client) {
            const portalData = JSON.parse(localStorage.getItem('kgc_portal_' + client.id) || '{}');
            const tastingDrafts = JSON.parse(localStorage.getItem('kgc_tasting_drafts') || '{}');
            const proposalDrafts = JSON.parse(localStorage.getItem('kgc_proposal_drafts') || '{}');
            const signatures = JSON.parse(localStorage.getItem('kgc_signatures') || '{}');

            const signed = signatures[client.id] || signatures[String(client.id)];
            const tastingDraft = tastingDrafts[client.id] || tastingDrafts[String(client.id)];
            const proposalDraft = proposalDrafts[client.id] || proposalDrafts[String(client.id)];
            const tastingPaid = portalData.tastingPaid;
            const tastingStarted = client.status === 'tasting' || tastingDraft || tastingPaid;

            const steps = ['inquiry', 'tasting', 'proposal', 'booked', 'delivered'];
            let currentStep = 0;
            let label = 'Inquiry';

            // Track which steps are actually completed
            let stepStates = ['complete', 'future', 'future', 'future', 'future']; // inquiry always done

            // Tasting stage
            if (tastingStarted) {
                stepStates[1] = tastingPaid ? 'complete' : 'current';
                if (!proposalDraft && !signed) {
                    currentStep = 1;
                    label = 'Tasting';
                }
            } else {
                stepStates[1] = 'skipped'; // Will be ghosted if we're past it
            }

            // Proposal stage - if proposal draft exists or signed
            if (client.status === 'proposal' || proposalDraft || signed) {
                currentStep = 2;
                label = 'Proposal';
                if (!tastingStarted) stepStates[1] = 'skipped';
                stepStates[2] = signed ? 'complete' : 'current';
            }

            // Booked stage - signed and deposit paid
            if (signed && portalData.depositPaid) {
                currentStep = 3;
                label = 'Booked';
                stepStates[2] = 'complete';
                stepStates[3] = 'current';
            }

            // Delivered stage
            if (client.status === 'complete' || client.status === 'delivered') {
                currentStep = 4;
                label = 'Delivered';
                stepStates[3] = 'complete';
                stepStates[4] = 'current';
            }

            return { currentStep, label, total: steps.length, stepStates };
        }

        function updateStatusTracker() {
            const client = window.currentClient;
            if (!client) return;

            const progress = getProgressInfo(client);
            const statusLabels = ['Inquiry', 'Tasting', 'Proposal', 'Booked', 'Delivered'];

            // Build progress bar HTML (same format as In Studio)
            let html = '<div class="progress-wrapper">';
            html += '<div class="progress-bar">';
            for (let i = 0; i < progress.total; i++) {
                const state = progress.stepStates[i];
                let cls = 'progress-step';
                if (state === 'complete') cls += ' complete';
                else if (state === 'current') cls += ' current';
                else if (state === 'skipped') cls += ' skipped';
                html += `<div class="${cls}"></div>`;
            }
            html += '</div>';

            // Label centered under current step
            const stepWidth = 100 / progress.total;
            const labelPosition = (progress.currentStep * stepWidth) + (stepWidth / 2);
            html += `<div class="progress-label current" style="position: absolute; left: ${labelPosition}%; transform: translateX(-50%); white-space: nowrap;">${progress.label}</div>`;
            html += '</div>';

            document.getElementById('progressBarContainer').innerHTML = html;
        }

        async function loadAccounting() {
            const container = document.getElementById('accountingList');
            const summaryEl = document.getElementById('accountingSummary');

            // Fetch invoices from API (same source as Finance page)
            let invoices = [];
            try {
                const resp = await fetch(`https://sugar-backend-production.up.railway.app/api/invoices?client_id=${clientId}`);
                if (resp.ok) invoices = await resp.json();
            } catch (e) { console.log('Could not load invoices:', e.message); }

            if (invoices.length === 0) {
                container.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">No invoices yet</p>';
                summaryEl.style.display = 'none';
                return;
            }

            // Deduplicate: keep highest-status invoice per type
            const statusPriority = { paid: 3, pending_verification: 2, sent: 1, draft: 0 };
            const byType = {};
            invoices.forEach(inv => {
                const type = inv.type || 'other';
                if (!byType[type] || (statusPriority[inv.status] || 0) > (statusPriority[byType[type].status] || 0)) {
                    byType[type] = inv;
                }
            });
            const dedupedInvoices = Object.values(byType);

            // Sort: tasting, deposit, final
            const typeOrder = { tasting: 0, deposit: 1, final: 2 };
            dedupedInvoices.sort((a, b) => (typeOrder[a.type] ?? 9) - (typeOrder[b.type] ?? 9));

            let totalDue = 0;
            let totalPaid = 0;

            container.innerHTML = dedupedInvoices.map(inv => {
                const amount = parseFloat(inv.amount) || 0;
                const isPaid = inv.status === 'paid';
                const isPending = inv.status === 'pending_verification';

                if (isPaid) totalPaid += amount;
                else if (inv.status === 'sent') totalDue += amount;

                // Invoice name
                let name = 'Invoice';
                if (inv.type === 'tasting') name = 'Tasting Fee';
                else if (inv.type === 'deposit') name = 'Deposit (50%)';
                else if (inv.type === 'final') name = 'Final Payment';

                // Status text
                let statusText = '';
                let statusClass = '';
                if (isPaid) {
                    statusText = 'Paid ' + (inv.paid_at ? formatDate(inv.paid_at) : '');
                    statusClass = 'paid';
                } else if (isPending) {
                    statusText = 'Pending verification';
                } else if (inv.status === 'sent') {
                    statusText = inv.due_date ? 'Due by ' + formatDate(inv.due_date) : 'Sent';
                } else {
                    statusText = inv.status || 'Draft';
                }

                const invNum = inv.invoice_number || '';

                return `
                <div class="accounting-item ${statusClass}">
                    <div class="accounting-info">
                        <div class="accounting-name">${name}</div>
                        <div class="accounting-meta">${statusText}</div>
                        ${invNum ? `<div style="font-size: 0.7rem; color: #999; margin-top: 2px;">${invNum}</div>` : ''}
                    </div>
                    <div class="accounting-actions">
                        <div class="accounting-amount ${statusClass}">$${amount.toFixed(2)}</div>
                        ${isPending ? '<span style="font-size: 0.65rem; color: #856404; background: #fff3cd; padding: 2px 8px; border-radius: 3px;">Verifying</span>' : ''}
                    </div>
                </div>
                `;
            }).join('');

            // Render summary
            summaryEl.innerHTML = `
                <div class="summary-item">
                    <div class="summary-label">Total Due</div>
                    <div class="summary-value due">$${totalDue.toFixed(2)}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Total Paid</div>
                    <div class="summary-value paid">$${totalPaid.toFixed(2)}</div>
                </div>
            `;
            summaryEl.style.display = 'flex';
        }

        function loadInternalDocs() {
            const portalData = JSON.parse(localStorage.getItem('kgc_portal_' + clientId) || '{}');
            const docs = portalData.internalDocs || [];

            const container = document.getElementById('internalDocsGrid');
            container.innerHTML = '';

            docs.forEach((doc, index) => {
                const div = document.createElement('div');
                div.className = 'file-item';
                div.style.position = 'relative';

                // Determine icon based on file type
                let icon = 'ðŸ“„';
                if (doc.type.includes('pdf')) icon = 'ðŸ“•';
                else if (doc.type.includes('image')) icon = 'ðŸ–¼ï¸';
                else if (doc.type.includes('word') || doc.name.endsWith('.doc') || doc.name.endsWith('.docx')) icon = 'ðŸ“';
                else if (doc.type.includes('excel') || doc.name.endsWith('.xls') || doc.name.endsWith('.xlsx')) icon = 'ðŸ“Š';

                div.innerHTML = `
                    <div class="file-thumbnail">${doc.type.startsWith('image/') ? `<img src="${doc.data}" alt="${doc.name}">` : icon}</div>
                    <div class="file-name">${doc.name}</div>
                    <button onclick="event.stopPropagation(); deleteInternalDoc(${index})" style="position:absolute; top:4px; right:4px; background:#ff4444; color:white; border:none; border-radius:50%; width:20px; height:20px; font-size:12px; cursor:pointer; line-height:1;">&times;</button>
                `;
                div.onclick = () => window.open(doc.data, '_blank');
                container.appendChild(div);
            });

            // Add upload button at the end
            const uploadDiv = document.createElement('div');
            uploadDiv.className = 'file-upload';
            uploadDiv.onclick = () => document.getElementById('internalDocUpload').click();
            uploadDiv.innerHTML = `
                <div class="file-upload-icon">+</div>
                <div class="file-upload-text">Add Document</div>
            `;
            container.appendChild(uploadDiv);
        }

        function handleInternalDocUpload(input) {
            if (!input.files) return;

            const portalData = JSON.parse(localStorage.getItem('kgc_portal_' + clientId) || '{}');
            portalData.internalDocs = portalData.internalDocs || [];

            Array.from(input.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    portalData.internalDocs.push({
                        name: file.name,
                        type: file.type,
                        data: e.target.result,
                        uploadedAt: new Date().toISOString()
                    });
                    localStorage.setItem('kgc_portal_' + clientId, JSON.stringify(portalData));
                    loadInternalDocs();
                };
                reader.readAsDataURL(file);
            });

            input.value = '';
        }

        function deleteInternalDoc(index) {
            if (!confirm('Delete this document?')) return;

            const portalData = JSON.parse(localStorage.getItem('kgc_portal_' + clientId) || '{}');
            portalData.internalDocs = portalData.internalDocs || [];
            portalData.internalDocs.splice(index, 1);
            localStorage.setItem('kgc_portal_' + clientId, JSON.stringify(portalData));
            loadInternalDocs();
        }

        // Day of Instructions functions
        function loadDayOfFiles() {
            const portalData = JSON.parse(localStorage.getItem('kgc_portal_' + clientId) || '{}');
            const files = portalData.dayOfFiles || [];

            const container = document.getElementById('dayOfFilesGrid');
            container.innerHTML = '';

            files.forEach((file, index) => {
                const div = document.createElement('div');
                div.className = 'file-item';
                div.style.position = 'relative';

                let icon = 'ðŸ“„';
                if (file.type.includes('pdf')) icon = 'ðŸ“•';
                else if (file.type.includes('image')) icon = 'ðŸ–¼ï¸';
                else if (file.type.includes('word') || file.name.endsWith('.doc') || file.name.endsWith('.docx')) icon = 'ðŸ“';
                else if (file.type.includes('excel') || file.name.endsWith('.xls') || file.name.endsWith('.xlsx')) icon = 'ðŸ“Š';

                div.innerHTML = `
                    <div class="file-thumbnail">${file.type.startsWith('image/') ? `<img src="${file.data}" alt="${file.name}">` : icon}</div>
                    <div class="file-name">${file.name}</div>
                    <button onclick="event.stopPropagation(); deleteDayOfFile(${index})" style="position:absolute; top:4px; right:4px; background:#ff4444; color:white; border:none; border-radius:50%; width:20px; height:20px; font-size:12px; cursor:pointer; line-height:1;">&times;</button>
                `;
                div.onclick = () => window.open(file.data, '_blank');
                container.appendChild(div);
            });

            // Add upload button at the end
            const uploadDiv = document.createElement('div');
            uploadDiv.className = 'file-upload';
            uploadDiv.onclick = () => document.getElementById('dayOfFileUpload').click();
            uploadDiv.innerHTML = `
                <div class="file-upload-icon">+</div>
                <div class="file-upload-text">Add File</div>
            `;
            container.appendChild(uploadDiv);
        }

        function handleDayOfFileUpload(input) {
            if (!input.files) return;

            const portalData = JSON.parse(localStorage.getItem('kgc_portal_' + clientId) || '{}');
            portalData.dayOfFiles = portalData.dayOfFiles || [];

            Array.from(input.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    portalData.dayOfFiles.push({
                        name: file.name,
                        type: file.type,
                        data: e.target.result,
                        uploadedAt: new Date().toISOString()
                    });
                    localStorage.setItem('kgc_portal_' + clientId, JSON.stringify(portalData));
                    loadDayOfFiles();
                };
                reader.readAsDataURL(file);
            });

            input.value = '';
        }

        function deleteDayOfFile(index) {
            if (!confirm('Delete this file?')) return;

            const portalData = JSON.parse(localStorage.getItem('kgc_portal_' + clientId) || '{}');
            portalData.dayOfFiles = portalData.dayOfFiles || [];
            portalData.dayOfFiles.splice(index, 1);
            localStorage.setItem('kgc_portal_' + clientId, JSON.stringify(portalData));
            loadDayOfFiles();
        }

        function saveDayOfInstructions() {
            const portalData = JSON.parse(localStorage.getItem('kgc_portal_' + clientId) || '{}');
            portalData.dayOfInstructions = document.getElementById('dayOfInstructions').value;
            localStorage.setItem('kgc_portal_' + clientId, JSON.stringify(portalData));
            showToast('Day of instructions saved!', 'success');
        }

        function saveChanges() {
            const portalData = JSON.parse(localStorage.getItem('kgc_portal_' + clientId) || '{}');
            portalData.internalNotes = document.getElementById('internalNotes').value;
            localStorage.setItem('kgc_portal_' + clientId, JSON.stringify(portalData));
            showToast('Changes saved!', 'success');
        }

        function openProposal() {
            window.location.href = '/proposals/proposal-builder.html?clientId=' + clientId;
        }

        function copyClientLink() {
            const clientUrl = window.location.origin + window.location.pathname + '?id=' + clientId;
            navigator.clipboard.writeText(clientUrl).then(() => {
                showToast('Client link copied to clipboard!', 'success');
            });
        }

        // Archive functions
        function updateArchiveToggle(isArchived) {
            const activeBtn = document.getElementById('activeBtn');
            const archivedBtn = document.getElementById('archivedBtn');

            if (isArchived) {
                activeBtn.style.background = '#fff';
                activeBtn.style.color = '#666';
                archivedBtn.style.background = '#999';
                archivedBtn.style.color = '#fff';
            } else {
                activeBtn.style.background = '#b5956a';
                activeBtn.style.color = '#fff';
                archivedBtn.style.background = '#fff';
                archivedBtn.style.color = '#666';
            }
        }

        function setClientActive() {
            if (!isAdmin) return;

            const clients = JSON.parse(localStorage.getItem('kgc_clients') || '[]');
            const client = clients.find(c => c.id === clientId || String(c.id) === String(clientId));
            if (client) {
                client.archived = false;
                localStorage.setItem('kgc_clients', JSON.stringify(clients));
                window.currentClient = client;
                updateArchiveToggle(false);
            }
        }

        async function deleteClient() {
            if (!isAdmin) return;

            const client = window.currentClient;
            const name = client ? (client.name || client.firstName || 'this client') : 'this client';

            if (!confirm(`Permanently delete ${name}?\n\nThis will remove ALL their data:\n- Proposals\n- Invoices\n- Payments & revenue\n- Communications\n\nThis cannot be undone.`)) return;

            if (!confirm(`Are you sure? Type OK to confirm deletion of ${name}.`)) return;

            try {
                const resp = await fetch(`https://sugar-backend-production.up.railway.app/api/clients/${clientId}`, { method: 'DELETE' });
                const data = await resp.json();

                if (data.success) {
                    // Clean up localStorage
                    const invoices = JSON.parse(localStorage.getItem('kgc_invoices') || '[]');
                    const cleaned = invoices.filter(i => String(i.clientId) !== String(clientId));
                    localStorage.setItem('kgc_invoices', JSON.stringify(cleaned));

                    const revenue = JSON.parse(localStorage.getItem('kgc_revenue') || '[]');
                    const cleanedRev = revenue.filter(r => String(r.clientId) !== String(clientId));
                    localStorage.setItem('kgc_revenue', JSON.stringify(cleanedRev));

                    const clients = JSON.parse(localStorage.getItem('kgc_clients') || '[]');
                    const cleanedClients = clients.filter(c => String(c.id) !== String(clientId));
                    localStorage.setItem('kgc_clients', JSON.stringify(cleanedClients));

                    alert(`${name} has been deleted.`);
                    window.location.href = '/admin/in-studio.html';
                } else {
                    alert('Error: ' + (data.error || 'Delete failed'));
                }
            } catch (err) {
                console.error('Delete error:', err);
                alert('Connection error. Please try again.');
            }
        }

        function setClientArchived() {
            if (!isAdmin) return;

            if (!confirm('Archive this client?\n\nThey will be moved to the Archived section on the dashboard.')) return;

            const clients = JSON.parse(localStorage.getItem('kgc_clients') || '[]');
            const client = clients.find(c => c.id === clientId || String(c.id) === String(clientId));
            if (client) {
                client.archived = true;
                localStorage.setItem('kgc_clients', JSON.stringify(clients));
                window.currentClient = client;
                updateArchiveToggle(true);
            }
        }

        function editPortalTitle() {
            if (!isAdmin) return;

            const currentTitle = document.getElementById('pageTitle').textContent;
            const client = window.currentClient;
            const defaultTitle = (client.name || 'Client') + ' ' + (client.eventType || 'Event');

            const newTitle = prompt('Edit portal title:', currentTitle);
            if (newTitle !== null && newTitle.trim() !== '') {
                document.getElementById('pageTitle').textContent = newTitle.trim();

                // Save to localStorage
                const portalData = JSON.parse(localStorage.getItem('kgc_portal_' + clientId) || '{}');
                portalData.portalTitle = newTitle.trim();
                localStorage.setItem('kgc_portal_' + clientId, JSON.stringify(portalData));
            }
        }

        function toggleCard(cardId) {
            const card = document.getElementById(cardId);
            card.classList.toggle('collapsed');
        }

        // Drag and drop for internal docs
        const internalDocsGrid = document.getElementById('internalDocsGrid');

        internalDocsGrid.addEventListener('dragover', (e) => {
            e.preventDefault();
            internalDocsGrid.classList.add('dragover');
        });

        internalDocsGrid.addEventListener('dragleave', (e) => {
            e.preventDefault();
            internalDocsGrid.classList.remove('dragover');
        });

        internalDocsGrid.addEventListener('drop', (e) => {
            e.preventDefault();
            internalDocsGrid.classList.remove('dragover');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleDroppedInternalDocs(files);
            }
        });

        function handleDroppedInternalDocs(files) {
            const portalData = JSON.parse(localStorage.getItem('kgc_portal_' + clientId) || '{}');
            portalData.internalDocs = portalData.internalDocs || [];

            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    portalData.internalDocs.push({
                        name: file.name,
                        type: file.type,
                        data: e.target.result,
                        uploadedAt: new Date().toISOString()
                    });
                    localStorage.setItem('kgc_portal_' + clientId, JSON.stringify(portalData));
                    loadInternalDocs();
                };
                reader.readAsDataURL(file);
            });
        }

        // Drag and drop for day of files
        const dayOfFilesGrid = document.getElementById('dayOfFilesGrid');

        dayOfFilesGrid.addEventListener('dragover', (e) => {
            e.preventDefault();
            dayOfFilesGrid.classList.add('dragover');
        });

        dayOfFilesGrid.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dayOfFilesGrid.classList.remove('dragover');
        });

        dayOfFilesGrid.addEventListener('drop', (e) => {
            e.preventDefault();
            dayOfFilesGrid.classList.remove('dragover');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleDroppedDayOfFiles(files);
            }
        });

        function handleDroppedDayOfFiles(files) {
            const portalData = JSON.parse(localStorage.getItem('kgc_portal_' + clientId) || '{}');
            portalData.dayOfFiles = portalData.dayOfFiles || [];

            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    portalData.dayOfFiles.push({
                        name: file.name,
                        type: file.type,
                        data: e.target.result,
                        uploadedAt: new Date().toISOString()
                    });
                    localStorage.setItem('kgc_portal_' + clientId, JSON.stringify(portalData));
                    loadDayOfFiles();
                };
                reader.readAsDataURL(file);
            });
        }

        // General Communication file drag/drop removed (section deleted)

        // Team functions
        let teamModalTab = 'new';
        let selectedContactId = null;

        const vendorRoles = ['Wedding Planner', 'Venue Contact', 'Photographer', 'Videographer', 'Florist', 'Caterer', 'DJ', 'Band', 'Rental Company', 'Lighting', 'Hair & Makeup'];
        const familyRoles = ['Mother of the Bride', 'Mother of the Groom', 'Father of the Bride', 'Father of the Groom', 'Maid of Honor', 'Best Man', 'Bridesmaid', 'Groomsman', 'Sibling', 'Grandparent'];

        function updateRoleOptions(mode) {
            const typeSelect = mode === 'new' ? document.getElementById('teamType') :
                              mode === 'contact' ? document.getElementById('teamTypeFromContact') :
                              document.getElementById('editTeamType');
            const roleSelect = mode === 'new' ? document.getElementById('teamRole') :
                              mode === 'contact' ? document.getElementById('teamRoleFromContact') :
                              document.getElementById('editTeamRole');
            const roleCustom = mode === 'new' ? document.getElementById('teamRoleCustom') :
                              mode === 'contact' ? document.getElementById('teamRoleFromContactCustom') :
                              document.getElementById('editTeamRoleCustom');

            const type = typeSelect.value;

            if (type === 'Vendor') {
                roleSelect.style.display = 'block';
                roleCustom.style.display = 'none';
                roleSelect.innerHTML = vendorRoles.map(r => `<option value="${r}">${r}</option>`).join('');
            } else if (type === 'Family') {
                roleSelect.style.display = 'block';
                roleCustom.style.display = 'none';
                roleSelect.innerHTML = familyRoles.map(r => `<option value="${r}">${r}</option>`).join('');
            } else {
                roleSelect.style.display = 'none';
                roleCustom.style.display = 'block';
                roleCustom.value = '';
            }
        }

        function getSelectedRole(mode) {
            const typeSelect = mode === 'new' ? document.getElementById('teamType') :
                              mode === 'contact' ? document.getElementById('teamTypeFromContact') :
                              document.getElementById('editTeamType');
            const roleSelect = mode === 'new' ? document.getElementById('teamRole') :
                              mode === 'contact' ? document.getElementById('teamRoleFromContact') :
                              document.getElementById('editTeamRole');
            const roleCustom = mode === 'new' ? document.getElementById('teamRoleCustom') :
                              mode === 'contact' ? document.getElementById('teamRoleFromContactCustom') :
                              document.getElementById('editTeamRoleCustom');

            if (typeSelect.value === 'Other') {
                return roleCustom.value || 'Other';
            }
            return roleSelect.value;
        }

        function openTeamModal() {
            document.getElementById('teamModal').style.display = 'flex';
            setTeamTab('new');
            document.getElementById('teamRole').value = 'Wedding Planner';
            document.getElementById('teamName').value = '';
            document.getElementById('teamPhone').value = '';
            document.getElementById('teamEmail').value = '';
            document.getElementById('teamCompany').value = '';
            document.getElementById('teamInstagram').value = '';
            document.getElementById('teamWebsite').value = '';
            document.getElementById('teamAddToContacts').checked = true;
            document.getElementById('contactSearch').value = '';
            selectedContactId = null;
            loadContactsList();
        }

        function closeTeamModal() {
            document.getElementById('teamModal').style.display = 'none';
        }

        function setTeamTab(tab) {
            teamModalTab = tab;
            document.getElementById('tabNewMember').style.background = tab === 'new' ? '#1a1a1a' : '#fff';
            document.getElementById('tabNewMember').style.color = tab === 'new' ? '#fff' : '#666';
            document.getElementById('tabNewMember').style.borderColor = tab === 'new' ? '#1a1a1a' : '#ddd';
            document.getElementById('tabFromContacts').style.background = tab === 'contacts' ? '#1a1a1a' : '#fff';
            document.getElementById('tabFromContacts').style.color = tab === 'contacts' ? '#fff' : '#666';
            document.getElementById('tabFromContacts').style.borderColor = tab === 'contacts' ? '#1a1a1a' : '#ddd';
            document.getElementById('newMemberSection').style.display = tab === 'new' ? 'block' : 'none';
            document.getElementById('fromContactsSection').style.display = tab === 'contacts' ? 'block' : 'none';
        }

        function loadContactsList() {
            const allContacts = JSON.parse(localStorage.getItem('kgc_clients') || '[]');
            // Get existing team member IDs
            const portalData = JSON.parse(localStorage.getItem('kgc_portal_' + clientId) || '{}');
            const existingTeamIds = (portalData.team || []).map(m => m.contactId).filter(Boolean);
            // Filter to contacts only (not primary client or already on team)
            const contacts = allContacts.filter(c =>
                c.status === 'contact' &&
                String(c.id) !== String(clientId) &&
                !existingTeamIds.includes(c.id)
            );
            renderContactsList(contacts);
        }

        function filterContactsList() {
            const search = document.getElementById('contactSearch').value.toLowerCase();
            const allContacts = JSON.parse(localStorage.getItem('kgc_clients') || '[]');
            const portalData = JSON.parse(localStorage.getItem('kgc_portal_' + clientId) || '{}');
            const existingTeamIds = (portalData.team || []).map(m => m.contactId).filter(Boolean);
            const contacts = allContacts.filter(c =>
                c.status === 'contact' &&
                String(c.id) !== String(clientId) &&
                !existingTeamIds.includes(c.id) &&
                (c.name?.toLowerCase().includes(search) || c.company?.toLowerCase().includes(search) || c.email?.toLowerCase().includes(search))
            );
            renderContactsList(contacts);
        }

        function renderContactsList(contacts) {
            const container = document.getElementById('contactsList');
            if (contacts.length === 0) {
                container.innerHTML = '<div style="padding:20px; text-align:center; color:#999;">No contacts found</div>';
                return;
            }
            container.innerHTML = contacts.map(c => `
                <div onclick="selectContact(${c.id})" style="padding:12px 16px; border-bottom:1px solid #eee; cursor:pointer; ${selectedContactId === c.id ? 'background:#f5f0e8;' : ''}" onmouseover="if(${selectedContactId !== c.id})this.style.background='#fafafa'" onmouseout="if(${selectedContactId !== c.id})this.style.background='#fff'">
                    <div style="font-weight:400;">${c.name}</div>
                    <div style="font-size:0.8rem; color:#666;">${c.company || ''} ${c.email ? (c.company ? 'â€¢ ' : '') + c.email : ''}</div>
                </div>
            `).join('');
        }

        function selectContact(contactId) {
            selectedContactId = contactId;
            loadContactsList(); // Re-render to show selection
        }

        function saveTeamMember() {
            if (teamModalTab === 'contacts') {
                // Adding from existing contact
                if (!selectedContactId) {
                    showToast('Please select a contact', 'warning');
                    return;
                }
                const allContacts = JSON.parse(localStorage.getItem('kgc_clients') || '[]');
                const contact = allContacts.find(c => c.id === selectedContactId);
                if (!contact) return;

                const member = {
                    id: Date.now(),
                    contactId: contact.id,
                    role: getSelectedRole('contact'),
                    name: contact.name,
                    phone: contact.phone,
                    email: contact.email,
                    company: contact.company,
                    instagram: contact.instagram,
                    website: contact.website
                };

                // Save to client's team
                const portalData = JSON.parse(localStorage.getItem('kgc_portal_' + clientId) || '{}');
                portalData.team = portalData.team || [];
                portalData.team.push(member);
                localStorage.setItem('kgc_portal_' + clientId, JSON.stringify(portalData));

                // Update the contact to be linked to this client
                const idx = allContacts.findIndex(c => c.id === selectedContactId);
                if (idx !== -1) {
                    allContacts[idx].linkedToClient = clientId;
                    allContacts[idx].role = member.role;
                    localStorage.setItem('kgc_clients', JSON.stringify(allContacts));
                }
            } else {
                // Adding new member
                const member = {
                    id: Date.now(),
                    role: getSelectedRole('new'),
                    name: document.getElementById('teamName').value,
                    phone: document.getElementById('teamPhone').value,
                    email: document.getElementById('teamEmail').value,
                    company: document.getElementById('teamCompany').value,
                    instagram: document.getElementById('teamInstagram').value,
                    website: document.getElementById('teamWebsite').value
                };

                if (!member.name) {
                    showToast('Please enter a name', 'warning');
                    return;
                }

                // Save to client's team
                const portalData = JSON.parse(localStorage.getItem('kgc_portal_' + clientId) || '{}');
                portalData.team = portalData.team || [];
                portalData.team.push(member);
                localStorage.setItem('kgc_portal_' + clientId, JSON.stringify(portalData));

                // Also add to All Contacts if checked
                if (document.getElementById('teamAddToContacts').checked) {
                    const clients = JSON.parse(localStorage.getItem('kgc_clients') || '[]');
                    clients.push({
                        id: member.id,
                        createdAt: new Date().toISOString(),
                        status: 'contact',
                        name: member.name,
                        phone: member.phone,
                        email: member.email,
                        company: member.company,
                        instagram: member.instagram,
                        website: member.website,
                        linkedToClient: clientId,
                        role: member.role
                    });
                    localStorage.setItem('kgc_clients', JSON.stringify(clients));
                }
            }

            loadTeam();
            closeTeamModal();
        }

        // Edit team member
        let editingTeamMemberId = null;

        function editTeamMember(memberId) {
            const portalData = JSON.parse(localStorage.getItem('kgc_portal_' + clientId) || '{}');
            const member = (portalData.team || []).find(m => m.id === memberId);
            if (!member) return;

            editingTeamMemberId = memberId;

            // Determine type based on existing role
            let type = 'Other';
            if (vendorRoles.includes(member.role)) {
                type = 'Vendor';
            } else if (familyRoles.includes(member.role)) {
                type = 'Family';
            }

            document.getElementById('editTeamType').value = type;
            updateRoleOptions('edit');

            if (type === 'Other') {
                document.getElementById('editTeamRoleCustom').value = member.role || '';
            } else {
                document.getElementById('editTeamRole').value = member.role || '';
            }

            document.getElementById('editTeamName').value = member.name || '';
            document.getElementById('editTeamPhone').value = member.phone || '';
            document.getElementById('editTeamEmail').value = member.email || '';
            document.getElementById('editTeamCompany').value = member.company || '';
            document.getElementById('editTeamInstagram').value = member.instagram || '';
            document.getElementById('editTeamWebsite').value = member.website || '';

            document.getElementById('editTeamModal').style.display = 'flex';
        }

        function closeEditTeamModal() {
            document.getElementById('editTeamModal').style.display = 'none';
            editingTeamMemberId = null;
        }

        function saveEditTeamMember() {
            if (!editingTeamMemberId) return;

            const portalData = JSON.parse(localStorage.getItem('kgc_portal_' + clientId) || '{}');
            const team = portalData.team || [];
            const idx = team.findIndex(m => m.id === editingTeamMemberId);
            if (idx === -1) return;

            const oldContactId = team[idx].contactId;

            team[idx].role = getSelectedRole('edit');
            team[idx].name = document.getElementById('editTeamName').value;
            team[idx].phone = document.getElementById('editTeamPhone').value;
            team[idx].email = document.getElementById('editTeamEmail').value;
            team[idx].company = document.getElementById('editTeamCompany').value;
            team[idx].instagram = document.getElementById('editTeamInstagram').value;
            team[idx].website = document.getElementById('editTeamWebsite').value;

            portalData.team = team;
            localStorage.setItem('kgc_portal_' + clientId, JSON.stringify(portalData));

            // Also update in All Contacts if linked
            if (oldContactId) {
                const clients = JSON.parse(localStorage.getItem('kgc_clients') || '[]');
                const cIdx = clients.findIndex(c => c.id === oldContactId);
                if (cIdx !== -1) {
                    clients[cIdx].name = team[idx].name;
                    clients[cIdx].phone = team[idx].phone;
                    clients[cIdx].email = team[idx].email;
                    clients[cIdx].company = team[idx].company;
                    clients[cIdx].instagram = team[idx].instagram;
                    clients[cIdx].website = team[idx].website;
                    clients[cIdx].role = team[idx].role;
                    localStorage.setItem('kgc_clients', JSON.stringify(clients));
                }
            }

            loadTeam();
            closeEditTeamModal();
        }

        // Communication Log functions
        const API_URL = 'https://sugar-backend-production.up.railway.app';
        let apiCommunications = []; // Cache for API communications

        // Auto-sync emails from Gmail in background (quiet, no UI)
        async function autoSyncEmails() {
            try {
                const response = await fetch(`${API_URL}/api/gmail/sync`, { method: 'POST' });
                if (response.ok) {
                    const result = await response.json();
                    if (result.matched > 0) {
                        console.log(`Auto-sync: ${result.matched} new emails matched to clients`);
                        await loadCommunicationsFromAPI();
                    }
                }
            } catch (err) {
                // Silent fail â€” auto-sync is best-effort
                console.log('Auto-sync skipped:', err.message);
            }
        }

        // Load communications from API
        async function loadCommunicationsFromAPI() {
            try {
                const response = await fetch(`${API_URL}/api/communications?client_id=${clientId}`);
                if (response.ok) {
                    apiCommunications = await response.json();
                    renderCommLog(); // Re-render with API data
                }
            } catch (err) {
                console.log('Could not load communications from API:', err.message);
            }
        }

        function getCommLog() {
            // Get old-style logs
            const oldLogs = JSON.parse(localStorage.getItem('kgc_comm_logs') || '{}');
            const oldEntries = (oldLogs[clientId] || []).map(e => ({
                ...e,
                source: 'log'
            }));

            // Get communications from API (or localStorage fallback)
            const comms = apiCommunications.length > 0
                ? apiCommunications
                : JSON.parse(localStorage.getItem('kgc_communications') || '[]');

            const clientComms = comms
                .filter(c => String(c.client_id || c.clientId) === String(clientId))
                .map(c => ({
                    type: c.type,
                    direction: c.direction,
                    title: c.subject || (c.type === 'email' ? 'Email' : c.type === 'text' ? 'Text Message' : c.type === 'call' ? 'Phone Call' : 'Note'),
                    message: c.message,
                    timestamp: c.created_at || c.timestamp,
                    source: 'comm'
                }));

            // Combine and sort by timestamp (newest first)
            const combined = [...oldEntries, ...clientComms];
            combined.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            return combined;
        }

        function addCommLogEntry(type, title) {
            const logs = JSON.parse(localStorage.getItem('kgc_comm_logs') || '{}');
            if (!logs[clientId]) logs[clientId] = [];

            logs[clientId].unshift({
                type: type,
                title: title,
                timestamp: new Date().toISOString()
            });

            localStorage.setItem('kgc_comm_logs', JSON.stringify(logs));
        }

        let commLogExpanded = false;
        const COMM_LOG_COLLAPSED_COUNT = 3;

        // Strip Gmail quoted reply header from message preview
        function stripQuotedReply(message) {
            if (!message) return '';
            // Remove "On [date] at [time] <email> wrote:" and everything after
            return message.replace(/\s*On\s+\w+,\s+\w+\s+\d+,\s+\d+\s+at\s+\d+:\d+\s*(AM|PM)?\s*<[^>]+>\s*wrote:[\s\S]*/i, '').trim();
        }

        // Store comm log entries for modal access
        let commLogEntries = [];

        function renderCommLog() {
            const container = document.getElementById('commLog');
            const log = getCommLog();
            commLogEntries = log; // Store for modal access

            if (log.length === 0) {
                container.innerHTML = '<div class="comm-log-empty">No activity logged yet</div>';
                return;
            }

            // Simple elegant icons (no color)
            const icons = {
                email: 'âœ‰',
                text: 'ðŸ—¨',
                call: 'â˜',
                note: 'â—‹',
                inquiry: 'â˜º',
                inquiry_received: 'â˜º'
            };

            // Show collapsed or expanded
            const displayLog = commLogExpanded ? log : log.slice(0, COMM_LOG_COLLAPSED_COUNT);
            const hiddenCount = log.length - COMM_LOG_COLLAPSED_COUNT;

            const itemsHtml = displayLog.map((entry, idx) => {
                let icon = icons[entry.type] || 'â€¢';

                // Email type always gets envelope icon
                if (entry.type === 'email') {
                    icon = 'âœ‰';
                }

                // Handle old-style entries
                if (entry.type && entry.type.includes('paid')) {
                    icon = 'âœ“';
                } else if (entry.type && entry.type.includes('signed')) {
                    icon = 'âœŽ';
                } else if (entry.type && entry.type.includes('sent')) {
                    icon = 'â†’';
                }

                const dateStr = formatShortDate(entry.timestamp);
                const hasFullMessage = entry.message && entry.message.length > 0;
                const cleanMessage = stripQuotedReply(entry.message || '');
                const oneLiner = cleanMessage ? cleanMessage.substring(0, 50).replace(/\n/g, ' ') + (cleanMessage.length > 50 ? '...' : '') : '';
                const entryId = entry.timestamp.replace(/[^0-9]/g, '');

                // For text/call, just show the message. For email, show To:/Reply: with client name then subject.
                let displayText = '';
                const clientName = window.currentClient?.name || 'Client';
                if (entry.type === 'email') {
                    const prefix = entry.direction === 'inbound' ? `<strong>Reply:</strong> ${clientName} â€” ` : `<strong>To:</strong> ${clientName} â€” `;
                    displayText = prefix + (entry.title || 'Email');
                    if (oneLiner) displayText += ' â€” ' + oneLiner;
                } else if (entry.channel === 'website' || entry.type === 'inquiry_received') {
                    // Website inquiry - show "Inquiry:" label with message
                    displayText = '<strong>Inquiry:</strong> ' + (oneLiner || entry.title || 'New inquiry');
                } else {
                    displayText = oneLiner || entry.title;
                }

                const isExpandable = hasFullMessage && entry.message.length > 50;
                const isEmail = entry.type === 'email';

                // Click handler: emails open view modal, others toggle expand
                const clickHandler = isEmail
                    ? `onclick="openEmailViewModalByIndex(${idx})"`
                    : (isExpandable ? `onclick="toggleCommEntry('${entryId}')"` : '');

                return `
                    <div class="comm-log-item ${isExpandable || isEmail ? 'expandable' : ''}" ${clickHandler}>
                        <div class="comm-log-icon">${icon}</div>
                        <div class="comm-log-date">${dateStr}</div>
                        <div class="comm-log-content">
                            <span class="comm-log-title">${displayText}</span>
                        </div>
                    </div>
                    ${!isEmail ? `<div class="comm-log-expanded-content" id="comm-${entryId}" style="display:none;">
                        <div class="comm-full-message">${(entry.message || '').replace(/\n/g, '<br>')}</div>
                    </div>` : ''}
                `;
            }).join('');

            // Add view more/less button if needed
            let viewMoreHtml = '';
            if (log.length > COMM_LOG_COLLAPSED_COUNT) {
                if (commLogExpanded) {
                    viewMoreHtml = `
                        <div class="comm-log-view-more">
                            <button onclick="toggleCommLog()">Show less</button>
                        </div>
                    `;
                } else {
                    viewMoreHtml = `
                        <div class="comm-log-view-more">
                            <button onclick="toggleCommLog()">View ${hiddenCount} more</button>
                        </div>
                    `;
                }
            }

            container.innerHTML = `
                <div class="${commLogExpanded ? 'comm-log-expanded' : ''}">
                    ${itemsHtml}
                </div>
                ${viewMoreHtml}
            `;
        }

        function toggleCommLog() {
            commLogExpanded = !commLogExpanded;
            renderCommLog();
        }

        function toggleCommEntry(entryId) {
            const el = document.getElementById('comm-' + entryId);
            if (el) {
                el.style.display = el.style.display === 'none' ? 'block' : 'none';
            }
        }

        function formatShortDate(isoString) {
            if (!isoString) return '';
            const d = new Date(isoString);
            const now = new Date();
            const isToday = d.toDateString() === now.toDateString();
            const time = d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });

            if (isToday) {
                return 'Today ' + time;
            }
            return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' ' + time;
        }

        // Quick Communication from Event Portal
        // Send email via Gmail API
        // Build branded HTML email matching Kenna's aesthetic
        function buildBrandedEmailHtml(bodyText) {
            const paragraphs = bodyText.split('\n\n').map(p =>
                '<p style="margin:0 0 16px 0; font-family:Arial,Helvetica,sans-serif; font-size:15px; line-height:1.7; color:#333333;">' +
                p.replace(/\n/g, '<br>') + '</p>'
            ).join('');

            return '<div style="background-color:#f5f3f0; padding:30px 20px;">' +
                '<table role="presentation" width="100%" cellpadding="0" cellspacing="0" style="max-width:600px; margin:0 auto; background-color:#ffffff;">' +
                '<!-- Gold accent bar -->' +
                '<tr><td style="height:4px; background-color:#b5956a;"></td></tr>' +
                '<!-- Logo -->' +
                '<tr><td align="center" style="padding:30px 40px 10px;">' +
                '<img src="https://portal.kennagiuziocake.com/images/logo.png" alt="Kenna Giuzio Cake" width="140" style="display:block;">' +
                '</td></tr>' +
                '<!-- Body -->' +
                '<tr><td style="padding:20px 40px 10px;">' +
                paragraphs +
                '</td></tr>' +
                '<!-- Divider -->' +
                '<tr><td style="padding:0 40px;"><hr style="border:none; border-top:1px solid #eeeeee; margin:0;"></td></tr>' +
                '<!-- Footer -->' +
                '<tr><td align="center" style="padding:24px 40px 30px;">' +
                '<p style="margin:0; font-family:Georgia,serif; font-size:13px; color:#999999; line-height:1.6;">' +
                'Kenna Giuzio Cake<br>' +
                '(206) 472-5401 &nbsp;|&nbsp; kenna@kennagiuziocake.com<br>' +
                'Queen Anne, Seattle' +
                '</p>' +
                '</td></tr>' +
                '</table>' +
                '</div>';
        }

        function toggleBrandedBodyEditor() {
            const editor = document.getElementById('brandedBodyEditor');
            editor.style.display = editor.style.display === 'none' ? 'block' : 'none';
        }

        function updateBrandedPreview() {
            const bodyText = document.getElementById('brandedBodyText').value;
            const html = buildBrandedEmailHtml(bodyText);
            document.getElementById('brandedPreviewFrame').innerHTML = html;
            // Also sync to replyMessage for send
            document.getElementById('replyMessage').value = bodyText;
        }

        async function sendEmailViaAPI(to, subject, message) {
            try {
                const response = await fetch(`${API_URL}/api/gmail/send`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        to: to,
                        subject: subject,
                        message: message,
                        client_id: clientId
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    showToast('Email sent!', 'success');
                    loadCommunicationsFromAPI();
                } else {
                    throw new Error(result.error || 'Failed to send');
                }
            } catch (err) {
                showToast('Error sending email: ' + err.message, 'error');
            }
        }

        // Reply modal state
        let currentReplyData = null;

        // Tasting date slots state (for tasting-options template)
        let tastingDateSlots = [];
        let currentSlotIndex = -1;

        function openReplyModal(originalSubject, originalMessage, prefilledBody, branded) {
            const client = window.currentClient;
            if (!client || !client.email) {
                showToast('No client email available', 'warning');
                return;
            }

            // If prefilledBody is provided, this is a compose (not reply)
            const isCompose = prefilledBody !== undefined;
            const subject = isCompose ? originalSubject : (originalSubject.startsWith('Re:') ? originalSubject : 'Re: ' + originalSubject);

            // Store data for sending
            currentReplyData = {
                to: client.email,
                subject: subject,
                clientName: client.name,
                branded: !!branded
            };

            // Update modal title and button
            document.getElementById('composeModalTitle').textContent = isCompose ? 'Compose Email' : 'Reply to Email';
            document.getElementById('composeSendBtn').textContent = isCompose ? 'Send Email' : 'Send Reply';

            // Populate fields
            document.getElementById('replyTo').textContent = `${client.name} <${client.email}>`;
            document.getElementById('replySubject').value = subject;
            document.getElementById('replyMessage').value = prefilledBody || '';

            // Reset send status
            document.getElementById('composeSendStatus').textContent = '';
            document.getElementById('composeSendBtn').disabled = false;
            document.getElementById('composeSendBtn').style.background = '#b5956a';

            // Toggle between branded preview and plain text compose
            if (branded) {
                document.getElementById('plainTextCompose').style.display = 'none';
                document.getElementById('brandedPreviewSection').style.display = 'block';
                document.getElementById('editBodyToggleBtn').style.display = 'inline-block';
                document.getElementById('brandedBodyEditor').style.display = 'none';
                document.getElementById('brandedBodyText').value = prefilledBody || '';

                // Build and show HTML preview
                const html = buildBrandedEmailHtml(prefilledBody || '');
                document.getElementById('brandedPreviewFrame').innerHTML = html;
            } else {
                document.getElementById('plainTextCompose').style.display = 'flex';
                document.getElementById('brandedPreviewSection').style.display = 'none';
                document.getElementById('editBodyToggleBtn').style.display = 'none';
                document.getElementById('brandedBodyEditor').style.display = 'none';

                // Hide/show original message section
                const originalSection = document.getElementById('originalMessageSection');
                if (isCompose) {
                    originalSection.style.display = 'none';
                } else {
                    originalSection.style.display = 'block';
                    document.getElementById('replyOriginal').textContent = originalMessage || '(No original message)';
                }
            }

            // Center modal position
            const modalInner = document.getElementById('composeModalInner');
            modalInner.style.position = 'absolute';
            modalInner.style.left = '50%';
            modalInner.style.top = '50%';
            modalInner.style.transform = 'translate(-50%, -50%)';
            modalInner.style.margin = '0';

            // Show modal and prevent body scroll
            const modal = document.getElementById('replyEmailModal');
            modal.style.display = 'flex';
            document.body.classList.add('modal-open');
        }

        function closeReplyModal() {
            document.getElementById('replyEmailModal').style.display = 'none';
            document.body.classList.remove('modal-open');
            currentReplyData = null;
            // Hide tasting date slots and reset modal size
            document.getElementById('tastingDateSlots').style.display = 'none';
            tastingDateSlots = [];
            currentSlotIndex = -1;
            // Reset branded preview state
            document.getElementById('brandedPreviewSection').style.display = 'none';
            document.getElementById('brandedBodyEditor').style.display = 'none';
            document.getElementById('editBodyToggleBtn').style.display = 'none';
            document.getElementById('plainTextCompose').style.display = 'flex';
            // Reset modal to default size
            const modal = document.getElementById('composeModalInner');
            modal.style.width = '720px';
            modal.style.height = '80vh';
        }

        // Make compose modal draggable with constraints
        (function() {
            const header = document.getElementById('composeModalHeader');
            const modal = document.getElementById('composeModalInner');
            let isDragging = false;
            let startX, startY, startLeft, startTop;

            header.addEventListener('mousedown', function(e) {
                if (e.target.tagName === 'BUTTON') return;
                isDragging = true;

                // Get current position
                const rect = modal.getBoundingClientRect();
                startX = e.clientX;
                startY = e.clientY;
                startLeft = rect.left;
                startTop = rect.top;

                // Switch to absolute positioning
                modal.style.position = 'fixed';
                modal.style.left = startLeft + 'px';
                modal.style.top = startTop + 'px';
                modal.style.transform = 'none';
                modal.style.margin = '0';

                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });

            function onMouseMove(e) {
                if (!isDragging) return;
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;

                let newLeft = startLeft + dx;
                let newTop = startTop + dy;

                // Keep modal within viewport bounds
                const rect = modal.getBoundingClientRect();
                const minTop = 10;
                const minLeft = -rect.width + 100;
                const maxLeft = window.innerWidth - 100;
                const maxTop = window.innerHeight - 50;

                newTop = Math.max(minTop, Math.min(maxTop, newTop));
                newLeft = Math.max(minLeft, Math.min(maxLeft, newLeft));

                modal.style.left = newLeft + 'px';
                modal.style.top = newTop + 'px';
            }

            function onMouseUp() {
                isDragging = false;
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            }
        })();

        async function sendReplyEmail() {
            if (!currentReplyData) return;

            // Get message from the right source based on mode
            const isBranded = currentReplyData.branded;
            const message = isBranded
                ? document.getElementById('brandedBodyText').value.trim()
                : document.getElementById('replyMessage').value.trim();

            if (!message) {
                showToast('Please enter a message', 'warning');
                return;
            }

            const subject = document.getElementById('replySubject').value.trim();
            const btn = document.getElementById('composeSendBtn');
            const status = document.getElementById('composeSendStatus');

            btn.disabled = true;
            btn.textContent = 'Sending...';

            try {
                const payload = {
                    to: currentReplyData.to,
                    subject: subject,
                    message: message,
                    client_id: clientId
                };

                // Include branded HTML if in branded mode
                if (isBranded) {
                    payload.html = buildBrandedEmailHtml(message);
                }

                const response = await fetch(`${API_URL}/api/gmail/send`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (response.ok) {
                    status.style.color = '#5a6b52';
                    status.textContent = 'Sent successfully!';
                    btn.textContent = 'Sent';
                    btn.style.background = '#5a6b52';

                    // Log to localStorage for immediate display
                    const logs = JSON.parse(localStorage.getItem('kgc_comm_logs') || '{}');
                    const cid = String(clientId);
                    if (!logs[cid]) logs[cid] = [];
                    logs[cid].unshift({
                        type: 'email',
                        title: subject,
                        message: message,
                        timestamp: new Date().toISOString(),
                        _localOnly: true
                    });
                    localStorage.setItem('kgc_comm_logs', JSON.stringify(logs));

                    setTimeout(async () => {
                        closeReplyModal();
                        await loadCommunicationsFromAPI();
                        // Remove _localOnly entries that now exist in API data
                        const freshLogs = JSON.parse(localStorage.getItem('kgc_comm_logs') || '{}');
                        if (freshLogs[cid]) {
                            freshLogs[cid] = freshLogs[cid].filter(e => !e._localOnly || e.type !== 'email');
                            localStorage.setItem('kgc_comm_logs', JSON.stringify(freshLogs));
                        }
                        renderCommLog();
                    }, 1500);
                } else {
                    throw new Error(result.error || 'Failed to send');
                }
            } catch (err) {
                status.style.color = '#c44';
                status.textContent = 'Error: ' + err.message;
                btn.disabled = false;
                btn.textContent = 'Retry Send';
                btn.style.background = '#b5956a';
            }
        }

        // Reply to email from communication log
        function replyToCommEmail(entryId, originalSubject, originalMessage) {
            openReplyModal(originalSubject, originalMessage);
        }

        // Email view modal state
        let currentEmailView = null;

        function openEmailViewModalByIndex(idx) {
            const entry = commLogEntries[idx];
            if (entry) openEmailViewModal(entry);
        }

        // Strip quoted reply and signature from email for clean display
        function getCleanEmailBody(message) {
            if (!message) return '(No message)';
            // Remove "On ... wrote:" and everything after
            let clean = message.replace(/\s*On\s+\w+,\s+\w+\s+\d+,\s+\d+\s+at\s+\d+:\d+\s*(AM|PM)?\s*[^>]*>?\s*wrote:[\s\S]*/i, '').trim();
            // Remove email signature (-- followed by content)
            clean = clean.replace(/\n--\s*\n[\s\S]*$/m, '').trim();
            return clean || '(No message)';
        }

        // Get base subject (without Re:, Fwd:, etc.)
        function getBaseSubject(subject) {
            return (subject || '').replace(/^(Re:\s*|Fwd:\s*|Fw:\s*)+/i, '').trim().toLowerCase();
        }

        function openEmailViewModal(entry) {
            const client = window.currentClient;
            currentEmailView = {
                subject: entry.title || 'Email',
                message: entry.message || ''
            };

            const contactName = client?.name || 'Client';

            // Get emails in same thread (same base subject)
            const baseSubject = getBaseSubject(entry.title);
            const threadEmails = commLogEntries
                .filter(e => e.type === 'email' && getBaseSubject(e.title) === baseSubject)
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); // Newest first

            document.getElementById('emailViewTitle').textContent = entry.title || 'Email';

            // Build thread HTML
            const threadHtml = threadEmails.map(email => {
                const isOutbound = email.direction !== 'inbound';
                const dateStr = new Date(email.timestamp).toLocaleString('en-US', {
                    weekday: 'short', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit'
                });
                const isCurrent = email.timestamp === entry.timestamp;
                const cleanMessage = getCleanEmailBody(email.message);
                // Show who wrote it: Kenna for outbound, client name for inbound
                const fromName = isOutbound ? 'Kenna' : contactName;

                return `
                    <div class="email-thread-item" style="margin-bottom:16px; padding:14px; border-radius:8px; background:${isCurrent ? '#faf5ef' : '#f9f9f9'}; border-left:3px solid ${isOutbound ? '#b5956a' : '#7aa37a'};" data-current="${isCurrent}">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                            <div>
                                <strong style="color:${isOutbound ? '#b5956a' : '#7aa37a'};">From:</strong>
                                <span style="color:#333;">${fromName}</span>
                            </div>
                            <span style="font-size:0.75rem; color:#999;">${dateStr}</span>
                        </div>
                        <div style="font-size:0.75rem; color:#666; margin-bottom:8px;">${(email.title || '(No subject)').replace(/</g, '&lt;')}</div>
                        <div style="color:#444; line-height:1.5; white-space:pre-wrap; font-size:0.85rem;">${cleanMessage.replace(/</g, '&lt;')}</div>
                    </div>
                `;
            }).join('');

            document.getElementById('emailViewBody').innerHTML = threadHtml || '<p style="color:#999;">No emails found</p>';
            document.getElementById('emailViewModal').style.display = 'flex';

            // Scroll to current email
            setTimeout(() => {
                const currentEmail = document.querySelector('.email-thread-item[data-current="true"]');
                if (currentEmail) currentEmail.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
        }

        function closeEmailViewModal() {
            document.getElementById('emailViewModal').style.display = 'none';
            currentEmailView = null;
        }

        function replyFromViewModal() {
            if (!currentEmailView) return;
            closeEmailViewModal();
            openReplyModal(currentEmailView.subject, currentEmailView.message);
        }

        function openQuickComm(type) {
            const client = window.currentClient;
            if (!client) {
                showToast('No client loaded', 'warning');
                return;
            }

            if (type === 'email') {
                // Open compose prompt for email
                const subject = prompt(`Email to: ${client.name}\n\nSubject:`);
                if (!subject) return;

                const message = prompt('Message:');
                if (!message) return;

                // Send via Gmail API
                sendEmailViaAPI(client.email, subject, message.trim());
                return;
            } else {
                // Show quick log modal
                const typeLabel = type === 'text' ? 'Text' : 'Call';
                const note = prompt(`Log ${typeLabel}\n\nBrief note:`);

                if (note && note.trim()) {
                    // Save to communications
                    const comms = JSON.parse(localStorage.getItem('kgc_communications') || '[]');
                    comms.push({
                        id: Date.now().toString(),
                        type: type,
                        clientId: clientId,
                        clientName: client.name,
                        clientEmail: client.email || '',
                        subject: typeLabel,
                        message: note.trim(),
                        category: 'general',
                        timestamp: new Date().toISOString()
                    });
                    localStorage.setItem('kgc_communications', JSON.stringify(comms));

                    // Refresh the log
                    renderCommLog();
                }
            }
        }

        // Template Modal Functions
        function openTemplateModal() {
            const container = document.getElementById('templateList');
            container.innerHTML = emailTemplates.map(t => `
                <div onclick="selectTemplate('${t.id}')" style="padding:14px 16px; border:1px solid #eee; cursor:pointer; transition:all 0.2s;" onmouseover="this.style.background='#f5f0e8';this.style.borderColor='#b5956a'" onmouseout="this.style.background='#fff';this.style.borderColor='#eee'">
                    <div style="font-weight:400; margin-bottom:4px;">${t.name}</div>
                    <div style="font-size:0.8rem; color:#888;">${t.description}</div>
                </div>
            `).join('');
            document.getElementById('templateModal').style.display = 'flex';
        }

        function closeTemplateModal() {
            document.getElementById('templateModal').style.display = 'none';
        }

        async function selectTemplate(templateId) {
            // Check for custom template saved from Templates page (DB first, then localStorage)
            let template = emailTemplates.find(t => t.id === templateId);
            if (!template) return;

            let custom = {};
            try {
                const res = await fetch(`${API_BASE_URL}/api/settings/email_templates`);
                if (res.ok) {
                    const data = await res.json();
                    if (data.value && typeof data.value === 'object') custom = data.value;
                }
            } catch (e) {
                try { custom = JSON.parse(localStorage.getItem('kgc_email_templates') || '{}'); } catch (e2) {}
            }
            if (custom[templateId]) {
                template = { ...template, ...custom[templateId] };
            }

            const client = window.currentClient;
            if (!client) {
                showToast('No client loaded', 'warning');
                return;
            }

            // Replace placeholders with client data â€” handle couples: "Sophia & Emma Williams" â†’ "Sophia & Emma"
            let firstName = 'there';
            if (client.name) {
                const name = client.name.trim();
                if (name.includes(' & ')) {
                    const parts = name.split(' ');
                    parts.pop();
                    firstName = parts.join(' ');
                } else {
                    firstName = name.split(' ')[0];
                }
            }
            const eventType = client.eventType || 'event';
            const eventDate = client.eventDate ? formatDate(client.eventDate) : '[EVENT DATE]';
            const venue = client.venue || '[VENUE]';

            // Calculate balance due date (2 weeks before event)
            let balanceDueDate = '[DUE DATE]';
            if (client.eventDate) {
                const cleanDate = String(client.eventDate).split('T')[0];
                const ed = new Date(cleanDate + 'T00:00:00');
                ed.setDate(ed.getDate() - 14);
                balanceDueDate = ed.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
            }

            // Get tasting info if available
            const portalData = JSON.parse(localStorage.getItem('kgc_portal_' + clientId) || '{}');
            const tastingDate = portalData.tastingDate ? formatDate(portalData.tastingDate) : '[TASTING DATE]';
            const tastingTime = portalData.tastingTime ? formatTime(portalData.tastingTime) : '[TASTING TIME]';

            // Balance amount placeholder
            const balanceAmount = '[BALANCE AMOUNT]';

            // Replace all placeholders
            let subject = template.subject
                .replace(/{firstName}/g, firstName)
                .replace(/{eventType}/g, eventType)
                .replace(/{eventDate}/g, eventDate)
                .replace(/{tastingDate}/g, tastingDate);

            let body = template.body
                .replace(/{firstName}/g, firstName)
                .replace(/{eventType}/g, eventType)
                .replace(/{eventDate}/g, eventDate)
                .replace(/{venue}/g, venue)
                .replace(/{balanceDueDate}/g, balanceDueDate)
                .replace(/{balanceAmount}/g, balanceAmount)
                .replace(/{tastingDate}/g, tastingDate)
                .replace(/{tastingTime}/g, tastingTime);

            closeTemplateModal();

            // Open reply modal with branded HTML preview
            openReplyModal(subject, '', body, true);

            // If tasting-options template, also show date picker sidebar
            if (templateId === 'tasting-options') {
                setTimeout(() => {
                    initTastingDateSlots();
                }, 100);
            }
        }

        // Tasting calendar state
        let tastingCalendarMonth = new Date().getMonth();
        let tastingCalendarYear = new Date().getFullYear();
        let tastingCalendarSelectedDate = null;

        async function initTastingDateSlots() {
            // Fetch all clients from API so calendar shows all events/tastings
            await loadAllClientsForCalendar();

            // Show the date slots sidebar
            document.getElementById('tastingDateSlots').style.display = 'block';

            // Initialize with 1 empty slot (Kenna can add more with the + button)
            tastingDateSlots = [
                { date: null, time: null, label: 'DATE' }
            ];

            renderTastingDateSlots();
        }

        function renderTastingDateSlots() {
            const container = document.getElementById('dateSlotsList');
            container.innerHTML = tastingDateSlots.map((slot, index) => {
                const isSelected = slot.date !== null;

                // Compact date display for side panel
                let dateDisplay = 'Select...';
                if (slot.date && slot.time) {
                    const d = new Date(slot.date + 'T00:00:00');
                    const month = d.toLocaleDateString('en-US', { month: 'short' });
                    const day = d.getDate();
                    const [hours, minutes] = slot.time.split(':');
                    const h = parseInt(hours);
                    const ampm = h >= 12 ? 'p' : 'a';
                    const hour12 = h % 12 || 12;
                    dateDisplay = `${month} ${day}, ${hour12}${ampm}`;
                }

                return `
                    <div style="position:relative;">
                        <div onclick="openTastingDatePicker(${index})" style="padding:8px 10px; background:${isSelected ? '#fff' : '#f5f5f5'}; border:1px solid ${isSelected ? '#b5956a' : '#e0d8cc'}; border-radius:4px; cursor:pointer; font-family:'Montserrat',sans-serif; transition:all 0.2s;" onmouseover="this.style.borderColor='#b5956a';this.style.background='#fff'" onmouseout="this.style.borderColor='${isSelected ? '#b5956a' : '#e0d8cc'}';this.style.background='${isSelected ? '#fff' : '#f5f5f5'}'">
                            ${tastingDateSlots.length > 1 ? `<div style="font-size:0.6rem; text-transform:uppercase; letter-spacing:0.5px; color:#999; margin-bottom:2px;">${slot.label}</div>` : ''}
                            <div style="font-size:0.75rem; color:${isSelected ? '#333' : '#aaa'}; font-weight:${isSelected ? '500' : '400'};">${dateDisplay}</div>
                        </div>
                        ${tastingDateSlots.length > 1 ? `<button onclick="event.stopPropagation(); removeTastingDateSlot(${index})" style="position:absolute; top:4px; right:4px; width:14px; height:14px; padding:0; background:#fff; border:1px solid #ddd; border-radius:50%; cursor:pointer; color:#999; font-size:0.6rem; line-height:12px; text-align:center;" title="Remove">&times;</button>` : ''}
                    </div>
                `;
            }).join('');
        }

        function openTastingDatePicker(index) {
            currentSlotIndex = index;

            // If this slot already has a date, use it to set the calendar month
            if (tastingDateSlots[index].date) {
                const d = new Date(tastingDateSlots[index].date + 'T00:00:00');
                tastingCalendarMonth = d.getMonth();
                tastingCalendarYear = d.getFullYear();
                tastingCalendarSelectedDate = tastingDateSlots[index].date;
                // Pre-select the time
                document.getElementById('tastingTimePicker').value = tastingDateSlots[index].time || '';
                document.getElementById('tastingEndTimePicker').value = tastingDateSlots[index].endTime || '';
            } else {
                const now = new Date();
                tastingCalendarMonth = now.getMonth();
                tastingCalendarYear = now.getFullYear();
                tastingCalendarSelectedDate = null;
                document.getElementById('tastingTimePicker').value = '14:00'; // Default 2pm
                document.getElementById('tastingEndTimePicker').value = '15:00'; // Default 3pm (1hr later)
            }

            renderTastingCalendar();
            document.getElementById('tastingCalendarPopup').classList.add('active');
        }

        function closeTastingCalendarPopup() {
            document.getElementById('tastingCalendarPopup').classList.remove('active');
            currentSlotIndex = -1;
        }

        function changeTastingMonth(delta) {
            tastingCalendarMonth += delta;
            if (tastingCalendarMonth > 11) {
                tastingCalendarMonth = 0;
                tastingCalendarYear++;
            } else if (tastingCalendarMonth < 0) {
                tastingCalendarMonth = 11;
                tastingCalendarYear--;
            }
            renderTastingCalendar();
        }

        // Cache for API-fetched data (loaded once when tasting calendar opens)
        let cachedAllClients = null;
        let cachedCalendarEvents = null;

        async function loadAllClientsForCalendar() {
            if (cachedAllClients) return;
            try {
                const [clientsResp, eventsResp] = await Promise.all([
                    fetch(API_BASE_URL + '/api/clients'),
                    fetch(API_BASE_URL + '/api/events').catch(() => null)
                ]);
                if (clientsResp.ok) cachedAllClients = await clientsResp.json();
                if (eventsResp && eventsResp.ok) cachedCalendarEvents = await eventsResp.json();
            } catch (e) {
                console.log('Could not fetch data for calendar:', e.message);
            }
        }

        function getEventsForMonth(year, month) {
            const events = [];
            const monthStart = new Date(year, month, 1);
            const monthEnd = new Date(year, month + 1, 0);

            // Helper: check if a date string falls in this month
            function inMonth(dateStr) {
                if (!dateStr) return false;
                const d = new Date(String(dateStr).split('T')[0] + 'T00:00:00');
                return d.getFullYear() === year && d.getMonth() === month;
            }

            // Helper: expand multi-day events into individual day entries for this month
            function expandEvent(startDate, endDate, name, type) {
                const start = new Date(String(startDate).split('T')[0] + 'T00:00:00');
                const end = endDate ? new Date(String(endDate).split('T')[0] + 'T00:00:00') : start;
                const cursor = new Date(Math.max(start.getTime(), monthStart.getTime()));
                const limit = new Date(Math.min(end.getTime(), monthEnd.getTime()));
                const isMultiDay = end.getTime() > start.getTime();
                while (cursor <= limit) {
                    const dateStr = cursor.toISOString().split('T')[0];
                    let spanPos = 'single';
                    if (isMultiDay) {
                        const isFirst = cursor.getTime() === start.getTime();
                        const isLast = cursor.getTime() === end.getTime();
                        if (isFirst) spanPos = 'span-start';
                        else if (isLast) spanPos = 'span-end';
                        else spanPos = 'span-mid';
                    }
                    events.push({ date: dateStr, type, name, eventType: type, spanPos });
                    cursor.setDate(cursor.getDate() + 1);
                }
            }

            // 1. Clients from API â€” event dates, tasting dates, inquiry dates
            const apiClients = cachedAllClients || [];
            const localClients = JSON.parse(localStorage.getItem('kgc_clients') || '[]');
            const clientMap = {};
            localClients.forEach(c => { clientMap[c.id || c.name] = c; });
            apiClients.forEach(c => {
                clientMap[c.id || c.name] = {
                    id: c.id, name: c.name,
                    eventDate: c.event_date || c.eventDate,
                    eventType: c.event_type || c.eventType,
                    tastingDate: c.tasting_date || c.tastingDate,
                    createdAt: c.created_at || c.createdAt
                };
            });

            Object.values(clientMap).forEach(client => {
                if (client.eventDate && inMonth(client.eventDate)) {
                    events.push({ date: String(client.eventDate).split('T')[0], type: 'event', name: client.name });
                }
                if (client.tastingDate && inMonth(client.tastingDate)) {
                    events.push({ date: String(client.tastingDate).split('T')[0], type: 'tasting', name: client.name });
                }
                if (client.createdAt) {
                    const d = new Date(client.createdAt);
                    const dateStr = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
                    if (inMonth(dateStr)) {
                        const lastName = client.name.split(' ').pop();
                        events.push({ date: dateStr, type: 'event', name: lastName + ' Inquiry' });
                    }
                }
            });

            // 2. Custom calendar events from localStorage (includes multi-day)
            const customEvents = JSON.parse(localStorage.getItem('kgc_calendar_events') || '[]');
            customEvents.forEach(evt => {
                const startDate = evt.date || evt.eventDate;
                if (!startDate) return;
                const endDate = evt.endDate || evt.eventEndDate;
                const evtType = (evt.type || evt.eventType || 'custom').toLowerCase();
                const mappedType = evtType === 'tasting' ? 'tasting' : evtType === 'personal' ? 'personal' : 'event';
                const name = evt.title || evt.name || 'Event';

                if (endDate) {
                    expandEvent(startDate, endDate, name, mappedType);
                } else if (inMonth(startDate)) {
                    events.push({ date: String(startDate).split('T')[0], type: mappedType, name });
                }
            });

            // 3. Imported calendars (includes multi-day)
            const importedCalendars = JSON.parse(localStorage.getItem('kgc_imported_calendars') || '[]');
            importedCalendars.forEach(cal => {
                if (!cal.enabled) return;
                cal.events.forEach(evt => {
                    if (!evt.date) return;
                    if (evt.endDate) {
                        expandEvent(evt.date, evt.endDate, evt.name || 'Personal', 'personal');
                    } else if (inMonth(evt.date)) {
                        events.push({ date: String(evt.date).split('T')[0], type: 'personal', name: evt.name || 'Personal' });
                    }
                });
            });

            // 4. API calendar events (prep events, server-created)
            if (cachedCalendarEvents) {
                cachedCalendarEvents.forEach(evt => {
                    const startDate = evt.event_date || evt.date;
                    if (!startDate) return;
                    const endDate = evt.event_end_date || evt.endDate;
                    const evtType = (evt.event_type || evt.type || 'custom').toLowerCase();
                    const mappedType = evtType === 'tasting' ? 'tasting' : evtType === 'personal' ? 'personal' : 'event';
                    const name = evt.title || evt.name || 'Event';

                    if (endDate) {
                        expandEvent(startDate, endDate, name, mappedType);
                    } else if (inMonth(startDate)) {
                        events.push({ date: String(startDate).split('T')[0], type: mappedType, name });
                    }
                });
            }

            return events;
        }

        function renderTastingCalendar() {
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                               'July', 'August', 'September', 'October', 'November', 'December'];

            document.getElementById('tastingCalendarMonthYear').textContent =
                monthNames[tastingCalendarMonth] + ' ' + tastingCalendarYear;

            const events = getEventsForMonth(tastingCalendarYear, tastingCalendarMonth);

            // Group events by date
            const eventsByDate = {};
            events.forEach(e => {
                if (!eventsByDate[e.date]) eventsByDate[e.date] = [];
                eventsByDate[e.date].push(e);
            });

            const firstDay = new Date(tastingCalendarYear, tastingCalendarMonth, 1);
            const lastDay = new Date(tastingCalendarYear, tastingCalendarMonth + 1, 0);
            const startDayOfWeek = firstDay.getDay();
            const daysInMonth = lastDay.getDate();

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            let html = '';

            // Previous month's trailing days
            const prevMonth = new Date(tastingCalendarYear, tastingCalendarMonth, 0);
            const prevMonthDays = prevMonth.getDate();
            for (let i = startDayOfWeek - 1; i >= 0; i--) {
                const day = prevMonthDays - i;
                html += `<div class="calendar-day other-month"><span class="day-number">${day}</span></div>`;
            }

            // Current month days
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${tastingCalendarYear}-${String(tastingCalendarMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const date = new Date(tastingCalendarYear, tastingCalendarMonth, day);
                const dayEvents = eventsByDate[dateStr] || [];

                let classes = 'calendar-day';
                if (date < today) classes += ' past';
                if (date.getTime() === today.getTime()) classes += ' today';
                if (dateStr === tastingCalendarSelectedDate) classes += ' selected';

                // Build events HTML
                let eventsHtml = '<div class="day-events">';
                const maxDisplay = 2;
                dayEvents.slice(0, maxDisplay).forEach(e => {
                    const pos = e.spanPos || 'single';
                    const showName = pos === 'single' || pos === 'span-start';
                    const shortName = showName ? (e.name.length > 12 ? e.name.substring(0, 10) + '...' : e.name) : '';
                    eventsHtml += `<div class="day-event ${e.type} ${pos}" title="${e.name}">${shortName}</div>`;
                });
                if (dayEvents.length > maxDisplay) {
                    eventsHtml += `<div class="day-event-more">+${dayEvents.length - maxDisplay} more</div>`;
                }
                eventsHtml += '</div>';

                const clickable = date >= today;
                html += `<div class="${classes}" ${clickable ? `onclick="selectTastingCalendarDate('${dateStr}')"` : ''}>
                    <span class="day-number">${day}</span>
                    ${eventsHtml}
                </div>`;
            }

            // Next month's leading days
            const totalCells = startDayOfWeek + daysInMonth;
            const remainingCells = (7 - (totalCells % 7)) % 7;
            for (let i = 1; i <= remainingCells; i++) {
                html += `<div class="calendar-day other-month"><span class="day-number">${i}</span></div>`;
            }

            document.getElementById('tastingCalendarDays').innerHTML = html;
        }

        function selectTastingCalendarDate(dateStr) {
            tastingCalendarSelectedDate = dateStr;
            renderTastingCalendar();
        }

        function confirmTastingDateTime() {
            if (!tastingCalendarSelectedDate) {
                showToast('Please select a date first', 'warning');
                return;
            }

            const time = document.getElementById('tastingTimePicker').value;
            if (!time) {
                showToast('Please select a time', 'warning');
                return;
            }

            const endTime = document.getElementById('tastingEndTimePicker').value;

            // Save to the slot
            tastingDateSlots[currentSlotIndex].date = tastingCalendarSelectedDate;
            tastingDateSlots[currentSlotIndex].time = time;
            tastingDateSlots[currentSlotIndex].endTime = endTime || null;

            // Immediately save first slot to tasting drafts so it appears on the calendar
            if (currentSlotIndex === 0) {
                const cid = clientId;
                const tastingDrafts = JSON.parse(localStorage.getItem('kgc_tasting_drafts') || '{}');
                if (!tastingDrafts[cid]) tastingDrafts[cid] = {};
                tastingDrafts[cid].tastingDate = tastingCalendarSelectedDate;
                tastingDrafts[cid].tastingTime = time;
                tastingDrafts[cid].tastingEndTime = endTime || null;
                localStorage.setItem('kgc_tasting_drafts', JSON.stringify(tastingDrafts));

                // Update the display in the left panel
                document.getElementById('tastingDate').textContent = formatDate(tastingCalendarSelectedDate);
                let timeDisplay = formatTime(time);
                if (endTime) timeDisplay += ' - ' + formatTime(endTime);
                document.getElementById('tastingTime').textContent = timeDisplay;
            }

            renderTastingDateSlots();
            updateEmailBodyWithDates();
            closeTastingCalendarPopup();
        }

        function autoSetTastingEndTime() {
            const startVal = document.getElementById('tastingTimePicker').value;
            const endEl = document.getElementById('tastingEndTimePicker');
            if (!startVal) { endEl.value = ''; return; }
            const [h, m] = startVal.split(':').map(Number);
            const endStr = String(h + 1).padStart(2, '0') + ':' + String(m).padStart(2, '0');
            const option = endEl.querySelector(`option[value="${endStr}"]`);
            endEl.value = option ? endStr : '';
        }

        function relabelTastingSlots() {
            if (tastingDateSlots.length === 1) {
                tastingDateSlots[0].label = 'DATE';
            } else {
                tastingDateSlots.forEach((slot, i) => {
                    slot.label = `Option ${i + 1}`;
                });
            }
        }

        function addTastingDateSlot() {
            tastingDateSlots.push({ date: null, time: null, label: '' });
            relabelTastingSlots();
            // When going from 1â†’2 options, also update the intro text in the email body
            if (tastingDateSlots.length === 2) {
                updateIntroTextForMultipleOptions();
            }
            renderTastingDateSlots();
            updateEmailBodyWithDates();
        }

        function removeTastingDateSlot(index) {
            tastingDateSlots.splice(index, 1);
            relabelTastingSlots();
            // When going from 2â†’1 option, update intro text back to singular
            if (tastingDateSlots.length === 1) {
                updateIntroTextForSingleOption();
            }
            renderTastingDateSlots();
            updateEmailBodyWithDates();
        }

        function updateIntroTextForMultipleOptions() {
            const singleIntro = /Here is a date and time that works for me:/;
            const multiIntro = 'Here are a few dates and times that work for me:';
            const singleOutro = /Please let me know if this works for you/;
            const multiOutro = 'Please let me know which option works best for you';

            [document.getElementById('replyMessage'), document.getElementById('brandedBodyText')].forEach(el => {
                if (!el) return;
                el.value = el.value.replace(singleIntro, multiIntro).replace(singleOutro, multiOutro);
            });
        }

        function updateIntroTextForSingleOption() {
            const multiIntro = /Here are a few dates and times that work for me:/;
            const singleIntro = 'Here is a date and time that works for me:';
            const multiOutro = /Please let me know which option works best for you/;
            const singleOutro = 'Please let me know if this works for you';

            [document.getElementById('replyMessage'), document.getElementById('brandedBodyText')].forEach(el => {
                if (!el) return;
                el.value = el.value.replace(multiIntro, singleIntro).replace(multiOutro, singleOutro);
            });
        }

        function formatTastingDateTime(dateStr, timeStr) {
            const date = new Date(dateStr + 'T00:00:00');
            const formattedDate = date.toLocaleDateString('en-US', {
                weekday: 'long',
                month: 'long',
                day: 'numeric',
                year: 'numeric'
            });

            // Format time
            const [hours, minutes] = timeStr.split(':');
            const h = parseInt(hours);
            const ampm = h >= 12 ? 'PM' : 'AM';
            const hour12 = h % 12 || 12;
            const formattedTime = `${hour12}:${minutes} ${ampm}`;

            return `${formattedDate} at ${formattedTime}`;
        }

        function updateEmailBodyWithDates() {
            // Build the new options section â€” different format for 1 vs multiple
            let optionsText;
            if (tastingDateSlots.length === 1) {
                const slot = tastingDateSlots[0];
                optionsText = slot.date && slot.time
                    ? formatTastingDateTime(slot.date, slot.time)
                    : '[Click to select date/time]';
            } else {
                optionsText = tastingDateSlots.map(slot => {
                    const dateDisplay = slot.date && slot.time
                        ? formatTastingDateTime(slot.date, slot.time)
                        : '[Click to select date/time]';
                    return `${slot.label}: ${dateDisplay}`;
                }).join('\n');
            }

            // Match either single date line or "Option 1:" multi-line block before "Tastings typically"
            const optionsRegex = /(?:Option \d+:.*?\n)*(?:Option \d+:.*?|(?:Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday),.*?|\[Click to select date\/time\])(?=\n\nTastings typically)/si;

            // Update plain text textarea
            const textarea = document.getElementById('replyMessage');
            const body = textarea.value;
            if (optionsRegex.test(body)) {
                textarea.value = body.replace(optionsRegex, optionsText);
            }

            // Also update branded body text + preview if in branded mode
            if (currentReplyData && currentReplyData.branded) {
                const brandedTextarea = document.getElementById('brandedBodyText');
                const brandedBody = brandedTextarea.value;
                if (optionsRegex.test(brandedBody)) {
                    brandedTextarea.value = brandedBody.replace(optionsRegex, optionsText);
                }
                // Rebuild branded preview
                const html = buildBrandedEmailHtml(brandedTextarea.value);
                document.getElementById('brandedPreviewFrame').innerHTML = html;
            }
        }

        function formatDateTime(isoString) {
            if (!isoString) return '';
            const d = new Date(isoString);
            return d.toLocaleDateString('en-US', {
                month: 'short', day: 'numeric', year: 'numeric',
                hour: 'numeric', minute: '2-digit'
            });
        }

        function loadTeam() {
            const client = window.currentClient;
            const portalData = JSON.parse(localStorage.getItem('kgc_portal_' + clientId) || '{}');
            const team = portalData.team || [];

            // Render primary contact
            const primaryContainer = document.getElementById('primaryContact');
            if (client) {
                primaryContainer.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center; padding:16px 20px; background:#f5f0e8; border:1px solid #d4c4a8; border-left:3px solid #b5956a; cursor:pointer; transition:background 0.2s;" onclick="editPrimaryContact()" onmouseover="this.style.background='#efe5d5'" onmouseout="this.style.background='#f5f0e8'">
                        <div>
                            <div style="font-weight:400;">${client.name}</div>
                            <div style="font-size:0.8rem; color:#b5956a;">Primary Contact${portalData.primaryRole ? ' â€” ' + portalData.primaryRole : ''}</div>
                            <div style="font-size:0.8rem; color:#666; margin-top:4px;">
                                ${client.email ? `<span style="color:#666;">${client.email}</span>` : ''}
                                ${client.email && client.phone ? ' &bull; ' : ''}
                                ${client.phone || ''}
                            </div>
                        </div>
                        <div style="display:flex; gap:8px; align-items:center;">
                            <button onclick="event.stopPropagation(); openSwitchPrimaryModal()" style="padding:6px 12px; background:#fff; border:1px solid #d4c4a8; font-family:'Montserrat',sans-serif; font-size:0.7rem; color:#666; cursor:pointer;" onmouseover="this.style.borderColor='#b5956a';this.style.color='#b5956a'" onmouseout="this.style.borderColor='#d4c4a8';this.style.color='#666'">Switch</button>
                        </div>
                    </div>
                `;
            }

            // Render team members
            const container = document.getElementById('teamList');
            if (team.length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = team.map((member, index) => `
                <div class="team-member-row" draggable="true" data-index="${index}" data-id="${member.id}" style="display:flex; justify-content:space-between; align-items:center; padding:16px 20px; background:#fafafa; border:1px solid #eee; margin-bottom:10px; cursor:grab; transition:all 0.2s;" onclick="editTeamMember(${member.id})" onmouseover="if(!this.classList.contains('dragging'))this.style.background='#f0f0f0'" onmouseout="if(!this.classList.contains('dragging'))this.style.background='#fafafa'">
                    <div style="display:flex; align-items:center; gap:12px;">
                        <span class="drag-handle" style="color:#ccc; cursor:grab;">â‹®â‹®</span>
                        <div>
                            <div style="font-weight:400;">${member.name}</div>
                            <div style="font-size:0.8rem; color:#b5956a;">${member.role}${member.company ? ' - ' + member.company : ''}</div>
                            <div style="font-size:0.8rem; color:#666; margin-top:4px;">
                                ${member.email ? `<span style="color:#666;">${member.email}</span>` : ''}
                                ${member.email && member.phone ? ' &bull; ' : ''}
                                ${member.phone || ''}
                            </div>
                        </div>
                    </div>
                    <div style="display:flex; gap:8px; align-items:center;">
                        ${member.instagram ? `<span style="color:#b5956a; font-size:0.8rem;">IG</span>` : ''}
                        <button onclick="event.stopPropagation(); removeTeamMember(${member.id})" style="background:none; border:none; color:#ccc; cursor:pointer; font-size:1.2rem;" onmouseover="this.style.color='#e53935'" onmouseout="this.style.color='#ccc'">&times;</button>
                    </div>
                </div>
            `).join('');

            // Add drag and drop listeners
            initTeamDragDrop();
        }

        function removeTeamMember(memberId) {
            if (!confirm('Remove this team member?')) return;

            const portalData = JSON.parse(localStorage.getItem('kgc_portal_' + clientId) || '{}');
            portalData.team = (portalData.team || []).filter(m => m.id !== memberId);
            localStorage.setItem('kgc_portal_' + clientId, JSON.stringify(portalData));

            // Also remove from contacts if they were added there
            let clients = JSON.parse(localStorage.getItem('kgc_clients') || '[]');
            clients = clients.filter(c => c.id !== memberId);
            localStorage.setItem('kgc_clients', JSON.stringify(clients));

            loadTeam();
        }

        // Team drag and drop
        let draggedElement = null;
        let draggedIndex = null;

        function initTeamDragDrop() {
            const rows = document.querySelectorAll('.team-member-row');

            rows.forEach(row => {
                row.addEventListener('dragstart', handleDragStart);
                row.addEventListener('dragend', handleDragEnd);
                row.addEventListener('dragover', handleDragOver);
                row.addEventListener('dragenter', handleDragEnter);
                row.addEventListener('dragleave', handleDragLeave);
                row.addEventListener('drop', handleDrop);
            });
        }

        function handleDragStart(e) {
            draggedElement = this;
            draggedIndex = parseInt(this.dataset.index);
            this.classList.add('dragging');
            this.style.opacity = '0.5';
            this.style.cursor = 'grabbing';
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', this.dataset.index);
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            this.style.opacity = '1';
            this.style.cursor = 'grab';
            document.querySelectorAll('.team-member-row').forEach(row => {
                row.classList.remove('drop-above', 'drop-below');
            });
            draggedElement = null;
            draggedIndex = null;
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        function handleDragEnter(e) {
            e.preventDefault();
            if (this !== draggedElement) {
                // Clear all other indicators first
                document.querySelectorAll('.team-member-row').forEach(row => {
                    row.classList.remove('drop-above', 'drop-below');
                });
                const targetIndex = parseInt(this.dataset.index);
                if (targetIndex < draggedIndex) {
                    this.classList.add('drop-above');
                } else {
                    this.classList.add('drop-below');
                }
            }
        }

        function handleDragLeave(e) {
            // Only remove if actually leaving (not entering a child)
            if (!this.contains(e.relatedTarget)) {
                this.classList.remove('drop-above', 'drop-below');
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();

            if (this === draggedElement) return;

            const fromIndex = draggedIndex;
            const toIndex = parseInt(this.dataset.index);

            // Reorder team in storage
            const portalData = JSON.parse(localStorage.getItem('kgc_portal_' + clientId) || '{}');
            const team = portalData.team || [];

            if (fromIndex >= 0 && fromIndex < team.length && toIndex >= 0 && toIndex < team.length) {
                const [movedItem] = team.splice(fromIndex, 1);
                team.splice(toIndex, 0, movedItem);
                portalData.team = team;
                localStorage.setItem('kgc_portal_' + clientId, JSON.stringify(portalData));
                loadTeam();
            }
        }

        // Primary contact functions
        function editPrimaryContact() {
            const client = window.currentClient;
            if (!client) return;

            document.getElementById('editPrimaryName').value = client.name || '';
            document.getElementById('editPrimaryPhone').value = client.phone || '';
            document.getElementById('editPrimaryEmail').value = client.email || '';
            document.getElementById('editPrimaryAddress').value = client.address || '';

            document.getElementById('editPrimaryModal').style.display = 'flex';
        }

        function closeEditPrimaryModal() {
            document.getElementById('editPrimaryModal').style.display = 'none';
        }

        function savePrimaryContact() {
            const clients = JSON.parse(localStorage.getItem('kgc_clients') || '[]');
            const idx = clients.findIndex(c => String(c.id) === String(clientId));
            if (idx === -1) return;

            clients[idx].name = document.getElementById('editPrimaryName').value;
            clients[idx].phone = document.getElementById('editPrimaryPhone').value;
            clients[idx].email = document.getElementById('editPrimaryEmail').value;
            clients[idx].address = document.getElementById('editPrimaryAddress').value;

            localStorage.setItem('kgc_clients', JSON.stringify(clients));

            // Update page
            window.currentClient = clients[idx];
            document.getElementById('pageTitle').textContent = clients[idx].name;
            document.getElementById('clientName').textContent = clients[idx].name || '-';
            document.getElementById('clientEmail').textContent = clients[idx].email || '-';
            document.getElementById('clientPhone').textContent = clients[idx].phone || '-';
            document.getElementById('clientAddress').textContent = clients[idx].address || '-';

            loadTeam();
            closeEditPrimaryModal();

            // Sync to API in background
            syncClientToAPI(clients[idx]);
        }

        function openSwitchPrimaryModal() {
            const portalData = JSON.parse(localStorage.getItem('kgc_portal_' + clientId) || '{}');
            const team = portalData.team || [];

            const container = document.getElementById('switchPrimaryList');

            if (team.length === 0) {
                container.innerHTML = '<p style="color:#999; text-align:center; padding:20px;">No team members to switch with. Add team members first.</p>';
            } else {
                container.innerHTML = team.map(member => `
                    <div onclick="switchPrimaryTo(${member.id})" style="padding:14px 16px; border:1px solid #eee; margin-bottom:8px; cursor:pointer; transition:all 0.2s;" onmouseover="this.style.background='#f5f0e8';this.style.borderColor='#b5956a'" onmouseout="this.style.background='#fff';this.style.borderColor='#eee'">
                        <div style="font-weight:400;">${member.name}</div>
                        <div style="font-size:0.8rem; color:#b5956a;">${member.role}</div>
                    </div>
                `).join('');
            }

            document.getElementById('switchPrimaryModal').style.display = 'flex';
        }

        function closeSwitchPrimaryModal() {
            document.getElementById('switchPrimaryModal').style.display = 'none';
        }

        function switchPrimaryTo(memberId) {
            const portalData = JSON.parse(localStorage.getItem('kgc_portal_' + clientId) || '{}');
            const team = portalData.team || [];
            const memberIdx = team.findIndex(m => m.id === memberId);
            if (memberIdx === -1) return;

            const newPrimary = team[memberIdx];
            const currentClient = window.currentClient;

            // Create team member entry for current primary
            // Use their stored primaryRole, or 'Client' as default
            const oldPrimaryRole = portalData.primaryRole || 'Client';
            const oldPrimaryAsTeam = {
                id: Date.now(),
                role: oldPrimaryRole,
                name: currentClient.name,
                phone: currentClient.phone,
                email: currentClient.email,
                company: currentClient.company || '',
                instagram: currentClient.instagram || '',
                website: currentClient.website || ''
            };

            // Store the new primary's role before promoting them
            portalData.primaryRole = newPrimary.role || '';

            // Update client record with new primary's info
            const clients = JSON.parse(localStorage.getItem('kgc_clients') || '[]');
            const clientIdx = clients.findIndex(c => String(c.id) === String(clientId));
            if (clientIdx !== -1) {
                clients[clientIdx].name = newPrimary.name;
                clients[clientIdx].phone = newPrimary.phone;
                clients[clientIdx].email = newPrimary.email;
                localStorage.setItem('kgc_clients', JSON.stringify(clients));
                window.currentClient = clients[clientIdx];
            }

            // Remove new primary from team and add old primary
            team.splice(memberIdx, 1);
            team.unshift(oldPrimaryAsTeam);
            portalData.team = team;
            localStorage.setItem('kgc_portal_' + clientId, JSON.stringify(portalData));

            // Update page
            document.getElementById('pageTitle').textContent = newPrimary.name;
            document.getElementById('clientName').textContent = newPrimary.name || '-';
            document.getElementById('clientEmail').textContent = newPrimary.email || '-';
            document.getElementById('clientPhone').textContent = newPrimary.phone || '-';

            loadTeam();
            closeSwitchPrimaryModal();
        }

        // Edit Event Details functions
        function openEditEventModal() {
            if (!isAdmin) return;

            const client = window.currentClient;
            if (!client) return;

            // Get current event title
            const portalData = JSON.parse(localStorage.getItem('kgc_portal_' + clientId) || '{}');
            const defaultTitle = (client.name || 'Client') + ' ' + (client.eventType || 'Event');

            // Populate the form with current values - Client Info
            document.getElementById('editClientName').value = client.name || '';
            document.getElementById('editClientEmail').value = client.email || '';
            document.getElementById('editClientPhone').value = client.phone || '';
            document.getElementById('editClientAddress').value = client.address || '';

            // Populate the form with current values - Event Info
            document.getElementById('editEventTitle').value = portalData.portalTitle || defaultTitle;
            document.getElementById('editEventType').value = client.eventType || 'Wedding';
            // Set date using Flatpickr API (handles ISO dates properly)
            if (client.eventDate && window.editDatePicker) {
                window.editDatePicker.setDate(client.eventDate, true);
            } else if (window.editDatePicker) {
                window.editDatePicker.clear();
            }
            document.getElementById('editEventTime').value = client.eventTime || '';
            document.getElementById('editEventVenue').value = client.venue || '';
            document.getElementById('editEventVenueAddress').value = client.venueAddress || '';
            document.getElementById('editEventGuestCount').value = client.guestCount || '';
            document.getElementById('editEventSource').value = client.source || '';

            document.getElementById('editEventModal').style.display = 'flex';
        }

        function closeEditEventModal() {
            document.getElementById('editEventModal').style.display = 'none';
        }

        function saveEventDetails() {
            const clients = JSON.parse(localStorage.getItem('kgc_clients') || '[]');
            const idx = clients.findIndex(c => String(c.id) === String(clientId));
            if (idx === -1) return;

            // Update client info
            clients[idx].name = document.getElementById('editClientName').value;
            clients[idx].email = document.getElementById('editClientEmail').value;
            clients[idx].phone = document.getElementById('editClientPhone').value;
            clients[idx].address = document.getElementById('editClientAddress').value;

            // Update event data
            clients[idx].eventType = document.getElementById('editEventType').value;
            clients[idx].eventDate = document.getElementById('editEventDate').value;
            clients[idx].eventTime = document.getElementById('editEventTime').value;
            clients[idx].venue = document.getElementById('editEventVenue').value;
            clients[idx].venueAddress = document.getElementById('editEventVenueAddress').value;
            clients[idx].guestCount = document.getElementById('editEventGuestCount').value;
            clients[idx].source = document.getElementById('editEventSource').value;

            localStorage.setItem('kgc_clients', JSON.stringify(clients));

            // Update current client reference
            window.currentClient = clients[idx];

            // Update client display
            document.getElementById('clientName').textContent = clients[idx].name || '-';
            document.getElementById('clientEmail').textContent = clients[idx].email || '-';
            document.getElementById('clientPhone').textContent = clients[idx].phone || '-';
            document.getElementById('clientAddress').textContent = clients[idx].address || '-';

            // Update event display
            document.getElementById('eventType').textContent = clients[idx].eventType || '-';
            if (isAdmin && clients[idx].eventDate) {
                document.getElementById('eventDate').innerHTML = `<a href="/admin/calendar?date=${clients[idx].eventDate}" style="color: inherit; text-decoration: none;" onmouseover="this.style.color='#b5956a'" onmouseout="this.style.color='inherit'">${formatDate(clients[idx].eventDate)}</a>`;
            } else {
                document.getElementById('eventDate').textContent = formatDate(clients[idx].eventDate);
            }
            // Update header subtitle with event date
            if (clients[idx].eventDate) {
                document.getElementById('headerEventDate').textContent = formatDate(clients[idx].eventDate);
            }
            document.getElementById('eventTime').textContent = formatTime(clients[idx].eventTime);
            document.getElementById('venue').textContent = clients[idx].venue || '-';
            document.getElementById('venueAddress').textContent = clients[idx].venueAddress || '-';
            document.getElementById('guestCount').textContent = clients[idx].guestCount ? clients[idx].guestCount + ' guests' : '-';
            document.getElementById('source').textContent = clients[idx].source || '-';

            // Save and update event title
            const portalData = JSON.parse(localStorage.getItem('kgc_portal_' + clientId) || '{}');
            const newTitle = document.getElementById('editEventTitle').value.trim();
            portalData.portalTitle = newTitle;
            localStorage.setItem('kgc_portal_' + clientId, JSON.stringify(portalData));

            // Update both page title and event details title display
            document.getElementById('pageTitle').textContent = newTitle;
            document.getElementById('eventDetailsTitle').textContent = newTitle + ' Event Details';

            // Reload team in case primary contact name changed
            loadTeam();

            closeEditEventModal();

            // Sync to API in background
            syncClientToAPI(clients[idx]);
        }

        // Close edit event modal on overlay click
        document.getElementById('editEventModal').addEventListener('click', function(e) {
            if (e.target === this) closeEditEventModal();
        });

        // Initialize
        loadClient();
        loadTeam();
        renderCommLog();
        loadCommunicationsFromAPI(); // Load from API in background

        // Load from API in background
        loadClientsFromAPI();

        // Accounting now reads directly from API â€” no localStorage sync needed

        // Auto-sync Gmail emails quietly on page load
        autoSyncEmails();

        // Collapse all sections except Event Details by default
        function setDefaultCollapsedState() {
            const cardsToCollapse = ['teamCard', 'accountingCard', 'logCard', 'dayOfCard', 'internalCard'];
            cardsToCollapse.forEach(cardId => {
                const card = document.getElementById(cardId);
                if (card) card.classList.add('collapsed');
            });
        }
        setDefaultCollapsedState();

        // Make Edit Event Details modal draggable
        (function() {
            const modal = document.getElementById('editEventModalContent');
            const header = document.getElementById('editEventModalHeader');
            let isDragging = false;
            let offsetX, offsetY;

            header.addEventListener('mousedown', function(e) {
                if (e.target.tagName === 'BUTTON') return; // Don't drag if clicking close button
                isDragging = true;

                // Get the modal's current position
                const rect = modal.getBoundingClientRect();

                // If modal hasn't been positioned yet, center it first
                if (!modal.style.left) {
                    modal.style.position = 'fixed';
                    modal.style.left = rect.left + 'px';
                    modal.style.top = rect.top + 'px';
                    modal.style.margin = '0';
                }

                offsetX = e.clientX - rect.left;
                offsetY = e.clientY - rect.top;

                e.preventDefault();
            });

            document.addEventListener('mousemove', function(e) {
                if (!isDragging) return;

                let newX = e.clientX - offsetX;
                let newY = e.clientY - offsetY;

                // Keep modal within viewport bounds
                const maxX = window.innerWidth - modal.offsetWidth;
                const maxY = window.innerHeight - modal.offsetHeight;
                newX = Math.max(0, Math.min(newX, maxX));
                newY = Math.max(0, Math.min(newY, maxY));

                modal.style.left = newX + 'px';
                modal.style.top = newY + 'px';
            });

            document.addEventListener('mouseup', function() {
                isDragging = false;
            });

            // Reset position when modal closes
            const originalClose = window.closeEditEventModal;
            window.closeEditEventModal = function() {
                originalClose();
                modal.style.left = '';
                modal.style.top = '';
                modal.style.position = '';
                modal.style.margin = '';
            };
        })();

        // Test function: Add sample team members (call from console: addTestTeam())
        window.addTestTeam = function() {
            const portalData = JSON.parse(localStorage.getItem('kgc_portal_' + clientId) || '{}');
            portalData.team = portalData.team || [];
            const clients = JSON.parse(localStorage.getItem('kgc_clients') || '[]');

            const testMembers = [
                { id: Date.now(), name: 'Sarah Mitchell', role: 'Wedding Planner', email: 'sarah@elegantevents.com', phone: '(206) 555-1234', company: 'Elegant Events' },
                { id: Date.now() + 1, name: 'James Chen', role: 'Photographer', email: 'james@jamesphoto.com', phone: '(206) 555-2345', company: 'James Chen Photography' },
                { id: Date.now() + 2, name: 'Bella Florals', role: 'Florist', email: 'hello@bellaflorals.com', phone: '(425) 555-3456', company: 'Bella Florals' }
            ];

            testMembers.forEach(m => {
                // Add to portal team if not already there
                if (!portalData.team.some(t => t.name === m.name)) {
                    const contactId = Date.now() + Math.random();
                    const teamMember = { ...m, contactId: contactId };
                    portalData.team.push(teamMember);

                    // Also add to main contacts list with link to parent client
                    const contact = {
                        id: contactId,
                        createdAt: new Date().toISOString(),
                        status: 'contact',
                        linkedToClient: clientId,
                        name: m.name,
                        role: m.role,
                        email: m.email,
                        phone: m.phone,
                        company: m.company
                    };
                    clients.push(contact);
                }
            });

            localStorage.setItem('kgc_portal_' + clientId, JSON.stringify(portalData));
            localStorage.setItem('kgc_clients', JSON.stringify(clients));
            loadTeam();
            console.log('Added test team members to portal and contacts!');
        };
    </script>
    <!-- Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        // Initialize Flatpickr on edit event date
        window.editDatePicker = flatpickr("#editEventDate", {
            dateFormat: "Y-m-d",
            altInput: true,
            altFormat: "F j, Y",
            disableMobile: false,
            monthSelectorType: "static",
            animate: true
        });

        // Calendar button toggles picker
        document.getElementById('editEventDateBtn').addEventListener('click', function() {
            if (window.editDatePicker.isOpen) {
                window.editDatePicker.close();
            } else {
                window.editDatePicker.open();
            }
        });
    </script>
    </div><!-- End main-wrapper -->
</body>
</html>
