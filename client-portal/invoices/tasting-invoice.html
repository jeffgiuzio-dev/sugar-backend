<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="/favicon.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tasting Invoice - Kenna Giuzio Cake</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500&family=Mr+De+Haviland&family=Montserrat:wght@300;400;500&display=swap" rel="stylesheet">
    <script src="https://js.stripe.com/v3/"></script>
    <script>
        // Run immediately before any rendering - check if we need fade
        if (window.location.search.includes('fade=true')) {
            document.write('<style id="fadeStyle">html{background:#000}body{opacity:0}</style>');
        }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            font-weight: 300;
            background: #faf8f5;
            color: #1a1a1a;
            line-height: 1.6;
            min-height: 100vh;
            padding: 40px 20px;
        }

        /* Sidebar (admin view only) */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 260px;
            background: #fff;
            border-right: 1px solid #eee;
            padding: 30px 0;
            display: none;
            flex-direction: column;
            z-index: 100;
        }

        body.admin-view .sidebar {
            display: flex;
        }

        body.admin-view {
            padding-left: 280px;
        }

        .logo {
            text-align: center;
            padding: 30px 30px 30px;
            border-bottom: 1px solid #eee;
        }

        .logo img {
            width: 160px;
            height: auto;
        }

        .nav-menu {
            padding: 30px 0;
            flex: 1;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 30px;
            color: #666;
            text-decoration: none;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background: #fafafa;
            color: #1a1a1a;
        }

        .nav-item.active {
            background: #fafafa;
            color: #1a1a1a;
            border-left-color: #b5956a;
        }

        .nav-item svg {
            width: 18px;
            height: 18px;
            opacity: 0.7;
        }

        .nav-divider {
            height: 1px;
            background: #eee;
            margin: 15px 30px;
        }

        /* Back Button */
        .back-to-finances {
            display: none;
            max-width: 650px;
            margin: 0 auto 16px;
        }

        .back-to-finances.visible {
            display: block;
        }

        .back-to-finances a {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #666;
            text-decoration: none;
            font-size: 0.85rem;
            padding: 8px 0;
            transition: color 0.2s;
        }

        .back-to-finances a:hover {
            color: #b5956a;
        }

        .invoice-container {
            max-width: 650px;
            margin: 0 auto;
            background: #fff;
            box-shadow: 0 2px 20px rgba(0,0,0,0.08);
        }

        /* Header */
        .invoice-header {
            text-align: center;
            padding: 30px 40px;
            border-bottom: 1px solid #eee;
        }


        .invoice-contact {
            margin-top: 24px;
            font-size: 0.8rem;
            color: #666;
            line-height: 1.8;
        }

        /* Invoice Title */
        .invoice-title-section {
            padding: 40px;
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid #eee;
        }

        .invoice-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 2rem;
            font-weight: 400;
        }

        .paid-badge {
            display: none;
            background: #e8ede5;
            color: #5a6b52;
            padding: 8px 20px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 500;
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-top: 12px;
        }

        .paid-badge.visible {
            display: inline-block;
        }

        .invoice-meta {
            text-align: right;
        }

        .invoice-meta-label {
            font-size: 0.65rem;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: #999;
        }

        .invoice-meta-value {
            font-size: 0.9rem;
            margin-bottom: 12px;
        }

        /* Bill To */
        .bill-to-section {
            padding: 30px 40px;
            background: #fafafa;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
        }

        .bill-to-label {
            font-size: 0.65rem;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: #999;
            margin-bottom: 8px;
        }

        .bill-to-name {
            font-weight: 400;
            font-size: 1rem;
            margin-bottom: 4px;
        }

        .bill-to-email {
            font-size: 0.85rem;
            color: #666;
        }

        .event-details {
            font-size: 0.85rem;
            color: #666;
            line-height: 1.8;
        }

        /* Line Items */
        .line-items {
            padding: 40px;
        }

        .line-item {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 20px;
            padding: 24px 0;
            border-bottom: 1px solid #eee;
        }

        .line-item:last-child {
            border-bottom: none;
        }

        .line-item-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.3rem;
            font-weight: 400;
            margin-bottom: 12px;
        }

        .line-item-desc {
            font-size: 0.85rem;
            color: #666;
            line-height: 1.8;
        }

        .line-item-price {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.5rem;
            font-weight: 400;
            text-align: right;
        }

        /* Tasting Details */
        .tasting-details {
            background: #fafafa;
            padding: 20px 24px;
            margin-top: 16px;
            font-size: 0.85rem;
        }

        .tasting-details-title {
            font-size: 0.65rem;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: #999;
            margin-bottom: 8px;
        }

        .tasting-details p {
            color: #666;
            margin-bottom: 4px;
        }

        /* Totals */
        .totals-section {
            padding: 0 40px 40px;
        }

        .totals-table {
            width: 100%;
            max-width: 280px;
            margin-left: auto;
        }

        .totals-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            font-size: 0.9rem;
        }

        .totals-row.subtotal {
            border-top: 1px solid #eee;
            padding-top: 20px;
        }

        .totals-row.fee {
            color: #999;
            font-size: 0.85rem;
        }

        .totals-row.total {
            border-top: 2px solid #1a1a1a;
            margin-top: 10px;
            padding-top: 16px;
            font-weight: 400;
        }

        .totals-row.total .amount {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.8rem;
        }

        /* Payment Options */
        .payment-section {
            padding: 40px;
            background: #fafafa;
            border-top: 1px solid #eee;
        }

        .payment-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.3rem;
            font-weight: 400;
            margin-bottom: 24px;
            text-align: center;
        }

        .payment-options {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 14px;
        }

        .payment-option {
            background: #fff;
            border: 1px solid #e8e0d5;
            padding: 16px 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .payment-option:hover {
            border-color: #b5956a;
        }

        .payment-option.selected {
            border-color: #b5956a;
            background: #fdf9f4;
        }

        .payment-option-icon {
            font-size: 1.2rem;
            margin-bottom: 6px;
        }

        .payment-option-title {
            font-size: 0.85rem;
            font-weight: 400;
            margin-bottom: 2px;
        }

        .payment-option-desc {
            font-size: 0.65rem;
            color: #b5956a;
            letter-spacing: 0.3px;
        }

        .payment-option-fee {
            margin-top: 4px;
            font-size: 0.6rem;
            color: #999;
        }

        /* Zelle Info */
        .zelle-info {
            display: none;
            margin-top: 24px;
            padding: 24px;
            background: #fff;
            border: 1px solid #ddd;
            text-align: center;
        }

        .zelle-info.visible {
            display: block;
        }

        .zelle-info p {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 8px;
        }

        .zelle-info .zelle-email {
            font-size: 1.1rem;
            font-weight: 400;
            color: #1a1a1a;
            margin: 16px 0;
        }

        .zelle-info .zelle-amount {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.5rem;
        }

        /* Pay Button */
        .pay-button {
            display: block;
            width: 100%;
            padding: 18px 24px;
            margin-top: 24px;
            background: #b5956a;
            color: #fff;
            border: none;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.85rem;
            font-weight: 400;
            letter-spacing: 2px;
            text-transform: uppercase;
            cursor: pointer;
            transition: background 0.2s;
        }

        .pay-button:hover {
            background: #a38559;
        }

        .pay-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* Terms */
        .terms-section {
            padding: 40px;
            border-top: 1px solid #eee;
        }

        .terms-title {
            font-size: 0.65rem;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: #999;
            margin-bottom: 16px;
        }

        .terms-text {
            font-size: 0.8rem;
            color: #666;
            line-height: 1.8;
        }

        .terms-text p {
            margin-bottom: 12px;
        }

        .terms-note {
            background: #fff8e7;
            padding: 16px 20px;
            margin-top: 20px;
            font-size: 0.8rem;
            color: #8b6914;
        }

        /* Footer */
        .invoice-footer {
            text-align: center !important;
            padding: 30px 40px !important;
            background: #fff !important;
            border-top: 1px solid #eee !important;
            color: #666 !important;
        }

        .invoice-footer img {
            width: 240px;
            opacity: 0.7;
            display: block;
            margin: 0 auto 12px;
        }

        .invoice-footer p {
            font-size: 0.75rem;
            color: #999;
            margin-top: 12px;
        }

        /* Hero Banner */
        .hero-banner {
            position: relative;
            height: 200px;
            background: url('../images/header-flowers.jpg') 30% center / cover no-repeat;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding-left: 25px;
        }

        .hero-banner::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.15);
        }

        .hero-banner img {
            position: relative;
            width: 150px;
            z-index: 1;
        }

        /* Responsive */
        @media (max-width: 600px) {
            body {
                padding: 20px 10px;
            }

            .hero-banner {
                height: 140px;
            }

            .hero-banner img {
                width: 220px;
            }

            .invoice-title-section {
                flex-direction: column;
                gap: 20px;
            }

            .invoice-meta {
                text-align: left;
            }

            .bill-to-section {
                grid-template-columns: 1fr;
                gap: 24px;
            }

            .payment-options {
                grid-template-columns: 1fr;
            }

            .invoice-header,
            .line-items,
            .totals-section,
            .terms-section {
                padding-left: 24px;
                padding-right: 24px;
            }
        }

        /* Preview Mode Banner */
        .preview-banner {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #f8f5f0;
            border-bottom: 1px solid #e0d8cc;
            padding: 12px 24px;
            z-index: 1000;
            text-align: center;
        }

        .preview-banner.show {
            display: block;
        }

        .preview-banner-content {
            max-width: 650px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .preview-label {
            font-size: 0.8rem;
            color: #8b7355;
            letter-spacing: 0.5px;
        }

        .preview-back-btn {
            padding: 8px 16px;
            font-size: 0.75rem;
            color: #666;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
            transition: all 0.2s;
        }

        .preview-back-btn:hover {
            border-color: #b5956a;
            color: #b5956a;
        }

        body.preview-mode {
            padding-top: 70px;
        }
    </style>
</head>
<body>
    <!-- Sidebar (admin view only) -->
    <aside class="sidebar">
        <div class="logo">
            <img src="../images/logo.png" alt="Kenna Giuzio Cake">
        </div>

        <nav class="nav-menu">
            <a href="/admin/in-studio.html" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                    <path d="M2 17l10 5 10-5"/>
                    <path d="M2 12l10 5 10-5"/>
                </svg>
                In Studio
            </a>
            <a href="/admin/calendar.html" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                    <line x1="16" y1="2" x2="16" y2="6"/>
                    <line x1="8" y1="2" x2="8" y2="6"/>
                    <line x1="3" y1="10" x2="21" y2="10"/>
                </svg>
                Calendar
            </a>
            <a href="/admin/contacts.html" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
                Contacts
            </a>

            <div class="nav-divider"></div>

            <a href="#" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                    <line x1="16" y1="13" x2="8" y2="13"/>
                    <line x1="16" y1="17" x2="8" y2="17"/>
                </svg>
                Proposals
            </a>
            <a href="/admin/finances.html" class="nav-item active">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <line x1="18" y1="20" x2="18" y2="10"/>
                    <line x1="12" y1="20" x2="12" y2="4"/>
                    <line x1="6" y1="20" x2="6" y2="14"/>
                </svg>
                Finances
            </a>
            <a href="/admin/communications.html" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                </svg>
                Communications
            </a>

            <div class="nav-divider"></div>

            <a href="/admin/settings.html" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                </svg>
                Settings
            </a>
            <a href="/admin/archive.html" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <polyline points="21 8 21 21 3 21 3 8"/>
                    <rect x="1" y="3" width="22" height="5"/>
                    <line x1="10" y1="12" x2="14" y2="12"/>
                </svg>
                Archive
            </a>
        </nav>
    </aside>

    <!-- Preview Banner -->
    <div class="preview-banner" id="previewBanner">
        <div class="preview-banner-content">
            <span class="preview-label">Client Preview</span>
            <button class="preview-back-btn" onclick="window.close()">← Back to Invoice</button>
        </div>
    </div>

    <!-- Back to Finances Button -->
    <div class="back-to-finances" id="backToFinances">
        <a href="/admin/finances.html">← Back to Finances</a>
    </div>

    <div class="invoice-container">
        <!-- Hero Banner -->
        <div class="hero-banner">
            <img src="../images/logo.png" alt="Kenna Giuzio Cake">
        </div>

        <!-- Header -->
        <div class="invoice-header">
            <div class="invoice-contact">
                (206) 472-5401 | kenna@kennagiuziocake.com<br>
                Queen Anne, Seattle
            </div>
        </div>

        <!-- Invoice Title -->
        <div class="invoice-title-section">
            <div>
                <h1 class="invoice-title">Tasting Invoice</h1>
                <div class="paid-badge" id="paidBadge">✓ Paid</div>
            </div>
            <div class="invoice-meta">
                <div class="invoice-meta-label">Invoice #</div>
                <div class="invoice-meta-value" id="invoiceNumber">TI-2026-001</div>
                <div class="invoice-meta-label">Date Issued</div>
                <div class="invoice-meta-value" id="invoiceDate">January 27, 2026</div>
            </div>
        </div>

        <!-- Bill To -->
        <div class="bill-to-section">
            <div>
                <div class="bill-to-label">Bill To</div>
                <div class="bill-to-name" id="clientName">Elizabeth Seelinger</div>
                <div class="bill-to-email" id="clientEmail">eseelinger@gmail.com</div>
                <div class="bill-to-email" id="clientAddress"></div>
            </div>
            <div>
                <div class="bill-to-label">Event Details</div>
                <div class="event-details">
                    <span id="eventType">Wedding</span><br>
                    <span id="eventDate">August 28, 2026</span>
                </div>
            </div>
        </div>

        <!-- Line Items -->
        <div class="line-items">
            <div class="line-item">
                <div>
                    <h3 class="line-item-title">Tasting Party</h3>
                    <p class="line-item-desc" id="tastingDescription" style="white-space: pre-line;">A bespoke tasting party and design consultation for you and your guests at my studio during which we will sample cakes, review designs and discuss your vision.</p>
                    <p style="font-size: 0.7rem; font-style: italic; color: #888; margin-top: 10px; margin-bottom: 14px;">Custom cake commissions begin at $2,500. This tasting is designed to explore fit, flavor, and creative direction before moving forward.</p>
                    <div class="tasting-details">
                        <div class="tasting-details-title">Tasting Details</div>
                        <p id="tastingDate">Friday, February 6, 2026</p>
                        <p id="tastingTime">12:00 PM</p>
                        <p id="tastingLocation">Queen Anne Studio, Seattle</p>
                        <div class="tasting-details-title" style="margin-top: 12px;">Arrival</div>
                        <p id="arrivalInstructions" style="font-size: 0.9rem; line-height: 1.5; white-space: pre-line;">The studio entrance is on the W 3rd Ave side of the house.
I'll meet you there! At the tall white gate in front of my blue studio door.</p>
                    </div>
                </div>
                <div class="line-item-price">$250</div>
            </div>
        </div>

        <!-- Totals -->
        <div class="totals-section">
            <div class="totals-table">
                <div class="totals-row subtotal">
                    <span>Subtotal</span>
                    <span>$250.00</span>
                </div>
                <div class="totals-row fee" id="processingFeeRow">
                    <span>Processing Fee (3.4%)</span>
                    <span id="processingFee">$8.50</span>
                </div>
                <div class="totals-row total">
                    <span>Total</span>
                    <span class="amount" id="totalAmount">$258.50</span>
                </div>
            </div>
        </div>

        <!-- Payment Options -->
        <div class="payment-section" id="paymentSection">
            <h2 class="payment-title">Select Payment Method</h2>
            <div class="payment-options">
                <div class="payment-option selected" data-method="card" onclick="selectPayment('card')">
                    <div class="payment-option-title">Credit Card</div>
                    <div class="payment-option-desc">Visa, Mastercard, Amex</div>
                    <div class="payment-option-fee">+3.4% processing fee</div>
                </div>
                <div class="payment-option" data-method="zelle" onclick="selectPayment('zelle')">
                    <div class="payment-option-title">Zelle</div>
                    <div class="payment-option-desc">Direct bank transfer</div>
                    <div class="payment-option-fee">No fee</div>
                </div>
                <div class="payment-option" data-method="check" onclick="selectPayment('check')">
                    <div class="payment-option-title">Check</div>
                    <div class="payment-option-desc">Mail a check</div>
                    <div class="payment-option-fee">No fee</div>
                </div>
            </div>

            <div class="zelle-info" id="zelleInfo">
                <p><strong>Zelle:</strong> Send payment to:</p>
                <div class="zelle-email">kgiuzio@gmail.com</div>
                <p>Amount:</p>
                <div class="zelle-amount">$250.00</div>
                <p style="margin-top: 12px; font-size: 0.8rem; color: #999;">
                    Your date will be confirmed once payment is verified.
                </p>
            </div>

            <div class="zelle-info" id="checkInfo">
                <p><strong>Make payable and mail to:</strong><br>
                <strong>Kenna Giuzio Cake</strong><br>
                <strong>302 W Howe St</strong><br>
                <strong>Seattle, WA 98119</strong></p>
                <p>Amount:</p>
                <div class="zelle-amount">$250.00</div>
                <p style="margin-top: 12px; font-size: 0.85rem; color: #666;">
                    Please include your name and "Tasting" in the memo.
                </p>
                <p style="margin-top: 12px; font-size: 0.8rem; color: #999;">
                    Your date will be confirmed once payment is verified.
                </p>
            </div>

            <!-- Embedded Card Form (Stripe Payment Element) -->
            <div id="cardFormContainer" style="margin-top: 24px; display: none;">
                <div style="background: #fff; border: 1px solid #e8e0d5; padding: 24px; border-radius: 4px; min-height: 60px;">
                    <div id="payment-element-loading" style="text-align: center; color: #999; font-size: 0.8rem; padding: 16px 0;">Loading payment form...</div>
                    <div id="payment-element"></div>
                </div>
                <div id="card-errors" style="color: #df1b41; font-size: 0.8rem; margin-top: 8px; min-height: 20px;"></div>
            </div>

            <button class="pay-button" id="payButton" onclick="processPayment()">
                Pay $258.50 with Card
            </button>

            <!-- Sandbox test button (remove before go-live) -->
            <button id="testPayBtn" onclick="testPay()" style="display:none; width:100%; margin-top:12px; padding:14px 24px; background:#e8e0d5; color:#666; border:1px dashed #ccc; border-radius:8px; font-family:'Montserrat',sans-serif; font-size:0.8rem; cursor:pointer; letter-spacing:1px;">
                SANDBOX: TEST PAY (4242)
            </button>
        </div>

        <!-- Terms -->
        <div class="terms-section">
            <div class="terms-title">Please Note</div>
            <div class="terms-text">
                <p>
                    This invoice secures a bespoke tasting and design consultation for you and up to four guests
                    at my studio on the agreed upon date. During this session, we will sample cakes, review cake
                    models, and discuss your wedding cake vision. I will also follow up with a detailed proposal
                    for your event.
                </p>
                <p>
                    The tasting fee will be deducted from your final cake invoice if you choose to book.
                </p>
                <div class="terms-note">
                    <strong>Important:</strong> This tasting invoice does not secure your wedding date.
                    If you wish to officially lock in your date, a separate agreement and 50% deposit
                    will be required under a separate invoice.
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="invoice-footer">
            <img src="../images/logo.png" alt="Kenna Giuzio Cake">
            <p>Thank you for considering Kenna Giuzio Cake for your celebration.</p>
        </div>
    </div>

    <script>
        // Banner image is set via CSS on .hero-banner

        // Handle fade from black if coming from welcome page
        if (window.location.search.includes('fade=true')) {
            // Remove the hide style and add fade-in
            setTimeout(() => {
                // Remove the injected style
                const fadeStyle = document.getElementById('fadeStyle');
                if (fadeStyle) fadeStyle.remove();

                // Apply transitions and fade in
                document.documentElement.style.cssText = 'background: #000; transition: background 3s ease-in-out;';
                document.body.style.cssText = document.body.style.cssText + '; opacity: 0; transition: opacity 3s ease-in-out;';

                // Trigger reflow then fade in
                document.body.offsetHeight;
                document.documentElement.style.background = '#faf8f5';
                document.body.style.opacity = '1';
            }, 500);
        }

        let selectedPayment = 'card';

        // Stripe embedded payment state
        let stripeInstance = null;
        let stripeElements = null;
        let paymentIntentClientSecret = null;
        let paymentElementMounted = false;

        const API_URL = 'https://sugar-backend-production.up.railway.app';

        // Initialize Stripe with publishable key from backend
        async function initStripe() {
            const loadingEl = document.getElementById('payment-element-loading');
            try {
                if (typeof Stripe === 'undefined') {
                    document.getElementById('card-errors').textContent = 'Payment system failed to load. Please refresh the page.';
                    loadingEl.style.display = 'none';
                    return;
                }
                const resp = await fetch(`${API_URL}/api/stripe/status`);
                const data = await resp.json();
                if (data.configured && data.publishableKey) {
                    stripeInstance = Stripe(data.publishableKey);
                    // Show sandbox test button if using test keys
                    if (data.publishableKey.startsWith('pk_test_')) {
                        document.getElementById('testPayBtn').style.display = 'block';
                    }
                } else {
                    document.getElementById('card-errors').textContent = 'Payment system is not configured.';
                    loadingEl.style.display = 'none';
                }
            } catch (err) {
                console.error('Failed to init Stripe:', err);
                document.getElementById('card-errors').textContent = 'Failed to connect to payment system.';
                loadingEl.style.display = 'none';
            }
        }

        // Create PaymentIntent and mount the Payment Element
        async function createPaymentIntent() {
            const loadingEl = document.getElementById('payment-element-loading');
            if (!stripeInstance) {
                document.getElementById('card-errors').textContent = 'Stripe failed to initialize. Please refresh.';
                if (loadingEl) loadingEl.style.display = 'none';
                return;
            }
            if (paymentIntentClientSecret) return;

            const clientId = params.get('clientId');
            const clientName = document.getElementById('clientName').textContent;
            const clientEmail = document.getElementById('clientEmail').textContent;
            const invoiceId = params.get('invoiceId');
            const feeText = document.querySelector('.line-item-price').textContent;
            const baseAmount = parseFloat(feeText.replace('$', '')) || 250;
            const processingFee = baseAmount * 0.034;
            const totalAmount = baseAmount + processingFee;

            try {
                const response = await fetch(`${API_URL}/api/payments/create-payment-intent`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        invoice_id: invoiceId,
                        invoice_type: 'tasting',
                        client_id: clientId,
                        client_name: clientName,
                        client_email: clientEmail,
                        amount: totalAmount.toFixed(2),
                        description: 'Tasting Party - Kenna Giuzio Cake'
                    })
                });

                const data = await response.json();
                if (data.success && data.clientSecret) {
                    paymentIntentClientSecret = data.clientSecret;
                    mountPaymentElement();
                } else {
                    console.error('PaymentIntent failed:', data);
                    document.getElementById('card-errors').textContent = 'Failed to initialize payment. Please refresh.';
                    document.getElementById('payment-element-loading').style.display = 'none';
                }
            } catch (err) {
                console.error('Failed to create PaymentIntent:', err);
                document.getElementById('card-errors').textContent = 'Failed to connect to payment server.';
                document.getElementById('payment-element-loading').style.display = 'none';
            }
        }

        // Mount the Stripe Payment Element with Kenna's branding
        function mountPaymentElement() {
            if (paymentElementMounted || !stripeInstance || !paymentIntentClientSecret) return;

            const appearance = {
                theme: 'stripe',
                variables: {
                    colorPrimary: '#b5956a',
                    colorBackground: '#faf8f5',
                    fontFamily: 'Montserrat, sans-serif',
                    borderRadius: '4px',
                    colorText: '#1a1a1a',
                    colorTextSecondary: '#666',
                    colorDanger: '#df1b41'
                },
                rules: {
                    '.Input': {
                        border: '1px solid #e8e0d5',
                        boxShadow: 'none'
                    },
                    '.Input:focus': {
                        border: '1px solid #b5956a',
                        boxShadow: '0 0 0 1px #b5956a'
                    },
                    '.Label': {
                        color: '#666',
                        fontSize: '0.8rem',
                        fontWeight: '400',
                        textTransform: 'uppercase',
                        letterSpacing: '0.5px'
                    }
                }
            };

            stripeElements = stripeInstance.elements({
                clientSecret: paymentIntentClientSecret,
                appearance: appearance,
                fonts: [{
                    cssSrc: 'https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500'
                }]
            });

            const paymentElement = stripeElements.create('payment', {
                layout: 'tabs',
                wallets: {
                    link: 'never'
                }
            });
            paymentElement.on('ready', () => {
                document.getElementById('payment-element-loading').style.display = 'none';
            });
            paymentElement.on('loaderror', (event) => {
                document.getElementById('card-errors').textContent = 'Card form failed to load: ' + (event.error ? event.error.message : 'unknown error');
                document.getElementById('payment-element-loading').style.display = 'none';
            });
            paymentElement.mount('#payment-element');
            paymentElementMounted = true;

            // Fallback: if element doesn't load in 15 seconds, show help message
            setTimeout(() => {
                const loadEl = document.getElementById('payment-element-loading');
                if (loadEl && loadEl.style.display !== 'none') {
                    loadEl.innerHTML = 'Card form is taking longer than expected.<br><span style="font-size:0.75rem;">Try disabling ad blockers or refreshing the page.</span>';
                }
            }, 15000);

            // Show the card form
            document.getElementById('cardFormContainer').style.display = 'block';
        }

        function selectPayment(method) {
            selectedPayment = method;

            // Update UI
            document.querySelectorAll('.payment-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.querySelector(`[data-method="${method}"]`).classList.add('selected');

            // Show/hide info sections and card form
            const zelleInfo = document.getElementById('zelleInfo');
            const checkInfo = document.getElementById('checkInfo');
            const cardForm = document.getElementById('cardFormContainer');
            const payButton = document.getElementById('payButton');
            const feeRow = document.getElementById('processingFeeRow');
            const totalAmountEl = document.getElementById('totalAmount');

            // Hide all method-specific info first
            zelleInfo.classList.remove('visible');
            checkInfo.classList.remove('visible');
            cardForm.style.display = 'none';

            if (method === 'zelle') {
                zelleInfo.classList.add('visible');
                payButton.textContent = 'I\'ve Sent Payment';
                payButton.style.background = '#8b7355';
                feeRow.style.display = 'none';
                totalAmountEl.textContent = '$250.00';
            } else if (method === 'check') {
                checkInfo.classList.add('visible');
                payButton.textContent = 'I\'ve Sent a Check';
                payButton.style.background = '#8b7355';
                feeRow.style.display = 'none';
                totalAmountEl.textContent = '$250.00';
            } else {
                if (paymentElementMounted) cardForm.style.display = 'block';
                payButton.style.background = '#b5956a';
                feeRow.style.display = 'flex';
                // Recalculate total
                const feeText = document.querySelector('.line-item-price').textContent;
                const baseAmount = parseFloat(feeText.replace('$', '')) || 250;
                const total = baseAmount + (baseAmount * 0.034);
                totalAmountEl.textContent = '$' + total.toFixed(2);
                payButton.textContent = 'Pay $' + total.toFixed(2);
                // Create PaymentIntent if not yet created
                if (!paymentIntentClientSecret) createPaymentIntent();
            }
        }

        async function testPay() {
            if (!paymentIntentClientSecret) {
                alert('Payment not ready yet. Wait a moment.');
                return;
            }
            const btn = document.getElementById('testPayBtn');
            btn.textContent = 'Processing test payment...';
            btn.disabled = true;
            try {
                // Extract PaymentIntent ID from client secret (pi_xxx_secret_yyy → pi_xxx)
                const piId = paymentIntentClientSecret.split('_secret_')[0];
                const resp = await fetch(`${API_URL}/api/payments/test-confirm`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ paymentIntentId: piId })
                });
                const data = await resp.json();
                if (data.success) {
                    window.location.href = `/invoices/payment-success.html?payment_intent=${piId}`;
                } else {
                    alert('Test payment failed: ' + (data.error || 'Unknown error'));
                    btn.textContent = 'SANDBOX: TEST PAY (4242)';
                    btn.disabled = false;
                }
            } catch (err) {
                alert('Test payment error: ' + err.message);
                btn.textContent = 'SANDBOX: TEST PAY (4242)';
                btn.disabled = false;
            }
        }

        async function processPayment() {
            const clientId = params.get('clientId');
            const feeText = document.querySelector('.line-item-price').textContent;
            const baseAmount = parseFloat(feeText.replace('$', '')) || 250;

            if (selectedPayment === 'card') {
                if (!stripeInstance || !stripeElements || !paymentIntentClientSecret) {
                    alert('Payment form is still loading. Please wait a moment and try again.');
                    return;
                }

                const payButton = document.getElementById('payButton');
                payButton.textContent = 'Processing...';
                payButton.disabled = true;
                document.getElementById('card-errors').textContent = '';

                const frontendUrl = window.location.origin || 'https://portal.kennagiuziocake.com';

                const { error } = await stripeInstance.confirmPayment({
                    elements: stripeElements,
                    confirmParams: {
                        return_url: `${frontendUrl}/invoices/payment-success.html`
                    }
                });

                // If we get here, there was an error (success redirects automatically)
                if (error) {
                    document.getElementById('card-errors').textContent = error.message;
                    const total = baseAmount + (baseAmount * 0.034);
                    payButton.textContent = 'Pay $' + total.toFixed(2);
                    payButton.disabled = false;
                }
            } else {
                // Zelle or Check — client claims they sent payment (pending verification by Kenna)
                const methodLabel = selectedPayment === 'check' ? 'check' : 'Zelle';

                const payButton = document.getElementById('payButton');
                payButton.textContent = 'Submitting...';
                payButton.disabled = true;

                try {
                    const clientName = document.getElementById('clientName').textContent;
                    const clientEmail = document.getElementById('clientEmail').textContent;
                    const invoiceId = params.get('invoiceId');

                    const resp = await fetch(`${API_URL}/api/payments/offline-claimed`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            invoice_id: invoiceId,
                            invoice_type: 'tasting',
                            client_id: clientId,
                            client_name: clientName,
                            client_email: clientEmail,
                            amount: baseAmount.toFixed(2),
                            payment_method: selectedPayment
                        })
                    });
                    const data = await resp.json();

                    if (data.success) {
                        // Redirect to branded success page with pending flag
                        window.location.href = `/invoices/payment-success.html?pending=true&amount=${baseAmount.toFixed(2)}&method=${selectedPayment}`;
                    } else {
                        alert('There was an issue recording your payment. Please contact kenna@kennagiuziocake.com');
                        payButton.textContent = 'I\'ve Sent Payment';
                        payButton.disabled = false;
                    }
                } catch (err) {
                    console.error('Zelle claim error:', err);
                    alert('There was a connection issue. Please contact kenna@kennagiuziocake.com to confirm your payment.');
                    payButton.textContent = 'I\'ve Sent Payment';
                    payButton.disabled = false;
                }
            }
        }

        function markTastingPaid(clientId) {
            if (!clientId) return;

            // Update portal data
            const portalData = JSON.parse(localStorage.getItem('kgc_portal_' + clientId) || '{}');
            portalData.tastingPaid = true;
            portalData.tastingPaidAt = new Date().toISOString();
            portalData.tastingPaymentMethod = selectedPayment;
            localStorage.setItem('kgc_portal_' + clientId, JSON.stringify(portalData));

            // Update invoice status
            const invoices = JSON.parse(localStorage.getItem('kgc_invoices') || '[]');
            const invoiceId = params.get('invoiceId');
            const invoice = invoices.find(i => i.id === invoiceId);
            if (invoice) {
                invoice.status = 'paid';
                invoice.paidAt = new Date().toISOString();
                invoice.paymentMethod = selectedPayment;
                localStorage.setItem('kgc_invoices', JSON.stringify(invoices));
            }

            // Add to communication log
            addCommLogEntry(clientId, 'tasting_invoice_paid', 'Tasting invoice paid (' + (selectedPayment === 'card' ? 'Card' : 'Zelle') + ')');
        }

        function addCommLogEntry(cId, type, title) {
            const logs = JSON.parse(localStorage.getItem('kgc_comm_logs') || '{}');
            if (!logs[cId]) logs[cId] = [];

            logs[cId].unshift({
                type: type,
                title: title,
                timestamp: new Date().toISOString()
            });

            localStorage.setItem('kgc_comm_logs', JSON.stringify(logs));
        }

        // Load client data from URL params
        const params = new URLSearchParams(window.location.search);

        // Function to populate invoice data from an invoice object
        function populateFromInvoice(invoice) {
            if (!invoice) return false;

            // Get data from invoice.data (JSONB) or from invoice directly
            const data = invoice.data || invoice;

            document.getElementById('clientName').textContent = data.clientName || data.client_name || '';
            document.getElementById('clientEmail').textContent = data.clientEmail || data.client_email || '';
            document.getElementById('clientAddress').textContent = data.clientAddress || data.client_address || data.address || '';
            document.getElementById('invoiceNumber').textContent = invoice.invoice_number || invoice.invoiceNumber || data.invoiceNumber || 'TI-2026-001';

            const createdDate = invoice.created_at || invoice.createdAt || data.createdAt;
            if (createdDate) {
                document.getElementById('invoiceDate').textContent = new Date(createdDate).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
            }

            if (data.eventType) document.getElementById('eventType').textContent = data.eventType;
            if (data.eventDate) document.getElementById('eventDate').textContent = data.eventDate;
            if (data.tastingDate) document.getElementById('tastingDate').textContent = data.tastingDate;
            if (data.tastingTime) document.getElementById('tastingTime').textContent = data.tastingTime;
            if (data.location) {
                const locationEl = document.getElementById('tastingLocation');
                if (locationEl) locationEl.textContent = data.location;
            }
            if (data.arrival) {
                const arrivalEl = document.getElementById('arrivalInstructions');
                if (arrivalEl) arrivalEl.textContent = data.arrival;
            }
            if (data.description) {
                const descEl = document.getElementById('tastingDescription');
                if (descEl) descEl.textContent = data.description;
            }

            const fee = parseFloat(invoice.amount || data.amount || data.fee) || 250;
            const processingFee = fee * 0.034;
            const total = fee + processingFee;

            document.querySelector('.line-item-price').textContent = '$' + fee;
            document.querySelector('.totals-row.subtotal span:last-child').textContent = '$' + fee.toFixed(2);
            document.getElementById('processingFee').textContent = '$' + processingFee.toFixed(2);
            document.getElementById('totalAmount').textContent = '$' + total.toFixed(2);
            document.querySelector('.zelle-amount').textContent = '$' + fee.toFixed(2);
            document.getElementById('payButton').textContent = 'Pay $' + total.toFixed(2) + ' with Card';

            // If invoice is already paid, hide payment section and show paid badge
            if (invoice.status === 'paid') {
                document.getElementById('paymentSection').style.display = 'none';
                document.getElementById('paidBadge').classList.add('visible');

                // In admin view, show payment details in totals
                if (params.get('from') === 'finances') {
                    const method = invoice.payment_method || data.paymentMethod || 'card';
                    const paidDate = invoice.paid_at || data.paidAt;

                    // If paid via Zelle, hide processing fee and show base amount as total
                    if (method === 'zelle') {
                        document.getElementById('processingFeeRow').style.display = 'none';
                        document.getElementById('totalAmount').textContent = '$' + fee.toFixed(2);
                    }

                    // Add paid info row after total
                    const totalsTable = document.querySelector('.totals-table');
                    const paidRow = document.createElement('div');
                    paidRow.className = 'totals-row';
                    paidRow.style.cssText = 'color:#5a6b52; font-size:0.85rem; margin-top:8px; padding-top:8px; border-top:1px solid #e8ede5;';
                    const methodLabel = method === 'zelle' ? 'Zelle' : 'Card';
                    const dateLabel = paidDate ? new Date(paidDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : '';
                    paidRow.innerHTML = `<span>Paid via ${methodLabel}</span><span>${dateLabel}</span>`;
                    totalsTable.appendChild(paidRow);
                }
            }

            // In admin view, if NOT paid, show a sent status badge
            if (invoice.status !== 'paid' && params.get('from') === 'finances') {
                const badge = document.getElementById('paidBadge');
                badge.textContent = '◷ Sent';
                badge.style.background = '#f5eee3';
                badge.style.color = '#8b7355';
                badge.classList.add('visible');
            }

            return true;
        }

        // Function to populate from URL params (fallback)
        function populateFromParams() {
            if (params.get('name')) {
                document.getElementById('clientName').textContent = params.get('name');
            }
            if (params.get('email')) {
                document.getElementById('clientEmail').textContent = params.get('email');
            }
            if (params.get('address')) {
                document.getElementById('clientAddress').textContent = params.get('address');
            }
            if (params.get('eventType')) {
                document.getElementById('eventType').textContent = params.get('eventType');
            }
            if (params.get('eventDate')) {
                document.getElementById('eventDate').textContent = params.get('eventDate');
            }
            if (params.get('tastingDate')) {
                document.getElementById('tastingDate').textContent = params.get('tastingDate');
            }
            if (params.get('tastingTime')) {
                document.getElementById('tastingTime').textContent = params.get('tastingTime');
            }
            if (params.get('fee')) {
                const fee = parseFloat(params.get('fee')) || 250;
                const processingFee = fee * 0.034;
                const total = fee + processingFee;

                document.querySelector('.line-item-price').textContent = '$' + fee;
                document.querySelector('.totals-row.subtotal span:last-child').textContent = '$' + fee.toFixed(2);
                document.getElementById('processingFee').textContent = '$' + processingFee.toFixed(2);
                document.getElementById('totalAmount').textContent = '$' + total.toFixed(2);
                document.querySelector('.zelle-amount').textContent = '$' + fee.toFixed(2);
                document.getElementById('payButton').textContent = 'Pay $' + total.toFixed(2) + ' with Card';
            }
            if (params.get('location')) {
                const locationEl = document.getElementById('tastingLocation');
                if (locationEl) locationEl.textContent = params.get('location');
            }
            if (params.get('arrival')) {
                const arrivalEl = document.getElementById('arrivalInstructions');
                if (arrivalEl) arrivalEl.textContent = params.get('arrival');
            }
            if (params.get('description')) {
                const descEl = document.getElementById('tastingDescription');
                if (descEl) descEl.textContent = params.get('description');
            }
        }

        // Initialize the page
        async function initializePage() {
            const invoiceId = params.get('invoiceId');

            // Check for preview mode
            if (params.get('preview') === 'true') {
                document.getElementById('previewBanner').classList.add('show');
                document.body.classList.add('preview-mode');
            }

            // Show admin sidebar if from admin (has 'from' parameter)
            if (params.get('from') === 'finances') {
                document.body.classList.add('admin-view');
                document.getElementById('backToFinances').classList.add('visible');
                // Admin view = locked invoice — hide payment section entirely
                document.getElementById('paymentSection').style.display = 'none';
            }

            // If we have an invoiceId, try to load the invoice data
            if (invoiceId) {
                let invoiceLoaded = false;

                // First try: Fetch from API (works for clients on different devices)
                try {
                    const response = await fetch(`${API_URL}/api/invoices/${invoiceId}`);
                    if (response.ok) {
                        const invoice = await response.json();
                        invoiceLoaded = populateFromInvoice(invoice);
                    }
                } catch (err) {
                    console.log('API fetch failed, trying localStorage:', err);
                }

                // Second try: localStorage (works for Kenna viewing on same device)
                if (!invoiceLoaded) {
                    const invoices = JSON.parse(localStorage.getItem('kgc_invoices') || '[]');
                    const invoice = invoices.find(i => i.id === invoiceId);
                    if (invoice) {
                        invoiceLoaded = populateFromInvoice(invoice);
                    }
                }

                // If invoice found, we're done
                if (invoiceLoaded) {
                    return;
                }
            }

            // Fallback: populate from URL params
            populateFromParams();

            // Set default invoice number and date if not set by other methods
            if (document.getElementById('invoiceNumber').textContent === 'TI-2026-001') {
                const invoiceNum = invoiceId || ('TI-' + new Date().getFullYear() + '-' + String(Date.now()).slice(-4));
                document.getElementById('invoiceNumber').textContent = invoiceNum;
            }

            document.getElementById('invoiceDate').textContent = new Date().toLocaleDateString('en-US', {
                month: 'long', day: 'numeric', year: 'numeric'
            });
        }

        // Sync tasting date from invoice to client record (so confirmation email can use it)
        async function syncTastingDateToClient() {
            const clientId = params.get('clientId');
            if (!clientId) return;

            const tastingDateEl = document.getElementById('tastingDate');
            const tastingTimeEl = document.getElementById('tastingTime');
            const tastingDate = tastingDateEl ? tastingDateEl.textContent.trim() : '';
            const tastingTime = tastingTimeEl ? tastingTimeEl.textContent.trim() : '';

            // Only sync if we have a real tasting date (not the default placeholder)
            if (!tastingDate || tastingDate === '-' || tastingDate === 'Friday, February 6, 2026') return;

            try {
                // Fetch current client to preserve existing fields
                const resp = await fetch(`${API_URL}/api/clients/${clientId}`);
                if (!resp.ok) return;
                const client = await resp.json();

                // Only update if tasting_date is currently empty
                if (client.tasting_date) return;

                await fetch(`${API_URL}/api/clients/${clientId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: client.name,
                        email: client.email,
                        phone: client.phone || '',
                        address: client.address || '',
                        event_type: client.event_type || '',
                        event_date: client.event_date || '',
                        venue: client.venue || '',
                        guest_count: client.guest_count || '',
                        tasting_date: tastingDate,
                        tasting_time: tastingTime || '',
                        source: client.source || ''
                    })
                });
                console.log('Synced tasting date to client record:', tastingDate);
            } catch (err) {
                console.error('Failed to sync tasting date:', err);
            }
        }

        // Run initialization
        (async () => {
            await initializePage();
            // Sync tasting date to client record for confirmation email
            await syncTastingDateToClient();
            // Initialize Stripe embedded payment if payment section is visible (not paid, not admin view)
            const paySection = document.getElementById('paymentSection');
            if (paySection && paySection.style.display !== 'none') {
                // Show card form container immediately with loading state
                document.getElementById('cardFormContainer').style.display = 'block';
                await initStripe();
                await createPaymentIntent();
            }
        })();
    </script>
</body>
</html>
