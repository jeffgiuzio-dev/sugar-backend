<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="/favicon.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tasting Invoice - Kenna Giuzio Cake</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500&family=Mr+De+Haviland&family=Montserrat:wght@300;400;500&display=swap" rel="stylesheet">
    <script>
        // Run immediately before any rendering - check if we need fade
        if (window.location.search.includes('fade=true')) {
            document.write('<style id="fadeStyle">html{background:#000}body{opacity:0}</style>');
        }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            font-weight: 300;
            background: #faf8f5;
            color: #1a1a1a;
            line-height: 1.6;
            min-height: 100vh;
            padding: 40px 20px;
        }

        /* Sidebar (admin view only) */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 260px;
            background: #fff;
            border-right: 1px solid #eee;
            padding: 30px 0;
            display: none;
            flex-direction: column;
            z-index: 100;
        }

        body.admin-view .sidebar {
            display: flex;
        }

        body.admin-view {
            padding-left: 280px;
        }

        .logo {
            text-align: center;
            padding: 30px 30px 30px;
            border-bottom: 1px solid #eee;
        }

        .logo img {
            width: 160px;
            height: auto;
        }

        .nav-menu {
            padding: 30px 0;
            flex: 1;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 30px;
            color: #666;
            text-decoration: none;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background: #fafafa;
            color: #1a1a1a;
        }

        .nav-item.active {
            background: #fafafa;
            color: #1a1a1a;
            border-left-color: #b5956a;
        }

        .nav-item svg {
            width: 18px;
            height: 18px;
            opacity: 0.7;
        }

        .nav-divider {
            height: 1px;
            background: #eee;
            margin: 15px 30px;
        }

        /* Back Button */
        .back-to-finances {
            display: none;
            max-width: 650px;
            margin: 0 auto 16px;
        }

        .back-to-finances.visible {
            display: block;
        }

        .back-to-finances a {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #666;
            text-decoration: none;
            font-size: 0.85rem;
            padding: 8px 0;
            transition: color 0.2s;
        }

        .back-to-finances a:hover {
            color: #b5956a;
        }

        .invoice-container {
            max-width: 650px;
            margin: 0 auto;
            background: #fff;
            box-shadow: 0 2px 20px rgba(0,0,0,0.08);
        }

        /* Header */
        .invoice-header {
            text-align: center;
            padding: 30px 40px;
            border-bottom: 1px solid #eee;
        }


        .invoice-contact {
            margin-top: 24px;
            font-size: 0.8rem;
            color: #666;
            line-height: 1.8;
        }

        /* Invoice Title */
        .invoice-title-section {
            padding: 40px;
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid #eee;
        }

        .invoice-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 2rem;
            font-weight: 400;
        }

        .paid-badge {
            display: none;
            background: #e8ede5;
            color: #5a6b52;
            padding: 8px 20px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 500;
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-top: 12px;
        }

        .paid-badge.visible {
            display: inline-block;
        }

        .invoice-meta {
            text-align: right;
        }

        .invoice-meta-label {
            font-size: 0.65rem;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: #999;
        }

        .invoice-meta-value {
            font-size: 0.9rem;
            margin-bottom: 12px;
        }

        /* Bill To */
        .bill-to-section {
            padding: 30px 40px;
            background: #fafafa;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
        }

        .bill-to-label {
            font-size: 0.65rem;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: #999;
            margin-bottom: 8px;
        }

        .bill-to-name {
            font-weight: 400;
            font-size: 1rem;
            margin-bottom: 4px;
        }

        .bill-to-email {
            font-size: 0.85rem;
            color: #666;
        }

        .event-details {
            font-size: 0.85rem;
            color: #666;
            line-height: 1.8;
        }

        /* Line Items */
        .line-items {
            padding: 40px;
        }

        .line-item {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 20px;
            padding: 24px 0;
            border-bottom: 1px solid #eee;
        }

        .line-item:last-child {
            border-bottom: none;
        }

        .line-item-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.3rem;
            font-weight: 400;
            margin-bottom: 12px;
        }

        .line-item-desc {
            font-size: 0.85rem;
            color: #666;
            line-height: 1.8;
        }

        .line-item-price {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.5rem;
            font-weight: 400;
            text-align: right;
        }

        /* Tasting Details */
        .tasting-details {
            background: #fafafa;
            padding: 20px 24px;
            margin-top: 16px;
            font-size: 0.85rem;
        }

        .tasting-details-title {
            font-size: 0.65rem;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: #999;
            margin-bottom: 8px;
        }

        .tasting-details p {
            color: #666;
            margin-bottom: 4px;
        }

        /* Totals */
        .totals-section {
            padding: 0 40px 40px;
        }

        .totals-table {
            width: 100%;
            max-width: 280px;
            margin-left: auto;
        }

        .totals-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            font-size: 0.9rem;
        }

        .totals-row.subtotal {
            border-top: 1px solid #eee;
            padding-top: 20px;
        }

        .totals-row.fee {
            color: #999;
            font-size: 0.85rem;
        }

        .totals-row.total {
            border-top: 2px solid #1a1a1a;
            margin-top: 10px;
            padding-top: 16px;
            font-weight: 400;
        }

        .totals-row.total .amount {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.8rem;
        }

        /* Payment Options */
        .payment-section {
            padding: 40px;
            background: #fafafa;
            border-top: 1px solid #eee;
        }

        .payment-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.3rem;
            font-weight: 400;
            margin-bottom: 24px;
            text-align: center;
        }

        .payment-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .payment-option {
            background: #fff;
            border: 1px solid #ddd;
            padding: 28px 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .payment-option:hover {
            border-color: #b5956a;
        }

        .payment-option.selected {
            border-color: #b5956a;
            background: #fffaf5;
        }

        .payment-option-icon {
            font-size: 2rem;
            margin-bottom: 12px;
        }

        .payment-option-title {
            font-weight: 400;
            margin-bottom: 4px;
        }

        .payment-option-desc {
            font-size: 0.75rem;
            color: #999;
        }

        .payment-option-fee {
            margin-top: 8px;
            font-size: 0.7rem;
            color: #b5956a;
        }

        /* Zelle Info */
        .zelle-info {
            display: none;
            margin-top: 24px;
            padding: 24px;
            background: #fff;
            border: 1px solid #ddd;
            text-align: center;
        }

        .zelle-info.visible {
            display: block;
        }

        .zelle-info p {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 8px;
        }

        .zelle-info .zelle-email {
            font-size: 1.1rem;
            font-weight: 400;
            color: #1a1a1a;
            margin: 16px 0;
        }

        .zelle-info .zelle-amount {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.5rem;
        }

        /* Pay Button */
        .pay-button {
            display: block;
            width: 100%;
            padding: 18px 24px;
            margin-top: 24px;
            background: #b5956a;
            color: #fff;
            border: none;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.85rem;
            font-weight: 400;
            letter-spacing: 2px;
            text-transform: uppercase;
            cursor: pointer;
            transition: background 0.2s;
        }

        .pay-button:hover {
            background: #a38559;
        }

        .pay-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* Terms */
        .terms-section {
            padding: 40px;
            border-top: 1px solid #eee;
        }

        .terms-title {
            font-size: 0.65rem;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: #999;
            margin-bottom: 16px;
        }

        .terms-text {
            font-size: 0.8rem;
            color: #666;
            line-height: 1.8;
        }

        .terms-text p {
            margin-bottom: 12px;
        }

        .terms-note {
            background: #fff8e7;
            padding: 16px 20px;
            margin-top: 20px;
            font-size: 0.8rem;
            color: #8b6914;
        }

        /* Footer */
        .invoice-footer {
            text-align: center !important;
            padding: 30px 40px !important;
            background: #fff !important;
            border-top: 1px solid #eee !important;
            color: #666 !important;
        }

        .invoice-footer img {
            width: 240px;
            opacity: 0.7;
            display: block;
            margin: 0 auto 12px;
        }

        .invoice-footer p {
            font-size: 0.75rem;
            color: #999;
            margin-top: 12px;
        }

        /* Hero Banner */
        .hero-banner {
            position: relative;
            height: 200px;
            background: url('../images/header-flowers.jpg') 30% center / cover no-repeat;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding-left: 25px;
        }

        .hero-banner::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.15);
        }

        .hero-banner img {
            position: relative;
            width: 150px;
            z-index: 1;
        }

        /* Responsive */
        @media (max-width: 600px) {
            body {
                padding: 20px 10px;
            }

            .hero-banner {
                height: 140px;
            }

            .hero-banner img {
                width: 220px;
            }

            .invoice-title-section {
                flex-direction: column;
                gap: 20px;
            }

            .invoice-meta {
                text-align: left;
            }

            .bill-to-section {
                grid-template-columns: 1fr;
                gap: 24px;
            }

            .payment-options {
                grid-template-columns: 1fr;
            }

            .invoice-header,
            .line-items,
            .totals-section,
            .terms-section {
                padding-left: 24px;
                padding-right: 24px;
            }
        }

        /* Preview Mode Banner */
        .preview-banner {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #f8f5f0;
            border-bottom: 1px solid #e0d8cc;
            padding: 12px 24px;
            z-index: 1000;
            text-align: center;
        }

        .preview-banner.show {
            display: block;
        }

        .preview-banner-content {
            max-width: 650px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .preview-label {
            font-size: 0.8rem;
            color: #8b7355;
            letter-spacing: 0.5px;
        }

        .preview-back-btn {
            padding: 8px 16px;
            font-size: 0.75rem;
            color: #666;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
            transition: all 0.2s;
        }

        .preview-back-btn:hover {
            border-color: #b5956a;
            color: #b5956a;
        }

        body.preview-mode {
            padding-top: 70px;
        }
    </style>
</head>
<body>
    <!-- Sidebar (admin view only) -->
    <aside class="sidebar">
        <div class="logo">
            <img src="../images/logo.png" alt="Kenna Giuzio Cake">
        </div>

        <nav class="nav-menu">
            <a href="/admin/in-studio.html" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                    <path d="M2 17l10 5 10-5"/>
                    <path d="M2 12l10 5 10-5"/>
                </svg>
                In Studio
            </a>
            <a href="/admin/calendar.html" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                    <line x1="16" y1="2" x2="16" y2="6"/>
                    <line x1="8" y1="2" x2="8" y2="6"/>
                    <line x1="3" y1="10" x2="21" y2="10"/>
                </svg>
                Calendar
            </a>
            <a href="/admin/contacts.html" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
                Contacts
            </a>

            <div class="nav-divider"></div>

            <a href="#" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                    <line x1="16" y1="13" x2="8" y2="13"/>
                    <line x1="16" y1="17" x2="8" y2="17"/>
                </svg>
                Proposals
            </a>
            <a href="/admin/finances.html" class="nav-item active">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <line x1="18" y1="20" x2="18" y2="10"/>
                    <line x1="12" y1="20" x2="12" y2="4"/>
                    <line x1="6" y1="20" x2="6" y2="14"/>
                </svg>
                Finances
            </a>
            <a href="/admin/communications.html" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                </svg>
                Communications
            </a>

            <div class="nav-divider"></div>

            <a href="/admin/settings.html" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                </svg>
                Settings
            </a>
            <a href="/admin/archive.html" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <polyline points="21 8 21 21 3 21 3 8"/>
                    <rect x="1" y="3" width="22" height="5"/>
                    <line x1="10" y1="12" x2="14" y2="12"/>
                </svg>
                Archive
            </a>
        </nav>
    </aside>

    <!-- Preview Banner -->
    <div class="preview-banner" id="previewBanner">
        <div class="preview-banner-content">
            <span class="preview-label">Client Preview</span>
            <button class="preview-back-btn" onclick="window.close()">‚Üê Back to Invoice</button>
        </div>
    </div>

    <!-- Back to Finances Button -->
    <div class="back-to-finances" id="backToFinances">
        <a href="/admin/finances.html">‚Üê Back to Finances</a>
    </div>

    <div class="invoice-container">
        <!-- Hero Banner -->
        <div class="hero-banner">
            <img src="../images/logo.png" alt="Kenna Giuzio Cake">
        </div>

        <!-- Header -->
        <div class="invoice-header">
            <div class="invoice-contact">
                (206) 472-5401 | kenna@kennagiuziocake.com<br>
                Queen Anne, Seattle
            </div>
        </div>

        <!-- Invoice Title -->
        <div class="invoice-title-section">
            <div>
                <h1 class="invoice-title">Tasting Invoice</h1>
                <div class="paid-badge" id="paidBadge">‚úì Paid</div>
            </div>
            <div class="invoice-meta">
                <div class="invoice-meta-label">Invoice #</div>
                <div class="invoice-meta-value" id="invoiceNumber">TI-2026-001</div>
                <div class="invoice-meta-label">Date Issued</div>
                <div class="invoice-meta-value" id="invoiceDate">January 27, 2026</div>
            </div>
        </div>

        <!-- Bill To -->
        <div class="bill-to-section">
            <div>
                <div class="bill-to-label">Bill To</div>
                <div class="bill-to-name" id="clientName">Elizabeth Seelinger</div>
                <div class="bill-to-email" id="clientEmail">eseelinger@gmail.com</div>
            </div>
            <div>
                <div class="bill-to-label">Event Details</div>
                <div class="event-details">
                    <span id="eventType">Wedding</span><br>
                    <span id="eventDate">August 28, 2026</span>
                </div>
            </div>
        </div>

        <!-- Line Items -->
        <div class="line-items">
            <div class="line-item">
                <div>
                    <h3 class="line-item-title">Tasting Party</h3>
                    <p class="line-item-desc" id="tastingDescription" style="white-space: pre-line;">A bespoke tasting party and design consultation for you and your guests at my studio during which we will sample cakes, review designs and discuss your vision.</p>
                    <p style="font-size: 0.7rem; font-style: italic; color: #888; margin-top: 10px; margin-bottom: 14px;">Custom cake commissions begin at $2,500. This tasting is designed to explore fit, flavor, and creative direction before moving forward.</p>
                    <div class="tasting-details">
                        <div class="tasting-details-title">Tasting Details</div>
                        <p id="tastingDate">Friday, February 6, 2026</p>
                        <p id="tastingTime">12:00 PM</p>
                        <p id="tastingLocation">Queen Anne Studio, Seattle</p>
                        <div class="tasting-details-title" style="margin-top: 12px;">Arrival</div>
                        <p id="arrivalInstructions" style="font-size: 0.9rem; line-height: 1.5; white-space: pre-line;">The studio entrance is on the W 3rd Ave side of the house.
I'll meet you there! At the tall white gate in front of my blue studio door.</p>
                    </div>
                </div>
                <div class="line-item-price">$250</div>
            </div>
        </div>

        <!-- Totals -->
        <div class="totals-section">
            <div class="totals-table">
                <div class="totals-row subtotal">
                    <span>Subtotal</span>
                    <span>$250.00</span>
                </div>
                <div class="totals-row fee" id="processingFeeRow">
                    <span>Processing Fee (3.4%)</span>
                    <span id="processingFee">$8.50</span>
                </div>
                <div class="totals-row total">
                    <span>Total</span>
                    <span class="amount" id="totalAmount">$258.50</span>
                </div>
            </div>
        </div>

        <!-- Payment Options -->
        <div class="payment-section" id="paymentSection">
            <h2 class="payment-title">Select Payment Method</h2>
            <div class="payment-options">
                <div class="payment-option selected" data-method="card" onclick="selectPayment('card')">
                    <div class="payment-option-icon">üí≥</div>
                    <div class="payment-option-title">Credit Card</div>
                    <div class="payment-option-desc">Visa, Mastercard, Amex</div>
                    <div class="payment-option-fee">+3.4% processing fee</div>
                </div>
                <div class="payment-option" data-method="zelle" onclick="selectPayment('zelle')">
                    <div class="payment-option-icon">üè¶</div>
                    <div class="payment-option-title">Zelle</div>
                    <div class="payment-option-desc">Direct bank transfer</div>
                    <div class="payment-option-fee">No fee</div>
                </div>
            </div>

            <div class="zelle-info" id="zelleInfo">
                <p>Send payment via Zelle to:</p>
                <div class="zelle-email">kgiuzio@gmail.com</div>
                <p>Amount:</p>
                <div class="zelle-amount">$250.00</div>
                <p style="margin-top: 16px; font-size: 0.75rem;">
                    Please include your name and "Tasting" in the memo.<br>
                    Your date will be confirmed once payment is received.
                </p>
            </div>

            <button class="pay-button" id="payButton" onclick="processPayment()">
                Pay $258.50 with Card
            </button>
        </div>

        <!-- Terms -->
        <div class="terms-section">
            <div class="terms-title">Please Note</div>
            <div class="terms-text">
                <p>
                    This invoice secures a bespoke tasting and design consultation for you and up to four guests
                    at my studio on the agreed upon date. During this session, we will sample cakes, review cake
                    models, and discuss your wedding cake vision. I will also follow up with a detailed proposal
                    for your event.
                </p>
                <p>
                    The tasting fee will be deducted from your final cake invoice if you choose to book.
                </p>
                <div class="terms-note">
                    <strong>Important:</strong> This tasting invoice does not secure your wedding date.
                    If you wish to officially lock in your date, a separate agreement and 50% deposit
                    will be required under a separate invoice.
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="invoice-footer">
            <img src="../images/logo.png" alt="Kenna Giuzio Cake">
            <p>Thank you for considering Kenna Giuzio Cake for your celebration.</p>
        </div>
    </div>

    <script>
        // Handle fade from black if coming from welcome page
        if (window.location.search.includes('fade=true')) {
            // Remove the hide style and add fade-in
            setTimeout(() => {
                // Remove the injected style
                const fadeStyle = document.getElementById('fadeStyle');
                if (fadeStyle) fadeStyle.remove();

                // Apply transitions and fade in
                document.documentElement.style.cssText = 'background: #000; transition: background 3s ease-in-out;';
                document.body.style.cssText = document.body.style.cssText + '; opacity: 0; transition: opacity 3s ease-in-out;';

                // Trigger reflow then fade in
                document.body.offsetHeight;
                document.documentElement.style.background = '#faf8f5';
                document.body.style.opacity = '1';
            }, 500);
        }

        let selectedPayment = 'card';

        function selectPayment(method) {
            selectedPayment = method;

            // Update UI
            document.querySelectorAll('.payment-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.querySelector(`[data-method="${method}"]`).classList.add('selected');

            // Show/hide Zelle info
            const zelleInfo = document.getElementById('zelleInfo');
            const payButton = document.getElementById('payButton');
            const feeRow = document.getElementById('processingFeeRow');
            const totalAmount = document.getElementById('totalAmount');

            if (method === 'zelle') {
                zelleInfo.classList.add('visible');
                payButton.textContent = 'I\'ve Sent Payment via Zelle';
                payButton.style.background = '#8b7355';
                feeRow.style.display = 'none';
                totalAmount.textContent = '$250.00';
            } else {
                zelleInfo.classList.remove('visible');
                payButton.textContent = 'Pay $258.50 with Card';
                payButton.style.background = '#b5956a';
                feeRow.style.display = 'flex';
                totalAmount.textContent = '$258.50';
            }
        }

        const API_URL = 'https://sugar-backend-production.up.railway.app';

        async function processPayment() {
            const clientId = params.get('clientId');
            const clientName = document.getElementById('clientName').textContent;
            const clientEmail = document.getElementById('clientEmail').textContent;
            const invoiceId = params.get('invoiceId');

            // Get the fee amount (base amount without processing fee)
            const feeText = document.querySelector('.line-item-price').textContent;
            const baseAmount = parseFloat(feeText.replace('$', '')) || 250;

            if (selectedPayment === 'card') {
                // Calculate total with processing fee
                const processingFee = baseAmount * 0.034;
                const totalAmount = baseAmount + processingFee;

                const payButton = document.getElementById('payButton');
                payButton.textContent = 'Processing...';
                payButton.disabled = true;

                try {
                    const response = await fetch(`${API_URL}/api/payments/create-checkout`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            invoice_id: invoiceId,
                            invoice_type: 'tasting',
                            client_id: clientId,
                            client_name: clientName,
                            client_email: clientEmail,
                            amount: totalAmount.toFixed(2),
                            description: 'Tasting Party - Kenna Giuzio Cake'
                        })
                    });

                    const data = await response.json();

                    if (data.success && data.url) {
                        // Redirect to Stripe Checkout
                        window.location.href = data.url;
                    } else {
                        throw new Error(data.error || 'Failed to create checkout session');
                    }
                } catch (err) {
                    console.error('Payment error:', err);
                    alert('Unable to process payment. Please try again or contact kenna@kennagiuziocake.com');
                    payButton.textContent = 'Pay $' + totalAmount.toFixed(2) + ' with Card';
                    payButton.disabled = false;
                }
            } else {
                // Zelle confirmation
                if (!confirm('Please confirm you have sent $' + baseAmount.toFixed(2) + ' via Zelle to kgiuzio@gmail.com.\n\nClick OK to confirm your payment has been sent.')) {
                    return;
                }

                // Mark tasting as paid (Zelle - manual confirmation)
                markTastingPaid(clientId);

                // Show success
                alert('Payment confirmed! Thank you.\n\nYour tasting date is now confirmed.');

                // Update button to show paid
                const payButton = document.getElementById('payButton');
                payButton.textContent = '‚úì Paid';
                payButton.style.background = '#8b7355';
                payButton.disabled = true;
            }
        }

        function markTastingPaid(clientId) {
            if (!clientId) return;

            // Update portal data
            const portalData = JSON.parse(localStorage.getItem('kgc_portal_' + clientId) || '{}');
            portalData.tastingPaid = true;
            portalData.tastingPaidAt = new Date().toISOString();
            portalData.tastingPaymentMethod = selectedPayment;
            localStorage.setItem('kgc_portal_' + clientId, JSON.stringify(portalData));

            // Update invoice status
            const invoices = JSON.parse(localStorage.getItem('kgc_invoices') || '[]');
            const invoiceId = params.get('invoiceId');
            const invoice = invoices.find(i => i.id === invoiceId);
            if (invoice) {
                invoice.status = 'paid';
                invoice.paidAt = new Date().toISOString();
                invoice.paymentMethod = selectedPayment;
                localStorage.setItem('kgc_invoices', JSON.stringify(invoices));
            }

            // Add to communication log
            addCommLogEntry(clientId, 'tasting_invoice_paid', 'Tasting invoice paid (' + (selectedPayment === 'card' ? 'Card' : 'Zelle') + ')');
        }

        function addCommLogEntry(cId, type, title) {
            const logs = JSON.parse(localStorage.getItem('kgc_comm_logs') || '{}');
            if (!logs[cId]) logs[cId] = [];

            logs[cId].unshift({
                type: type,
                title: title,
                timestamp: new Date().toISOString()
            });

            localStorage.setItem('kgc_comm_logs', JSON.stringify(logs));
        }

        // Load client data from URL params
        const params = new URLSearchParams(window.location.search);

        // Function to populate invoice data from an invoice object
        function populateFromInvoice(invoice) {
            if (!invoice) return false;

            // Get data from invoice.data (JSONB) or from invoice directly
            const data = invoice.data || invoice;

            document.getElementById('clientName').textContent = data.clientName || data.client_name || '';
            document.getElementById('clientEmail').textContent = data.clientEmail || data.client_email || '';
            document.getElementById('invoiceNumber').textContent = invoice.invoice_number || invoice.invoiceNumber || data.invoiceNumber || 'TI-2026-001';

            const createdDate = invoice.created_at || invoice.createdAt || data.createdAt;
            if (createdDate) {
                document.getElementById('invoiceDate').textContent = new Date(createdDate).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
            }

            if (data.eventType) document.getElementById('eventType').textContent = data.eventType;
            if (data.eventDate) document.getElementById('eventDate').textContent = data.eventDate;
            if (data.tastingDate) document.getElementById('tastingDate').textContent = data.tastingDate;
            if (data.tastingTime) document.getElementById('tastingTime').textContent = data.tastingTime;
            if (data.location) {
                const locationEl = document.getElementById('tastingLocation');
                if (locationEl) locationEl.textContent = data.location;
            }
            if (data.arrival) {
                const arrivalEl = document.getElementById('arrivalInstructions');
                if (arrivalEl) arrivalEl.textContent = data.arrival;
            }
            if (data.description) {
                const descEl = document.getElementById('tastingDescription');
                if (descEl) descEl.textContent = data.description;
            }

            const fee = parseFloat(invoice.amount || data.amount || data.fee) || 250;
            const processingFee = fee * 0.034;
            const total = fee + processingFee;

            document.querySelector('.line-item-price').textContent = '$' + fee;
            document.querySelector('.totals-row.subtotal span:last-child').textContent = '$' + fee.toFixed(2);
            document.getElementById('processingFee').textContent = '$' + processingFee.toFixed(2);
            document.getElementById('totalAmount').textContent = '$' + total.toFixed(2);
            document.querySelector('.zelle-amount').textContent = '$' + fee.toFixed(2);
            document.getElementById('payButton').textContent = 'Pay $' + total.toFixed(2) + ' with Card';

            // If invoice is already paid, hide payment section and show paid badge
            if (invoice.status === 'paid') {
                document.getElementById('paymentSection').style.display = 'none';
                document.getElementById('paidBadge').classList.add('visible');
            }

            return true;
        }

        // Function to populate from URL params (fallback)
        function populateFromParams() {
            if (params.get('name')) {
                document.getElementById('clientName').textContent = params.get('name');
            }
            if (params.get('email')) {
                document.getElementById('clientEmail').textContent = params.get('email');
            }
            if (params.get('eventType')) {
                document.getElementById('eventType').textContent = params.get('eventType');
            }
            if (params.get('eventDate')) {
                document.getElementById('eventDate').textContent = params.get('eventDate');
            }
            if (params.get('tastingDate')) {
                document.getElementById('tastingDate').textContent = params.get('tastingDate');
            }
            if (params.get('tastingTime')) {
                document.getElementById('tastingTime').textContent = params.get('tastingTime');
            }
            if (params.get('fee')) {
                const fee = parseFloat(params.get('fee')) || 250;
                const processingFee = fee * 0.034;
                const total = fee + processingFee;

                document.querySelector('.line-item-price').textContent = '$' + fee;
                document.querySelector('.totals-row.subtotal span:last-child').textContent = '$' + fee.toFixed(2);
                document.getElementById('processingFee').textContent = '$' + processingFee.toFixed(2);
                document.getElementById('totalAmount').textContent = '$' + total.toFixed(2);
                document.querySelector('.zelle-amount').textContent = '$' + fee.toFixed(2);
                document.getElementById('payButton').textContent = 'Pay $' + total.toFixed(2) + ' with Card';
            }
            if (params.get('location')) {
                const locationEl = document.getElementById('tastingLocation');
                if (locationEl) locationEl.textContent = params.get('location');
            }
            if (params.get('arrival')) {
                const arrivalEl = document.getElementById('arrivalInstructions');
                if (arrivalEl) arrivalEl.textContent = params.get('arrival');
            }
            if (params.get('description')) {
                const descEl = document.getElementById('tastingDescription');
                if (descEl) descEl.textContent = params.get('description');
            }
        }

        // Initialize the page
        async function initializePage() {
            const invoiceId = params.get('invoiceId');

            // Check for preview mode
            if (params.get('preview') === 'true') {
                document.getElementById('previewBanner').classList.add('show');
                document.body.classList.add('preview-mode');
            }

            // Show admin sidebar if from admin (has 'from' parameter)
            if (params.get('from') === 'finances') {
                document.body.classList.add('admin-view');
                document.getElementById('backToFinances').classList.add('visible');
            }

            // If we have an invoiceId, try to load the invoice data
            if (invoiceId) {
                let invoiceLoaded = false;

                // First try: Fetch from API (works for clients on different devices)
                try {
                    const response = await fetch(`${API_URL}/api/invoices/${invoiceId}`);
                    if (response.ok) {
                        const invoice = await response.json();
                        invoiceLoaded = populateFromInvoice(invoice);
                    }
                } catch (err) {
                    console.log('API fetch failed, trying localStorage:', err);
                }

                // Second try: localStorage (works for Kenna viewing on same device)
                if (!invoiceLoaded) {
                    const invoices = JSON.parse(localStorage.getItem('kgc_invoices') || '[]');
                    const invoice = invoices.find(i => i.id === invoiceId);
                    if (invoice) {
                        invoiceLoaded = populateFromInvoice(invoice);
                    }
                }

                // If invoice found, we're done
                if (invoiceLoaded) {
                    return;
                }
            }

            // Fallback: populate from URL params
            populateFromParams();

            // Set default invoice number and date if not set by other methods
            if (document.getElementById('invoiceNumber').textContent === 'TI-2026-001') {
                const invoiceNum = invoiceId || ('TI-' + new Date().getFullYear() + '-' + String(Date.now()).slice(-4));
                document.getElementById('invoiceNumber').textContent = invoiceNum;
            }

            document.getElementById('invoiceDate').textContent = new Date().toLocaleDateString('en-US', {
                month: 'long', day: 'numeric', year: 'numeric'
            });
        }

        // Run initialization
        initializePage();
    </script>
</body>
</html>
