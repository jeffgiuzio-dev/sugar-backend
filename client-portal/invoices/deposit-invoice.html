<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="/favicon.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deposit Invoice - Kenna Giuzio Cake</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500&family=Mr+De+Haviland&family=Montserrat:wght@300;400;500&display=swap" rel="stylesheet">
    <script src="https://js.stripe.com/v3/"></script>
    <script>
        // Run immediately before any rendering - check if we need fade
        if (window.location.search.includes('fade=true')) {
            document.write('<style id="fadeStyle">html{background:#000}body{opacity:0}</style>');
        }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            font-weight: 300;
            background: #f5f5f5;
            color: #1a1a1a;
            line-height: 1.6;
            min-height: 100vh;
            padding: 40px 20px;
        }

        .invoice-container {
            max-width: 650px;
            margin: 0 auto;
            background: #fff;
            box-shadow: 0 2px 20px rgba(0,0,0,0.08);
        }

        /* Hero Banner */
        .hero-banner {
            position: relative;
            height: 200px;
            background: url('../images/header-flowers.jpg') 30% center / cover no-repeat;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding-left: 25px;
        }

        .hero-banner::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.15);
        }

        .hero-banner img {
            position: relative;
            width: 150px;
            z-index: 1;
        }

        /* Header */
        .invoice-header {
            text-align: center;
            padding: 30px 40px;
            border-bottom: 1px solid #eee;
        }

        .invoice-contact {
            margin-top: 24px;
            font-size: 0.8rem;
            color: #666;
            line-height: 1.8;
        }

        /* Invoice Title */
        .invoice-title-section {
            padding: 40px;
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid #eee;
        }

        .invoice-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 2rem;
            font-weight: 400;
        }

        .invoice-subtitle {
            font-size: 0.85rem;
            color: #b5956a;
            margin-top: 4px;
        }

        .invoice-meta {
            text-align: right;
        }

        .invoice-meta-label {
            font-size: 0.65rem;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: #999;
        }

        .invoice-meta-value {
            font-size: 0.9rem;
            margin-bottom: 12px;
        }

        /* Bill To */
        .bill-to-section {
            padding: 30px 40px;
            background: #fafafa;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
        }

        .bill-to-label {
            font-size: 0.65rem;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: #999;
            margin-bottom: 8px;
        }

        .bill-to-name {
            font-weight: 400;
            font-size: 1rem;
            margin-bottom: 4px;
        }

        .bill-to-email {
            font-size: 0.85rem;
            color: #666;
        }

        .event-details {
            font-size: 0.85rem;
            color: #666;
            line-height: 1.8;
        }

        /* Summary Box */
        .summary-box {
            padding: 30px 40px;
            background: #fffaf5;
            border-bottom: 1px solid #eee;
        }

        .summary-title {
            font-size: 0.65rem;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: #999;
            margin-bottom: 16px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 0.9rem;
        }

        .summary-row.highlight {
            background: #fff;
            margin: 16px -20px 0;
            padding: 16px 20px;
            border: 1px solid #b5956a;
        }

        .summary-row.highlight .label {
            font-weight: 400;
            color: #b5956a;
        }

        .summary-row.highlight .amount {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.5rem;
            color: #b5956a;
        }

        /* Line Items */
        .line-items {
            padding: 40px;
        }

        .line-items-title {
            font-size: 0.65rem;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: #999;
            margin-bottom: 20px;
        }

        .line-item {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 20px;
            padding: 16px 0;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
        }

        .line-item:last-child {
            border-bottom: none;
        }

        .line-item-name {
            color: #1a1a1a;
        }

        .line-item-desc {
            font-size: 0.8rem;
            color: #999;
            margin-top: 4px;
        }

        .line-item-price {
            text-align: right;
            color: #666;
        }

        /* Totals */
        .totals-section {
            padding: 0 40px 40px;
        }

        .totals-table {
            width: 100%;
            max-width: 300px;
            margin-left: auto;
        }

        .totals-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            font-size: 0.9rem;
        }

        .totals-row.subtotal {
            border-top: 1px solid #eee;
            padding-top: 20px;
        }

        .totals-row.fee {
            color: #999;
            font-size: 0.85rem;
        }

        .totals-row.deposit {
            border-top: 2px solid #b5956a;
            margin-top: 10px;
            padding-top: 16px;
            font-weight: 400;
            color: #b5956a;
        }

        .totals-row.deposit .amount {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.8rem;
        }

        .totals-row.balance {
            color: #999;
            font-size: 0.85rem;
        }

        /* Payment Options */
        .payment-section {
            padding: 40px;
            background: #fafafa;
            border-top: 1px solid #eee;
        }

        .payment-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.3rem;
            font-weight: 400;
            margin-bottom: 24px;
            text-align: center;
        }

        .payment-options {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 14px;
        }

        .payment-option {
            background: #fff;
            border: 1px solid #e8e0d5;
            padding: 16px 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .payment-option:hover {
            border-color: #b5956a;
        }

        .payment-option.selected {
            border-color: #b5956a;
            background: #fdf9f4;
        }

        .payment-option-title {
            font-size: 0.85rem;
            font-weight: 400;
            margin-bottom: 2px;
        }

        .payment-option-desc {
            font-size: 0.65rem;
            color: #b5956a;
            letter-spacing: 0.3px;
        }

        .payment-option-fee {
            margin-top: 4px;
            font-size: 0.6rem;
            color: #999;
        }

        /* Paid Badge */
        .paid-badge {
            display: none;
            background: #e8ede5;
            color: #5a6b52;
            padding: 8px 20px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 500;
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-top: 12px;
        }

        .paid-badge.visible {
            display: inline-block;
        }

        /* Back to Finances */
        .back-to-finances {
            display: none;
            max-width: 650px;
            margin: 0 auto 16px;
        }

        .back-to-finances.visible {
            display: block;
        }

        .back-to-finances a {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #666;
            text-decoration: none;
            font-size: 0.85rem;
            padding: 8px 0;
            transition: color 0.2s;
        }

        .back-to-finances a:hover {
            color: #b5956a;
        }

        /* Zelle Info */
        .zelle-info {
            display: none;
            margin-top: 24px;
            padding: 24px;
            background: #fff;
            border: 1px solid #ddd;
            text-align: center;
        }

        .zelle-info.visible {
            display: block;
        }

        .zelle-info p {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 8px;
        }

        .zelle-info .zelle-email {
            font-size: 1.1rem;
            font-weight: 400;
            color: #1a1a1a;
            margin: 16px 0;
        }

        .zelle-info .zelle-amount {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.5rem;
        }

        /* Pay Button */
        .pay-button {
            display: block;
            width: 100%;
            padding: 18px 24px;
            margin-top: 24px;
            background: #b5956a;
            color: #fff;
            border: none;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.85rem;
            font-weight: 400;
            letter-spacing: 2px;
            text-transform: uppercase;
            cursor: pointer;
            transition: background 0.2s;
        }

        .pay-button:hover {
            background: #a38559;
        }

        .pay-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* Terms */
        .terms-section {
            padding: 40px;
            border-top: 1px solid #eee;
        }

        .terms-title {
            font-size: 0.65rem;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: #999;
            margin-bottom: 16px;
        }

        .terms-text {
            font-size: 0.8rem;
            color: #666;
            line-height: 1.8;
        }

        .terms-text p {
            margin-bottom: 12px;
        }

        .terms-schedule {
            background: #fafafa;
            padding: 20px;
            margin: 20px 0;
        }

        .terms-schedule-title {
            font-size: 0.65rem;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: #999;
            margin-bottom: 12px;
        }

        .terms-schedule-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 0.85rem;
            border-bottom: 1px solid #eee;
        }

        .terms-schedule-item:last-child {
            border-bottom: none;
        }

        .terms-schedule-item .status {
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 10px;
        }

        .terms-schedule-item .status.due {
            background: #f5efe8;
            color: #b5956a;
        }

        .terms-schedule-item .status.upcoming {
            background: #eef1ec;
            color: #6b7d63;
        }

        .terms-note {
            background: #eef1ec;
            padding: 16px 20px;
            margin-top: 20px;
            font-size: 0.8rem;
            color: #6b7d63;
        }

        /* Footer */
        .invoice-footer {
            text-align: center;
            padding: 30px 40px;
            background: #fff;
            border-top: 1px solid #eee;
        }

        .invoice-footer img {
            width: 240px;
            opacity: 0.7;
            display: block;
            margin: 0 auto 12px;
        }

        .invoice-footer p {
            font-size: 0.75rem;
            color: #999;
            margin-top: 12px;
        }

        /* Responsive */
        @media (max-width: 600px) {
            body {
                padding: 20px 10px;
            }

            .hero-banner {
                height: 140px;
            }

            .hero-banner img {
                width: 220px;
            }

            .invoice-title-section {
                flex-direction: column;
                gap: 20px;
            }

            .invoice-meta {
                text-align: left;
            }

            .bill-to-section {
                grid-template-columns: 1fr;
                gap: 24px;
            }

            .payment-options {
                grid-template-columns: 1fr;
            }

            .invoice-header,
            .line-items,
            .totals-section,
            .terms-section {
                padding-left: 24px;
                padding-right: 24px;
            }
        }
    </style>
</head>
<body>
    <!-- Back to Finances Button -->
    <div class="back-to-finances" id="backToFinances">
        <a href="/admin/finances.html">← Back to Finances</a>
    </div>

    <div class="invoice-container">
        <!-- Hero Banner -->
        <div class="hero-banner">
            <img src="../images/logo.png" alt="Kenna Giuzio Cake">
        </div>

        <!-- Header -->
        <div class="invoice-header">
            <div class="invoice-contact">
                (206) 472-5401 | kenna@kennagiuziocake.com<br>
                Queen Anne, Seattle
            </div>
        </div>

        <!-- Invoice Title -->
        <div class="invoice-title-section">
            <div>
                <h1 class="invoice-title" id="invoiceTitle">Deposit Invoice</h1>
                <p class="invoice-subtitle" id="invoiceSubtitle">50% to Reserve Your Date</p>
                <div class="paid-badge" id="paidBadge">✓ Paid</div>
            </div>
            <div class="invoice-meta">
                <div class="invoice-meta-label">Invoice #</div>
                <div class="invoice-meta-value" id="invoiceNumber">DI-2026-001</div>
                <div class="invoice-meta-label">Date Issued</div>
                <div class="invoice-meta-value" id="invoiceDate">January 31, 2026</div>
            </div>
        </div>

        <!-- Bill To -->
        <div class="bill-to-section">
            <div>
                <div class="bill-to-label">Bill To</div>
                <div class="bill-to-name" id="clientName">Client Name</div>
                <div class="bill-to-email" id="clientEmail">client@email.com</div>
                <div class="bill-to-address" id="clientAddress" style="font-size: 0.85rem; color: #666; margin-top: 4px;"></div>
            </div>
            <div>
                <div class="bill-to-label">Event Details</div>
                <div class="event-details">
                    <span id="eventType">Wedding</span><br>
                    <span id="eventDate">Date TBD</span><br>
                    <span id="venue">Venue TBD</span>
                </div>
            </div>
        </div>

        <!-- Summary Box - Combined Payment Summary and Proposal Details -->
        <div class="summary-box">
            <div class="summary-title">From Your Proposal <span id="proposalNumber" style="font-weight: 400;"></span></div>
            <div id="lineItemsList" style="margin-bottom: 16px;">
                <!-- Line items will be populated dynamically -->
            </div>
            <div class="summary-row" style="border-top: 1px solid #eee; padding-top: 12px;">
                <span class="label">Proposal Total</span>
                <span class="amount" id="proposalTotal">$0.00</span>
            </div>
            <div class="summary-row">
                <span class="label">Less: Tasting Credit</span>
                <span class="amount" id="tastingCredit">-$250.00</span>
            </div>
            <div class="summary-row">
                <span class="label">Adjusted Total</span>
                <span class="amount" id="adjustedTotal">$0.00</span>
            </div>
            <div class="summary-row highlight">
                <span class="label">50% Deposit Due Now</span>
                <span class="amount" id="depositAmount">$0.00</span>
            </div>
        </div>

        <!-- Totals -->
        <div class="totals-section">
            <div class="totals-table">
                <div class="totals-row subtotal">
                    <span>Deposit (50%)</span>
                    <span id="subtotalAmount">$0.00</span>
                </div>
                <div class="totals-row fee" id="processingFeeRow">
                    <span>Processing Fee (3%)</span>
                    <span id="processingFee">$0.00</span>
                </div>
                <div class="totals-row deposit">
                    <span>Total Due</span>
                    <span class="amount" id="totalDue">$0.00</span>
                </div>
                <div class="totals-row balance">
                    <span>Remaining Balance (due before event)</span>
                    <span id="remainingBalance">$0.00</span>
                </div>
            </div>
        </div>

        <!-- Terms -->
        <div class="terms-section">
            <div class="terms-title">Payment Terms</div>
            <div class="terms-text">
                <p>
                    Thank you for choosing Kenna Giuzio Cake for your celebration! This deposit invoice
                    secures your event date and begins the creation process for your custom cake.
                </p>

                <div class="terms-schedule">
                    <div class="terms-schedule-title">Payment Schedule</div>
                    <div class="terms-schedule-item">
                        <span><strong>Deposit (50%)</strong> - Due now to reserve date</span>
                        <span class="status due">DUE NOW</span>
                    </div>
                    <div class="terms-schedule-item">
                        <span><strong>Balance (50%)</strong> - Due 2 weeks before event</span>
                        <span class="status upcoming">UPCOMING</span>
                    </div>
                </div>

                <div class="terms-note">
                    <strong>Your date is not reserved until deposit is received.</strong>
                    Once payment is confirmed, you will receive an email confirmation with your
                    reserved date and next steps.
                </div>
            </div>
        </div>

        <!-- Payment Options -->
        <div class="payment-section" id="paymentSection">
            <h2 class="payment-title">Select Payment Method</h2>
            <div class="payment-options">
                <div class="payment-option selected" data-method="card" onclick="selectPayment('card')">
                    <div class="payment-option-title">Credit Card</div>
                    <div class="payment-option-desc">Visa, Mastercard, Amex</div>
                    <div class="payment-option-fee">+3% processing fee</div>
                </div>
                <div class="payment-option" data-method="zelle" onclick="selectPayment('zelle')">
                    <div class="payment-option-title">Zelle</div>
                    <div class="payment-option-desc">Direct bank transfer</div>
                    <div class="payment-option-fee">No fee</div>
                </div>
                <div class="payment-option" data-method="check" onclick="selectPayment('check')">
                    <div class="payment-option-title">Check</div>
                    <div class="payment-option-desc">Mail a check</div>
                    <div class="payment-option-fee">No fee</div>
                </div>
            </div>

            <div class="zelle-info" id="zelleInfo">
                <p><strong>Zelle:</strong> Send payment to:</p>
                <div class="zelle-email">kgiuzio@gmail.com</div>
                <p>Amount:</p>
                <div class="zelle-amount" id="zelleAmount">$0.00</div>
                <p style="margin-top: 12px; font-size: 0.8rem; color: #999;">
                    Please include your name and "Deposit" in the memo.<br>
                    Your date will be officially reserved once payment is verified.
                </p>
            </div>

            <div class="zelle-info" id="checkInfo">
                <p><strong>Make payable and mail to:</strong><br>
                <strong>Kenna Giuzio Cake</strong><br>
                <strong>302 W Howe St</strong><br>
                <strong>Seattle, WA 98119</strong></p>
                <p>Amount:</p>
                <div class="zelle-amount" id="checkAmount">$0.00</div>
                <p style="margin-top: 12px; font-size: 0.85rem; color: #666;">
                    Please include your name and "Deposit" in the memo.
                </p>
                <p style="margin-top: 12px; font-size: 0.8rem; color: #999;">
                    Your date will be confirmed once payment is verified.
                </p>
            </div>

            <!-- Embedded Card Form (Stripe Payment Element) -->
            <div id="cardFormContainer" style="margin-top: 24px; display: none;">
                <div style="background: #fff; border: 1px solid #e8e0d5; padding: 24px; border-radius: 4px; min-height: 60px;">
                    <div id="payment-element-loading" style="text-align: center; color: #999; font-size: 0.8rem; padding: 16px 0;">Loading payment form...</div>
                    <div id="payment-element"></div>
                </div>
                <div id="card-errors" style="color: #df1b41; font-size: 0.8rem; margin-top: 8px; min-height: 20px;"></div>
            </div>

            <button class="pay-button" id="payButton" onclick="processPayment()">
                Pay Deposit with Card
            </button>

            <!-- Sandbox test button -->
            <button id="testPayBtn" onclick="testPay()" style="display:none; width:100%; margin-top:12px; padding:14px 24px; background:#e8e0d5; color:#666; border:1px dashed #ccc; border-radius:8px; font-family:'Montserrat',sans-serif; font-size:0.8rem; cursor:pointer; letter-spacing:1px;">
                SANDBOX: TEST PAY (4242)
            </button>
        </div>

        <!-- Footer -->
        <div class="invoice-footer">
            <img src="../images/logo.png" alt="Kenna Giuzio Cake">
            <p>Thank you for choosing Kenna Giuzio Cake for your celebration.</p>
        </div>
    </div>

    <!-- API Client -->
    <script src="/js/api.js"></script>
    <script>
        // Load clients from API and sync to localStorage
        async function loadClientsFromAPI() {
            try {
                const clients = await getClients();
                localStorage.setItem('kgc_clients', JSON.stringify(clients));
                console.log('Deposit invoice: Loaded', clients.length, 'clients from API');
            } catch (error) {
                console.log('Deposit invoice: Using localStorage fallback:', error.message);
            }
        }

        // Start API loading in background
        loadClientsFromAPI();

        // Handle fade from black if coming from welcome page
        if (window.location.search.includes('fade=true')) {
            setTimeout(() => {
                const fadeStyle = document.getElementById('fadeStyle');
                if (fadeStyle) fadeStyle.remove();
                document.documentElement.style.cssText = 'background: #000; transition: background 3s ease-in-out;';
                document.body.style.cssText = document.body.style.cssText + '; opacity: 0; transition: opacity 3s ease-in-out;';
                document.body.offsetHeight;
                document.documentElement.style.background = '#f5f5f5';
                document.body.style.opacity = '1';
            }, 500);
        }

        let selectedPayment = 'card';
        let depositAmount = 0;
        let depositWithFee = 0;
        let clientId = null;
        let invoiceId = null;

        // Stripe embedded payment state
        let stripeInstance = null;
        let stripeElements = null;
        let paymentIntentClientSecret = null;
        let paymentElementMounted = false;

        // Mode detection
        const params = new URLSearchParams(window.location.search);
        const isFinalBalance = params.get('mode') === 'final-balance';
        const isLockDeposit = params.get('mode') === 'lock-deposit';
        const invoiceType = isFinalBalance ? 'final' : isLockDeposit ? 'lock_deposit' : 'deposit';
        const invoicePrefix = isFinalBalance ? 'FB-' : isLockDeposit ? 'LI-' : 'DI-';

        const API_URL = 'https://sugar-backend-production.up.railway.app';

        // Initialize Stripe with publishable key from backend
        async function initStripe() {
            const loadingEl = document.getElementById('payment-element-loading');
            try {
                if (typeof Stripe === 'undefined') {
                    document.getElementById('card-errors').textContent = 'Payment system failed to load. Please refresh the page.';
                    if (loadingEl) loadingEl.style.display = 'none';
                    return;
                }
                const resp = await fetch(`${API_URL}/api/stripe/status`);
                const data = await resp.json();
                if (data.configured && data.publishableKey) {
                    stripeInstance = Stripe(data.publishableKey);
                    // Show sandbox test button if using test keys
                    if (data.publishableKey.startsWith('pk_test_')) {
                        document.getElementById('testPayBtn').style.display = 'block';
                    }
                } else {
                    document.getElementById('card-errors').textContent = 'Payment system is not configured.';
                    if (loadingEl) loadingEl.style.display = 'none';
                }
            } catch (err) {
                console.error('Failed to init Stripe:', err);
                document.getElementById('card-errors').textContent = 'Failed to connect to payment system.';
                if (loadingEl) loadingEl.style.display = 'none';
            }
        }

        // Create PaymentIntent and mount the Payment Element
        async function createPaymentIntent() {
            const loadingEl = document.getElementById('payment-element-loading');
            if (!stripeInstance) {
                document.getElementById('card-errors').textContent = 'Stripe failed to initialize. Please refresh.';
                if (loadingEl) loadingEl.style.display = 'none';
                return;
            }
            if (paymentIntentClientSecret) return;

            const clientName = document.getElementById('clientName').textContent;
            const clientEmail = document.getElementById('clientEmail').textContent;
            const description = isFinalBalance
                ? 'Final Balance - Kenna Giuzio Cake'
                : isLockDeposit
                ? 'Lock the Date Deposit - Kenna Giuzio Cake'
                : 'Deposit (50%) - Kenna Giuzio Cake';

            try {
                const response = await fetch(`${API_URL}/api/payments/create-payment-intent`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        invoice_id: invoiceId,
                        invoice_type: invoiceType,
                        client_id: clientId,
                        client_name: clientName,
                        client_email: clientEmail,
                        amount: depositWithFee.toFixed(2),
                        description: description
                    })
                });

                const data = await response.json();
                if (data.success && data.clientSecret) {
                    paymentIntentClientSecret = data.clientSecret;
                    mountPaymentElement();
                } else {
                    console.error('PaymentIntent failed:', data);
                    document.getElementById('card-errors').textContent = 'Failed to initialize payment. Please refresh.';
                    if (loadingEl) loadingEl.style.display = 'none';
                }
            } catch (err) {
                console.error('Failed to create PaymentIntent:', err);
                document.getElementById('card-errors').textContent = 'Failed to connect to payment server.';
                if (loadingEl) loadingEl.style.display = 'none';
            }
        }

        // Mount the Stripe Payment Element with Kenna's branding
        function mountPaymentElement() {
            if (paymentElementMounted || !stripeInstance || !paymentIntentClientSecret) return;

            const appearance = {
                theme: 'stripe',
                variables: {
                    colorPrimary: '#b5956a',
                    colorBackground: '#faf8f5',
                    fontFamily: 'Montserrat, sans-serif',
                    borderRadius: '4px',
                    colorText: '#1a1a1a',
                    colorTextSecondary: '#666',
                    colorDanger: '#df1b41'
                },
                rules: {
                    '.Input': {
                        border: '1px solid #e8e0d5',
                        boxShadow: 'none'
                    },
                    '.Input:focus': {
                        border: '1px solid #b5956a',
                        boxShadow: '0 0 0 1px #b5956a'
                    },
                    '.Label': {
                        color: '#666',
                        fontSize: '0.8rem',
                        fontWeight: '400',
                        textTransform: 'uppercase',
                        letterSpacing: '0.5px'
                    }
                }
            };

            stripeElements = stripeInstance.elements({
                clientSecret: paymentIntentClientSecret,
                appearance: appearance,
                fonts: [{
                    cssSrc: 'https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500'
                }]
            });

            const paymentElement = stripeElements.create('payment', {
                layout: 'tabs',
                wallets: {
                    link: 'never'
                }
            });
            paymentElement.on('ready', () => {
                document.getElementById('payment-element-loading').style.display = 'none';
            });
            paymentElement.on('loaderror', (event) => {
                document.getElementById('card-errors').textContent = 'Card form failed to load: ' + (event.error ? event.error.message : 'unknown error');
                document.getElementById('payment-element-loading').style.display = 'none';
            });
            paymentElement.mount('#payment-element');
            paymentElementMounted = true;

            // Fallback: if element doesn't load in 15 seconds, show help message
            setTimeout(() => {
                const loadEl = document.getElementById('payment-element-loading');
                if (loadEl && loadEl.style.display !== 'none') {
                    loadEl.innerHTML = 'Card form is taking longer than expected.<br><span style="font-size:0.75rem;">Try disabling ad blockers or refreshing the page.</span>';
                }
            }, 15000);

            // Show the card form
            document.getElementById('cardFormContainer').style.display = 'block';
        }

        function selectPayment(method) {
            selectedPayment = method;

            // Update UI
            document.querySelectorAll('.payment-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.querySelector(`[data-method="${method}"]`).classList.add('selected');

            // Show/hide info sections and card form
            const zelleInfo = document.getElementById('zelleInfo');
            const checkInfo = document.getElementById('checkInfo');
            const cardForm = document.getElementById('cardFormContainer');
            const payButton = document.getElementById('payButton');
            const feeRow = document.getElementById('processingFeeRow');
            const totalDue = document.getElementById('totalDue');

            // Hide all method-specific info first
            zelleInfo.classList.remove('visible');
            checkInfo.classList.remove('visible');
            cardForm.style.display = 'none';

            if (method === 'zelle') {
                zelleInfo.classList.add('visible');
                payButton.textContent = "I've Sent Payment";
                payButton.style.background = '#8b7355';
                feeRow.style.display = 'none';
                totalDue.textContent = formatCurrency(depositAmount);
            } else if (method === 'check') {
                checkInfo.classList.add('visible');
                payButton.textContent = "I've Sent a Check";
                payButton.style.background = '#8b7355';
                feeRow.style.display = 'none';
                totalDue.textContent = formatCurrency(depositAmount);
            } else {
                if (paymentElementMounted) cardForm.style.display = 'block';
                payButton.textContent = 'Pay ' + formatCurrency(depositWithFee) + ' with Card';
                payButton.style.background = '#b5956a';
                feeRow.style.display = 'flex';
                totalDue.textContent = formatCurrency(depositWithFee);
                // Create PaymentIntent if not yet created
                if (!paymentIntentClientSecret) createPaymentIntent();
            }
        }

        async function testPay() {
            if (!paymentIntentClientSecret) {
                alert('Payment not ready yet. Wait a moment.');
                return;
            }
            const btn = document.getElementById('testPayBtn');
            btn.textContent = 'Processing test payment...';
            btn.disabled = true;
            try {
                const piId = paymentIntentClientSecret.split('_secret_')[0];
                const resp = await fetch(`${API_URL}/api/payments/test-confirm`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ paymentIntentId: piId })
                });
                const data = await resp.json();
                if (data.success) {
                    window.location.href = `/invoices/payment-success.html?payment_intent=${piId}`;
                } else {
                    alert('Test payment failed: ' + (data.error || 'Unknown error'));
                    btn.textContent = 'SANDBOX: TEST PAY (4242)';
                    btn.disabled = false;
                }
            } catch (err) {
                alert('Test payment error: ' + err.message);
                btn.textContent = 'SANDBOX: TEST PAY (4242)';
                btn.disabled = false;
            }
        }

        async function processPayment() {
            if (selectedPayment === 'card') {
                if (!stripeInstance || !stripeElements || !paymentIntentClientSecret) {
                    alert('Payment form is still loading. Please wait a moment and try again.');
                    return;
                }

                const payButton = document.getElementById('payButton');
                payButton.textContent = 'Processing...';
                payButton.disabled = true;
                document.getElementById('card-errors').textContent = '';

                const frontendUrl = window.location.origin || 'https://portal.kennagiuziocake.com';

                const { error } = await stripeInstance.confirmPayment({
                    elements: stripeElements,
                    confirmParams: {
                        return_url: `${frontendUrl}/invoices/payment-success.html`
                    }
                });

                // If we get here, there was an error (success redirects automatically)
                if (error) {
                    document.getElementById('card-errors').textContent = error.message;
                    payButton.textContent = 'Pay ' + formatCurrency(depositWithFee) + ' with Card';
                    payButton.disabled = false;
                }
            } else {
                // Zelle or Check — client claims they sent payment (pending verification by Kenna)
                const payButton = document.getElementById('payButton');
                payButton.textContent = 'Submitting...';
                payButton.disabled = true;

                try {
                    const clientName = document.getElementById('clientName').textContent;
                    const clientEmail = document.getElementById('clientEmail').textContent;
                    const memoType = isFinalBalance ? 'Final Balance' : isLockDeposit ? 'Lock Deposit' : 'Deposit';

                    const resp = await fetch(`${API_URL}/api/payments/offline-claimed`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            invoice_id: invoiceId,
                            invoice_type: invoiceType,
                            client_id: clientId,
                            client_name: clientName,
                            client_email: clientEmail,
                            amount: depositAmount.toFixed(2),
                            payment_method: selectedPayment
                        })
                    });
                    const data = await resp.json();

                    if (data.success) {
                        // Redirect to branded success page with pending flag
                        window.location.href = `/invoices/payment-success.html?pending=true&amount=${depositAmount.toFixed(2)}&method=${selectedPayment}`;
                    } else {
                        alert('There was an issue recording your payment. Please contact kenna@kennagiuziocake.com');
                        payButton.textContent = "I've Sent Payment";
                        payButton.disabled = false;
                    }
                } catch (err) {
                    console.error('Offline claim error:', err);
                    alert('There was a connection issue. Please contact kenna@kennagiuziocake.com to confirm your payment.');
                    payButton.textContent = "I've Sent Payment";
                    payButton.disabled = false;
                }
            }
        }

        function formatCurrency(amount) {
            return '$' + Math.floor(amount).toLocaleString();
        }

        function formatDate(dateStr) {
            if (!dateStr || dateStr === 'undefined' || dateStr === 'null') return 'TBD';
            try {
                // Handle both "2026-03-15" and "2026-03-15T00:00:00.000Z"
                const clean = dateStr.includes('T') ? dateStr.split('T')[0] : dateStr;
                const date = new Date(clean + 'T00:00:00');
                if (isNaN(date.getTime())) return 'TBD';
                return date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
            } catch(e) {
                return 'TBD';
            }
        }

        // Initialize the page
        async function initializePage() {
            // Get client ID
            clientId = params.get('clientId');
            invoiceId = params.get('invoiceId');

            // Admin locked view — from finances page
            if (params.get('from') === 'finances') {
                document.getElementById('backToFinances').classList.add('visible');
                document.getElementById('paymentSection').style.display = 'none';
            }

            // Final balance mode — update titles and labels
            if (isFinalBalance) {
                document.getElementById('invoiceTitle').textContent = 'Final Balance';
                document.getElementById('invoiceSubtitle').textContent = 'Final Balance Due';
                document.title = 'Final Balance - Kenna Giuzio Cake';
            }

            // Lock deposit mode — simplified invoice for pre-proposal reserve
            if (isLockDeposit) {
                document.getElementById('invoiceTitle').textContent = 'Lock the Date';
                document.getElementById('invoiceSubtitle').textContent = 'Reserve Your Date';
                document.title = 'Lock the Date - Kenna Giuzio Cake';
            }

            // Try to get client data from URL params first
            let clientNameVal = params.get('name');
            let clientEmailVal = params.get('email');
            let eventTypeVal = params.get('eventType');
            let eventDateVal = params.get('eventDate');
            let venueVal = params.get('venue');
            let clientAddressVal = '';

            // If URL params are empty/default, try to load from localStorage or API
            if (clientId && clientId !== 'new') {
                // Try API first
                try {
                    const resp = await fetch(`${API_URL}/api/clients/${clientId}`);
                    if (resp.ok) {
                        const client = await resp.json();
                        if (!clientNameVal || clientNameVal === 'Client') clientNameVal = client.name || clientNameVal;
                        if (!clientEmailVal) clientEmailVal = client.email || clientEmailVal;
                        if (!eventTypeVal) eventTypeVal = client.event_type || eventTypeVal;
                        if (!eventDateVal) eventDateVal = client.event_date || eventDateVal;
                        if (!venueVal) venueVal = client.venue || venueVal;
                        clientAddressVal = client.address || '';
                        console.log('Loaded client from API:', client.name);
                    }
                } catch(e) {
                    console.log('API fetch failed, trying localStorage');
                }

                // Fallback to localStorage
                if (!clientNameVal || clientNameVal === 'Client') {
                    try {
                        const clients = JSON.parse(localStorage.getItem('kgc_clients') || '[]');
                        const client = clients.find(c => String(c.id) === String(clientId));
                        if (client) {
                            if (!clientNameVal || clientNameVal === 'Client') clientNameVal = client.name || clientNameVal;
                            if (!clientEmailVal) clientEmailVal = client.email || clientEmailVal;
                            if (!eventTypeVal) eventTypeVal = client.eventType || eventTypeVal;
                            if (!eventDateVal) eventDateVal = client.eventDate || eventDateVal;
                            if (!venueVal) venueVal = client.venue || venueVal;
                            clientAddressVal = client.address || '';
                        }
                    } catch(e) { console.log('Could not load client:', e); }
                }
            }

            // Apply client info
            if (clientNameVal && clientNameVal !== 'Client') {
                document.getElementById('clientName').textContent = clientNameVal;
            }
            if (clientEmailVal) {
                document.getElementById('clientEmail').textContent = clientEmailVal;
            }
            if (clientAddressVal) {
                document.getElementById('clientAddress').textContent = clientAddressVal;
            }

            // Event info
            if (eventTypeVal) {
                document.getElementById('eventType').textContent = eventTypeVal;
            }
            if (eventDateVal && eventDateVal !== 'undefined' && eventDateVal !== 'null') {
                const formattedDate = formatDate(eventDateVal);
                if (formattedDate && formattedDate !== 'Invalid Date' && formattedDate !== 'TBD') {
                    document.getElementById('eventDate').textContent = formattedDate;
                }
            }
            if (venueVal) {
                document.getElementById('venue').textContent = venueVal;
            }

            // Proposal number - read from draft if available
            if (clientId && clientId !== 'new') {
                try {
                    const drafts = JSON.parse(localStorage.getItem('kgc_proposal_drafts') || '{}');
                    const draft = drafts[clientId];
                    if (draft && draft.proposalNumber) {
                        document.getElementById('proposalNumber').textContent = '#P-' + draft.proposalNumber;
                    }
                } catch(e) {
                    console.log('Could not load proposal number:', e);
                }
            }

            // Financial data — fetch from API if in final balance mode to ensure correct amounts
            let proposalTotal = parseFloat(params.get('total')) || 0;
            let tastingCredit = parseFloat(params.get('tastingCredit')) || 0;
            let depositPaidFromDB = 0;

            if (isFinalBalance && clientId) {
                // Fetch the signed proposal to get real totals
                try {
                    const propResp = await fetch(`${API_URL}/api/proposals?client_id=${clientId}`);
                    if (propResp.ok) {
                        const allProposals = await propResp.json();
                        const proposals = allProposals.filter(p => p.status === 'signed');
                        if (proposals.length > 0) {
                            const propData = typeof proposals[0].data === 'string' ? JSON.parse(proposals[0].data) : proposals[0].data;
                            const selectedDesign = propData.selectedDesign || 'base';
                            const designPrice = parseFloat(propData[selectedDesign + 'Price'] || propData.basePrice || 0);
                            let itemsTotal = 0;
                            (propData.items || []).forEach(item => {
                                if (item.type === 'fixed') itemsTotal += parseFloat(item.price) || 0;
                                else itemsTotal += (parseFloat(item.qty) || 0) * (parseFloat(item.rate) || 0);
                            });
                            const realTotal = designPrice + itemsTotal;
                            if (realTotal > 0) proposalTotal = realTotal;
                            if (propData.tastingCredit) tastingCredit = parseFloat(propData.tastingCredit) || 0;
                            // Also get proposal number
                            if (propData.proposalNumber) {
                                document.getElementById('proposalNumber').textContent = '#P-' + propData.proposalNumber;
                            }
                        }
                    }
                } catch (e) { console.log('Could not fetch proposal for final balance:', e); }

                // Fetch the paid deposit invoice (fallback only — prefer calculating from proposal)
                try {
                    const depResp = await fetch(`${API_URL}/api/invoices`);
                    if (depResp.ok) {
                        const invoices = await depResp.json();
                        const depInv = invoices.find(i => String(i.client_id) === String(clientId) && i.type === 'deposit' && i.status === 'paid');
                        if (depInv) depositPaidFromDB = parseFloat(depInv.amount) || 0;
                    }
                } catch (e) { console.log('Could not fetch deposit invoice:', e); }
            }

            // Lock deposit mode — simple fixed amount, no proposal reference
            if (isLockDeposit) {
                depositAmount = parseFloat(params.get('amount')) || 0;
                const processingFee = Math.floor(depositAmount * 0.03);
                depositWithFee = depositAmount + processingFee;

                // Replace the summary box with simple lock deposit info
                const summaryBox = document.querySelector('.summary-box');
                if (summaryBox) {
                    summaryBox.innerHTML = `
                        <div class="summary-title">Lock the Date Deposit</div>
                        <div class="summary-row" style="border-top: 1px solid #eee; padding-top: 12px;">
                            <span class="label">Reserve Deposit</span>
                            <span class="amount">${formatCurrency(depositAmount)}</span>
                        </div>
                        <div class="summary-row" style="font-size: 0.8rem; color: #888; padding-top: 4px;">
                            <span>This deposit will be credited toward your final balance</span>
                        </div>
                    `;
                }

                // Update totals
                document.querySelector('.totals-row.subtotal span:first-child').textContent = 'Lock Deposit';
                document.getElementById('subtotalAmount').textContent = formatCurrency(depositAmount);
                document.getElementById('processingFee').textContent = formatCurrency(processingFee);
                document.getElementById('totalDue').textContent = formatCurrency(depositWithFee);
                document.querySelector('.totals-row.deposit span:first-child').textContent = 'Total Due';

                // Hide remaining balance row
                const remainingRow = document.querySelector('.totals-row.balance');
                if (remainingRow) remainingRow.style.display = 'none';

                // Update Zelle and Check amounts
                document.getElementById('zelleAmount').textContent = formatCurrency(depositAmount);
                document.getElementById('checkAmount').textContent = formatCurrency(depositAmount);

                // Update pay button
                document.getElementById('payButton').textContent = 'Pay ' + formatCurrency(depositWithFee) + ' with Card';

                // Update payment terms
                const termsSection = document.querySelector('.terms-section');
                if (termsSection) {
                    termsSection.innerHTML = `
                        <div class="terms-title">Lock the Date</div>
                        <div class="terms-text">
                            <p>This deposit reserves your event date with Kenna Giuzio Cake. The full amount will be credited toward your 50% deposit once your custom proposal is finalized.</p>
                            <div class="terms-note">
                                <strong>Your date is reserved once payment is received.</strong>
                                A 3% processing fee applies to credit card payments. Zelle and check payments do not include a processing fee.
                            </div>
                        </div>
                    `;
                }
            }

            // Fallback defaults only for deposit mode (not final balance or lock deposit)
            if (!isLockDeposit && !proposalTotal) proposalTotal = parseFloat(params.get('total')) || (isFinalBalance ? 0 : 2500);
            if (!isLockDeposit && !tastingCredit) tastingCredit = parseFloat(params.get('tastingCredit')) || (isFinalBalance ? 0 : 250);
            const adjustedTotal = isLockDeposit ? 0 : (proposalTotal - tastingCredit);

            if (isFinalBalance) {
                // Final balance mode: total minus deposit already paid
                // Calculate deposit from proposal (service amount = half of adjusted total)
                // DO NOT use DB invoice amount — it includes the 3% CC processing fee
                const depositFromProposal = proposalTotal > 0 ? Math.floor(adjustedTotal / 2) : 0;
                const depositPaid = depositFromProposal || depositPaidFromDB || parseFloat(params.get('depositPaid')) || 0;
                depositAmount = Math.floor(adjustedTotal - depositPaid);
                const processingFee = Math.floor(depositAmount * 0.03);
                depositWithFee = depositAmount + processingFee;

                // Update summary box for final balance
                document.querySelector('.summary-row.highlight .label').textContent = 'Balance Due';
                document.getElementById('depositAmount').textContent = formatCurrency(depositAmount);

                // Add deposit paid row to summary
                const highlightRow = document.querySelector('.summary-row.highlight');
                const depositPaidRow = document.createElement('div');
                depositPaidRow.className = 'summary-row';
                depositPaidRow.innerHTML = `
                    <span class="label">Less: Deposit Paid</span>
                    <span class="amount">-${formatCurrency(depositPaid)}</span>
                `;
                highlightRow.parentNode.insertBefore(depositPaidRow, highlightRow);

                // Update totals section
                document.querySelector('.totals-row.subtotal span:first-child').textContent = 'Balance Due';
                document.getElementById('subtotalAmount').textContent = formatCurrency(depositAmount);
                document.getElementById('processingFee').textContent = formatCurrency(processingFee);
                document.getElementById('totalDue').textContent = formatCurrency(depositWithFee);

                // Hide remaining balance row (this IS the remaining balance)
                const remainingRow = document.querySelector('.totals-row.balance');
                if (remainingRow) remainingRow.style.display = 'none';

                // Update deposit row label
                document.querySelector('.totals-row.deposit span:first-child').textContent = 'Total Due';
            } else if (!isLockDeposit) {
                // Normal deposit mode — check for existing lock deposit to credit
                let lockDepositCredit = 0;
                if (clientId) {
                    try {
                        const invResp = await fetch(`${API_URL}/api/invoices?client_id=${clientId}`);
                        if (invResp.ok) {
                            const invoices = await invResp.json();
                            const lockInv = invoices.find(i => i.type === 'lock_deposit' && (i.status === 'paid' || i.status === 'pending_verification'));
                            if (lockInv) lockDepositCredit = parseFloat(lockInv.amount) || 0;
                        }
                    } catch (e) { console.log('Could not check lock deposit:', e); }
                }

                const fullDeposit = Math.floor(adjustedTotal / 2);
                depositAmount = Math.max(0, fullDeposit - lockDepositCredit);
                const processingFee = Math.floor(depositAmount * 0.03);
                depositWithFee = depositAmount + processingFee;
                const remainingBalance = adjustedTotal - fullDeposit;

                // If there's a lock deposit credit, show it in the summary
                if (lockDepositCredit > 0) {
                    const highlightRow = document.querySelector('.summary-row.highlight');
                    if (highlightRow) {
                        const creditRow = document.createElement('div');
                        creditRow.className = 'summary-row';
                        creditRow.innerHTML = `
                            <span class="label">Less: Lock the Date Deposit</span>
                            <span class="amount">-${formatCurrency(lockDepositCredit)}</span>
                        `;
                        highlightRow.parentNode.insertBefore(creditRow, highlightRow);
                        highlightRow.querySelector('.label').textContent = 'Deposit Due Now';
                    }
                }

                // Update totals
                document.getElementById('subtotalAmount').textContent = formatCurrency(depositAmount);
                document.getElementById('processingFee').textContent = formatCurrency(processingFee);
                document.getElementById('totalDue').textContent = formatCurrency(depositWithFee);
                document.getElementById('remainingBalance').textContent = formatCurrency(remainingBalance);
            }

            // Update summary (common fields) — skip for lock deposit (summary box replaced)
            if (!isLockDeposit) {
                document.getElementById('proposalTotal').textContent = formatCurrency(proposalTotal);
                document.getElementById('tastingCredit').textContent = '-' + formatCurrency(tastingCredit);
                document.getElementById('adjustedTotal').textContent = formatCurrency(adjustedTotal);
                if (!isFinalBalance) {
                    document.getElementById('depositAmount').textContent = formatCurrency(depositAmount);
                }

                // Update Zelle and Check amounts
                document.getElementById('zelleAmount').textContent = formatCurrency(depositAmount);
                document.getElementById('checkAmount').textContent = formatCurrency(depositAmount);

                // Update pay button
                document.getElementById('payButton').textContent = 'Pay ' + formatCurrency(depositWithFee) + ' with Card';
            }

            // Line items from proposal
            const lineItemsList = document.getElementById('lineItemsList');
            const lineItems = params.get('items');

            if (lineItems) {
                try {
                    const items = JSON.parse(decodeURIComponent(lineItems));
                    items.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'line-item';
                        div.innerHTML = `
                            <div>
                                <div class="line-item-name">${item.name}</div>
                                ${item.desc ? `<div class="line-item-desc">${item.desc}</div>` : ''}
                            </div>
                            <div class="line-item-price">${formatCurrency(item.price)}</div>
                        `;
                        lineItemsList.appendChild(div);
                    });
                } catch (e) {
                    lineItemsList.innerHTML = `
                        <div class="line-item">
                            <div>
                                <div class="line-item-name">Custom Cake</div>
                                <div class="line-item-desc">As specified in your proposal</div>
                            </div>
                            <div class="line-item-price">${formatCurrency(proposalTotal)}</div>
                        </div>
                    `;
                }
            } else {
                lineItemsList.innerHTML = `
                    <div class="line-item">
                        <div>
                            <div class="line-item-name">Custom Cake Package</div>
                            <div class="line-item-desc">As specified in your signed proposal</div>
                        </div>
                        <div class="line-item-price">${formatCurrency(proposalTotal)}</div>
                    </div>
                `;
            }

            // Generate invoice number — but first check if one already exists in DB for this client
            if (!invoiceId && clientId) {
                try {
                    const existResp = await fetch(`${API_URL}/api/invoices?client_id=${clientId}`);
                    if (existResp.ok) {
                        const allInvoices = await existResp.json();
                        const existing = allInvoices.find(i => i.type === invoiceType && (i.status === 'sent' || i.status === 'draft'));
                        if (existing) {
                            invoiceId = existing.invoice_number || existing.id;
                        }
                    }
                } catch (e) { console.log('Could not check existing invoices:', e); }
            }
            if (!invoiceId) {
                invoiceId = invoicePrefix + new Date().getFullYear() + '-' + String(Date.now()).slice(-4);
            }
            document.getElementById('invoiceNumber').textContent = invoiceId;

            // Set today's date
            document.getElementById('invoiceDate').textContent = new Date().toLocaleDateString('en-US', {
                month: 'long', day: 'numeric', year: 'numeric'
            });

            // Check for existing invoice / paid status
            if (clientId) {
                // Try API first
                let invoiceFound = false;
                if (invoiceId) {
                    try {
                        const resp = await fetch(`${API_URL}/api/invoices/${invoiceId}`);
                        if (resp.ok) {
                            const invoice = await resp.json();
                            if (invoice.status === 'paid') {
                                showPaidState(invoice);
                                invoiceFound = true;
                            }
                        }
                    } catch(e) { console.log('Could not check invoice from API'); }
                }

                if (!invoiceFound) {
                    // Check localStorage
                    const invoices = JSON.parse(localStorage.getItem('kgc_invoices') || '[]');
                    const existingInv = invoices.find(i =>
                        i.type === invoiceType && String(i.clientId) === String(clientId)
                    );

                    if (existingInv) {
                        invoiceId = existingInv.id;
                        document.getElementById('invoiceNumber').textContent = invoiceId;

                        if (existingInv.status === 'paid') {
                            showPaidState(existingInv);
                        }
                    } else {
                        // Save new invoice record
                        invoices.push({
                            id: invoiceId,
                            type: invoiceType,
                            clientId: clientId,
                            clientName: document.getElementById('clientName').textContent,
                            clientEmail: document.getElementById('clientEmail').textContent,
                            eventType: params.get('eventType') || 'Wedding',
                            eventDate: params.get('eventDate'),
                            venue: params.get('venue'),
                            proposalTotal: proposalTotal,
                            tastingCredit: tastingCredit,
                            amount: depositAmount,
                            status: 'sent',
                            sentAt: new Date().toISOString()
                        });
                        localStorage.setItem('kgc_invoices', JSON.stringify(invoices));
                    }
                }
            }
        }

        // Show paid state (hide payment, show badge)
        function showPaidState(invoice) {
            document.getElementById('paymentSection').style.display = 'none';
            document.getElementById('paidBadge').classList.add('visible');

            // In admin view, show payment details
            if (params.get('from') === 'finances') {
                const method = invoice.payment_method || invoice.paymentMethod || 'card';
                const paidDate = invoice.paid_at || invoice.paidAt;

                // If paid via Zelle/Check, hide processing fee and show base amount
                if (method === 'zelle' || method === 'check') {
                    document.getElementById('processingFeeRow').style.display = 'none';
                    document.getElementById('totalDue').textContent = formatCurrency(depositAmount);
                }

                // Add paid info row after total
                const totalsTable = document.querySelector('.totals-table');
                const paidRow = document.createElement('div');
                paidRow.className = 'totals-row';
                paidRow.style.cssText = 'color:#5a6b52; font-size:0.85rem; margin-top:8px; padding-top:8px; border-top:1px solid #e8ede5;';
                const methodLabel = method === 'zelle' ? 'Zelle' : method === 'check' ? 'Check' : 'Card';
                const dateLabel = paidDate ? new Date(paidDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : '';
                paidRow.innerHTML = `<span>Paid via ${methodLabel}</span><span>${dateLabel}</span>`;
                totalsTable.appendChild(paidRow);
            }

            // In admin view, if NOT paid show sent badge
            if (invoice.status !== 'paid' && params.get('from') === 'finances') {
                const badge = document.getElementById('paidBadge');
                badge.textContent = '◷ Sent';
                badge.style.background = '#f5eee3';
                badge.style.color = '#8b7355';
                badge.classList.add('visible');
            }
        }

        // Run initialization
        (async () => {
            await initializePage();
            // Initialize Stripe if payment section is visible
            const paySection = document.getElementById('paymentSection');
            if (paySection && paySection.style.display !== 'none') {
                document.getElementById('cardFormContainer').style.display = 'block';
                await initStripe();
                await createPaymentIntent();
            }
        })();
    </script>
</body>
</html>
