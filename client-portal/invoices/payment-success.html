<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Successful - Kenna Giuzio Cake</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500&family=Montserrat:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html {
            background: #0a0a0a;
        }
        body {
            font-family: 'Montserrat', sans-serif;
            font-weight: 300;
            background: #0a0a0a;
            min-height: 100vh;
            transition: background 3.5s ease-in-out;
        }
        body.revealed {
            background: #faf8f5;
        }

        /* Banner */
        .banner {
            width: 100%;
            height: 220px;
            background: url('../images/header-flowers.jpg') 30% center / cover no-repeat;
            opacity: 0;
            transition: opacity 4s ease-in-out;
        }
        .banner.visible {
            opacity: 1;
        }

        /* Content area */
        .content {
            max-width: 500px;
            margin: 0 auto;
            text-align: center;
            padding: 0 20px 60px;
        }

        .logo {
            height: 80px;
            margin-top: 40px;
            margin-bottom: 36px;
            opacity: 0;
            transition: opacity 3s ease-in-out;
        }
        .logo.visible {
            opacity: 1;
        }

        .success-text {
            opacity: 0;
            transition: opacity 3s ease-in-out;
        }
        .success-text.visible {
            opacity: 1;
        }

        h1 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 2rem;
            font-weight: 400;
            color: #1a1a1a;
            margin-bottom: 16px;
        }
        .amount {
            font-size: 2.5rem;
            font-weight: 500;
            color: #b5956a;
            margin-bottom: 20px;
        }
        p {
            font-size: 0.95rem;
            color: #666;
            line-height: 1.7;
            margin-bottom: 12px;
        }
        a {
            color: #b5956a;
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #999;
            font-size: 0.9rem;
        }
        .loading.hide {
            display: none;
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <p>Confirming your payment...</p>
    </div>

    <div class="banner" id="banner"></div>

    <div class="content">
        <img src="/images/logo.png" alt="Kenna Giuzio Cake" class="logo" id="logo">

        <div class="success-text" id="successText">
            <h1 id="successTitle">Payment Successful</h1>
            <div class="amount" id="amount"></div>
            <p id="successMessage">Thank you for your payment. A confirmation has been sent to your email.</p>
            <p style="margin-top: 24px;">If you have any questions, please contact<br>
            <a href="mailto:kenna@kennagiuziocake.com">kenna@kennagiuziocake.com</a></p>
        </div>
    </div>

    <script>
        const API_URL = 'https://sugar-backend-production.up.railway.app';

        async function loadPaymentDetails() {
            const urlParams = new URLSearchParams(window.location.search);
            const sessionId = urlParams.get('session_id');
            const paymentIntentId = urlParams.get('payment_intent');
            const isZelle = urlParams.get('zelle') === 'true';
            const zelleAmount = urlParams.get('amount');

            // Handle pending offline payments (Zelle/Check — not yet verified)
            const isPending = urlParams.get('pending') === 'true';
            const pendingAmount = urlParams.get('amount');
            const pendingMethod = urlParams.get('method');

            if (isPending && pendingAmount) {
                const methodLabel = pendingMethod === 'check' ? 'Check' : 'Zelle';
                document.getElementById('amount').textContent = '$' + parseFloat(pendingAmount).toLocaleString('en-US', { minimumFractionDigits: 2 });
                document.getElementById('successTitle').textContent = 'Thank You';
                document.getElementById('successMessage').textContent = `Your ${methodLabel} payment notification has been received. Once verified, a confirmation will be sent to your email.`;
                document.title = 'Thank You - Kenna Giuzio Cake';
                revealSequence();
                return;
            }

            // Handle Zelle payments (no Stripe lookup needed) — legacy
            if (isZelle && zelleAmount) {
                document.getElementById('amount').textContent = '$' + parseFloat(zelleAmount).toLocaleString('en-US', { minimumFractionDigits: 2 });
                revealSequence();
                return;
            }

            if (!sessionId && !paymentIntentId) {
                revealSequence();
                return;
            }

            try {
                let data;

                if (sessionId) {
                    const response = await fetch(`${API_URL}/api/payments/session/${sessionId}`);
                    data = await response.json();
                } else if (paymentIntentId) {
                    const response = await fetch(`${API_URL}/api/payments/intent/${paymentIntentId}`);
                    data = await response.json();
                }

                if (data && data.success && data.paid) {
                    document.getElementById('amount').textContent = '$' + data.amount.toLocaleString('en-US', { minimumFractionDigits: 2 });

                    // Update invoice status in localStorage
                    if (data.metadata && data.metadata.invoice_id) {
                        const invoices = JSON.parse(localStorage.getItem('kgc_invoices') || '[]');
                        const idx = invoices.findIndex(i => i.id === data.metadata.invoice_id);
                        if (idx >= 0) {
                            invoices[idx].status = 'paid';
                            invoices[idx].paidAt = new Date().toISOString();
                            invoices[idx].paymentMethod = 'card';
                            localStorage.setItem('kgc_invoices', JSON.stringify(invoices));
                        }
                    }

                    // Update client status in localStorage
                    if (data.metadata && data.metadata.client_id) {
                        const clients = JSON.parse(localStorage.getItem('kgc_clients') || '[]');
                        const cIdx = clients.findIndex(c => String(c.id) === String(data.metadata.client_id));
                        if (cIdx >= 0 && data.metadata.invoice_type === 'tasting') {
                            clients[cIdx].tastingPaid = true;
                            clients[cIdx].tastingPaidDate = new Date().toISOString();
                            localStorage.setItem('kgc_clients', JSON.stringify(clients));
                        }
                    }
                }

                revealSequence();

            } catch (err) {
                console.error('Error loading payment details:', err);
                revealSequence();
            }
        }

        function revealSequence() {
            // Hide loading
            document.getElementById('loading').classList.add('hide');

            // Step 1: Fade in banner from black + change body bg
            setTimeout(() => {
                document.body.classList.add('revealed');
                document.getElementById('banner').classList.add('visible');
            }, 600);

            // Step 2: Fade in logo
            setTimeout(() => {
                document.getElementById('logo').classList.add('visible');
            }, 3500);

            // Step 3: Fade in "Payment Successful" + amount
            setTimeout(() => {
                document.getElementById('successText').classList.add('visible');
            }, 5500);
        }

        loadPaymentDetails();
    </script>
</body>
</html>
