<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="/favicon.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>In Studio - Kenna Giuzio Cake</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500&family=Mr+De+Haviland&family=Montserrat:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        :root {
            --bg-primary: #faf8f5;
            --bg-secondary: #fff;
            --bg-tertiary: #fafafa;
            --bg-hover: #f5f3f0;
            --text-primary: #1a1a1a;
            --text-secondary: #666;
            --text-muted: #999;
            --border-color: #eee;
            --border-light: #f0f0f0;
            --accent-gold: #b5956a;
            --accent-gold-hover: #a08050;
            --modal-bg: #fff;
            --input-bg: #fff;
            --shadow: rgba(0,0,0,0.1);
            --overlay: rgba(0,0,0,0.5);
        }

        body.dark-mode {
            --bg-primary: #1a1a1a;
            --bg-secondary: #252525;
            --bg-tertiary: #2d2d2d;
            --bg-hover: #333;
            --text-primary: #e0e0e0;
            --text-secondary: #aaa;
            --text-muted: #777;
            --border-color: #3a3a3a;
            --border-light: #333;
            --accent-gold: #c9a66a;
            --accent-gold-hover: #d4b87a;
            --modal-bg: #252525;
            --input-bg: #2d2d2d;
            --shadow: rgba(0,0,0,0.3);
            --overlay: rgba(0,0,0,0.7);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            font-weight: 300;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        body.dark-mode .logo img {
            filter: invert(0.85);
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 260px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            padding: 30px 0;
            display: flex;
            flex-direction: column;
        }

        .logo {
            text-align: center;
            padding: 30px 30px 30px;
            border-bottom: 1px solid var(--border-color);
        }

        .logo img {
            width: 160px;
            height: auto;
        }

        .nav-menu {
            padding: 30px 0;
            flex: 1;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 30px;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-left-color: var(--accent-gold);
        }

        .nav-item svg {
            width: 18px;
            height: 18px;
            opacity: 0.7;
        }

        .nav-divider {
            height: 1px;
            background: var(--border-color);
            margin: 15px 30px;
        }

        /* Main Content */
        .main {
            margin-left: 260px;
            min-height: 100vh;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px 40px;
            background: url('../images/header-flowers.jpg') center center / cover no-repeat;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header > * {
            position: relative;
            z-index: 1;
        }

        .header h1 {
            font-family: 'Cormorant Garamond', serif;
            font-weight: 300;
            font-size: 2rem;
            color: #fff;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .header-date {
            font-size: 0.85rem;
            color: rgba(255,255,255,0.9);
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .main-content {
            padding: 40px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: var(--accent-gold);
            color: #fff;
            border: none;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.8rem;
            font-weight: 400;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:hover {
            background: var(--accent-gold-hover);
        }

        .btn svg {
            width: 16px;
            height: 16px;
        }

        /* Section */
        .section {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            margin-bottom: 30px;
        }

        /* Projects Table */
        .projects-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        .projects-table th {
            text-align: left;
            padding: 16px 20px;
            font-size: 0.65rem;
            font-weight: 500;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border-color);
        }

        .projects-table td {
            padding: 18px 20px;
            border-bottom: 1px solid var(--border-light);
            font-size: 0.85rem;
        }

        .projects-table tr:last-child td {
            border-bottom: none;
        }

        .projects-table tr:hover {
            background: var(--bg-tertiary);
        }

        .project-name {
            font-weight: 400;
        }

        .project-name a {
            color: inherit;
            text-decoration: none;
            transition: color 0.2s;
        }

        .project-name a:hover {
            color: var(--accent-gold);
        }

        .date-cell {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        .date-cell.empty {
            color: var(--text-muted);
        }

        .date-cell.past {
            color: var(--text-muted);
        }

        .date-cell.upcoming {
            color: var(--text-primary);
            font-weight: 400;
        }

        .date-cell.soon {
            color: var(--accent-gold);
            font-weight: 500;
        }

        .date-cell.clickable {
            cursor: pointer;
            position: relative;
        }

        .date-cell.clickable:hover {
            color: var(--accent-gold);
        }

        .date-cell .set-date {
            color: var(--accent-gold);
            cursor: pointer;
            font-size: 0.75rem;
        }

        .time-display {
            color: var(--text-muted);
            font-size: 0.75rem;
        }

        .date-cell .set-date:hover {
            text-decoration: underline;
        }

        /* Progress Bar */
        /* Workflow Buttons */
        .wf-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            padding: 8px 6px;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
            transition: all 0.2s;
            border-radius: 6px;
            width: 100%;
        }

        .wf-btn:hover {
            border-color: var(--accent-gold);
        }

        .wf-btn .wf-label {
            font-size: 0.65rem;
            font-weight: 500;
            letter-spacing: 0.3px;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .wf-btn .wf-status {
            font-size: 0.55rem;
            color: var(--text-muted);
            white-space: nowrap;
        }

        .wf-btn.wf-done {
            background: #f0f7f2;
            border-color: #a8b5a0;
        }

        .wf-btn.wf-done .wf-label {
            color: #5a6b52;
        }

        .wf-btn.wf-done .wf-status {
            color: #5a6b52;
        }

        .wf-btn.wf-progress {
            background: #fdf8f3;
            border-color: #dfc89f;
        }

        .wf-btn.wf-progress .wf-label {
            color: #8b7355;
        }

        .wf-btn.wf-progress .wf-status {
            color: #8b7355;
        }

        .wf-btn.wf-disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .wf-btn.wf-disabled:hover {
            border-color: var(--border-color);
        }

        .wf-cell {
            padding: 10px 4px !important;
        }

        .empty-state {
            text-align: center;
            padding: 60px 40px;
            color: var(--text-muted);
        }

        .empty-state h3 {
            font-family: 'Cormorant Garamond', serif;
            font-weight: 400;
            font-size: 1.5rem;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }

        .empty-state p {
            font-size: 0.9rem;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--overlay);
            z-index: 1200;
            display: none;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .modal-overlay.active {
            display: flex;
            opacity: 1;
        }

        .modal {
            background: var(--modal-bg);
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .to-modal {
            display: flex;
            flex-direction: column;
            max-height: 90vh;
            overflow: hidden;
            height: auto;
        }

        .modal-header {
            padding: 28px 32px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.5rem;
            font-weight: 400;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-muted);
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .modal-body {
            padding: 32px;
        }

        .modal-footer {
            padding: 24px 32px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-row.full {
            grid-template-columns: 1fr;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-label {
            font-size: 0.75rem;
            font-weight: 500;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            color: var(--text-secondary);
        }

        .form-input, .form-select, .form-textarea {
            padding: 12px 14px;
            border: 1px solid var(--border-color);
            background: var(--input-bg);
            color: var(--text-primary);
            font-family: 'Montserrat', sans-serif;
            font-size: 0.9rem;
            transition: border-color 0.2s;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--accent-gold);
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* Timeline */
        .timeline-container {
            position: relative;
            height: 90px;
        }

        .timeline-track {
            position: absolute;
            top: 50px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--border-color);
        }

        .timeline-months {
            display: flex;
            justify-content: space-between;
            position: absolute;
            top: 60px;
            left: 0;
            right: 0;
        }

        .timeline-month {
            font-size: 0.6rem;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: var(--text-muted);
        }

        .timeline-today {
            position: absolute;
            top: 51px;
            transform: translate(-50%, -50%);
            z-index: 3;
        }

        .timeline-today-dot {
            width: 12px;
            height: 12px;
            background: #7b9e87;
            border-radius: 50%;
        }

        .timeline-event {
            position: absolute;
            top: 51px;
            transform: translate(-50%, -50%);
            text-align: center;
            cursor: pointer;
            z-index: 2;
        }

        .timeline-event-dot {
            width: 12px;
            height: 12px;
            background: var(--accent-gold);
            border-radius: 50%;
        }

        .timeline-event-label {
            font-size: 0.55rem;
            color: var(--text-muted);
            white-space: nowrap;
            position: absolute;
            bottom: 18px;
            left: 50%;
            transform: translateX(-50%);
        }

        .timeline-event-label.stagger {
            bottom: 30px;
        }

        .timeline-event:hover .timeline-event-dot {
            transform: scale(1.3);
            box-shadow: 0 0 0 3px rgba(181, 149, 106, 0.3);
        }

        .timeline-event:hover .timeline-event-label {
            color: var(--text-primary);
            font-weight: 500;
        }

        .projects-table tr.highlight {
            background: var(--bg-hover) !important;
            box-shadow: inset 4px 0 0 var(--accent-gold);
        }

        .projects-table tr.highlight .project-name a {
            color: var(--accent-gold) !important;
            font-weight: 500;
        }

        .projects-table tr.highlight .date-cell {
            color: var(--accent-gold) !important;
        }

        .projects-table tr.highlight .date-cell span {
            color: var(--accent-gold) !important;
        }

        /* Location cell */
        .location-cell {
            font-size: 0.8rem;
            color: var(--text-secondary);
            max-width: 140px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Calendar Popup */
        .calendar-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 600px;
            max-width: 95vw;
            max-height: 90vh;
            background: var(--modal-bg);
            border: 1px solid var(--border-color);
            box-shadow: 0 10px 40px var(--shadow);
            z-index: 1000;
            flex-direction: column;
            overflow: hidden;
        }

        .calendar-popup.active {
            display: flex;
        }

        .calendar-popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            cursor: move;
        }

        .calendar-popup-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.2rem;
            font-weight: 400;
            color: var(--text-primary);
        }

        .calendar-popup-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-muted);
            line-height: 1;
        }

        .calendar-popup-close:hover {
            color: var(--text-primary);
        }

        .calendar-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .calendar-nav button {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 6px 12px;
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.8rem;
            border-radius: 4px;
            color: var(--text-primary);
        }

        .calendar-nav button:hover {
            background: var(--bg-tertiary);
        }

        .calendar-month-year {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.1rem;
            color: var(--text-primary);
        }

        .calendar-grid {
            padding: 16px;
            overflow-y: auto;
        }

        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
            font-size: 0.65rem;
            font-weight: 500;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }

        .calendar-day {
            min-height: 70px;
            padding: 6px;
            border: 1px solid var(--border-light);
            cursor: pointer;
            transition: all 0.15s;
            position: relative;
            background: var(--bg-secondary);
        }

        .calendar-day:hover {
            background: var(--bg-tertiary);
            border-color: var(--border-color);
        }

        .calendar-day.other-month {
            color: var(--text-muted);
            background: var(--bg-tertiary);
        }

        .calendar-day.today {
            border-color: var(--text-muted);
        }

        .calendar-day.selected {
            border-color: var(--accent-gold);
            background: var(--bg-hover);
        }

        .calendar-day.past {
            color: var(--text-muted);
        }

        .calendar-day .day-number {
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .calendar-day .day-events {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .day-event {
            font-size: 0.6rem;
            padding: 2px 4px;
            border-radius: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .day-event.event {
            background: #e8ede5;
            color: #5a6b52;
        }

        .day-event.tasting {
            background: #f5eee3;
            color: #8b7355;
        }

        .day-event.inquiry {
            background: #e8e3f0;
            color: #6b5b7a;
        }

        .day-event.personal {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .day-event.custom {
            background: #b5956a;
            color: #fff;
        }

        .day-event.hold {
            background: #f0e6d4;
            color: #b5956a;
            border: 1px dashed #cbb896;
            font-style: italic;
        }

        .day-event.prep {
            background: #8a9a7b;
            color: #fff;
        }

        .day-event.multi-day {
            border-radius: 0;
            margin-left: -7px;
            margin-right: -7px;
            padding-left: 4px;
            padding-right: 4px;
            width: calc(100% + 14px);
            text-align: center;
            position: relative;
            z-index: 2;
        }

        .day-event.multi-day.bar-start {
            margin-left: 0;
            margin-right: -7px;
            width: calc(100% + 7px);
            border-radius: 3px 0 0 3px;
        }

        .day-event.multi-day.bar-end {
            margin-left: -7px;
            margin-right: 0;
            width: calc(100% + 7px);
            border-radius: 0 3px 3px 0;
        }

        .day-event.multi-day.bar-single {
            margin-left: 0;
            margin-right: 0;
            width: 100%;
            border-radius: 3px;
        }

        .calendar-day {
            overflow: visible;
        }

        .calendar-day .day-events {
            overflow: visible;
        }

        .day-event-more {
            font-size: 0.55rem;
            color: var(--text-muted);
        }

        .calendar-popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--overlay);
            z-index: 999;
        }

        .calendar-popup-overlay.active {
            display: block;
        }

        .calendar-popup-footer {
            padding: 12px 20px;
            border-top: 1px solid var(--border-color);
            text-align: center;
        }

        .full-calendar-link {
            color: var(--accent-gold);
            text-decoration: none;
            font-size: 0.8rem;
        }

        .full-calendar-link:hover {
            text-decoration: underline;
        }

        /* Time Picker Modal */
        .time-picker-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--overlay);
            z-index: 1100;
            justify-content: center;
            align-items: center;
        }

        .time-picker-modal.active {
            display: flex;
        }

        .time-picker-content {
            background: var(--modal-bg);
            width: 360px;
            max-width: 95vw;
            border-radius: 4px;
            box-shadow: 0 10px 40px var(--shadow);
        }

        .time-picker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .time-picker-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.2rem;
            color: var(--text-primary);
        }

        .time-picker-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-muted);
            line-height: 1;
        }

        .time-picker-close:hover {
            color: var(--text-primary);
        }

        .time-picker-body {
            padding: 20px;
        }

        .time-picker-date {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 16px;
            text-align: center;
        }

        .time-picker-input-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .time-picker-input-row label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .time-picker-input-row input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            background: var(--input-bg);
            color: var(--text-primary);
            font-family: 'Montserrat', sans-serif;
            font-size: 1rem;
        }

        .time-picker-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding: 16px 20px;
            border-top: 1px solid var(--border-color);
        }

        .btn-secondary {
            padding: 10px 20px;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-family: 'Montserrat', sans-serif;
            font-size: 0.8rem;
            cursor: pointer;
        }

        .btn-secondary:hover {
            background: var(--bg-tertiary);
        }

        .btn-primary {
            padding: 10px 20px;
            border: none;
            background: var(--accent-gold);
            color: #fff;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.8rem;
            cursor: pointer;
        }

        .btn-primary:hover {
            background: var(--accent-gold-hover);
        }

        /* Flatpickr Custom Styling */
        .flatpickr-calendar {
            font-family: 'Montserrat', sans-serif;
            border: none;
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
            border-radius: 0;
            background: var(--modal-bg);
        }

        .flatpickr-calendar.arrowTop:before,
        .flatpickr-calendar.arrowTop:after { display: none; }

        .flatpickr-months { padding: 12px 0; }
        .flatpickr-months .flatpickr-month { height: 40px; }

        .flatpickr-current-month {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.1rem;
            font-weight: 400;
            letter-spacing: 1px;
            color: var(--text-primary);
        }

        .flatpickr-current-month .flatpickr-monthDropdown-months {
            font-family: 'Cormorant Garamond', serif;
            background: var(--modal-bg);
            color: var(--text-primary);
        }

        .flatpickr-current-month input.cur-year {
            color: var(--text-primary);
        }

        .flatpickr-months .flatpickr-prev-month,
        .flatpickr-months .flatpickr-next-month { padding: 12px; }

        .flatpickr-months .flatpickr-prev-month svg,
        .flatpickr-months .flatpickr-next-month svg { fill: var(--text-secondary); }

        .flatpickr-months .flatpickr-prev-month:hover svg,
        .flatpickr-months .flatpickr-next-month:hover svg { fill: var(--accent-gold); }

        .flatpickr-weekdays { background: transparent; }

        span.flatpickr-weekday {
            font-family: 'Montserrat', sans-serif;
            font-size: 0.65rem;
            font-weight: 400;
            letter-spacing: 1px;
            color: var(--text-muted);
            background: transparent;
        }

        .flatpickr-day {
            font-family: 'Montserrat', sans-serif;
            font-weight: 300;
            color: var(--text-primary);
            border-radius: 0;
        }

        .flatpickr-day:hover {
            background: var(--bg-tertiary);
            border-color: transparent;
        }

        .flatpickr-day.selected,
        .flatpickr-day.selected:hover {
            background: var(--accent-gold);
            border-color: var(--accent-gold);
            color: #fff;
        }

        .flatpickr-day.today { border-color: var(--accent-gold); }
        .flatpickr-day.today:hover { background: var(--accent-gold); color: #fff; }

        .flatpickr-day.prevMonthDay,
        .flatpickr-day.nextMonthDay { color: var(--text-muted); }

        .flatpickr-innerContainer { background: var(--modal-bg); }
        .flatpickr-rContainer { background: var(--modal-bg); }
        .flatpickr-days { background: var(--modal-bg); }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="logo">
            <img src="../images/logo.png" alt="Kenna Giuzio Cake">
        </div>

        <nav class="nav-menu">
            <a href="/admin/in-studio.html" class="nav-item active">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                    <path d="M2 17l10 5 10-5"/>
                    <path d="M2 12l10 5 10-5"/>
                </svg>
                In Studio
            </a>
            <a href="/admin/calendar.html" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                    <line x1="16" y1="2" x2="16" y2="6"/>
                    <line x1="8" y1="2" x2="8" y2="6"/>
                    <line x1="3" y1="10" x2="21" y2="10"/>
                </svg>
                Calendar
            </a>
            <a href="/admin/contacts.html" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
                Contacts
            </a>
            <a href="/admin/communications.html" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                </svg>
                Communications
            </a>
            <a href="/admin/templates.html" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                    <line x1="16" y1="13" x2="8" y2="13"/>
                    <line x1="16" y1="17" x2="8" y2="17"/>
                    <polyline points="10 9 9 9 8 9"/>
                </svg>
                Templates
            </a>

            <div class="nav-divider"></div>

            <a href="/admin/finances.html" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <line x1="18" y1="20" x2="18" y2="10"/>
                    <line x1="12" y1="20" x2="12" y2="4"/>
                    <line x1="6" y1="20" x2="6" y2="14"/>
                </svg>
                Finances
            </a>
            <a href="/admin/media.html" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                    <circle cx="8.5" cy="8.5" r="1.5"/>
                    <polyline points="21 15 16 10 5 21"/>
                </svg>
                Media
            </a>

            <div class="nav-divider"></div>

            <a href="/admin/settings.html" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                </svg>
                Settings
            </a>
            <a href="/admin/archive.html" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <polyline points="21 8 21 21 3 21 3 8"/>
                    <rect x="1" y="3" width="22" height="5"/>
                    <line x1="10" y1="12" x2="14" y2="12"/>
                </svg>
                Archive
            </a>
            <a href="/admin/dev-tools.html" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <polyline points="16 18 22 12 16 6"/>
                    <polyline points="8 6 2 12 8 18"/>
                </svg>
                Dev Tools
            </a>
        </nav>

        <!-- Dark Mode Toggle -->
        <div style="padding: 14px 30px; margin-top: auto;">
            <button onclick="toggleDarkMode()" id="darkModeBtn" style="display: flex; align-items: center; gap: 10px; width: 100%; padding: 10px 14px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; font-family: 'Montserrat', sans-serif; font-size: 0.8rem; color: var(--text-secondary); transition: all 0.2s;">
                <span id="darkModeIcon">ðŸŒ™</span>
                <span id="darkModeText">Night Mode</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main">
        <header class="header">
            <div>
                <h1>In Studio</h1>
                <p class="header-date" id="headerDate"></p>
            </div>
        </header>

        <div class="main-content">
            <!-- 6-Month Timeline -->
            <div class="section" style="padding: 20px 24px; margin-bottom: 20px;">
                <div class="timeline-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <span style="font-size: 0.7rem; letter-spacing: 1px; text-transform: uppercase; color: var(--text-muted);">Upcoming Events</span>
                    <div style="display:flex; gap:8px;">
                        <button class="btn" onclick="openLockTheDateModal()" style="padding: 8px 16px; font-size: 0.8rem; border-radius: 6px; background: #b5956a; color: #fff;">Lock the Date</button>
                        <button class="btn" onclick="openInquiryModal()" style="padding: 8px 16px; font-size: 0.8rem; border-radius: 6px;">Add Inquiry</button>
                    </div>
                </div>
                <div class="timeline-container" id="timelineContainer">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <div class="section">
                <table class="projects-table">
                    <thead>
                        <tr>
                            <th style="width: 20%;">Project</th>
                            <th style="width: 10%;">Event Date</th>
                            <th style="width: 12%;">Location</th>
                            <th style="width: 5%;">Guests</th>
                            <th style="width: 13%;"></th>
                            <th style="width: 13%;"></th>
                            <th style="width: 13%;"></th>
                            <th style="width: 14%;"></th>
                        </tr>
                    </thead>
                    <tbody id="projectsBody">
                        <!-- Populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Calendar Popup Overlay -->
    <div class="calendar-popup-overlay" id="calendarOverlay" onclick="closeCalendarPopup()"></div>

    <!-- Calendar Popup -->
    <div class="calendar-popup" id="calendarPopup">
        <div class="calendar-popup-header">
            <span class="calendar-popup-title" id="calendarPopupTitle">Select Date</span>
            <button class="calendar-popup-close" onclick="closeCalendarPopup()">&times;</button>
        </div>
        <div class="calendar-nav">
            <button onclick="changeMonth(-1)">&larr; Prev</button>
            <span class="calendar-month-year" id="calendarMonthYear"></span>
            <button onclick="changeMonth(1)">Next &rarr;</button>
        </div>
        <div class="calendar-grid">
            <div class="calendar-weekdays">
                <div>Sun</div>
                <div>Mon</div>
                <div>Tue</div>
                <div>Wed</div>
                <div>Thu</div>
                <div>Fri</div>
                <div>Sat</div>
            </div>
            <div class="calendar-days" id="calendarDays"></div>
        </div>
        <div class="calendar-popup-footer">
            <a href="/admin/calendar.html" class="full-calendar-link">Open Full Calendar &rarr;</a>
        </div>
    </div>

    <!-- Tasting Options Email Modal -->
    <div class="modal-overlay" id="tastingOptionsModal" style="display:none;">
        <div class="modal to-modal" id="toModalInner" style="max-width:95vw; width:800px; resize:both; min-width:500px; min-height:350px;">
            <div class="modal-header to-drag-handle" id="toDragHandle" style="cursor:move; user-select:none;">
                <h2 class="modal-title" id="tastingOptionsTitle">Tasting Options</h2>
                <button class="modal-close" onclick="closeTastingOptionsModal()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div style="display:flex; gap:0; flex:1; overflow:hidden;">
                <!-- Left: Date Slots -->
                <div style="width:220px; flex-shrink:0; padding:16px; background:#faf8f5; border-right:1px solid #e8e0d5; overflow-y:auto; display:flex; flex-direction:column;">
                    <div style="font-size:0.6rem; letter-spacing:1px; text-transform:uppercase; color:#b5956a; margin-bottom:12px; font-weight:500;">Tasting Date Options</div>
                    <div id="toDateSlotsList" style="display:flex; flex-direction:column; gap:8px;"></div>
                    <button onclick="addTODateSlot()" style="margin-top:10px; width:100%; padding:8px; background:transparent; border:1px dashed #cbb896; border-radius:4px; cursor:pointer; font-family:'Montserrat',sans-serif; font-size:0.7rem; color:#b5956a;">+ Add Option</button>
                </div>
                <!-- Right: Email Preview -->
                <div style="flex:1; padding:20px; overflow-y:auto; display:flex; flex-direction:column;">
                    <div style="font-size:0.6rem; letter-spacing:1px; text-transform:uppercase; color:#999; margin-bottom:12px;">Email Preview</div>
                    <div style="font-size:0.75rem; color:#666; margin-bottom:6px;">
                        To: <span id="toEmailTo" style="color:#333;"></span>
                    </div>
                    <div style="font-size:0.75rem; color:#666; margin-bottom:12px;">
                        Subject: <span id="toEmailSubject" style="color:#333;"></span>
                    </div>
                    <div id="toEmailBody" style="flex:1; background:#fff; border:1px solid #eee; padding:20px; font-size:0.85rem; line-height:1.7; color:#333; white-space:pre-wrap; font-family:'Montserrat',sans-serif;"></div>
                </div>
            </div>
            <div style="padding:16px 20px; border-top:1px solid #eee; display:flex; justify-content:space-between; background:#faf8f5;">
                <button onclick="closeTastingOptionsModal()" style="padding:10px 20px; background:#fff; border:1px solid #ddd; border-radius:4px; cursor:pointer; font-family:'Montserrat',sans-serif; font-size:0.8rem; color:#666;">Cancel</button>
                <div style="display:flex; gap:10px;">
                    <button onclick="saveTastingOptionsDraft()" style="padding:10px 20px; background:#fff; border:1px solid #b5956a; border-radius:4px; cursor:pointer; font-family:'Montserrat',sans-serif; font-size:0.8rem; color:#b5956a;">Save Draft</button>
                    <button id="toSendBtn" onclick="sendTastingOptionsEmail()" style="padding:10px 24px; background:#b5956a; color:#fff; border:none; border-radius:4px; cursor:pointer; font-family:'Montserrat',sans-serif; font-size:0.8rem;">Send Email</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Set Tasting Date Modal -->
    <div class="modal-overlay" id="setTastingDateModal" style="display:none;">
        <div class="modal" style="max-width:420px;">
            <div class="modal-header">
                <h2 class="modal-title" id="setTastingDateTitle">Set Tasting Date</h2>
                <button class="modal-close" onclick="closeSetTastingDateModal()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div id="setTastingDateBody" style="padding:20px;"></div>
            <div style="padding:16px 20px; border-top:1px solid #eee; display:flex; justify-content:flex-end; gap:10px;">
                <button onclick="closeSetTastingDateModal()" style="padding:10px 20px; background:#fff; border:1px solid #ddd; border-radius:4px; cursor:pointer; font-family:'Montserrat',sans-serif; font-size:0.8rem; color:#666;">Cancel</button>
                <button id="confirmTastingDateBtn" onclick="confirmTastingDate()" style="padding:10px 24px; background:#b5956a; color:#fff; border:none; border-radius:4px; cursor:pointer; font-family:'Montserrat',sans-serif; font-size:0.8rem;">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Add Inquiry Modal -->
    <div class="modal-overlay" id="addInquiryModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Add New Inquiry</h2>
                <button class="modal-close" onclick="closeInquiryModal()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <form id="addInquiryForm">
                <div class="modal-body">
                    <div class="form-row full">
                        <div class="form-group">
                            <button type="button" class="btn" onclick="openContactPicker()" style="background: var(--bg-tertiary); color: var(--text-secondary); border: 1px solid var(--border-color); width: 100%;">
                                Select from Contacts
                            </button>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Name *</label>
                            <input type="text" class="form-input" id="inquiryName" placeholder="Client name" required oninput="if(this.value.toLowerCase()==='jeff')fillTestInquiry()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email *</label>
                            <input type="email" class="form-input" id="inquiryEmail" placeholder="email@example.com" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Event Date</label>
                            <input type="text" class="form-input" id="inquiryEventDate" placeholder="Select date">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Guest Count</label>
                            <input type="text" class="form-input" id="inquiryGuestCount" placeholder="Approximate">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Event Type</label>
                            <select class="form-select" id="inquiryEventType">
                                <option value="Wedding">Wedding</option>
                                <option value="Birthday">Birthday</option>
                                <option value="Anniversary">Anniversary</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Venue / Location</label>
                            <input type="text" class="form-input" id="inquiryVenue" placeholder="City, State or Venue name">
                        </div>
                    </div>

                    <div class="form-row full">
                        <div class="form-group">
                            <label class="form-label">Their Vision / Message</label>
                            <textarea class="form-textarea" id="inquiryMessage" placeholder="Colors, themes, inspirations..." style="min-height: 80px;"></textarea>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Phone</label>
                            <input type="tel" class="form-input" id="inquiryPhone" placeholder="(206) 555-0123" maxlength="14">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Source</label>
                            <select class="form-select" id="inquirySource">
                                <option value="Website">Website Form</option>
                                <option value="Instagram">Instagram</option>
                                <option value="Referral">Referral</option>
                                <option value="Vendor">Vendor Referral</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeInquiryModal()">Cancel</button>
                    <button type="submit" class="btn" style="background: var(--accent-gold);">Add Inquiry</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Contact Picker Popup -->
    <div id="contactPickerOverlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--overlay); z-index: 2000; align-items: center; justify-content: center;">
        <div style="background: var(--modal-bg); width: 90%; max-width: 500px; max-height: 80vh; display: flex; flex-direction: column; box-shadow: 0 10px 40px var(--shadow);">
            <div style="padding: 16px 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                <h3 style="font-family: 'Cormorant Garamond', serif; font-size: 1.3rem; font-weight: 400; color: var(--text-primary);">Select Contact</h3>
                <button onclick="closeContactPicker()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-muted);">&times;</button>
            </div>
            <div style="padding: 12px 20px; border-bottom: 1px solid var(--border-color);">
                <input type="text" id="contactPickerSearch" placeholder="Search contacts..." oninput="filterContactPicker(this.value)" style="width: 100%; padding: 10px 12px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary); font-family: 'Montserrat', sans-serif; font-size: 0.85rem;">
            </div>
            <div id="contactPickerList" style="flex: 1; overflow-y: auto; max-height: 400px; background: var(--bg-secondary);">
                <!-- Contacts loaded here -->
            </div>
        </div>
    </div>

    <!-- Time Picker Modal -->
    <div class="time-picker-modal" id="timePickerModal">
        <div class="time-picker-content">
            <div class="time-picker-header">
                <span class="time-picker-title" id="timePickerTitle">Set Time</span>
                <button class="time-picker-close" onclick="closeTimePicker()">&times;</button>
            </div>
            <div class="time-picker-body">
                <p class="time-picker-date" id="timePickerDate"></p>
                <div class="time-picker-input-row">
                    <label>Time:</label>
                    <select id="timePickerInput" style="flex: 1; padding: 10px 12px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary); font-family: 'Montserrat', sans-serif; font-size: 1rem;">
                        <option value="09:00">9:00 AM</option>
                        <option value="09:15">9:15 AM</option>
                        <option value="09:30">9:30 AM</option>
                        <option value="09:45">9:45 AM</option>
                        <option value="10:00" selected>10:00 AM</option>
                        <option value="10:15">10:15 AM</option>
                        <option value="10:30">10:30 AM</option>
                        <option value="10:45">10:45 AM</option>
                        <option value="11:00">11:00 AM</option>
                        <option value="11:15">11:15 AM</option>
                        <option value="11:30">11:30 AM</option>
                        <option value="11:45">11:45 AM</option>
                        <option value="12:00">12:00 PM</option>
                        <option value="12:15">12:15 PM</option>
                        <option value="12:30">12:30 PM</option>
                        <option value="12:45">12:45 PM</option>
                        <option value="13:00">1:00 PM</option>
                        <option value="13:15">1:15 PM</option>
                        <option value="13:30">1:30 PM</option>
                        <option value="13:45">1:45 PM</option>
                        <option value="14:00">2:00 PM</option>
                        <option value="14:15">2:15 PM</option>
                        <option value="14:30">2:30 PM</option>
                        <option value="14:45">2:45 PM</option>
                        <option value="15:00">3:00 PM</option>
                        <option value="15:15">3:15 PM</option>
                        <option value="15:30">3:30 PM</option>
                        <option value="15:45">3:45 PM</option>
                        <option value="16:00">4:00 PM</option>
                        <option value="16:15">4:15 PM</option>
                        <option value="16:30">4:30 PM</option>
                        <option value="16:45">4:45 PM</option>
                        <option value="17:00">5:00 PM</option>
                    </select>
                </div>
                <div class="time-picker-input-row" id="guestsRow" style="margin-top: 16px;">
                    <label>Guests:</label>
                    <input type="number" id="guestsInput" min="1" max="500" value="2" style="width: 80px; padding: 10px 12px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary); font-family: 'Montserrat', sans-serif; font-size: 1rem;">
                </div>
            </div>
            <div class="time-picker-footer">
                <button class="btn-secondary" onclick="closeTimePicker()">Cancel</button>
                <button class="btn-primary" onclick="saveDateTime()">Save</button>
            </div>
        </div>
    </div>

    <!-- Lock the Date Modal -->
    <div class="modal-overlay" id="lockTheDateModal" style="display:none;">
        <div class="modal" id="ltdModalInner" style="max-width:95vw; width:820px; min-width:500px;">
            <div class="modal-header">
                <h2 class="modal-title" id="ltdTitle">Lock the Date</h2>
                <button class="modal-close" onclick="closeLockTheDateModal()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div style="display:flex; gap:0; flex:1; overflow:hidden;">
                <!-- Left: Client & Amount -->
                <div style="width:260px; flex-shrink:0; padding:20px; background:#faf8f5; border-right:1px solid #e8e0d5; overflow-y:auto; display:flex; flex-direction:column; gap:16px;">
                    <div style="font-size:0.6rem; letter-spacing:1px; text-transform:uppercase; color:#b5956a; font-weight:500;">Client & Deposit</div>

                    <div>
                        <label style="font-size:0.7rem; color:var(--text-muted); letter-spacing:0.5px; text-transform:uppercase; display:block; margin-bottom:4px;">Client *</label>
                        <select id="ltdClientSelect" onchange="ltdClientChanged()" style="width:100%; padding:10px 12px; border:1px solid var(--border-color); border-radius:4px; background:var(--input-bg); color:var(--text-primary); font-family:'Montserrat',sans-serif; font-size:0.85rem;">
                            <option value="">Select client...</option>
                        </select>
                    </div>

                    <div>
                        <label style="font-size:0.7rem; color:var(--text-muted); letter-spacing:0.5px; text-transform:uppercase; display:block; margin-bottom:4px;">Lock Deposit Amount *</label>
                        <div style="position:relative;">
                            <span style="position:absolute; left:12px; top:50%; transform:translateY(-50%); color:var(--text-muted); font-size:0.9rem;">$</span>
                            <input type="number" id="ltdAmount" placeholder="1500" min="100" step="50" style="width:100%; padding:10px 12px 10px 28px; border:1px solid var(--border-color); border-radius:4px; background:var(--input-bg); color:var(--text-primary); font-family:'Montserrat',sans-serif; font-size:0.85rem;">
                        </div>
                    </div>

                    <div id="ltdClientInfo" style="display:none; padding:12px; background:#fff; border:1px solid #eee; border-radius:4px;">
                        <div style="font-size:0.7rem; color:#b5956a; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:6px;">Client Info</div>
                        <div id="ltdClientEmail" style="font-size:0.8rem; color:var(--text-secondary);"></div>
                        <div id="ltdClientEvent" style="font-size:0.8rem; color:var(--text-secondary); margin-top:2px;"></div>
                        <div id="ltdClientDate" style="font-size:0.8rem; color:var(--text-secondary); margin-top:2px;"></div>
                    </div>
                </div>

                <!-- Right: Email Preview -->
                <div style="flex:1; padding:20px; overflow-y:auto; display:flex; flex-direction:column;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                        <div style="font-size:0.6rem; letter-spacing:1px; text-transform:uppercase; color:#999;">Email Preview</div>
                        <button class="ai-polish-btn" id="ltdAiPolishBtn" onclick="aiPolish(document.getElementById('ltdEmailBody'), { apiUrl: API_BASE_URL, onAccept: ltdUpdatePreview, subjectInput: document.getElementById('ltdEmailSubjectInput') })" style="padding:4px 12px; background:linear-gradient(135deg,#b5956a,#d4b896); color:#fff; border:none; border-radius:3px; font-size:0.7rem; font-family:'Montserrat',sans-serif; font-weight:400; letter-spacing:0.5px; cursor:pointer;">Optional AI</button>
                    </div>
                    <div style="font-size:0.75rem; color:#666; margin-bottom:6px;">
                        To: <span id="ltdEmailTo" style="color:#333;">Select a client</span>
                    </div>
                    <div style="font-size:0.75rem; color:#666; margin-bottom:4px;">
                        Subject: <input type="text" id="ltdEmailSubjectInput" style="border:1px solid #eee; padding:4px 8px; font-family:'Montserrat',sans-serif; font-size:0.75rem; color:#333; width:80%; border-radius:3px;" value="">
                    </div>
                    <textarea id="ltdEmailBody" style="flex:1; min-height:250px; background:#fff; border:1px solid #eee; padding:16px; font-size:0.85rem; line-height:1.7; color:#333; font-family:'Montserrat',sans-serif; resize:none; outline:none;"></textarea>
                </div>
            </div>
            <div style="padding:16px 20px; border-top:1px solid #eee; display:flex; justify-content:space-between; background:#faf8f5;">
                <button onclick="closeLockTheDateModal()" style="padding:10px 20px; background:#fff; border:1px solid #ddd; border-radius:4px; cursor:pointer; font-family:'Montserrat',sans-serif; font-size:0.8rem; color:#666;">Cancel</button>
                <button id="ltdSendBtn" onclick="sendLockTheDate()" style="padding:10px 24px; background:#b5956a; color:#fff; border:none; border-radius:4px; cursor:pointer; font-family:'Montserrat',sans-serif; font-size:0.8rem;">Send Lock the Date</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="/js/api.js"></script>
    <script src="/js/ai-polish.js"></script>
    <script>
        // Dark Mode - check saved preference on load
        (function() {
            const darkMode = localStorage.getItem('kgc_dark_mode') === 'true';
            if (darkMode) {
                document.body.classList.add('dark-mode');
            }
            document.addEventListener('DOMContentLoaded', updateDarkModeButton);
        })();

        // Initialize Flatpickr on inquiry date input
        let fpInquiryDate;
        document.addEventListener('DOMContentLoaded', function() {
            fpInquiryDate = flatpickr('#inquiryEventDate', {
                dateFormat: 'Y-m-d',
                altInput: true,
                altFormat: 'F j, Y',
                disableMobile: true,
                monthSelectorType: 'static',
                animate: true
            });

            // Phone auto-format: (xxx) xxx-xxxx
            document.getElementById('inquiryPhone').addEventListener('input', function(e) {
                let digits = this.value.replace(/\D/g, '').substring(0, 10);
                if (digits.length === 0) { this.value = ''; return; }
                if (digits.length <= 3) { this.value = '(' + digits; }
                else if (digits.length <= 6) { this.value = '(' + digits.substring(0,3) + ') ' + digits.substring(3); }
                else { this.value = '(' + digits.substring(0,3) + ') ' + digits.substring(3,6) + '-' + digits.substring(6); }
            });
        });

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('kgc_dark_mode', isDark);
            updateDarkModeButton();
        }

        function updateDarkModeButton() {
            const isDark = document.body.classList.contains('dark-mode');
            const icon = document.getElementById('darkModeIcon');
            const text = document.getElementById('darkModeText');
            if (icon && text) {
                icon.textContent = isDark ? 'â˜€ï¸' : 'ðŸŒ™';
                text.textContent = isDark ? 'Day Mode' : 'Night Mode';
            }
        }

        // Set header date
        const today = new Date();
        const todayStr = today.toISOString().split('T')[0];
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('headerDate').textContent = today.toLocaleDateString('en-US', options);

        // Calendar state
        let calendarCurrentMonth = today.getMonth();
        let calendarCurrentYear = today.getFullYear();
        let calendarSelectedDate = null;
        let calendarEditingClientId = null;
        let calendarEditingField = null; // 'tasting' or 'event'
        let pendingDate = null; // Date selected, waiting for time

        // ========== API-FIRST APPROACH ==========
        // All data comes from the Railway backend
        // In-memory cache for fast synchronous reads

        let clientsCache = [];
        let portalDataCache = {};
        let proposalsCache = {};
        let signaturesCache = {};
        let tastingDraftsCache = {};

        // Load all data from API on page start
        async function loadAllDataFromAPI() {
            try {
                // Load clients
                const apiClients = await apiGetClients();
                clientsCache = toCamelCase(apiClients || []);
                console.log('Loaded', clientsCache.length, 'clients from API');

                // Load proposals for all clients
                const apiProposals = await apiGetProposals();
                const proposals = toCamelCase(apiProposals || []);
                proposals.forEach(p => {
                    if (p.clientId) {
                        proposalsCache[p.clientId] = p;
                        if (p.signedAt) {
                            signaturesCache[p.clientId] = p;
                        }
                    }
                });

                // Load portal data for active clients
                for (const client of clientsCache.filter(c => c.status !== 'contact')) {
                    try {
                        const pd = await apiGetPortalData(client.id);
                        if (pd && Object.keys(pd).length > 0) {
                            portalDataCache[client.id] = toCamelCase(pd);
                        }
                    } catch (e) {
                        // No portal data for this client yet
                    }
                }

                // Render with fresh data
                renderTimeline();
                renderProjects();
            } catch (error) {
                console.error('API error:', error);
                showError('Could not connect to server. Please check your internet connection.');
            }
        }

        // Show error message to user
        function showToast(message, type) {
            const toast = document.createElement('div');
            toast.textContent = message;
            const bg = type === 'success' ? '#5a6b52' : type === 'error' ? '#c44' : '#b5956a';
            Object.assign(toast.style, {
                position: 'fixed', bottom: '24px', right: '24px', padding: '12px 24px',
                background: bg, color: '#fff', borderRadius: '6px', zIndex: '9999',
                fontFamily: "'Montserrat',sans-serif", fontSize: '0.85rem', boxShadow: '0 4px 12px rgba(0,0,0,0.2)'
            });
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function showError(message) {
            const tbody = document.getElementById('projectsBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="empty-state" style="color: #c00;">
                        <h3>Connection Error</h3>
                        <p>${message}</p>
                        <button onclick="location.reload()" class="btn" style="margin-top: 15px;">Retry</button>
                    </td>
                </tr>
            `;
        }

        // Synchronous getters (read from cache)
        function getClients() {
            return clientsCache;
        }

        function getPortalData(clientId) {
            return portalDataCache[clientId] || portalDataCache[String(clientId)] || {};
        }

        function isProposalSigned(clientId) {
            return signaturesCache[clientId] || signaturesCache[String(clientId)];
        }

        function hasProposalDraft(clientId) {
            return proposalsCache[clientId] || proposalsCache[String(clientId)];
        }

        function getTastingDraft(clientId) {
            // Check localStorage tasting drafts first (from tasting scheduler)
            const drafts = JSON.parse(localStorage.getItem('kgc_tasting_drafts') || '{}');
            const draft = drafts[clientId] || drafts[String(clientId)];
            if (draft && (draft.tastingDate || draft.tastingTime)) {
                return { date: draft.tastingDate, time: draft.tastingTime, guests: draft.guestCount };
            }

            // Then check client data from API
            const client = clientsCache.find(c => c.id == clientId);
            if (client && (client.tastingDate || client.tastingTime)) {
                return { date: client.tastingDate, time: client.tastingTime, guests: client.tastingGuests };
            }

            // Finally check portal data
            const pd = getPortalData(clientId);
            if (pd.tastingDate) {
                return { date: pd.tastingDate, time: pd.tastingTime, guests: pd.tastingGuests };
            }
            return null;
        }

        // Async save to API (updates cache immediately for responsiveness)
        async function updateClient(clientId, updates) {
            // Update cache immediately
            const idx = clientsCache.findIndex(c => c.id == clientId);
            if (idx >= 0) {
                clientsCache[idx] = { ...clientsCache[idx], ...updates };
            }

            // Sync to API
            try {
                await apiUpdateClient(clientId, toSnakeCase(updates));
                console.log('Client updated in API');
            } catch (error) {
                console.error('Failed to update client in API:', error);
            }
        }

        function openTastingScheduler(clientId) {
            window.location.href = `/invoices/tasting-scheduler.html?clientId=${clientId}`;
        }

        // Guarded tasting invoice - check date first
        function openTastingInvoiceGuarded(clientId) {
            const client = clientsCache.find(c => String(c.id) === String(clientId));
            const tastingDraft = getTastingDraft(clientId);
            const tastingDate = tastingDraft?.date || client?.tastingDate;
            if (!tastingDate) {
                showToast('Set a tasting date first', 'warning');
                return;
            }
            openTastingScheduler(clientId);
        }

        async function openProposalBuilder(clientId) {
            // Generate a unique 4-digit proposal number if not already assigned
            const drafts = JSON.parse(localStorage.getItem('kgc_proposal_drafts') || '{}');

            // Check if this client already has a proposal with a number
            if (!drafts[clientId] || !drafts[clientId].proposalNumber) {
                // Find the highest existing proposal number
                let maxNum = 0;
                Object.values(drafts).forEach(draft => {
                    if (draft.proposalNumber) {
                        const num = parseInt(draft.proposalNumber, 10);
                        if (num > maxNum) maxNum = num;
                    }
                });

                // Generate next proposal number (4 digits, starting from 0750)
                const newProposalNumber = String(maxNum === 0 ? 750 : maxNum + 1).padStart(4, '0');

                // Save the proposal number to the draft
                if (!drafts[clientId]) {
                    drafts[clientId] = {};
                }
                drafts[clientId].proposalNumber = newProposalNumber;
                drafts[clientId].createdAt = drafts[clientId].createdAt || new Date().toISOString();
                localStorage.setItem('kgc_proposal_drafts', JSON.stringify(drafts));

                // Sync to API
                try {
                    await saveProposalDraft(clientId, drafts[clientId]);
                } catch (error) {
                    console.log('Proposal draft API sync failed:', error.message);
                }

                console.log('Assigned proposal number P-' + newProposalNumber + ' to client ' + clientId);
            }

            window.location.href = `/proposals/proposal-builder.html?clientId=${clientId}`;
        }

        function viewSignedProposal(clientId) {
            // Open in same window for now - could be popup later
            window.location.href = `/proposals/proposal-builder.html?clientId=${clientId}&view=signed`;
        }

        // ============ TASTING OPTIONS EMAIL MODAL ============

        let toCurrentClientId = null;
        let toDateSlots = [];

        const defaultTastingOptionsTemplate = {
            subject: 'Kenna Giuzio Cake - Tasting Options for Your {eventType}',
            body: `Hi {firstName},

I'd love to schedule your tasting consultation! Here is a date and time that works for me:

[Click to select date/time]

Tastings typically last about 1-2 hours. We'll sample flavors, discuss your design vision, and I'll answer any questions you have.

Please let me know what works for you, or if you'd prefer a different time, share a few times that fit your schedule and I'll do my best to accommodate.

Looking forward to meeting you!

Warmly,
Kenna`
        };

        async function getTastingOptionsTemplate() {
            let custom = {};
            try {
                const res = await fetch(`${API_BASE_URL}/api/settings/email_templates`);
                if (res.ok) {
                    const data = await res.json();
                    if (data.value && typeof data.value === 'object') custom = data.value;
                }
            } catch (e) {
                try { custom = JSON.parse(localStorage.getItem('kgc_email_templates') || '{}'); } catch (e2) {}
            }
            if (custom['tasting-options']) {
                return { ...defaultTastingOptionsTemplate, ...custom['tasting-options'] };
            }
            return defaultTastingOptionsTemplate;
        }

        function openTastingOptionsModal(clientId) {
            toCurrentClientId = clientId;
            const client = clientsCache.find(c => String(c.id) === String(clientId));
            if (!client) { showToast('Client not found', 'error'); return; }
            if (!client.email) { showToast('No email for this client', 'warning'); return; }

            document.getElementById('tastingOptionsTitle').textContent = 'Tasting Options â€” ' + client.name;
            document.getElementById('toEmailTo').textContent = client.email;

            // Load saved draft or start with 1 empty slot
            const drafts = JSON.parse(localStorage.getItem('kgc_tasting_options_drafts') || '{}');
            const draft = drafts[clientId] || drafts[String(clientId)];
            if (draft && draft.dateSlots) {
                toDateSlots = draft.dateSlots;
            } else {
                toDateSlots = [{ date: null, startTime: '14:00', endTime: '16:00' }];
            }
            renderTODateSlots();
            updateTOEmailPreview();

            // Reset modal position for fresh open
            const inner = document.getElementById('toModalInner');
            inner.style.position = '';
            inner.style.left = '';
            inner.style.top = '';
            inner.style.transform = '';
            inner.style.margin = '';

            const modal = document.getElementById('tastingOptionsModal');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('active'), 10);
            document.body.style.overflow = 'hidden';
        }

        function closeTastingOptionsModal() {
            // Clear pending holds if modal was cancelled (not sent)
            if (toCurrentClientId) clearPendingHolds(toCurrentClientId);
            const modal = document.getElementById('tastingOptionsModal');
            modal.classList.remove('active');
            setTimeout(() => {
                modal.style.display = 'none';
                document.body.style.overflow = '';
            }, 300);
            toCurrentClientId = null;
        }

        // Draggable modal
        (function() {
            let isDragging = false, dragOffsetX = 0, dragOffsetY = 0;
            const handle = document.getElementById('toDragHandle');
            const modal = document.getElementById('toModalInner');

            handle.addEventListener('mousedown', function(e) {
                if (e.target.closest('.modal-close')) return;
                isDragging = true;
                const rect = modal.getBoundingClientRect();
                dragOffsetX = e.clientX - rect.left;
                dragOffsetY = e.clientY - rect.top;
                modal.style.position = 'fixed';
                modal.style.margin = '0';
                e.preventDefault();
            });

            document.addEventListener('mousemove', function(e) {
                if (!isDragging) return;
                modal.style.left = (e.clientX - dragOffsetX) + 'px';
                modal.style.top = (e.clientY - dragOffsetY) + 'px';
                modal.style.transform = 'none';
            });

            document.addEventListener('mouseup', function() {
                isDragging = false;
            });
        })();

        function addTODateSlot() {
            if (toDateSlots.length >= 3) return;
            toDateSlots.push({ date: null, startTime: '14:00', endTime: '16:00' });
            renderTODateSlots();
            updateTOEmailPreview();
        }

        function removeTODateSlot(index) {
            if (toDateSlots.length <= 1) return;
            toDateSlots.splice(index, 1);
            renderTODateSlots();
            updateTOEmailPreview();
            syncPendingHoldsToCalendar();
        }

        function updateTOSlotStartTime(index, newStartTime) {
            toDateSlots[index].startTime = newStartTime;
            // Auto-set end time to start + 2 hours
            const [h, m] = newStartTime.split(':').map(Number);
            const endH = h + 2;
            if (endH <= 23) {
                toDateSlots[index].endTime = String(endH).padStart(2, '0') + ':' + String(m).padStart(2, '0');
            }
            renderTODateSlots();
            updateTOEmailPreview();
            syncPendingHoldsToCalendar();
        }

        function renderTODateSlots() {
            const container = document.getElementById('toDateSlotsList');
            container.innerHTML = toDateSlots.map((slot, i) => {
                const label = toDateSlots.length > 1 ? `Option ${i + 1}` : '';
                const dateDisplay = slot.date ? new Date(slot.date + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' }) : 'Pick from calendar...';

                return `
                    <div style="position:relative; background:#fff; border:1px solid ${slot.date ? '#b5956a' : '#ddd'}; border-radius:6px; padding:10px;">
                        ${label ? `<div style="font-size:0.55rem; text-transform:uppercase; letter-spacing:0.5px; color:#999; margin-bottom:4px;">${label}</div>` : ''}
                        <div class="to-date-btn" data-slot="${i}" onclick="openCalendarForSlot(${i})"
                            style="width:100%; padding:6px 8px; border:1px solid #eee; border-radius:3px; font-family:'Montserrat',sans-serif; font-size:0.75rem; cursor:pointer; background:#fafafa; margin-bottom:6px; box-sizing:border-box; color:${slot.date ? '#333' : '#999'};">
                            ${dateDisplay}
                        </div>
                        <div style="display:flex; gap:4px;">
                            <select onchange="updateTOSlotStartTime(${i}, this.value)" style="flex:1; padding:4px; border:1px solid #eee; border-radius:3px; font-size:0.65rem; font-family:'Montserrat',sans-serif;">
                                ${generateTimeOptions(slot.startTime)}
                            </select>
                            <span style="font-size:0.6rem; color:#999; align-self:center;">to</span>
                            <select onchange="toDateSlots[${i}].endTime=this.value; updateTOEmailPreview(); syncPendingHoldsToCalendar();" style="flex:1; padding:4px; border:1px solid #eee; border-radius:3px; font-size:0.65rem; font-family:'Montserrat',sans-serif;">
                                ${generateTimeOptions(slot.endTime)}
                            </select>
                        </div>
                        ${toDateSlots.length > 1 ? `<button onclick="removeTODateSlot(${i})" style="position:absolute; top:4px; right:4px; width:16px; height:16px; padding:0; background:#fff; border:1px solid #ddd; border-radius:50%; cursor:pointer; color:#999; font-size:0.6rem; line-height:14px; text-align:center;">&times;</button>` : ''}
                    </div>
                `;
            }).join('');
        }

        function syncPendingHoldsToCalendar() {
            // Write current date slots as pending holds so they show on calendar immediately
            if (!toCurrentClientId) return;
            const client = clientsCache.find(c => String(c.id) === String(toCurrentClientId));
            if (!client) return;
            const lastName = client.name.split(' ').pop();

            const holds = JSON.parse(localStorage.getItem('kgc_tasting_holds') || '[]');
            // Remove old pending holds for this client
            const cleaned = holds.filter(e => !(e.isPending && String(e.clientId) === String(toCurrentClientId)));
            // Add current filled slots as pending holds
            toDateSlots.forEach((slot, i) => {
                if (slot.date) {
                    cleaned.push({
                        id: 'pending_' + toCurrentClientId + '_' + i,
                        title: lastName + ' Tasting Hold',
                        date: slot.date,
                        time: slot.startTime || '',
                        endTime: slot.endTime || '',
                        type: 'hold',
                        clientId: toCurrentClientId,
                        isHold: true,
                        isPending: true
                    });
                }
            });
            localStorage.setItem('kgc_tasting_holds', JSON.stringify(cleaned));
        }

        function clearPendingHolds(clientId) {
            const holds = JSON.parse(localStorage.getItem('kgc_tasting_holds') || '[]');
            localStorage.setItem('kgc_tasting_holds', JSON.stringify(holds.filter(e => !(e.isPending && String(e.clientId) === String(clientId)))));
        }

        function openCalendarForSlot(slotIndex) {
            // Set callback so calendar returns the date to this slot
            calendarPickerCallback = function(dateStr) {
                toDateSlots[slotIndex].date = dateStr;
                renderTODateSlots();
                updateTOEmailPreview();
                // Sync pending holds so the just-picked date shows on calendar
                syncPendingHoldsToCalendar();
                // Reset z-index after picking
                document.getElementById('calendarOverlay').style.zIndex = '';
                document.getElementById('calendarPopup').style.zIndex = '';
            };

            // Open the full calendar popup (shows all events for conflict detection)
            calendarEditingClientId = null;
            calendarEditingField = null;
            calendarSelectedDate = toDateSlots[slotIndex].date || null;

            const title = 'Select Tasting Date â€” See Calendar for Conflicts';
            document.getElementById('calendarPopupTitle').textContent = title;

            calendarCurrentMonth = today.getMonth();
            calendarCurrentYear = today.getFullYear();

            // Bump z-index above the modal overlay (z-index: 1200)
            document.getElementById('calendarOverlay').style.zIndex = '1300';
            document.getElementById('calendarPopup').style.zIndex = '1301';

            renderCalendar();
            document.getElementById('calendarOverlay').classList.add('active');
            document.getElementById('calendarPopup').classList.add('active');
        }

        function generateTimeOptions(selectedValue) {
            const times = [];
            for (let h = 8; h <= 19; h++) {
                for (let m = 0; m < 60; m += 30) {
                    const val = String(h).padStart(2, '0') + ':' + String(m).padStart(2, '0');
                    const hour12 = h % 12 || 12;
                    const ampm = h >= 12 ? 'PM' : 'AM';
                    const label = `${hour12}:${String(m).padStart(2, '0')} ${ampm}`;
                    const sel = val === selectedValue ? ' selected' : '';
                    times.push(`<option value="${val}"${sel}>${label}</option>`);
                }
            }
            return times.join('');
        }

        async function updateTOEmailPreview() {
            const client = clientsCache.find(c => String(c.id) === String(toCurrentClientId));
            if (!client) return;

            const template = await getTastingOptionsTemplate();

            // Build first name (handle couples)
            let firstName = 'there';
            if (client.name) {
                const name = client.name.trim();
                if (name.includes(' & ')) {
                    const parts = name.split(' ');
                    parts.pop();
                    firstName = parts.join(' ');
                } else {
                    firstName = name.split(' ')[0];
                }
            }
            const eventType = client.eventType || 'event';

            // Build date options list
            let dateList = '';
            const filledSlots = toDateSlots.filter(s => s.date);
            if (filledSlots.length > 0) {
                dateList = filledSlots.map((slot, i) => {
                    const d = new Date(slot.date + 'T00:00:00');
                    const dateStr = d.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
                    const startH = parseInt(slot.startTime.split(':')[0]);
                    const startM = slot.startTime.split(':')[1];
                    const startAmpm = startH >= 12 ? 'PM' : 'AM';
                    const startH12 = startH % 12 || 12;
                    const endH = parseInt(slot.endTime.split(':')[0]);
                    const endM = slot.endTime.split(':')[1];
                    const endAmpm = endH >= 12 ? 'PM' : 'AM';
                    const endH12 = endH % 12 || 12;
                    const timeStr = `${startH12}:${startM} ${startAmpm} - ${endH12}:${endM} ${endAmpm}`;
                    const prefix = filledSlots.length > 1 ? `Option ${i + 1}: ` : '';
                    return `${prefix}${dateStr}, ${timeStr}`;
                }).join('\n');
            } else {
                dateList = '[Select dates above]';
            }

            // Replace placeholders
            let subject = template.subject
                .replace(/{firstName}/g, firstName)
                .replace(/{eventType}/g, eventType);

            let body = template.body
                .replace(/{firstName}/g, firstName)
                .replace(/{eventType}/g, eventType)
                .replace(/\[Click to select date\/time\]/g, dateList);

            document.getElementById('toEmailSubject').textContent = subject;
            document.getElementById('toEmailBody').textContent = body;
        }

        function buildBrandedEmailHtml(bodyText) {
            const paragraphs = bodyText.split('\n\n').map(p =>
                '<p style="margin:0 0 16px 0; font-family:Arial,Helvetica,sans-serif; font-size:15px; line-height:1.7; color:#333333;">' +
                p.replace(/\n/g, '<br>') + '</p>'
            ).join('');

            return '<div style="background-color:#f5f3f0; padding:30px 20px;">' +
                '<table role="presentation" width="100%" cellpadding="0" cellspacing="0" style="max-width:600px; margin:0 auto; background-color:#ffffff;">' +
                '<tr><td style="height:4px; background-color:#b5956a;"></td></tr>' +
                '<tr><td align="center" style="padding:30px 40px 10px;">' +
                '<img src="https://portal.kennagiuziocake.com/images/logo.png" alt="Kenna Giuzio Cake" width="140" style="display:block;">' +
                '</td></tr>' +
                '<tr><td style="padding:20px 40px 10px;">' +
                paragraphs +
                '</td></tr>' +
                '<tr><td style="padding:0 40px;"><hr style="border:none; border-top:1px solid #eeeeee; margin:0;"></td></tr>' +
                '<tr><td align="center" style="padding:24px 40px 30px;">' +
                '<p style="margin:0; font-family:Georgia,serif; font-size:13px; color:#999999; line-height:1.6;">' +
                'Kenna Giuzio Cake<br>' +
                '(206) 472-5401 &nbsp;|&nbsp; kenna@kennagiuziocake.com<br>' +
                'Queen Anne, Seattle' +
                '</p>' +
                '</td></tr>' +
                '</table>' +
                '</div>';
        }

        function saveTastingOptionsDraft() {
            if (!toCurrentClientId) return;
            const drafts = JSON.parse(localStorage.getItem('kgc_tasting_options_drafts') || '{}');
            drafts[toCurrentClientId] = {
                dateSlots: toDateSlots,
                savedAt: new Date().toISOString()
            };
            localStorage.setItem('kgc_tasting_options_drafts', JSON.stringify(drafts));
            showToast('Draft saved', 'success');
            closeTastingOptionsModal();
            renderProjects();
        }

        async function sendTastingOptionsEmail() {
            const client = clientsCache.find(c => String(c.id) === String(toCurrentClientId));
            if (!client || !client.email) { showToast('No client email', 'error'); return; }

            const subject = document.getElementById('toEmailSubject').textContent;
            const bodyText = document.getElementById('toEmailBody').textContent;

            if (!bodyText.trim()) { showToast('Email body is empty', 'warning'); return; }

            const btn = document.getElementById('toSendBtn');
            btn.disabled = true;
            btn.textContent = 'Sending...';

            try {
                const html = buildBrandedEmailHtml(bodyText);
                const response = await fetch(`${API_BASE_URL}/api/gmail/send`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        to: client.email,
                        subject: subject,
                        message: bodyText,
                        html: html,
                        client_id: toCurrentClientId
                    })
                });

                const result = await response.json();
                if (!response.ok) throw new Error(result.error || 'Failed to send');

                // Mark tasting options as sent for this client
                const sentFlags = JSON.parse(localStorage.getItem('kgc_tasting_options_sent') || '{}');
                sentFlags[toCurrentClientId] = new Date().toISOString();
                localStorage.setItem('kgc_tasting_options_sent', JSON.stringify(sentFlags));

                // Convert pending holds to permanent (remove pending flag)
                const holds = JSON.parse(localStorage.getItem('kgc_tasting_holds') || '[]');
                // Remove any pending holds for this client first
                const cleaned = holds.filter(e => !(e.isPending && String(e.clientId) === String(toCurrentClientId)));
                // Add permanent holds
                const filledSlots = toDateSlots.filter(s => s.date);
                const lastName = client.name.split(' ').pop();
                filledSlots.forEach(slot => {
                    cleaned.push({
                        id: 'hold_' + toCurrentClientId + '_' + slot.date + '_' + Date.now(),
                        title: lastName + ' Tasting Hold',
                        date: slot.date,
                        time: slot.startTime || '',
                        endTime: slot.endTime || '',
                        type: 'hold',
                        clientId: toCurrentClientId,
                        isHold: true
                    });
                });
                localStorage.setItem('kgc_tasting_holds', JSON.stringify(cleaned));
                console.log('Tasting holds saved:', cleaned.length, 'holds for client', toCurrentClientId, cleaned);

                // Clear draft since it's been sent
                const drafts = JSON.parse(localStorage.getItem('kgc_tasting_options_drafts') || '{}');
                delete drafts[toCurrentClientId];
                delete drafts[String(toCurrentClientId)];
                localStorage.setItem('kgc_tasting_options_drafts', JSON.stringify(drafts));

                showToast('Tasting options email sent!', 'success');
                closeTastingOptionsModal();
                // Refresh to update button statuses
                renderProjects();
            } catch (err) {
                showToast('Error: ' + err.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Send Email';
            }
        }

        // ============ END TASTING OPTIONS MODAL ============

        // ============ LOCK THE DATE MODAL ============
        let ltdCurrentClient = null;

        const defaultLockTheDateTemplate = {
            subject: 'Kenna Giuzio Cake - Lock Your Date - {eventDate}',
            body: `Hi {firstName},

Thank you for your interest in a custom creation for your {eventType}! I'm truly excited about the possibility of working together.

To reserve your date of {eventDate}, a Lock the Date deposit of {lockAmount} is required. This deposit will be credited toward your final balance once your custom proposal is ready.

You can submit your deposit securely here:
[LOCK DEPOSIT LINK]

Once received, your date will be held exclusively for you while we finalize the design details.

I look forward to creating something beautiful for your celebration!

Warmly,
Kenna`
        };

        async function getLockTheDateTemplate() {
            let custom = {};
            try {
                const res = await fetch(`${API_BASE_URL}/api/settings/email_templates`);
                if (res.ok) {
                    const data = await res.json();
                    if (data.value && typeof data.value === 'object') custom = data.value;
                }
            } catch (e) {
                try { custom = JSON.parse(localStorage.getItem('kgc_email_templates') || '{}'); } catch (e2) {}
            }
            if (custom['lock-the-date']) {
                return { ...defaultLockTheDateTemplate, ...custom['lock-the-date'] };
            }
            return defaultLockTheDateTemplate;
        }

        async function openLockTheDateModal() {
            // Populate client dropdown
            const select = document.getElementById('ltdClientSelect');
            const clients = clientsCache.length ? clientsCache : await getClients();
            select.innerHTML = '<option value="">Select client...</option>' +
                clients.sort((a, b) => a.name.localeCompare(b.name)).map(c =>
                    `<option value="${c.id}">${c.name}${c.email ? ' â€” ' + c.email : ''}</option>`
                ).join('');

            // Reset fields
            document.getElementById('ltdAmount').value = '';
            document.getElementById('ltdEmailTo').textContent = 'Select a client';
            document.getElementById('ltdClientInfo').style.display = 'none';
            ltdCurrentClient = null;

            // Load template
            const tpl = await getLockTheDateTemplate();
            document.getElementById('ltdEmailSubjectInput').value = tpl.subject;
            document.getElementById('ltdEmailBody').value = tpl.body;

            const modal = document.getElementById('lockTheDateModal');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('active'), 10);
            document.body.style.overflow = 'hidden';
        }

        function closeLockTheDateModal() {
            const modal = document.getElementById('lockTheDateModal');
            modal.classList.remove('active');
            setTimeout(() => {
                modal.style.display = 'none';
                document.body.style.overflow = '';
            }, 300);
            ltdCurrentClient = null;
        }

        // Close modal on overlay click
        document.getElementById('lockTheDateModal').addEventListener('click', function(e) {
            if (e.target === this) closeLockTheDateModal();
        });

        function ltdClientChanged() {
            const select = document.getElementById('ltdClientSelect');
            const clientId = select.value;
            if (!clientId) {
                ltdCurrentClient = null;
                document.getElementById('ltdEmailTo').textContent = 'Select a client';
                document.getElementById('ltdClientInfo').style.display = 'none';
                return;
            }

            const client = clientsCache.find(c => String(c.id) === String(clientId));
            if (!client) return;
            ltdCurrentClient = client;

            document.getElementById('ltdEmailTo').textContent = client.email || 'No email';
            document.getElementById('ltdClientInfo').style.display = 'block';
            document.getElementById('ltdClientEmail').textContent = client.email || 'No email';
            document.getElementById('ltdClientEvent').textContent = client.eventType || 'No event type';
            document.getElementById('ltdClientDate').textContent = client.eventDate ? new Date(client.eventDate + 'T00:00:00').toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' }) : 'No date';

            ltdUpdatePreview();
        }

        function ltdUpdatePreview() {
            if (!ltdCurrentClient) return;
            const client = ltdCurrentClient;
            const firstName = (client.name || '').split(' ')[0];
            const eventType = client.eventType || 'celebration';
            const eventDate = client.eventDate ? new Date(client.eventDate + 'T00:00:00').toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' }) : '[date]';
            const amount = document.getElementById('ltdAmount').value;
            const lockAmount = amount ? '$' + parseFloat(amount).toLocaleString() : '[amount]';

            // Update subject
            const subjectInput = document.getElementById('ltdEmailSubjectInput');
            let subject = subjectInput.value;
            subject = subject.replace(/{firstName}/g, firstName)
                .replace(/{eventType}/g, eventType)
                .replace(/{eventDate}/g, eventDate)
                .replace(/{lockAmount}/g, lockAmount);
            // Only replace if template vars are present (don't re-replace after manual edits)
            if (subjectInput.value.includes('{')) {
                subjectInput.value = subject;
            }

            // Update body
            const bodyEl = document.getElementById('ltdEmailBody');
            let body = bodyEl.value;
            body = body.replace(/{firstName}/g, firstName)
                .replace(/{eventType}/g, eventType)
                .replace(/{eventDate}/g, eventDate)
                .replace(/{lockAmount}/g, lockAmount);
            bodyEl.value = body;
        }

        // Update preview when amount changes
        document.getElementById('ltdAmount').addEventListener('input', function() {
            if (ltdCurrentClient) {
                // Only replace {lockAmount} placeholder, not already-filled amounts
                const bodyEl = document.getElementById('ltdEmailBody');
                const body = bodyEl.value;
                const amount = this.value;
                const lockAmount = amount ? '$' + parseFloat(amount).toLocaleString() : '[amount]';
                // Replace the lock amount pattern
                bodyEl.value = body.replace(/\$[\d,]+(?= is required)|\[amount\](?= is required)/g, lockAmount);
            }
        });

        async function sendLockTheDate() {
            if (!ltdCurrentClient) { showToast('Select a client first', 'warning'); return; }
            if (!ltdCurrentClient.email) { showToast('Client has no email address', 'error'); return; }

            const amount = parseFloat(document.getElementById('ltdAmount').value);
            if (!amount || amount < 100) { showToast('Enter a deposit amount ($100 minimum)', 'warning'); return; }

            const btn = document.getElementById('ltdSendBtn');
            btn.disabled = true;
            btn.textContent = 'Sending...';

            try {
                // 1. Create the lock_deposit invoice in the database
                const invoiceNumber = 'LI-' + new Date().getFullYear() + '-' + String(ltdCurrentClient.id).padStart(4, '0');
                const invoiceResp = await fetch(`${API_BASE_URL}/api/invoices`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        client_id: ltdCurrentClient.id,
                        invoice_number: invoiceNumber,
                        type: 'lock_deposit',
                        amount: amount,
                        status: 'sent',
                        data: {
                            clientName: ltdCurrentClient.name,
                            eventType: ltdCurrentClient.eventType,
                            eventDate: ltdCurrentClient.eventDate,
                            sentAt: new Date().toISOString()
                        }
                    })
                });
                if (!invoiceResp.ok) throw new Error('Failed to create invoice');
                const invoice = await invoiceResp.json();

                // 2. Build the payment link
                const paymentUrl = `https://portal.kennagiuziocake.com/invoices/deposit-invoice.html?clientId=${ltdCurrentClient.id}&invoiceId=${invoice.id}&mode=lock-deposit&amount=${amount}&name=${encodeURIComponent(ltdCurrentClient.name)}&email=${encodeURIComponent(ltdCurrentClient.email)}&eventType=${encodeURIComponent(ltdCurrentClient.eventType || '')}&eventDate=${encodeURIComponent(ltdCurrentClient.eventDate || '')}`;

                // 3. Build email with payment link
                const subject = document.getElementById('ltdEmailSubjectInput').value;
                let bodyText = document.getElementById('ltdEmailBody').value;
                bodyText = bodyText.replace('[LOCK DEPOSIT LINK]', paymentUrl);

                // Build branded HTML with button
                const buttonHtml = `<table role="presentation" width="100%" cellpadding="0" cellspacing="0" style="margin:24px 0;"><tr><td align="center"><a href="${paymentUrl}" style="display:inline-block; padding:16px 48px; background-color:#b5956a; color:#ffffff; font-family:'Montserrat',Arial,sans-serif; font-size:14px; font-weight:400; letter-spacing:2px; text-transform:uppercase; text-decoration:none; border-radius:2px;">View Invoice & Pay</a></td></tr></table>`;
                const htmlBody = bodyText.replace(paymentUrl, buttonHtml);
                const html = buildBrandedEmailHtml(htmlBody);

                // 4. Send the email
                const sendResp = await fetch(`${API_BASE_URL}/api/gmail/send`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        to: ltdCurrentClient.email,
                        subject: subject,
                        message: bodyText,
                        html: html,
                        client_id: ltdCurrentClient.id
                    })
                });
                const sendResult = await sendResp.json();
                if (!sendResp.ok) throw new Error(sendResult.error || 'Failed to send email');

                showToast('Lock the Date sent to ' + ltdCurrentClient.name + '!', 'success');
                closeLockTheDateModal();
                renderProjects();
            } catch (err) {
                showToast('Error: ' + err.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Send Lock the Date';
            }
        }

        // ============ END LOCK THE DATE MODAL ============

        // ============ SET TASTING DATE MODAL ============
        let stdClientId = null;

        function openSetTastingDate(clientId) {
            const client = clientsCache.find(c => String(c.id) === String(clientId));
            if (!client) return;

            // Check for hold events (sent tasting options) â€” check both new and legacy keys
            const newHolds = JSON.parse(localStorage.getItem('kgc_tasting_holds') || '[]');
            const legacyHolds = JSON.parse(localStorage.getItem('kgc_calendar_events') || '[]').filter(e => e.isHold);
            const allHolds = [...newHolds, ...legacyHolds];
            const holds = allHolds.filter(e => String(e.clientId) === String(clientId));
            console.log('Set Tasting Date â€” holds found:', holds.length, 'for client', clientId, '| new:', newHolds.length, 'legacy:', legacyHolds.length);

            // Check if a tasting date is already set
            const td = getTastingDraft(clientId);
            const existingDate = td?.date || client.tastingDate;
            const existingTime = td?.time || client.tastingTime;

            if (holds.length === 0 && !existingDate) {
                // No tasting options sent and no date set â€” fall back to calendar popup
                openCalendarPopup(clientId, 'tasting', null, null);
                return;
            }

            if (holds.length === 0 && existingDate) {
                // Date already set, no holds â€” open edit mode with current date pre-selected
                openEditTastingDate(clientId, existingDate, existingTime);
                return;
            }

            stdClientId = clientId;
            const lastName = client.name.split(' ').pop();
            document.getElementById('setTastingDateTitle').textContent = 'Set Tasting Date â€” ' + client.name;

            // Build options HTML
            let html = '<div style="display:flex; flex-direction:column; gap:12px;">';

            const multipleHolds = holds.length > 1;
            holds.forEach((hold, i) => {
                const d = new Date(hold.date + 'T00:00:00');
                const dateLabel = d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
                const startLabel = hold.time ? formatTime(hold.time) : '';
                const endLabel = hold.endTime ? formatTime(hold.endTime) : '';
                const timeLabel = startLabel && endLabel ? startLabel + ' - ' + endLabel : startLabel || '';
                const optionLabel = multipleHolds ? `Option ${i + 1}: ` : '';

                html += `
                    <label style="display:flex; align-items:flex-start; gap:10px; padding:12px; border:1px solid #eee; border-radius:6px; cursor:pointer; transition:background 0.15s;"
                           onmouseover="this.style.background='#faf8f5'" onmouseout="this.style.background=''">
                        <input type="radio" name="tastingDateOption" value="hold_${i}"
                               data-date="${hold.date}" data-start="${hold.time || ''}" data-end="${hold.endTime || ''}"
                               style="margin-top:3px; accent-color:#b5956a;">
                        <div>
                            <div style="font-family:'Montserrat',sans-serif; font-size:0.85rem; font-weight:500; color:#333;">${optionLabel}${dateLabel}</div>
                            ${timeLabel ? `<div style="font-family:'Montserrat',sans-serif; font-size:0.75rem; color:#888; margin-top:2px;">${timeLabel}</div>` : ''}
                        </div>
                    </label>`;
            });

            // Custom option
            html += `
                <label style="display:flex; align-items:flex-start; gap:10px; padding:12px; border:1px solid #eee; border-radius:6px; cursor:pointer; transition:background 0.15s;"
                       onmouseover="this.style.background='#faf8f5'" onmouseout="this.style.background=''">
                    <input type="radio" name="tastingDateOption" value="custom" style="margin-top:3px; accent-color:#b5956a;"
                           onchange="document.getElementById('stdCustomFields').style.display='flex'">
                    <div style="flex:1;">
                        <div style="font-family:'Montserrat',sans-serif; font-size:0.85rem; font-weight:500; color:#333;">Custom date & time</div>
                        <div id="stdCustomFields" style="display:none; flex-direction:column; gap:8px; margin-top:8px;">
                            <div id="stdCustomDateBtn" onclick="openCalendarForCustomTastingDate()"
                                style="padding:6px 8px; border:1px solid #ddd; border-radius:4px; font-family:'Montserrat',sans-serif; font-size:0.8rem; cursor:pointer; background:#fafafa; color:#999;">
                                Pick from calendar...
                            </div>
                            <input type="hidden" id="stdCustomDate">
                            <div style="display:flex; gap:6px; align-items:center;">
                                <select id="stdCustomStartTime" style="flex:1; padding:6px; border:1px solid #ddd; border-radius:4px; font-size:0.75rem; font-family:'Montserrat',sans-serif;">
                                    ${generateTimeOptions('14:00')}
                                </select>
                                <span style="font-size:0.7rem; color:#999;">to</span>
                                <select id="stdCustomEndTime" style="flex:1; padding:6px; border:1px solid #ddd; border-radius:4px; font-size:0.75rem; font-family:'Montserrat',sans-serif;">
                                    ${generateTimeOptions('16:00')}
                                </select>
                            </div>
                        </div>
                    </div>
                </label>`;

            html += '</div>';

            document.getElementById('setTastingDateBody').innerHTML = html;

            // Show/hide custom fields based on radio selection
            document.querySelectorAll('input[name="tastingDateOption"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    document.getElementById('stdCustomFields').style.display = this.value === 'custom' ? 'flex' : 'none';
                });
            });

            // Show modal â€” ensure confirm button uses the holds-based handler
            const modal = document.getElementById('setTastingDateModal');
            document.getElementById('confirmTastingDateBtn').setAttribute('onclick', 'confirmTastingDate()');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('active'), 10);
        }

        function closeSetTastingDateModal() {
            const modal = document.getElementById('setTastingDateModal');
            modal.classList.remove('active');
            setTimeout(() => { modal.style.display = 'none'; }, 300);
            stdClientId = null;
        }

        function openEditTastingDate(clientId, existingDate, existingTime) {
            stdClientId = clientId;
            const client = clientsCache.find(c => String(c.id) === String(clientId));
            if (!client) return;

            document.getElementById('setTastingDateTitle').textContent = 'Edit Tasting Date â€” ' + client.name;

            const d = new Date(existingDate + 'T00:00:00');
            const dateLabel = d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
            const timeLabel = existingTime ? formatTime(existingTime) : '';

            let html = '<div style="display:flex; flex-direction:column; gap:12px;">';

            // Show current date
            html += `
                <div style="padding:12px; border:1px solid #b5956a; border-radius:6px; background:#faf8f5;">
                    <div style="font-size:0.6rem; text-transform:uppercase; letter-spacing:0.5px; color:#999; margin-bottom:4px;">Current Tasting Date</div>
                    <div style="font-family:'Montserrat',sans-serif; font-size:0.9rem; font-weight:500; color:#333;">${dateLabel}</div>
                    ${timeLabel ? `<div style="font-family:'Montserrat',sans-serif; font-size:0.75rem; color:#888; margin-top:2px;">${timeLabel}</div>` : ''}
                </div>`;

            // Calendar pick button
            html += `
                <div style="text-align:center;">
                    <div id="editTastingDateBtn" onclick="openCalendarForEditTastingDate()"
                        style="display:inline-block; padding:8px 16px; border:1px solid #b5956a; border-radius:6px; font-family:'Montserrat',sans-serif; font-size:0.8rem; cursor:pointer; background:#fff; color:#b5956a; transition:background 0.15s;"
                        onmouseover="this.style.background='#faf8f5'" onmouseout="this.style.background='#fff'">
                        Change Date on Calendar
                    </div>
                    <input type="hidden" id="editTastingDate" value="${existingDate}">
                </div>`;

            // Time selectors
            html += `
                <div style="display:flex; gap:6px; align-items:center; justify-content:center;">
                    <select id="editTastingStartTime" style="padding:6px; border:1px solid #ddd; border-radius:4px; font-size:0.75rem; font-family:'Montserrat',sans-serif;">
                        ${generateTimeOptions(existingTime || '14:00')}
                    </select>
                    <span style="font-size:0.7rem; color:#999;">to</span>
                    <select id="editTastingEndTime" style="padding:6px; border:1px solid #ddd; border-radius:4px; font-size:0.75rem; font-family:'Montserrat',sans-serif;">
                        ${generateTimeOptions(existingTime ? (() => { const [h,m] = existingTime.split(':').map(Number); return String(h+2).padStart(2,'0') + ':' + String(m).padStart(2,'0'); })() : '16:00')}
                    </select>
                </div>`;

            html += '</div>';

            document.getElementById('setTastingDateBody').innerHTML = html;

            // Show modal â€” reuse the same setTastingDateModal but swap the confirm button handler
            const modal = document.getElementById('setTastingDateModal');
            const confirmBtn = document.getElementById('confirmTastingDateBtn');
            confirmBtn.setAttribute('onclick', 'confirmEditTastingDate()');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('active'), 10);
        }

        function openCalendarForEditTastingDate() {
            calendarPickerCallback = function(dateStr) {
                document.getElementById('editTastingDate').value = dateStr;
                const d = new Date(dateStr + 'T00:00:00');
                const label = d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
                const btn = document.getElementById('editTastingDateBtn');
                btn.textContent = label;
                btn.style.color = '#333';
                btn.style.borderColor = '#4a9a6a';
                btn.style.background = '#f0f8f4';
                document.getElementById('calendarOverlay').style.zIndex = '';
                document.getElementById('calendarPopup').style.zIndex = '';
            };

            calendarEditingClientId = null;
            calendarEditingField = null;
            calendarSelectedDate = document.getElementById('editTastingDate').value || null;

            document.getElementById('calendarPopupTitle').textContent = 'Change Tasting Date â€” See Calendar for Conflicts';

            calendarCurrentMonth = today.getMonth();
            calendarCurrentYear = today.getFullYear();

            document.getElementById('calendarOverlay').style.zIndex = '1300';
            document.getElementById('calendarPopup').style.zIndex = '1301';

            renderCalendar();
            document.getElementById('calendarOverlay').classList.add('active');
            document.getElementById('calendarPopup').classList.add('active');
        }

        async function confirmEditTastingDate() {
            const date = document.getElementById('editTastingDate').value;
            const startTime = document.getElementById('editTastingStartTime').value;
            if (!date) { showToast('Pick a date', 'warning'); return; }

            const client = clientsCache.find(c => String(c.id) === String(stdClientId));
            if (!client) return;

            const btn = document.getElementById('confirmTastingDateBtn');
            btn.disabled = true;
            btn.textContent = 'Saving...';

            try {
                // Save tasting date via API
                await updateClient(client.id, {
                    tastingDate: date,
                    tastingTime: startTime
                });

                // Sync to tasting drafts
                const tastingDrafts = JSON.parse(localStorage.getItem('kgc_tasting_drafts') || '{}');
                if (!tastingDrafts[client.id]) tastingDrafts[client.id] = {};
                tastingDrafts[client.id].tastingDate = date;
                tastingDrafts[client.id].tastingTime = startTime;
                localStorage.setItem('kgc_tasting_drafts', JSON.stringify(tastingDrafts));

                showToast('Tasting date updated!', 'success');
                closeSetTastingDateModal();
                renderProjects();
            } catch (err) {
                showToast('Error: ' + err.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Confirm';
                // Restore original confirm handler
                btn.setAttribute('onclick', 'confirmTastingDate()');
            }
        }

        function openCalendarForCustomTastingDate() {
            calendarPickerCallback = function(dateStr) {
                document.getElementById('stdCustomDate').value = dateStr;
                const d = new Date(dateStr + 'T00:00:00');
                const label = d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
                const btn = document.getElementById('stdCustomDateBtn');
                btn.textContent = label;
                btn.style.color = '#333';
                // Reset z-index
                document.getElementById('calendarOverlay').style.zIndex = '';
                document.getElementById('calendarPopup').style.zIndex = '';
            };

            calendarEditingClientId = null;
            calendarEditingField = null;
            calendarSelectedDate = document.getElementById('stdCustomDate').value || null;

            document.getElementById('calendarPopupTitle').textContent = 'Select Tasting Date â€” See Calendar for Conflicts';

            calendarCurrentMonth = today.getMonth();
            calendarCurrentYear = today.getFullYear();

            // Bump z-index above both modals
            document.getElementById('calendarOverlay').style.zIndex = '1300';
            document.getElementById('calendarPopup').style.zIndex = '1301';

            renderCalendar();
            document.getElementById('calendarOverlay').classList.add('active');
            document.getElementById('calendarPopup').classList.add('active');
        }

        async function confirmTastingDate() {
            const selected = document.querySelector('input[name="tastingDateOption"]:checked');
            if (!selected) { showToast('Select a date option', 'warning'); return; }

            let date, startTime, endTime;

            if (selected.value === 'custom') {
                date = document.getElementById('stdCustomDate').value;
                startTime = document.getElementById('stdCustomStartTime').value;
                endTime = document.getElementById('stdCustomEndTime').value;
                if (!date) { showToast('Enter a custom date', 'warning'); return; }
            } else {
                date = selected.dataset.date;
                startTime = selected.dataset.start;
                endTime = selected.dataset.end;
            }

            const client = clientsCache.find(c => String(c.id) === String(stdClientId));
            if (!client) return;

            const btn = document.getElementById('confirmTastingDateBtn');
            btn.disabled = true;
            btn.textContent = 'Saving...';

            try {
                // Save tasting date via API
                await updateClient(client.id, {
                    tastingDate: date,
                    tastingTime: startTime
                });

                // Sync to tasting drafts for calendar
                const tastingDrafts = JSON.parse(localStorage.getItem('kgc_tasting_drafts') || '{}');
                if (!tastingDrafts[client.id]) tastingDrafts[client.id] = {};
                tastingDrafts[client.id].tastingDate = date;
                tastingDrafts[client.id].tastingTime = startTime;
                localStorage.setItem('kgc_tasting_drafts', JSON.stringify(tastingDrafts));

                // Remove hold events for this client (both keys)
                const newHolds = JSON.parse(localStorage.getItem('kgc_tasting_holds') || '[]');
                localStorage.setItem('kgc_tasting_holds', JSON.stringify(newHolds.filter(e => String(e.clientId) !== String(stdClientId))));
                const calEvts = JSON.parse(localStorage.getItem('kgc_calendar_events') || '[]');
                localStorage.setItem('kgc_calendar_events', JSON.stringify(calEvts.filter(e => !(e.isHold && String(e.clientId) === String(stdClientId)))));

                showToast('Tasting date set!', 'success');
                closeSetTastingDateModal();
                renderProjects();
            } catch (err) {
                showToast('Error: ' + err.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Confirm';
            }
        }

        // ============ END SET TASTING DATE MODAL ============

        function formatDate(dateStr) {
            if (!dateStr) return null;
            // Always strip time/timezone to avoid UTCâ†’local shift (-1 day in PT)
            const clean = String(dateStr).split('T')[0];
            const date = new Date(clean + 'T00:00:00');
            if (isNaN(date.getTime())) return null;
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function formatTime(timeStr) {
            if (!timeStr) return '';
            const [hours, mins] = timeStr.split(':');
            const h = parseInt(hours);
            const ampm = h >= 12 ? 'PM' : 'AM';
            const hour12 = h % 12 || 12;
            return `${hour12}:${mins} ${ampm}`;
        }

        function formatDateTime(dateStr, timeStr) {
            const date = formatDate(dateStr);
            if (!date) return null;
            const time = formatTime(timeStr);
            return time ? `${date} @ ${time}` : date;
        }

        function getDateClass(dateStr) {
            if (!dateStr) return 'empty';
            // Always strip time/timezone to avoid UTCâ†’local shift
            const clean = String(dateStr).split('T')[0];
            const date = new Date(clean + 'T00:00:00');
            if (isNaN(date.getTime())) return 'empty';
            const diffDays = Math.ceil((date - today) / (1000 * 60 * 60 * 24));

            if (diffDays < 0) return 'past';
            return '';
        }

        // Check if tasting is paid (portal data OR localStorage invoice)
        function isTastingPaid(clientId) {
            const portalData = getPortalData(clientId);
            if (portalData.tastingPaid) return true;

            // Fallback: check localStorage invoices
            const invoices = JSON.parse(localStorage.getItem('kgc_invoices') || '[]');
            const tastingInvoice = invoices.find(i => String(i.clientId) === String(clientId) && i.type === 'tasting');
            if (tastingInvoice && tastingInvoice.status === 'paid') return true;

            // Fallback: check client data
            const clients = JSON.parse(localStorage.getItem('kgc_clients') || '[]');
            const client = clients.find(c => String(c.id) === String(clientId));
            if (client && client.tastingPaid) return true;

            return false;
        }

        function getProgressInfo(client) {
            const signed = isProposalSigned(client.id);
            const portalData = getPortalData(client.id);
            const tastingDraft = getTastingDraft(client.id);
            const proposalDraft = hasProposalDraft(client.id);
            const tastingPaid = isTastingPaid(client.id);
            const tastingStarted = client.status === 'tasting' || tastingDraft || tastingPaid;

            const steps = ['inquiry', 'tasting', 'proposal', 'booked', 'delivered'];
            let currentStep = 0;
            let label = 'Inquiry';

            // Track which steps are actually completed
            let stepStates = ['complete', 'future', 'future', 'future', 'future']; // inquiry always done

            // Tasting stage
            if (tastingStarted) {
                stepStates[1] = tastingPaid ? 'complete' : 'current';
                if (!proposalDraft && !signed) {
                    currentStep = 1;
                    label = 'Tasting';
                }
            } else {
                stepStates[1] = 'skipped'; // Will be ghosted if we're past it
            }

            // Proposal stage - if proposal draft exists or signed
            if (client.status === 'proposal' || proposalDraft || signed) {
                currentStep = 2;
                label = 'Proposal';
                if (!tastingStarted) stepStates[1] = 'skipped';
                stepStates[2] = signed ? 'complete' : 'current';
            }

            // Booked stage - signed and deposit paid
            if (signed && portalData.depositPaid) {
                currentStep = 3;
                label = 'Booked';
                stepStates[2] = 'complete';
                stepStates[3] = 'current';
            }

            // Delivered stage
            if (client.status === 'complete' || client.status === 'delivered') {
                currentStep = 4;
                label = 'Delivered';
                stepStates[3] = 'complete';
                stepStates[4] = 'current';
            }

            return { currentStep, label, total: steps.length, stepStates };
        }

        function renderProgressBar(progress) {
            // Calculate position percentage for the label (center it on current step)
            const stepWidth = 100 / progress.total;
            const labelPosition = (progress.currentStep * stepWidth) + (stepWidth / 2);

            let html = '<div class="progress-wrapper">';
            html += '<div class="progress-bar">';
            for (let i = 0; i < progress.total; i++) {
                const state = progress.stepStates ? progress.stepStates[i] : (i < progress.currentStep ? 'complete' : (i === progress.currentStep ? 'current' : 'future'));
                let cls = 'progress-step';
                if (state === 'complete') cls += ' complete';
                else if (state === 'current') cls += ' current';
                else if (state === 'skipped') cls += ' skipped';
                // 'future' gets no additional class (stays ghosted/grey)
                html += `<div class="${cls}"></div>`;
            }
            html += '</div>';
            html += `<div class="progress-label ${progress.currentStep < progress.total - 1 ? 'current' : ''}" style="position: absolute; left: ${labelPosition}%; transform: translateX(-50%); white-space: nowrap;">${progress.label}</div>`;
            html += '</div>';
            return html;
        }

        function openClientPortal(clientId) {
            window.location.href = `/clients/view.html?id=${clientId}`;
        }

        // Calendar popup functions
        let calendarEditingCurrentTime = null;
        let calendarPickerCallback = null; // For Tasting Options date picker mode

        function openCalendarPopup(clientId, field, currentDate, currentTime) {
            calendarEditingClientId = clientId;
            calendarEditingField = field;
            calendarSelectedDate = currentDate || null;
            calendarEditingCurrentTime = currentTime || null;

            // Set title
            const title = field === 'tasting' ? 'Select Tasting Date' : 'Select Event Date';
            document.getElementById('calendarPopupTitle').textContent = title;

            // Set month/year to current date or selected date
            if (currentDate) {
                const d = new Date(currentDate + 'T00:00:00');
                calendarCurrentMonth = d.getMonth();
                calendarCurrentYear = d.getFullYear();
            } else {
                calendarCurrentMonth = today.getMonth();
                calendarCurrentYear = today.getFullYear();
            }

            renderCalendar();
            document.getElementById('calendarOverlay').classList.add('active');
            document.getElementById('calendarPopup').classList.add('active');
        }

        function closeCalendarPopup() {
            document.getElementById('calendarOverlay').classList.remove('active');
            document.getElementById('calendarPopup').classList.remove('active');
            document.getElementById('calendarOverlay').style.zIndex = '';
            document.getElementById('calendarPopup').style.zIndex = '';
            calendarEditingClientId = null;
            calendarEditingField = null;
            calendarPickerCallback = null;
        }

        function changeMonth(delta) {
            calendarCurrentMonth += delta;
            if (calendarCurrentMonth > 11) {
                calendarCurrentMonth = 0;
                calendarCurrentYear++;
            } else if (calendarCurrentMonth < 0) {
                calendarCurrentMonth = 11;
                calendarCurrentYear--;
            }
            renderCalendar();
        }

        function getEventsForMonth(year, month) {
            const clients = getClients();
            const events = [];

            clients.forEach(client => {
                // Event dates
                if (client.eventDate) {
                    const d = new Date(client.eventDate + 'T00:00:00');
                    if (d.getFullYear() === year && d.getMonth() === month) {
                        events.push({
                            date: client.eventDate,
                            type: 'event',
                            name: client.name,
                            eventType: client.eventType || 'Event'
                        });
                    }
                }
                // Tasting dates
                const tastingDraft = getTastingDraft(client.id);
                const tastingDate = tastingDraft?.date || client.tastingDate;
                if (tastingDate) {
                    const d = new Date(tastingDate + 'T00:00:00');
                    if (d.getFullYear() === year && d.getMonth() === month) {
                        events.push({
                            date: tastingDate,
                            type: 'tasting',
                            name: client.name,
                            eventType: 'Tasting'
                        });
                    }
                }
                // Inquiry dates
                if (client.createdAt) {
                    // Convert UTC timestamp to local date to avoid +1 day offset
                    const createdLocal = new Date(client.createdAt);
                    const inquiryDate = createdLocal.getFullYear() + '-' + String(createdLocal.getMonth()+1).padStart(2,'0') + '-' + String(createdLocal.getDate()).padStart(2,'0');
                    const d = createdLocal;
                    if (d.getFullYear() === year && d.getMonth() === month) {
                        const lastName = client.name.split(' ').pop();
                        events.push({
                            date: inquiryDate,
                            type: 'inquiry',
                            name: lastName + ' Inquiry',
                            eventType: 'Inquiry'
                        });
                    }
                }
            });

            // Custom calendar events
            const customEvents = JSON.parse(localStorage.getItem('kgc_calendar_events') || '[]');
            customEvents.forEach(evt => {
                if (evt.date) {
                    addEventForMonth(events, evt.date, evt.endDate, year, month, {
                        type: evt.type || 'event',
                        name: evt.title || 'Event',
                        eventType: evt.eventType || 'Event'
                    });
                }
            });

            // Tasting hold events (stored separately to survive API sync)
            const holdEvents = JSON.parse(localStorage.getItem('kgc_tasting_holds') || '[]');
            holdEvents.forEach(evt => {
                if (evt.date) {
                    const d = new Date(evt.date + 'T00:00:00');
                    if (d.getFullYear() === year && d.getMonth() === month) {
                        events.push({
                            date: evt.date,
                            type: 'hold',
                            name: evt.title || 'Tasting Hold',
                            eventType: 'Hold'
                        });
                    }
                }
            });

            // Imported calendars
            const importedCalendars = JSON.parse(localStorage.getItem('kgc_imported_calendars') || '[]');
            importedCalendars.forEach(cal => {
                if (cal.enabled) {
                    cal.events.forEach(evt => {
                        if (evt.date) {
                            addEventForMonth(events, evt.date, evt.endDate, year, month, {
                                type: 'personal',
                                name: evt.name || 'Personal',
                                eventType: cal.name || 'Personal'
                            });
                        }
                    });
                }
            });

            return events;
        }

        // Helper to add event entries for each day it spans within the month
        function addEventForMonth(events, startDate, endDate, year, month, eventData) {
            const monthStart = new Date(year, month, 1);
            const monthEnd = new Date(year, month + 1, 0);

            const start = new Date(startDate + 'T00:00:00');
            const end = endDate ? new Date(endDate + 'T00:00:00') : start;

            // Iterate through each day of the event
            const current = new Date(Math.max(start.getTime(), monthStart.getTime()));
            const lastDay = new Date(Math.min(end.getTime(), monthEnd.getTime()));

            while (current <= lastDay) {
                if (current.getMonth() === month && current.getFullYear() === year) {
                    const dateStr = current.getFullYear() + '-' +
                        String(current.getMonth() + 1).padStart(2, '0') + '-' +
                        String(current.getDate()).padStart(2, '0');
                    events.push({
                        date: dateStr,
                        ...eventData,
                        isMultiDay: endDate && endDate !== startDate,
                        isStart: dateStr === startDate,
                        isEnd: dateStr === endDate
                    });
                }
                current.setDate(current.getDate() + 1);
            }
        }

        function renderCalendar() {
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                               'July', 'August', 'September', 'October', 'November', 'December'];

            document.getElementById('calendarMonthYear').textContent =
                monthNames[calendarCurrentMonth] + ' ' + calendarCurrentYear;

            const events = getEventsForMonth(calendarCurrentYear, calendarCurrentMonth);

            // Group events by date
            const eventsByDate = {};
            events.forEach(e => {
                if (!eventsByDate[e.date]) eventsByDate[e.date] = [];
                eventsByDate[e.date].push(e);
            });

            const firstDay = new Date(calendarCurrentYear, calendarCurrentMonth, 1);
            const lastDay = new Date(calendarCurrentYear, calendarCurrentMonth + 1, 0);
            const startDayOfWeek = firstDay.getDay();
            const daysInMonth = lastDay.getDate();

            let html = '';

            // Previous month's trailing days
            const prevMonth = new Date(calendarCurrentYear, calendarCurrentMonth, 0);
            const prevMonthDays = prevMonth.getDate();
            for (let i = startDayOfWeek - 1; i >= 0; i--) {
                const day = prevMonthDays - i;
                html += `<div class="calendar-day other-month"><span class="day-number">${day}</span></div>`;
            }

            // Current month days
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${calendarCurrentYear}-${String(calendarCurrentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const date = new Date(calendarCurrentYear, calendarCurrentMonth, day);
                const dayEvents = eventsByDate[dateStr] || [];

                let classes = 'calendar-day';
                if (date < today) classes += ' past';
                if (date.toDateString() === today.toDateString()) classes += ' today';
                if (dateStr === calendarSelectedDate) classes += ' selected';

                // Build events HTML
                let eventsHtml = '<div class="day-events">';
                const maxDisplay = 2;
                dayEvents.slice(0, maxDisplay).forEach(e => {
                    let classes = `day-event ${e.type}`;
                    const shortName = e.name.length > 10 ? e.name.substring(0, 8) + '...' : e.name;
                    if (e.isMultiDay) {
                        classes += ' multi-day';
                        if (e.isStart && e.isEnd) classes += ' bar-single';
                        else if (e.isStart) classes += ' bar-start';
                        else if (e.isEnd) classes += ' bar-end';
                        else classes += ' bar-middle';
                    }
                    eventsHtml += `<div class="${classes}" title="${e.name} (${e.eventType})">${shortName}</div>`;
                });
                if (dayEvents.length > maxDisplay) {
                    eventsHtml += `<div class="day-event-more">+${dayEvents.length - maxDisplay} more</div>`;
                }
                eventsHtml += '</div>';

                html += `<div class="${classes}" onclick="selectCalendarDate('${dateStr}')">
                    <span class="day-number">${day}</span>
                    ${eventsHtml}
                </div>`;
            }

            // Next month's leading days
            const totalCells = startDayOfWeek + daysInMonth;
            const remainingCells = (7 - (totalCells % 7)) % 7;
            for (let i = 1; i <= remainingCells; i++) {
                html += `<div class="calendar-day other-month"><span class="day-number">${i}</span></div>`;
            }

            document.getElementById('calendarDays').innerHTML = html;
        }

        function selectCalendarDate(dateStr) {
            calendarSelectedDate = dateStr;
            pendingDate = dateStr;
            renderCalendar();

            // If in picker callback mode (Tasting Options), return date and close
            if (calendarPickerCallback) {
                const cb = calendarPickerCallback;
                calendarPickerCallback = null;
                closeCalendarPopup();
                cb(dateStr);
                return;
            }

            // Show time picker
            setTimeout(() => {
                openTimePicker(dateStr);
            }, 150);
        }

        function openTimePicker(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            const formattedDate = date.toLocaleDateString('en-US', {
                weekday: 'long',
                month: 'long',
                day: 'numeric',
                year: 'numeric'
            });

            const fieldLabel = calendarEditingField === 'tasting' ? 'Tasting' : 'Event';
            document.getElementById('timePickerTitle').textContent = `Set ${fieldLabel} Time`;
            document.getElementById('timePickerDate').textContent = formattedDate;
            // Use existing time if available, otherwise default to 10:00
            document.getElementById('timePickerInput').value = calendarEditingCurrentTime || '10:00';

            // Load existing guests
            const clients = getClients();
            const client = clients.find(c => c.id === calendarEditingClientId || String(c.id) === String(calendarEditingClientId));
            if (calendarEditingField === 'tasting') {
                document.getElementById('guestsInput').value = client?.tastingGuests || 2;
            } else {
                document.getElementById('guestsInput').value = client?.guestCount || client?.eventGuests || 100;
            }

            document.getElementById('timePickerModal').classList.add('active');
        }

        function closeTimePicker() {
            document.getElementById('timePickerModal').classList.remove('active');
            pendingDate = null;
        }

        async function saveDateTime() {
            const time = document.getElementById('timePickerInput').value;

            if (calendarEditingClientId && calendarEditingField && pendingDate) {
                const clients = getClients();
                const client = clients.find(c => c.id === calendarEditingClientId || String(c.id) === String(calendarEditingClientId));

                if (client) {
                    const guests = parseInt(document.getElementById('guestsInput').value) || 2;

                    let updates = {};
                    if (calendarEditingField === 'tasting') {
                        updates = {
                            tastingDate: pendingDate,
                            tastingTime: time,
                            tastingGuests: guests
                        };
                    } else if (calendarEditingField === 'event') {
                        updates = {
                            eventDate: pendingDate,
                            eventTime: time,
                            guestCount: guests
                        };
                    }

                    // Update via API (also updates cache)
                    await updateClient(client.id, updates);

                    // Also sync tasting date to kgc_tasting_drafts so calendar picks it up
                    if (calendarEditingField === 'tasting') {
                        const tastingDrafts = JSON.parse(localStorage.getItem('kgc_tasting_drafts') || '{}');
                        if (!tastingDrafts[client.id]) tastingDrafts[client.id] = {};
                        tastingDrafts[client.id].tastingDate = pendingDate;
                        tastingDrafts[client.id].tastingTime = time;
                        tastingDrafts[client.id].guestCount = guests;
                        localStorage.setItem('kgc_tasting_drafts', JSON.stringify(tastingDrafts));
                    }
                }
            }

            closeTimePicker();
            closeCalendarPopup();
            renderProjects();
        }

        function renderProjects() {
            const allClients = getClients();

            // In Studio = active pipeline
            const activeClients = allClients.filter(c =>
                c.status !== 'complete' &&
                c.status !== 'contact' &&
                !c.archived
            );

            const tbody = document.getElementById('projectsBody');

            if (activeClients.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-state">
                            <h3>No Active Projects</h3>
                            <p>Click "Add Inquiry" to start a new project.</p>
                        </td>
                    </tr>
                `;
                return;
            }

            // Sort by event date (soonest first)
            activeClients.sort((a, b) => {
                if (a.eventDate && b.eventDate) {
                    return new Date(a.eventDate) - new Date(b.eventDate);
                }
                if (a.eventDate) return -1;
                if (b.eventDate) return 1;
                return new Date(b.createdAt || 0) - new Date(a.createdAt || 0);
            });

            tbody.innerHTML = activeClients.map(client => {
                const portalData = getPortalData(client.id);
                const tastingDraft = getTastingDraft(client.id);

                // Key data
                const tastingDate = tastingDraft?.date || client.tastingDate;
                const tastingTime = tastingDraft?.time || client.tastingTime;
                const eventDate = client.eventDate;
                const eventTime = client.eventTime;
                const eventGuests = client.guestCount;
                const venue = client.venue || '';

                // Project title
                const eventTitle = portalData.portalTitle || `${client.name} ${client.eventType || 'Event'}`;

                // Event date cell - clickable to open calendar
                const eventDisplay = eventDate
                    ? `<span class="clickable" onclick="event.stopPropagation(); openCalendarPopup(${client.id}, 'event', '${eventDate}', '${eventTime || ''}')">${formatDate(eventDate)}${eventTime ? '<br><span class="time-display">' + formatTime(eventTime) + '</span>' : ''}</span>`
                    : `<span class="set-date" onclick="event.stopPropagation(); openCalendarPopup(${client.id}, 'event', null, null)">+ Set</span>`;

                // --- Workflow button statuses ---

                // 1. Tasting Options: done if sent, draft if saved, default if nothing
                const toSentFlags = JSON.parse(localStorage.getItem('kgc_tasting_options_sent') || '{}');
                const tastingOptionsSent = !!toSentFlags[client.id] || !!toSentFlags[String(client.id)];
                const toDraftFlags = JSON.parse(localStorage.getItem('kgc_tasting_options_drafts') || '{}');
                const tastingOptionsDraft = !!toDraftFlags[client.id] || !!toDraftFlags[String(client.id)];
                let tastingOptClass = 'wf-btn';
                let tastingOptStatus = 'Not sent';
                if (tastingOptionsSent || !!tastingDate) {
                    tastingOptClass = 'wf-btn wf-done';
                    tastingOptStatus = 'Sent';
                } else if (tastingOptionsDraft) {
                    tastingOptClass = 'wf-btn wf-progress';
                    tastingOptStatus = 'Draft';
                }

                // 2. Set Tasting Date: done if date exists
                const setDateClass = tastingDate ? 'wf-btn wf-done' : 'wf-btn';
                const setDateStatus = tastingDate ? formatDate(tastingDate) : 'Not set';

                // 3. Tasting Invoice: disabled if no date, draft if date set, sent if emailed, paid if paid
                const tastingPaid = isTastingPaid(client.id);
                const invoiceSentFlags = JSON.parse(localStorage.getItem('kgc_tasting_invoice_sent') || '{}');
                const tastingInvoiceSent = !!invoiceSentFlags[client.id] || !!invoiceSentFlags[String(client.id)];
                let invoiceClass = 'wf-btn';
                let invoiceStatus = 'Not sent';
                if (!tastingDate) {
                    invoiceClass = 'wf-btn wf-disabled';
                    invoiceStatus = 'Set date first';
                } else if (tastingPaid) {
                    invoiceClass = 'wf-btn wf-done';
                    invoiceStatus = 'Paid';
                } else if (tastingInvoiceSent) {
                    invoiceClass = 'wf-btn wf-done';
                    invoiceStatus = 'Sent';
                } else {
                    invoiceClass = 'wf-btn wf-progress';
                    invoiceStatus = 'Draft';
                }

                // 4. Proposal: Not started â†’ Draft â†’ Sent â†’ Signed â†’ Paid
                const proposalFromAPI = proposalsCache[client.id] || proposalsCache[String(client.id)];
                const localDrafts = JSON.parse(localStorage.getItem('kgc_proposal_drafts') || '{}');
                const hasLocalDraft = !!localDrafts[client.id] || !!localDrafts[String(client.id)];
                const proposalSent = (proposalFromAPI && proposalFromAPI.status === 'sent') || client.proposalSentAt || client.status === 'proposal';
                const signed = isProposalSigned(client.id);
                const depositPaid = portalData.depositPaid;
                let proposalClass = 'wf-btn';
                let proposalStatus = 'Not started';
                if (depositPaid) {
                    proposalClass = 'wf-btn wf-done';
                    proposalStatus = 'Paid';
                } else if (signed) {
                    proposalClass = 'wf-btn wf-done';
                    proposalStatus = 'Signed';
                } else if (proposalSent) {
                    proposalClass = 'wf-btn wf-done';
                    proposalStatus = 'Sent';
                } else if (hasLocalDraft || proposalFromAPI) {
                    proposalClass = 'wf-btn wf-progress';
                    proposalStatus = 'Draft';
                }

                return `
                    <tr onclick="openClientPortal(${client.id})" style="cursor: pointer;" data-client-id="${client.id}">
                        <td class="project-name">
                            <a href="#" onclick="openClientPortal(${client.id}); return false;">${eventTitle}</a>
                        </td>
                        <td class="date-cell ${getDateClass(eventDate)}" onclick="event.stopPropagation(); openCalendarPopup(${client.id}, 'event', ${eventDate ? `'${eventDate}'` : 'null'}, ${eventTime ? `'${eventTime}'` : 'null'})">
                            ${eventDisplay}
                        </td>
                        <td class="location-cell" title="${venue}">${venue || '-'}</td>
                        <td class="date-cell" style="color: var(--text-muted);">${eventGuests || '-'}</td>
                        <td class="wf-cell" onclick="event.stopPropagation();">
                            <button class="${tastingOptClass}" onclick="openTastingOptionsModal(${client.id})">
                                <span class="wf-label">Tasting Options</span>
                                <span class="wf-status">${tastingOptStatus}</span>
                            </button>
                        </td>
                        <td class="wf-cell" onclick="event.stopPropagation();">
                            <button class="${setDateClass}" onclick="openSetTastingDate(${client.id})">
                                <span class="wf-label">Tasting Date</span>
                                <span class="wf-status">${setDateStatus}</span>
                            </button>
                        </td>
                        <td class="wf-cell" onclick="event.stopPropagation();">
                            <button class="${invoiceClass}" onclick="openTastingInvoiceGuarded(${client.id})">
                                <span class="wf-label">Tasting Invoice</span>
                                <span class="wf-status">${invoiceStatus}</span>
                            </button>
                        </td>
                        <td class="wf-cell" onclick="event.stopPropagation();">
                            <button class="${proposalClass}" onclick="${signed ? 'viewSignedProposal' : 'openProposalBuilder'}(${client.id})">
                                <span class="wf-label">Proposal</span>
                                <span class="wf-status">${proposalStatus}</span>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Apply brand colors
        function applyBrandColors() {
            const palette = JSON.parse(localStorage.getItem('kgc_brand_palette') || 'null');
            if (!palette) return;

            const primary = palette.primary || [];
            if (primary.length > 0) {
                let css = '';
                css += `.nav-item.active { border-left-color: ${primary[0].hex}; }\n`;
                css += `.btn { background: ${primary[0].hex}; }\n`;
                css += `.btn:hover { background: ${primary[0].hex}dd; }\n`;
                css += `.date-cell.soon { color: ${primary[0].hex}; }\n`;
                css += `.wf-btn:hover { border-color: ${primary[0].hex}; }\n`;
                css += `.date-cell .set-date { color: ${primary[0].hex}; }\n`;
                css += `.date-cell.clickable:hover { color: ${primary[0].hex}; }\n`;
                css += `.project-name a:hover { color: ${primary[0].hex}; }\n`;
                css += `.calendar-day.selected { border-color: ${primary[0].hex}; }\n`;

                const style = document.createElement('style');
                style.textContent = css;
                document.head.appendChild(style);
            }
        }

        // Load brand palette from API in background
        async function loadBrandPaletteFromAPI() {
            try {
                const palette = await getSetting('brand_palette');
                if (palette) {
                    localStorage.setItem('kgc_brand_palette', JSON.stringify(palette));
                    applyBrandColors();
                }
            } catch (error) {
                console.log('In-studio: Using localStorage for brand palette:', error.message);
            }
        }

        // Test data fill
        function fillTestInquiry() {
            const firstNames = ['Emma', 'Olivia', 'Ava', 'Sophia', 'Isabella', 'Charlotte', 'Amelia', 'Harper', 'Michael', 'James', 'William', 'Benjamin'];
            const lastNames = ['Smith', 'Johnson', 'Williams', 'Brown', 'Jones', 'Garcia', 'Miller', 'Davis', 'Rodriguez', 'Martinez', 'Chen', 'Thompson'];
            const venues = ['The Foundry Seattle', 'Golden Gardens', 'The Edgewater Hotel', 'Olympic Rooftop', 'Willows Lodge', 'Salish Lodge', 'Woodinville Wine Country'];
            const eventTypes = ['Wedding', 'Birthday', 'Anniversary', 'Other'];
            const addresses = [
                '1423 NW Market St, Seattle, WA 98107',
                '742 Bellevue Way NE, Bellevue, WA 98004',
                '305 Harrison St, Seattle, WA 98109',
                '8912 Linden Ave N, Seattle, WA 98103',
                '2201 Westlake Ave, Seattle, WA 98121',
                '4507 Brooklyn Ave NE, Seattle, WA 98105',
                '1100 Fairview Ave N, Seattle, WA 98109',
                '3421 Thorndyke Ave W, Seattle, WA 98199'
            ];
            const messages = [
                'Looking for an elegant three-tier cake with fresh flowers. Colors: blush pink, ivory, and gold accents.',
                'Want something modern and minimalist - geometric design with clean lines. Navy blue and white.',
                'Classic elegance - all white with sugar flowers. Four tiers, smooth buttercream finish.',
                'Fun and colorful birthday cake for a garden party! Think wildflowers and butterflies.'
            ];
            const rand = arr => arr[Math.floor(Math.random() * arr.length)];
            const randNum = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

            const firstName1 = rand(firstNames);
            const firstName2 = rand(firstNames);
            const lastName = rand(lastNames);

            // Random date 2-6 months out
            const eventDate = new Date();
            eventDate.setMonth(eventDate.getMonth() + randNum(2, 6));
            eventDate.setDate(randNum(1, 28));

            document.getElementById('inquiryName').value = firstName1 + ' & ' + firstName2 + ' ' + lastName;
            document.getElementById('inquiryEmail').value = 'jeff.giuzio@gmail.com';
            document.getElementById('inquiryPhone').value = `(${randNum(206,425)}) ${randNum(200,999)}-${randNum(1000,9999)}`;
            if (fpInquiryDate) fpInquiryDate.setDate(eventDate, true);
            document.getElementById('inquiryGuestCount').value = randNum(50, 250);
            document.getElementById('inquiryEventType').value = rand(eventTypes);
            document.getElementById('inquiryVenue').value = rand(venues);
            document.getElementById('inquirySource').value = ['Website', 'Instagram', 'Referral'][randNum(0, 2)];
            document.getElementById('inquiryMessage').value = rand(messages);

            // Store extra client data for submit handler
            window._testInquiryExtra = {
                address: rand(addresses),
                instagram: '@' + firstName1.toLowerCase() + lastName.toLowerCase()
            };
        }

        // Inquiry Modal functions
        function openInquiryModal() {
            const modal = document.getElementById('addInquiryModal');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('active'), 10);
            document.body.style.overflow = 'hidden';
        }

        // Contact Picker functions
        let allContactsForPicker = [];

        function openContactPicker() {
            const overlay = document.getElementById('contactPickerOverlay');
            const list = document.getElementById('contactPickerList');
            const searchInput = document.getElementById('contactPickerSearch');

            allContactsForPicker = getClients().sort((a, b) => a.name.localeCompare(b.name));
            searchInput.value = '';
            renderContactPickerList(allContactsForPicker);

            overlay.style.display = 'flex';
        }

        function closeContactPicker() {
            document.getElementById('contactPickerOverlay').style.display = 'none';
        }

        function renderContactPickerList(contacts) {
            const list = document.getElementById('contactPickerList');

            if (contacts.length === 0) {
                list.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--text-muted);">No contacts found</div>';
                return;
            }

            list.innerHTML = contacts.map(client => `
                <div onclick="selectContactFromPicker(${client.id})" style="padding: 14px 20px; cursor: pointer; border-bottom: 1px solid var(--border-color); transition: background 0.15s;"
                     onmouseover="this.style.background='var(--bg-tertiary)'" onmouseout="this.style.background='var(--bg-secondary)'">
                    <div style="font-weight: 400; margin-bottom: 2px;">${client.name}</div>
                    <div style="font-size: 0.8rem; color: var(--text-muted);">${client.email || 'No email'}${client.phone ? ' â€¢ ' + client.phone : ''}</div>
                </div>
            `).join('');
        }

        function filterContactPicker(query) {
            if (!query) {
                renderContactPickerList(allContactsForPicker);
                return;
            }
            const q = query.toLowerCase();
            const filtered = allContactsForPicker.filter(c =>
                c.name.toLowerCase().includes(q) ||
                (c.email && c.email.toLowerCase().includes(q))
            );
            renderContactPickerList(filtered);
        }

        function selectContactFromPicker(clientId) {
            const client = allContactsForPicker.find(c => c.id == clientId);
            if (client) {
                document.getElementById('inquiryName').value = client.name || '';
                document.getElementById('inquiryEmail').value = client.email || '';
                document.getElementById('inquiryPhone').value = client.phone || '';
            }
            closeContactPicker();
        }

        // Close picker on overlay click
        document.getElementById('contactPickerOverlay').addEventListener('click', function(e) {
            if (e.target === this) closeContactPicker();
        });

        function closeInquiryModal() {
            const modal = document.getElementById('addInquiryModal');
            modal.classList.remove('active');
            document.getElementById('addInquiryForm').reset();
            if (fpInquiryDate) fpInquiryDate.clear();
            setTimeout(() => {
                modal.style.display = 'none';
                document.body.style.overflow = '';
            }, 300);
        }

        // Close modal on overlay click
        document.getElementById('addInquiryModal').addEventListener('click', function(e) {
            if (e.target === this) closeInquiryModal();
        });

        // Inquiry form submission
        document.getElementById('addInquiryForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const inquiry = {
                name: document.getElementById('inquiryName').value,
                email: document.getElementById('inquiryEmail').value,
                phone: document.getElementById('inquiryPhone').value,
                event_date: document.getElementById('inquiryEventDate').value || null,
                event_type: document.getElementById('inquiryEventType').value,
                guest_count: document.getElementById('inquiryGuestCount').value,
                venue: document.getElementById('inquiryVenue').value,
                source: document.getElementById('inquirySource').value,
                notes: document.getElementById('inquiryMessage').value,
                status: 'inquiry'
            };

            // Include extra test data if available (address, instagram, etc.)
            if (window._testInquiryExtra) {
                Object.assign(inquiry, window._testInquiryExtra);
                window._testInquiryExtra = null;
            }

            try {
                // Save to API
                const result = await apiCreateClient(inquiry);
                console.log('Client created in API:', result);

                // Update cache and localStorage with new client
                const newClient = toCamelCase(result);
                clientsCache.unshift(newClient);
                const localClients = JSON.parse(localStorage.getItem('kgc_clients') || '[]');
                localClients.unshift(newClient);
                localStorage.setItem('kgc_clients', JSON.stringify(localClients));

                // Log "Inquiry received" to comm log
                const logs = JSON.parse(localStorage.getItem('kgc_comm_logs') || '{}');
                const cid = String(newClient.id);
                if (!logs[cid]) logs[cid] = [];
                logs[cid].unshift({ type: 'inquiry_received', title: 'Inquiry received', timestamp: new Date().toISOString() });
                localStorage.setItem('kgc_comm_logs', JSON.stringify(logs));
            } catch (error) {
                console.error('Failed to create client:', error);
                alert('Error creating inquiry. Please try again.');
                return;
            }

            closeInquiryModal();
            renderTimeline();
            renderProjects();
        });

        // Render 6-month timeline
        function renderTimeline() {
            const container = document.getElementById('timelineContainer');
            const clients = getClients();

            // Get current date and 6 months later
            const now = new Date();
            const sixMonthsLater = new Date();
            sixMonthsLater.setMonth(sixMonthsLater.getMonth() + 6);

            // Collect only event dates (not tastings)
            const eventDots = [];

            clients.filter(c => !c.archived && c.status !== 'complete').forEach(c => {
                const lastName = c.name.split(' ').pop();

                if (c.eventDate) {
                    // Always strip timezone to avoid UTCâ†’local shift
                    const clean = String(c.eventDate).split('T')[0];
                    const eventDate = new Date(clean + 'T00:00:00');
                    if (!isNaN(eventDate.getTime()) && eventDate >= now && eventDate <= sixMonthsLater) {
                        eventDots.push({
                            id: c.id,
                            name: lastName,
                            date: eventDate,
                            time: c.eventTime
                        });
                    }
                }
            });

            // Sort by date
            eventDots.sort((a, b) => a.date - b.date);

            // Generate month data for next 6 months
            const months = [];
            for (let i = 0; i < 6; i++) {
                const d = new Date(now.getFullYear(), now.getMonth() + i, 1);
                months.push({
                    label: d.toLocaleDateString('en-US', { month: 'short' }).toUpperCase(),
                    year: d.getFullYear(),
                    month: d.getMonth()
                });
            }

            let html = '<div class="timeline-track"></div>';

            // Today marker (green dot) - position within first month segment (0-20%)
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            const dayInMonth = now.getDate();
            const daysInCurrentMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const todayPos = (dayInMonth / daysInCurrentMonth) * 20; // First segment is 20% wide
            const todayFormatted = now.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
            html += `<div class="timeline-today" style="left: ${Math.max(1, todayPos)}%;"><div class="timeline-today-dot" title="Today - ${todayFormatted}"></div></div>`;

            // Month labels (evenly spaced)
            html += '<div class="timeline-months">';
            months.forEach(m => {
                html += `<div class="timeline-month">${m.label}</div>`;
            });
            html += '</div>';

            // Helper to calculate position for a date (0-100%)
            // Month labels are at 0%, 20%, 40%, 60%, 80%, 100% (space-between with 6 items)
            // So each month segment is 20% wide (5 segments between 6 labels)
            function getPositionForDate(date) {
                const eventMonth = date.getMonth();
                const eventYear = date.getFullYear();
                const eventDay = date.getDate();
                const daysInEventMonth = new Date(eventYear, eventMonth + 1, 0).getDate();

                // Find which segment (0-5) this month falls in
                for (let i = 0; i < 6; i++) {
                    if (months[i].year === eventYear && months[i].month === eventMonth) {
                        // Position matches space-between label layout: 0%, 20%, 40%, 60%, 80%, 100%
                        const segmentStart = (i / 5) * 100; // 5 gaps between 6 labels
                        const segmentWidth = 20; // Each segment is 20%
                        const dayProgress = eventDay / daysInEventMonth;
                        // For last month (index 5), don't go past 100%
                        if (i === 5) {
                            return Math.min(100, segmentStart + (dayProgress * segmentWidth * 0.5));
                        }
                        return segmentStart + (dayProgress * segmentWidth);
                    }
                }
                return -1; // Not in range
            }

            // Event markers (gold dots) - with staggering for overlaps
            let lastBasePosition = -100; // Last label at base level
            let lastWasStaggered = false;
            eventDots.forEach(dot => {
                let position = getPositionForDate(dot.date);
                if (position < 0) return; // Skip if not in range
                position = Math.max(2, Math.min(98, position));

                // Check if too close to last base-level label (within 3%)
                let stagger = false;
                if (position - lastBasePosition < 3) {
                    // Only stagger if the previous one was NOT staggered (alternating pattern)
                    if (!lastWasStaggered) {
                        stagger = true;
                    } else {
                        // Previous was staggered, this goes back to base
                        lastBasePosition = position;
                    }
                } else {
                    // Enough space, reset to base level
                    lastBasePosition = position;
                }
                lastWasStaggered = stagger;

                const timeStr = dot.time ? ' @ ' + formatTime(dot.time) : '';
                const staggerClass = stagger ? ' stagger' : '';
                html += `<div class="timeline-event" style="left: ${position}%;"
                    onclick="openClientPortal(${dot.id})"
                    onmouseenter="highlightProject(${dot.id})"
                    onmouseleave="unhighlightProject(${dot.id})"
                    title="${dot.name} - ${dot.date.toLocaleDateString()}${timeStr}">
                    <div class="timeline-event-dot"></div>
                    <div class="timeline-event-label${staggerClass}">${dot.name}</div>
                </div>`;
            });

            container.innerHTML = html;
        }

        function highlightProject(clientId) {
            const row = document.querySelector(`tr[data-client-id="${clientId}"]`);
            if (row) row.classList.add('highlight');
        }

        function unhighlightProject(clientId) {
            const row = document.querySelector(`tr[data-client-id="${clientId}"]`);
            if (row) row.classList.remove('highlight');
        }

        applyBrandColors();
        // Load brand palette from API in background
        loadBrandPaletteFromAPI();

        // Show loading state
        document.getElementById('projectsBody').innerHTML = `
            <tr>
                <td colspan="8" class="empty-state">
                    <p>Loading...</p>
                </td>
            </tr>
        `;

        // Load all data from API and render
        loadAllDataFromAPI();
    </script>
</body>
</html>
