<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="/favicon.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Templates - Kenna Giuzio Cake</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500&family=Montserrat:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #faf8f5;
            --bg-secondary: #fff;
            --bg-tertiary: #fafafa;
            --bg-hover: #f5f3f0;
            --text-primary: #1a1a1a;
            --text-secondary: #666;
            --text-muted: #999;
            --border-color: #eee;
            --border-light: #f0f0f0;
            --accent-gold: #b5956a;
            --accent-gold-hover: #a08050;
            --modal-bg: #fff;
            --input-bg: #fff;
            --shadow: rgba(0,0,0,0.1);
            --overlay: rgba(0,0,0,0.5);
        }

        body.dark-mode {
            --bg-primary: #1a1a1a;
            --bg-secondary: #252525;
            --bg-tertiary: #2d2d2d;
            --bg-hover: #333;
            --text-primary: #e0e0e0;
            --text-secondary: #aaa;
            --text-muted: #777;
            --border-color: #3a3a3a;
            --border-light: #333;
            --accent-gold: #c9a66a;
            --accent-gold-hover: #d4b87a;
            --modal-bg: #252525;
            --input-bg: #2d2d2d;
            --shadow: rgba(0,0,0,0.3);
            --overlay: rgba(0,0,0,0.7);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            font-weight: 300;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 260px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            padding: 30px 0;
            display: flex;
            flex-direction: column;
            z-index: 100;
        }

        .logo {
            text-align: center;
            padding: 30px 30px 30px;
            border-bottom: 1px solid var(--border-color);
        }

        .logo img {
            width: 160px;
            height: auto;
        }

        body.dark-mode .logo img {
            filter: invert(0.85);
        }

        .nav-menu {
            padding: 30px 0;
            flex: 1;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 30px;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-left-color: var(--accent-gold);
        }

        .nav-item svg {
            width: 18px;
            height: 18px;
            opacity: 0.7;
        }

        .nav-divider {
            height: 1px;
            background: var(--border-color);
            margin: 16px 30px;
        }

        /* Main Content */
        .main-wrapper {
            margin-left: 260px;
            min-height: 100vh;
        }

        .header {
            background: url('../images/header-flowers.jpg') center center / cover no-repeat;
            padding: 40px;
            position: relative;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.3);
        }

        .header > * {
            position: relative;
            z-index: 1;
        }

        .header h1 {
            font-family: 'Cormorant Garamond', serif;
            font-weight: 300;
            font-size: 2rem;
            color: #fff;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .main {
            padding: 40px;
        }

        /* Section */
        .section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
        }

        .section-header h2 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.4rem;
            font-weight: 400;
            color: var(--text-primary);
        }

        .section-header .icon {
            width: 24px;
            height: 24px;
            color: var(--accent-gold);
        }

        /* Template List */
        .template-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-width: 600px;
        }

        .template-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }

        .template-item:hover {
            border-color: var(--accent-gold);
        }

        .template-info h3 {
            font-size: 0.95rem;
            font-weight: 400;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .template-info p {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .template-actions {
            display: flex;
            gap: 8px;
        }

        .btn {
            padding: 8px 16px;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.75rem;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-secondary);
        }

        .btn:hover {
            border-color: var(--accent-gold);
            color: var(--accent-gold);
        }

        .btn-primary {
            background: var(--accent-gold);
            border-color: var(--accent-gold);
            color: #fff;
        }

        .btn-primary:hover {
            background: var(--accent-gold-hover);
            border-color: var(--accent-gold-hover);
            color: #fff;
        }

        /* Modal Overlay */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--overlay);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        /* Prevent body scroll when modal open */
        body.modal-open {
            overflow: hidden;
        }

        /* Preview/Edit Modal */
        .modal {
            background: var(--modal-bg);
            width: 650px;
            height: 70vh;
            min-width: 400px;
            min-height: 300px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 20px var(--shadow);
            display: flex;
            flex-direction: column;
            position: absolute;
            resize: both;
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            cursor: move;
            user-select: none;
        }

        .modal-header h2 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.3rem;
            font-weight: 400;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-muted);
            cursor: pointer;
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
            overscroll-behavior: contain;
            display: flex;
            flex-direction: column;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group.flex-grow {
            flex: 1;
            display: flex;
            flex-direction: column;
            margin-bottom: 0;
        }

        .form-group.flex-grow textarea {
            flex: 1;
            min-height: 200px;
        }

        .form-group label {
            font-size: 0.7rem;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: var(--text-muted);
            display: block;
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            background: var(--input-bg);
            color: var(--text-primary);
            font-family: 'Montserrat', sans-serif;
            font-size: 0.9rem;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent-gold);
        }

        .form-group textarea {
            resize: none;
            line-height: 1.6;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-primary);
            flex-shrink: 0;
        }

        .modal-footer-right {
            display: flex;
            gap: 12px;
        }

        /* Confirmation Dialog - Elegant Style */
        .confirm-dialog {
            background: var(--modal-bg);
            width: 100%;
            max-width: 400px;
            margin: 20px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 30px var(--shadow);
            text-align: center;
        }

        .confirm-dialog .confirm-icon {
            padding: 30px 24px 0;
            color: var(--accent-gold);
        }

        .confirm-dialog .confirm-icon svg {
            width: 48px;
            height: 48px;
        }

        .confirm-dialog .confirm-content {
            padding: 20px 30px 30px;
        }

        .confirm-dialog h3 {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.4rem;
            font-weight: 400;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .confirm-dialog p {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .confirm-dialog .confirm-actions {
            padding: 0 24px 24px;
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .confirm-dialog .btn {
            min-width: 100px;
        }

        .ai-polish-btn {
            padding: 4px 12px;
            background: linear-gradient(135deg, #b5956a, #d4b896);
            color: #fff;
            border: none;
            border-radius: 3px;
            font-size: 0.7rem;
            font-family: 'Montserrat', sans-serif;
            font-weight: 400;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .ai-polish-btn:hover {
            background: linear-gradient(135deg, #a0825c, #c4a880);
            transform: translateY(-1px);
        }
        .ai-polish-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
    </style>
    <script src="/js/api.js"></script>
    <script src="/js/ai-polish.js?v=4"></script>
</head>
<body>
    <aside class="sidebar">
        <div class="logo">
            <img src="../images/logo.png" alt="Kenna Giuzio Cake">
        </div>

        <nav class="nav-menu">
            <a href="/admin/in-studio.html" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                    <path d="M2 17l10 5 10-5"/>
                    <path d="M2 12l10 5 10-5"/>
                </svg>
                In Studio
            </a>
            <a href="/admin/calendar.html" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                    <line x1="16" y1="2" x2="16" y2="6"/>
                    <line x1="8" y1="2" x2="8" y2="6"/>
                    <line x1="3" y1="10" x2="21" y2="10"/>
                </svg>
                Calendar
            </a>
            <a href="/admin/contacts.html" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
                Contacts
            </a>
            <a href="/admin/communications.html" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                </svg>
                Communications
            </a>
            <a href="/admin/templates.html" class="nav-item active">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                    <line x1="16" y1="13" x2="8" y2="13"/>
                    <line x1="16" y1="17" x2="8" y2="17"/>
                    <polyline points="10 9 9 9 8 9"/>
                </svg>
                Templates
            </a>

            <div class="nav-divider"></div>

            <a href="/admin/finances.html" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <line x1="18" y1="20" x2="18" y2="10"/>
                    <line x1="12" y1="20" x2="12" y2="4"/>
                    <line x1="6" y1="20" x2="6" y2="14"/>
                </svg>
                Finances
            </a>
            <a href="/admin/media.html" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                    <circle cx="8.5" cy="8.5" r="1.5"/>
                    <polyline points="21 15 16 10 5 21"/>
                </svg>
                Media
            </a>

            <div class="nav-divider"></div>

            <a href="/admin/settings.html" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                </svg>
                Settings
            </a>
            <a href="/admin/archive.html" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <polyline points="21 8 21 21 3 21 3 8"/>
                    <rect x="1" y="3" width="22" height="5"/>
                    <line x1="10" y1="12" x2="14" y2="12"/>
                </svg>
                Archive
            </a>
            <a href="/admin/dev-tools.html" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <polyline points="16 18 22 12 16 6"/>
                    <polyline points="8 6 2 12 8 18"/>
                </svg>
                Dev Tools
            </a>
        </nav>

        <!-- Dark Mode Toggle -->
        <div style="padding: 14px 30px; margin-top: auto;">
            <button onclick="toggleDarkMode()" id="darkModeBtn" style="display: flex; align-items: center; gap: 10px; width: 100%; padding: 10px 14px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; font-family: 'Montserrat', sans-serif; font-size: 0.8rem; color: var(--text-secondary); transition: all 0.2s;">
                <span id="darkModeIcon">üåô</span>
                <span id="darkModeText">Night Mode</span>
            </button>
        </div>
    </aside>

    <div class="main-wrapper">
        <header class="header">
            <h1>Templates</h1>
        </header>

        <main class="main">
            <div style="display: flex; gap: 40px; align-items: flex-start;">
                <!-- Email Templates Section -->
                <div style="flex: 1;">
                    <div class="section-header">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                            <polyline points="22,6 12,13 2,6"/>
                        </svg>
                        <h2>Email Templates</h2>
                    </div>

                    <div class="template-list" id="templateList">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Tasting Proposal Template Section -->
                <div style="flex: 1;">
                    <div class="section-header">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                            <line x1="16" y1="13" x2="8" y2="13"/>
                            <line x1="16" y1="17" x2="8" y2="17"/>
                        </svg>
                        <h2>Tasting Proposal</h2>
                    </div>

                    <div class="template-list">
                        <div class="template-item">
                            <div class="template-info">
                                <h3>Default Tasting Proposal <span id="tastingCustomBadge" style="color:#b5956a; font-size:0.7rem;"></span></h3>
                                <p>Description, arrival instructions, location, and fee used when scheduling new tastings</p>
                            </div>
                            <div class="template-actions">
                                <button class="btn" onclick="openTastingModal()">Preview</button>
                            </div>
                        </div>
                    </div>

                    <!-- Proposal Contract Template -->
                    <div class="section-header" style="margin-top: 40px;">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                            <path d="M12 18v-6"/>
                            <path d="M9 15l3 3 3-3"/>
                        </svg>
                        <h2>Proposal Contract</h2>
                    </div>

                    <div class="template-list">
                        <div class="template-item">
                            <div class="template-info">
                                <h3>Terms & Conditions <span id="contractCustomBadge" style="color:#b5956a; font-size:0.7rem;"></span></h3>
                                <p>Contract terms included in every cake proposal (payment, cancellation, delivery, etc.)</p>
                            </div>
                            <div class="template-actions">
                                <button class="btn" onclick="openContractModal()">Preview</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Preview/Edit Modal -->
    <div class="modal-overlay" id="editModal" onclick="if(event.target===this) closeEditModal()">
        <div class="modal">
            <div class="modal-header">
                <h2 id="editModalTitle">Template Name</h2>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Subject Line</label>
                    <input type="text" id="editSubject">
                </div>
                <div class="form-group flex-grow">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                        <label style="margin-bottom:0">Email Body</label>
                        <button class="ai-polish-btn" onclick="aiPolish(document.getElementById('editBody'), { apiUrl: API_BASE_URL, subjectInput: document.getElementById('editSubject') })">Optional AI</button>
                    </div>
                    <textarea id="editBody"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="resetTemplate()">Reset to Default</button>
                <div class="modal-footer-right">
                    <button class="btn" onclick="closeEditModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="confirmSave()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Dialog -->
    <div class="modal-overlay" id="confirmModal" onclick="if(event.target===this) closeConfirmModal()">
        <div class="confirm-dialog">
            <div class="confirm-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                    <line x1="12" y1="18" x2="12" y2="12"/>
                    <line x1="12" y1="9" x2="12" y2="9"/>
                </svg>
            </div>
            <div class="confirm-content">
                <h3>Update Template?</h3>
                <p>This will change the default template language. You can always reset it later.</p>
            </div>
            <div class="confirm-actions">
                <button class="btn" onclick="closeConfirmModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveTemplate()">Yes, Update</button>
            </div>
        </div>
    </div>

    <!-- Proposal Contract Edit Modal -->
    <div class="modal-overlay" id="contractModal" onclick="if(event.target===this) closeContractModal()">
        <div class="modal" style="width: 700px; max-width: 95vw; height: 75vh;">
            <div class="modal-header">
                <h2>Proposal Contract ‚Äî Terms & Conditions</h2>
                <button class="modal-close" onclick="closeContractModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group flex-grow">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                        <label style="margin-bottom:0">Contract Text (shown on proposals)</label>
                        <button class="ai-polish-btn" onclick="aiPolish(document.getElementById('contractTplBody'), { apiUrl: API_BASE_URL })">Optional AI</button>
                    </div>
                    <textarea id="contractTplBody" style="line-height: 1.8; font-size: 0.9rem;"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="resetContractTemplate()">Reset to Default</button>
                <div class="modal-footer-right">
                    <button class="btn" onclick="closeContractModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="saveContractTemplate()">Save as Default</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tasting Proposal Edit Modal -->
    <div class="modal-overlay" id="tastingModal">
        <div class="modal" style="width: 900px; max-width: 95vw; height: 80vh;">
            <div class="modal-header">
                <h2>Tasting Proposal Template</h2>
                <button class="modal-close" onclick="closeTastingModal()">&times;</button>
            </div>
            <div class="modal-body" style="flex-direction: row; gap: 24px; padding: 24px;">
                <!-- Edit Fields -->
                <div style="flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 16px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Invoice Banner Image</label>
                        <div id="bannerPicker" style="display: flex; gap: 8px; flex-wrap: wrap;"></div>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Tasting Description</label>
                        <textarea id="tastingTplDescription" oninput="updateTastingPreview()" style="min-height: 100px;"></textarea>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Arrival Instructions</label>
                        <textarea id="tastingTplArrival" oninput="updateTastingPreview()" style="min-height: 80px;"></textarea>
                    </div>
                    <div style="display: flex; gap: 16px;">
                        <div class="form-group" style="flex: 1; margin-bottom: 0;">
                            <label>Default Location</label>
                            <input type="text" id="tastingTplLocation" oninput="updateTastingPreview()">
                        </div>
                        <div class="form-group" style="flex: 0 0 120px; margin-bottom: 0;">
                            <label>Default Fee ($)</label>
                            <input type="text" id="tastingTplFee" oninput="updateTastingPreview()">
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Default Number of Guests</label>
                        <select id="tastingTplGuests" oninput="updateTastingPreview()" style="width: 100%; padding: 12px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary); font-family: 'Montserrat', sans-serif; font-size: 0.9rem;">
                            <option value="2">2 guests</option>
                            <option value="3">3 guests</option>
                            <option value="4">4 guests</option>
                            <option value="5">5 guests</option>
                            <option value="6">6 guests</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label>Default Internal Notes</label>
                        <textarea id="tastingTplNotes" style="min-height: 60px;" placeholder="Internal only - not shown on invoice"></textarea>
                    </div>
                </div>

                <!-- Live Preview -->
                <div style="flex: 1; overflow-y: auto; background: #fff; border: 1px solid var(--border-color); font-family: 'Cormorant Garamond', serif; color: #1a1a1a;">
                    <!-- Banner -->
                    <div id="tastingPreviewBanner" style="height: 90px; background: url('/images/header-flowers.jpg') 30% center / cover no-repeat; display: flex; align-items: center; padding-left: 16px; position: relative;">
                        <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.15);"></div>
                        <img src="/images/logo.png" alt="Kenna Giuzio Cake" style="width: 80px; position: relative; z-index: 1;">
                    </div>
                    <div style="text-align: center; font-family: 'Montserrat', sans-serif; font-size: 0.7rem; color: #666; padding: 8px 0; border-bottom: 1px solid #eee;">
                        (206) 472-5401 | kenna@kennagiuziocake.com<br>Queen Anne, Seattle
                    </div>
                    <div style="padding: 20px 30px;">
                    <div style="text-align: right; margin-bottom: 20px;">
                        <div style="font-size: 1.4rem; font-weight: 400;">Tasting Invoice</div>
                        <div style="font-size: 0.75rem; font-family: 'Montserrat', sans-serif; color: #999; margin-top: 4px;">PREVIEW</div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid #eee;">
                        <div>
                            <div style="font-size: 0.65rem; font-family: 'Montserrat', sans-serif; text-transform: uppercase; letter-spacing: 1px; color: #999;">Bill To</div>
                            <div style="font-size: 1rem;">Sample Client</div>
                            <div style="font-size: 0.85rem; color: #666;">client@email.com</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 0.65rem; font-family: 'Montserrat', sans-serif; text-transform: uppercase; letter-spacing: 1px; color: #999;">Event</div>
                            <div style="font-size: 1rem;">Wedding - Summer 2026</div>
                        </div>
                    </div>

                    <h3 style="font-size: 1.1rem; font-weight: 400; margin-bottom: 8px;">Tasting Party</h3>
                    <p id="tastingPreviewDesc" style="font-size: 0.85rem; font-family: 'Montserrat', sans-serif; font-weight: 300; color: #444; line-height: 1.6; white-space: pre-line;"></p>
                    <p style="font-size: 0.7rem; font-style: italic; color: #888; margin-top: 10px; margin-bottom: 14px; font-family: 'Montserrat', sans-serif;">Custom cake commissions begin at $2,500. This tasting is designed to explore fit, flavor, and creative direction before moving forward.</p>

                    <div style="background: #faf8f5; border: 1px solid #eee; padding: 16px; margin-bottom: 16px;">
                        <div style="font-size: 0.6rem; font-family: 'Montserrat', sans-serif; text-transform: uppercase; letter-spacing: 1.5px; color: #999; margin-bottom: 8px;">Tasting Details</div>
                        <div style="font-size: 0.9rem;" id="tastingPreviewDate">February 20, 2026</div>
                        <div style="font-size: 0.9rem;">12:00 PM</div>
                        <div style="font-size: 0.9rem;" id="tastingPreviewLocation"></div>
                        <div style="font-size: 0.6rem; font-family: 'Montserrat', sans-serif; text-transform: uppercase; letter-spacing: 1.5px; color: #999; margin-top: 12px; margin-bottom: 6px;">Arrival</div>
                        <div id="tastingPreviewArrival" style="font-size: 0.85rem; color: #666; line-height: 1.5; font-family: 'Montserrat', sans-serif; font-weight: 300; white-space: pre-line;"></div>
                    </div>

                    <div style="text-align: right; font-size: 1.1rem; margin-bottom: 16px;">$<span id="tastingPreviewFee">250</span></div>

                    <div style="border-top: 1px solid #eee; padding-top: 12px;">
                        <div style="display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 6px;">
                            <span>Subtotal</span>
                            <span>$<span id="tastingPreviewSubtotal">250.00</span></span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: #999; margin-bottom: 6px;">
                            <span>Processing Fee (3%)</span>
                            <span>$<span id="tastingPreviewProcessing">8.50</span></span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 1.1rem; font-weight: 400; border-top: 1px solid #1a1a1a; padding-top: 10px;">
                            <span>Total</span>
                            <span>$<span id="tastingPreviewTotal">258.50</span></span>
                        </div>
                    </div>
                    </div><!-- close padding div -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="resetTastingTemplate()">Reset to Default</button>
                <div class="modal-footer-right">
                    <button class="btn" onclick="closeTastingModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="saveTastingTemplate()">Save as Default</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Dark Mode - check saved preference on load
        (function() {
            const darkMode = localStorage.getItem('kgc_dark_mode') === 'true';
            if (darkMode) {
                document.body.classList.add('dark-mode');
            }
            document.addEventListener('DOMContentLoaded', updateDarkModeButton);
        })();

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('kgc_dark_mode', isDark);
            updateDarkModeButton();
        }

        function updateDarkModeButton() {
            const isDark = document.body.classList.contains('dark-mode');
            const icon = document.getElementById('darkModeIcon');
            const text = document.getElementById('darkModeText');
            if (icon && text) {
                icon.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
                text.textContent = isDark ? 'Day Mode' : 'Night Mode';
            }
        }

        // Default Email Templates
        const defaultTemplates = {
            'inquiry-response': {
                name: 'Inquiry Response',
                description: 'Thank them for reaching out, confirm date availability',
                subject: 'Kenna Giuzio Cake - Thank You for Your Inquiry - {eventType}',
                body: `Hi {firstName},

Thank you so much for reaching out about your {eventType}! I'm excited to hear about your vision for {eventDate}.

Here's how my process works:

1. TASTING CONSULTATION
Tastings are designed as a salon-style experience. A moment to slow down with cake and champagne with up to 4 additional guests, explore ideas, and determine if my work is the right fit for your celebration. The tasting fee is $250, which will then be fully credited to your final invoice should we decide to move forward together.

2. CUSTOM PROPOSAL
After our tasting, I'll create a detailed proposal with pricing based on your specific design, guest count, and any special requirements we discuss.

3. BOOKING
A 50% deposit locks in your date. The remaining balance is due two weeks before your event.

I work on a limited commission basis, with projects beginning at $2,500. Looking forward to creating something beautiful for your celebration!

Warmly,
Kenna`
            },
            'tasting-options': {
                name: 'Tasting Options',
                description: 'Offer available tasting dates and times',
                subject: 'Kenna Giuzio Cake - Tasting Options for Your {eventType}',
                body: `Hi {firstName},

I'd love to schedule your tasting consultation! Here is a date and time that works for me:

[Click to select date/time]

Tastings typically last about an 1-2 hours. We'll sample flavors, discuss your design vision, and I'll answer any questions you have.

Please let me know what works for you, or if you'd prefer a different time, share a few times that fit your schedule and I'll do my best to accommodate.

Looking forward to meeting you!

Warmly,
Kenna`
            },
            'tasting-invoice-email': {
                name: 'Tasting Invoice Email',
                description: 'Branded email sent with tasting invoice link. Footer is added automatically.',
                subject: 'Kenna Giuzio Cake - Your Tasting Invitation - {tastingDate}',
                body: `Dear {firstName},

Thank you so much for reaching out! I'm thrilled at the opportunity to create something beautiful for your {eventType}.

Your tasting is scheduled for:
{tastingDate} at {tastingTime}

Click below to view your invoice to schedule your tasting.

I can't wait to meet you and hear all about what you're dreaming of!

Warmly,
Kenna`
            },
            'tasting-confirmation': {
                name: 'Tasting Confirmation',
                description: 'Sent automatically after tasting payment. Tasting details card, payment receipt, and footer are added automatically.',
                subject: 'Kenna Giuzio Cake - Tasting Paid & Confirmed - {tastingDate}',
                body: `Dear {firstName},

Thank you for your payment of {amount}. Your tasting is confirmed!

Feel free to bring any inspiration photos, color swatches, or your event team members.

If you have any questions before your tasting, don't hesitate to reach out.

See you soon,
Kenna`
            },
            'proposal-delivery': {
                name: 'Proposal Ready',
                description: 'Let them know their custom proposal is ready',
                subject: 'Kenna Giuzio Cake - Your Custom Proposal is Ready!',
                body: `Hi {firstName},

It was a pleasure meeting you at your tasting! I'm excited to share the custom proposal I've prepared for your {eventType}.  Each commission is a fully bespoke artist-led process that combines design, craftsmanship, and personal narrative.  Cakes are conceived as both a celebratory center piece and a lasting keepsake, with select elements designed to be preserved beyond the event.

The proposal includes:
- Design details reflecting our conversations including a sketch
- Itemized pricing
- Timeline and delivery information

To secure your date, after signing the proposal you will be redirected to your deposit invoice. Once deposit is paid, your date of {eventDate} will be officially booked!

If you have any questions or would like to make adjustments, please don't hesitate to reach out.

I look forward to creating something special for you!

You can view your proposal here:
[PROPOSAL LINK]

Warmly,
Kenna`
            },
            'deposit-reminder': {
                name: 'Deposit Reminder',
                description: 'Gentle nudge sent 24 hours after signing if deposit not yet paid',
                subject: 'Kenna Giuzio Cake - A Gentle Reminder About Your {eventType}',
                body: `Hi {firstName},

Thank you so much for signing your proposal! It was such a pleasure discussing your vision, and I'm truly looking forward to bringing it to life for your {eventType}.

I wanted to reach out because I noticed your deposit hasn't been submitted yet, and I want to make sure your date of {eventDate} stays available for you. As a reminder, your date is officially reserved once the deposit is received.

You can complete your deposit here:
[DEPOSIT LINK]

If you have any questions or would like to discuss anything before moving forward, please don't hesitate to reach out. I'm always happy to help.

Warmly,
Kenna`
            },
            'lock-the-date': {
                name: 'Lock the Date',
                description: 'Pre-proposal reserve deposit email with payment link. Sent manually from In Studio.',
                subject: 'Kenna Giuzio Cake - Lock Your Date - {eventDate}',
                body: `Hi {firstName},

Thank you for your interest in a custom creation for your {eventType}! I'm truly excited about the possibility of working together.

To reserve your date of {eventDate}, a Lock the Date deposit of {lockAmount} is required. This deposit will be credited toward your final balance once your custom proposal is ready.

You can submit your deposit securely here:
[LOCK DEPOSIT LINK]

Once received, your date will be held exclusively for you while we finalize the design details.

I look forward to creating something beautiful for your celebration!

Warmly,
Kenna`
            },
            'booking-confirmation': {
                name: 'Booking Confirmation',
                description: 'Sent automatically after deposit payment. Event details card, payment receipt, and footer are added automatically.',
                subject: 'Kenna Giuzio Cake - You\'re Booked! - {eventDate}',
                body: `Hi {firstName},

I'm delighted to share that your date is officially booked! Thank you for trusting me with your {eventType}.

In the near future, you will receive an invitation to your event portal, which will allow you to provide wedding cake information such as delivery logistics and setup times, key team members, and a day-of contact phone number. Additionally, we will need to coordinate the return of the floral arrangements to have these preserved. I typically pick up the display cake, when possible and arranged in advance.

WHAT'S NEXT:
- If anything changes with your event, please don't hesitate to let me know.
- Your remaining balance will be due two weeks before your event ({balanceDueDate}).

I'm truly excited to create something beautiful for your celebration!

Warmly,
Kenna`
            },
            'one-month-reminder': {
                name: 'One Month Reminder',
                description: 'Friendly reminder about upcoming balance. Backend adds event details card automatically.',
                subject: 'Kenna Giuzio Cake - Countdown for Your Upcoming Event',
                body: `Hi {firstName},

I can hardly believe your {eventType} is just one month away! I'm truly excited to create your cake for this special occasion.

This is a friendly reminder that your remaining balance of {balanceAmount} will be due on {balanceDueDate}, which is two weeks before your event.

If you have any questions, please don't hesitate to reach out.

Looking forward to celebrating with you!

Warmly,
Kenna`
            },
            'two-week-reminder': {
                name: 'Final Balance Due',
                description: 'Balance due reminder two weeks before event. Backend adds event details card, balance amount, and payment link automatically.',
                subject: 'Kenna Giuzio Cake - Reminder for Your Upcoming Event',
                body: `Hi {firstName},

Your {eventType} is just two weeks away!

This is a friendly reminder that your final balance of {balanceAmount} is now due.

Payment can be made by credit card, Zelle, or check.

I'll reach out a few days before to confirm everything.

So excited for your big day!

Warmly,
Kenna`
            }
        };

        let currentTemplateId = null;
        let customTemplates = {};

        // Load custom templates from localStorage
        function loadCustomTemplates() {
            customTemplates = JSON.parse(localStorage.getItem('kgc_email_templates') || '{}');
        }

        // Get template (custom or default)
        function getTemplate(id) {
            if (customTemplates[id]) {
                return { ...defaultTemplates[id], ...customTemplates[id] };
            }
            return defaultTemplates[id];
        }

        function getVersionLabel(custom) {
            if (!custom || !custom.version) return '<span style="color:var(--text-muted); font-size:0.7rem;">Default</span>';
            return `<span style="color:#b5956a; font-size:0.7rem;">Version ${custom.version}</span>`;
        }

        // Templates that are sent automatically by the system
        const autoSendTemplates = {
            'inquiry-response': 'Sent automatically when a new inquiry is received',
            'tasting-confirmation': 'Sent automatically after tasting payment',
            'deposit-reminder': 'Sent automatically 24 hours after proposal signing if deposit unpaid',
            'booking-confirmation': 'Sent automatically after deposit payment'
        };

        function getAutoSendBadge(id) {
            if (!autoSendTemplates[id]) return '';
            return `<span style="display:inline-block; font-size:0.6rem; letter-spacing:0.5px; text-transform:uppercase; color:#8a9a7b; border:1px solid #c5d4be; padding:1px 6px; border-radius:3px; margin-left:6px; vertical-align:middle;" title="${autoSendTemplates[id]}">Auto</span>`;
        }

        // Render template list
        function renderTemplates() {
            const container = document.getElementById('templateList');
            container.innerHTML = Object.entries(defaultTemplates).map(([id, t]) => {
                const custom = customTemplates[id];
                return `
                    <div class="template-item">
                        <div class="template-info">
                            <h3>${t.name} ${getVersionLabel(custom)} ${getAutoSendBadge(id)}</h3>
                            <p>${t.description}</p>
                        </div>
                        <div class="template-actions">
                            <button class="btn" onclick="openEditModal('${id}')">Preview</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Open edit modal
        function openEditModal(templateId) {
            currentTemplateId = templateId;
            const template = getTemplate(templateId);

            document.getElementById('editModalTitle').textContent = template.name;
            document.getElementById('editSubject').value = template.subject;
            document.getElementById('editBody').value = template.body;

            const overlay = document.getElementById('editModal');
            const modal = overlay.querySelector('.modal');

            // Center the modal
            modal.style.left = '50%';
            modal.style.top = '50%';
            modal.style.transform = 'translate(-50%, -50%)';

            overlay.style.display = 'flex';
            document.body.classList.add('modal-open');
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            document.body.classList.remove('modal-open');
            currentTemplateId = null;
        }

        // Show confirmation dialog
        function confirmSave() {
            document.getElementById('confirmModal').style.display = 'flex';
            document.body.classList.add('modal-open');
        }

        function closeConfirmModal() {
            document.getElementById('confirmModal').style.display = 'none';
            // Keep body locked if edit modal is still open
            if (document.getElementById('editModal').style.display !== 'flex') {
                document.body.classList.remove('modal-open');
            }
        }

        // Save template
        function saveTemplate() {
            if (!currentTemplateId) return;

            const subject = document.getElementById('editSubject').value;
            const body = document.getElementById('editBody').value;

            const currentVersion = (customTemplates[currentTemplateId]?.version || 0) + 1;
            customTemplates[currentTemplateId] = { subject, body, version: currentVersion };
            localStorage.setItem('kgc_email_templates', JSON.stringify(customTemplates));

            // Sync to DB so backend auto-sender can read custom templates
            syncTemplatesToDB();

            document.getElementById('confirmModal').style.display = 'none';
            document.getElementById('editModal').style.display = 'none';
            document.body.classList.remove('modal-open');
            currentTemplateId = null;
            renderTemplates();
        }

        // Sync custom templates to DB for backend access
        async function syncTemplatesToDB() {
            try {
                await fetch(`${API_BASE_URL}/api/settings/email_templates`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ value: customTemplates })
                });
            } catch (e) {
                console.log('Template DB sync failed:', e.message);
            }
        }

        // Reset template to default
        function resetTemplate() {
            if (!currentTemplateId) return;

            delete customTemplates[currentTemplateId];
            localStorage.setItem('kgc_email_templates', JSON.stringify(customTemplates));

            // Sync deletion to DB so backend auto-sender uses defaults
            syncTemplatesToDB();

            // Refresh modal with default
            const template = defaultTemplates[currentTemplateId];
            document.getElementById('editSubject').value = template.subject;
            document.getElementById('editBody').value = template.body;

            renderTemplates();
        }

        // One-time reset: clear old customizations now baked into defaults (Feb 2026)
        if (!localStorage.getItem('kgc_template_defaults_v2')) {
            localStorage.removeItem('kgc_email_templates');
            localStorage.removeItem('kgc_contract_terms');
            localStorage.removeItem('kgc_contract_meta');
            localStorage.removeItem('kgc_tasting_defaults');
            localStorage.setItem('kgc_template_defaults_v2', 'true');
        }

        // Load templates from DB (source of truth for backend auto-sender)
        async function loadFromDB() {
            try {
                const res = await fetch(`${API_BASE_URL}/api/settings/email_templates`);
                if (res.ok) {
                    const data = await res.json();
                    if (data.value && typeof data.value === 'object') {
                        customTemplates = data.value;
                        localStorage.setItem('kgc_email_templates', JSON.stringify(customTemplates));
                        renderTemplates();
                    }
                }
            } catch (e) {
                console.log('Could not load templates from DB:', e.message);
            }
        }

        // Initialize
        loadCustomTemplates();
        renderTemplates();
        loadFromDB(); // Async ‚Äî updates UI when DB data arrives

        // ===== Draggable Modal Functionality =====
        function makeDraggable(modal) {
            const header = modal.querySelector('.modal-header');
            let isDragging = false;
            let startX, startY, initialX, initialY;

            header.addEventListener('mousedown', function(e) {
                if (e.target.classList.contains('modal-close')) return;
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;

                const rect = modal.getBoundingClientRect();
                initialX = rect.left;
                initialY = rect.top;

                // Remove centering transform when starting drag
                modal.style.transform = 'none';
                modal.style.left = initialX + 'px';
                modal.style.top = initialY + 'px';

                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });

            function onMouseMove(e) {
                if (!isDragging) return;
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;

                let newLeft = initialX + dx;
                let newTop = initialY + dy;

                // Keep modal within viewport bounds
                const rect = modal.getBoundingClientRect();
                const minTop = 10;
                const minLeft = -rect.width + 100; // Keep at least 100px visible
                const maxLeft = window.innerWidth - 100;
                const maxTop = window.innerHeight - 50;

                newTop = Math.max(minTop, Math.min(maxTop, newTop));
                newLeft = Math.max(minLeft, Math.min(maxLeft, newLeft));

                modal.style.left = newLeft + 'px';
                modal.style.top = newTop + 'px';
            }

            function onMouseUp() {
                isDragging = false;
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            }
        }

        // Apply draggable to edit modal
        makeDraggable(document.querySelector('#editModal .modal'));

        // ===== Tasting Proposal Template =====
        const tastingDefaults = {
            description: 'A bespoke tasting party and design consultation for you and your guests at my studio during which we will sample cakes, review designs and discuss your vision.',
            arrival: 'The studio entrance is on the W 3rd Ave side of the house.\nI\'ll meet you there! At the tall white gate in front of my blue studio door.',
            location: 'Queen Anne Studio, Seattle',
            fee: '250',
            guests: '2',
            notes: '',
            bannerImage: '/images/header-flowers.jpg'
        };

        // Available banner images
        const bannerImages = [
            { src: '/images/header-flowers.jpg', label: 'Flowers' },
            { src: '/images/hero.jpg', label: 'Hero' },
            { src: '/images/cake-01.jpg', label: 'Cake 1' },
            { src: '/images/cake-02.jpg', label: 'Cake 2' },
            { src: '/images/cake-03.jpg', label: 'Cake 3' },
            { src: '/images/cake-04.jpg', label: 'Cake 4' },
            { src: '/images/cake-05.jpg', label: 'Cake 5' },
            { src: '/images/cake-06.jpg', label: 'Cake 6' },
            { src: '/images/cake-07.jpg', label: 'Cake 7' },
            { src: '/images/cake-08.jpg', label: 'Cake 8' },
            { src: '/images/cake-09.jpg', label: 'Cake 9' },
            { src: '/images/cake-10.jpg', label: 'Cake 10' },
        ];

        let selectedBanner = tastingDefaults.bannerImage;

        function getTastingTemplate() {
            const saved = JSON.parse(localStorage.getItem('kgc_tasting_defaults') || '{}');
            return {
                description: saved.description || tastingDefaults.description,
                arrival: saved.arrival || tastingDefaults.arrival,
                location: saved.location || tastingDefaults.location,
                fee: saved.fee || tastingDefaults.fee,
                guests: saved.guests || tastingDefaults.guests,
                notes: saved.notes || tastingDefaults.notes,
                bannerImage: saved.bannerImage || tastingDefaults.bannerImage
            };
        }

        function renderBannerPicker(currentBanner) {
            const container = document.getElementById('bannerPicker');
            container.innerHTML = bannerImages.map(img => {
                const isSelected = img.src === currentBanner;
                return `<div onclick="selectBanner('${img.src}')" style="width: 70px; height: 45px; background: url('${img.src}') center / cover no-repeat; cursor: pointer; border: 2px solid ${isSelected ? 'var(--accent-gold)' : 'transparent'}; opacity: ${isSelected ? '1' : '0.6'}; transition: all 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='${isSelected ? '1' : '0.6'}'"></div>`;
            }).join('');
        }

        function selectBanner(src) {
            selectedBanner = src;
            renderBannerPicker(src);
            document.getElementById('tastingPreviewBanner').style.backgroundImage = `url('${src}')`;
        }

        function openTastingModal() {
            const tpl = getTastingTemplate();
            document.getElementById('tastingTplDescription').value = tpl.description;
            document.getElementById('tastingTplArrival').value = tpl.arrival;
            document.getElementById('tastingTplLocation').value = tpl.location;
            document.getElementById('tastingTplFee').value = tpl.fee;
            document.getElementById('tastingTplGuests').value = tpl.guests;
            document.getElementById('tastingTplNotes').value = tpl.notes;
            selectedBanner = tpl.bannerImage;
            renderBannerPicker(selectedBanner);
            document.getElementById('tastingPreviewBanner').style.backgroundImage = `url('${selectedBanner}')`;
            updateTastingPreview();

            const overlay = document.getElementById('tastingModal');
            const modal = overlay.querySelector('.modal');
            modal.style.left = '50%';
            modal.style.top = '50%';
            modal.style.transform = 'translate(-50%, -50%)';
            overlay.style.display = 'flex';
            document.body.classList.add('modal-open');
        }

        function closeTastingModal() {
            document.getElementById('tastingModal').style.display = 'none';
            document.body.classList.remove('modal-open');
        }

        function updateTastingPreview() {
            const desc = document.getElementById('tastingTplDescription').value;
            const arrival = document.getElementById('tastingTplArrival').value;
            const location = document.getElementById('tastingTplLocation').value;
            const fee = parseFloat(document.getElementById('tastingTplFee').value) || 0;

            document.getElementById('tastingPreviewDesc').textContent = desc;
            document.getElementById('tastingPreviewArrival').textContent = arrival;
            document.getElementById('tastingPreviewLocation').textContent = location;
            document.getElementById('tastingPreviewFee').textContent = fee.toFixed(0);

            const subtotal = fee;
            const processing = Math.round(fee * 0.03 * 100) / 100;
            const total = subtotal + processing;
            document.getElementById('tastingPreviewSubtotal').textContent = subtotal.toFixed(2);
            document.getElementById('tastingPreviewProcessing').textContent = processing.toFixed(2);
            document.getElementById('tastingPreviewTotal').textContent = total.toFixed(2);
        }

        function saveTastingTemplate() {
            const existing = JSON.parse(localStorage.getItem('kgc_tasting_defaults') || '{}');
            const currentVersion = (existing.version || 0) + 1;
            const tpl = {
                description: document.getElementById('tastingTplDescription').value,
                arrival: document.getElementById('tastingTplArrival').value,
                location: document.getElementById('tastingTplLocation').value,
                fee: document.getElementById('tastingTplFee').value,
                guests: document.getElementById('tastingTplGuests').value,
                notes: document.getElementById('tastingTplNotes').value,
                bannerImage: selectedBanner,
                version: currentVersion
            };
            localStorage.setItem('kgc_tasting_defaults', JSON.stringify(tpl));
            closeTastingModal();
            updateTastingCustomBadge();
        }

        function resetTastingTemplate() {
            if (!confirm('Reset tasting proposal to factory defaults?')) return;
            localStorage.removeItem('kgc_tasting_defaults');
            const tpl = tastingDefaults;
            document.getElementById('tastingTplDescription').value = tpl.description;
            document.getElementById('tastingTplArrival').value = tpl.arrival;
            document.getElementById('tastingTplLocation').value = tpl.location;
            document.getElementById('tastingTplFee').value = tpl.fee;
            document.getElementById('tastingTplGuests').value = tpl.guests;
            document.getElementById('tastingTplNotes').value = tpl.notes;
            selectedBanner = tpl.bannerImage;
            renderBannerPicker(selectedBanner);
            document.getElementById('tastingPreviewBanner').style.backgroundImage = `url('${selectedBanner}')`;
            updateTastingPreview();
            updateTastingCustomBadge();
        }

        function updateTastingCustomBadge() {
            const saved = JSON.parse(localStorage.getItem('kgc_tasting_defaults') || 'null');
            const badge = document.getElementById('tastingCustomBadge');
            if (!saved || !saved.version) {
                badge.innerHTML = '<span style="color:var(--text-muted);">Default</span>';
            } else {
                badge.textContent = 'Version ' + saved.version;
            }
        }

        updateTastingCustomBadge();
        makeDraggable(document.querySelector('#tastingModal .modal'));

        // ===== Proposal Contract Template =====
        const defaultContractTerms = `PAYMENT TERMS
A 50% deposit is required to secure your date. The remaining balance is due 2 weeks before your event. Payment may be made by credit card (3.0% processing fee applies) or Zelle/Check (no fee).

CANCELLATION POLICY
Cancellations made more than 90 days before the event will receive a full refund of the deposit. Cancellations made 60-90 days before the event will receive a 50% refund of the deposit. Cancellations within 60 days are non-refundable.

DESIGN CHANGES
Design changes may be requested up to 60 days before the event, subject to availability and potential price adjustments. Changes requested within 60 days cannot be guaranteed.

DELIVERY & SETUP
Setup includes placement and assembly of cake at venue. Client is responsible for ensuring venue access and appropriate display surface. No other desserts should be placed on the same table or near the display cake unless mutually agreed upon. Proposal outlines the fees associated with delivery, setup, and if needed travel. Once the cake is delivered and set up, it is the responsibility of the wedding coordinator to ensure it is not damaged, as for an example many staff members may be moving around to set up other elements.

DISPLAY CONDITIONS
Client is responsible for ensuring the cake is displayed in a cool, climate-controlled environment away from direct sunlight, heat sources, and outdoor elements. Kenna Giuzio Cake is not responsible for damage due to improper display conditions.

FORCE MAJEURE
In the event of circumstances beyond our control (natural disasters, severe weather, illness, etc.), Kenna Giuzio Cake will work with you to reschedule or provide a full refund.

FLOWER CLOCHES
Your cake is designed to function as both a celebration centerpiece and a keepsake element - the hand crafted sugar components are created to be preserved as heirlooms. These are delicate art pieces and should be handled with care. Not edible.

By accepting this proposal, you agree to these terms and conditions.`;

        function getContractTemplate() {
            return localStorage.getItem('kgc_contract_terms') || null;
        }

        function openContractModal() {
            const saved = getContractTemplate();
            document.getElementById('contractTplBody').value = saved || defaultContractTerms;

            const overlay = document.getElementById('contractModal');
            const modal = overlay.querySelector('.modal');
            modal.style.left = '50%';
            modal.style.top = '50%';
            modal.style.transform = 'translate(-50%, -50%)';
            overlay.style.display = 'flex';
            document.body.classList.add('modal-open');
        }

        function closeContractModal() {
            document.getElementById('contractModal').style.display = 'none';
            document.body.classList.remove('modal-open');
        }

        function saveContractTemplate() {
            const body = document.getElementById('contractTplBody').value;
            const existing = JSON.parse(localStorage.getItem('kgc_contract_meta') || '{}');
            const version = (existing.version || 0) + 1;
            localStorage.setItem('kgc_contract_terms', body);
            localStorage.setItem('kgc_contract_meta', JSON.stringify({ version }));
            closeContractModal();
            updateContractCustomBadge();
        }

        function resetContractTemplate() {
            if (!confirm('Reset contract terms to factory defaults?')) return;
            localStorage.removeItem('kgc_contract_terms');
            localStorage.removeItem('kgc_contract_meta');
            document.getElementById('contractTplBody').value = defaultContractTerms;
            updateContractCustomBadge();
        }

        function updateContractCustomBadge() {
            const meta = JSON.parse(localStorage.getItem('kgc_contract_meta') || 'null');
            const badge = document.getElementById('contractCustomBadge');
            if (!meta || !meta.version) {
                badge.innerHTML = '<span style="color:var(--text-muted);">Default</span>';
            } else {
                badge.textContent = 'Version ' + meta.version;
            }
        }

        updateContractCustomBadge();
        makeDraggable(document.querySelector('#contractModal .modal'));
    </script>
</body>
</html>
