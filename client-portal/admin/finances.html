<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="/favicon.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finances - Kenna Giuzio Cake</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500&family=Montserrat:wght@300;400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        :root {
            --bg-primary: #faf8f5;
            --bg-secondary: #fff;
            --bg-tertiary: #fafafa;
            --bg-hover: #f5f3f0;
            --text-primary: #1a1a1a;
            --text-secondary: #666;
            --text-muted: #999;
            --border-color: #eee;
            --border-light: #f0f0f0;
            --accent-gold: #b5956a;
            --accent-gold-hover: #a08050;
            --modal-bg: #fff;
            --input-bg: #fff;
            --shadow: rgba(0,0,0,0.1);
            --overlay: rgba(0,0,0,0.5);
        }

        body.dark-mode {
            --bg-primary: #1a1a1a;
            --bg-secondary: #252525;
            --bg-tertiary: #2d2d2d;
            --bg-hover: #333;
            --text-primary: #e0e0e0;
            --text-secondary: #aaa;
            --text-muted: #777;
            --border-color: #3a3a3a;
            --border-light: #333;
            --accent-gold: #c9a66a;
            --accent-gold-hover: #d4b87a;
            --modal-bg: #252525;
            --input-bg: #2d2d2d;
            --shadow: rgba(0,0,0,0.3);
            --overlay: rgba(0,0,0,0.7);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            font-weight: 300;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        body.dark-mode .logo img {
            filter: invert(0.85);
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 260px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            padding: 30px 0;
            display: flex;
            flex-direction: column;
        }

        .logo {
            text-align: center;
            padding: 30px 30px 30px;
            border-bottom: 1px solid var(--border-color);
        }

        .logo img {
            width: 160px;
            height: auto;
        }

        .nav-menu {
            padding: 30px 0;
            flex: 1;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 30px;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-left-color: var(--accent-gold);
        }

        .nav-item svg {
            width: 18px;
            height: 18px;
            opacity: 0.7;
        }

        .nav-divider {
            height: 1px;
            background: var(--border-color);
            margin: 15px 30px;
        }

        /* Main Content */
        .main {
            margin-left: 260px;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        .main > .header {
            flex-shrink: 0;
        }

        .main-content-wrapper {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .finance-panel {
            flex: none;
            width: 65%;
            min-width: 400px;
            max-width: calc(100% - 200px);
            overflow-y: auto;
            height: 100%;
        }

        .resize-handle {
            width: 8px;
            background: var(--border-color);
            cursor: col-resize;
            position: relative;
            flex-shrink: 0;
            transition: background 0.2s;
        }

        .resize-handle:hover,
        .resize-handle.dragging {
            background: var(--accent-gold);
        }

        .resize-handle::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 4px;
            height: 40px;
            background: repeating-linear-gradient(
                to bottom,
                #999 0px,
                #999 2px,
                transparent 2px,
                transparent 6px
            );
            border-radius: 2px;
            opacity: 0.5;
        }

        .resize-handle:hover::after,
        .resize-handle.dragging::after {
            opacity: 1;
            background: repeating-linear-gradient(
                to bottom,
                #fff 0px,
                #fff 2px,
                transparent 2px,
                transparent 6px
            );
        }

        .image-panel {
            flex: 1;
            min-width: 180px;
            background: var(--bg-primary);
            overflow-y: auto;
            padding: 30px 20px;
            align-self: stretch;
        }

        .gallery-wall {
            position: relative;
            height: 100%;
            min-height: 500px;
            width: 100%;
        }

        .gallery-frame {
            position: absolute;
            background: var(--bg-secondary);
            padding: 8px;
            box-shadow:
                0 3px 10px var(--shadow),
                0 1px 3px var(--shadow),
                inset 0 0 0 1px rgba(0,0,0,0.04);
            transition: transform 0.5s ease, box-shadow 0.5s ease;
        }

        .gallery-frame::before {
            content: '';
            position: absolute;
            top: 4px;
            left: 4px;
            right: 4px;
            bottom: 4px;
            border: 1px solid rgba(0,0,0,0.06);
            pointer-events: none;
        }

        .gallery-frame:hover {
            transform: scale(1.05) rotate(0deg) !important;
            box-shadow:
                0 15px 40px rgba(0,0,0,0.15),
                0 5px 15px rgba(0,0,0,0.1);
            z-index: 10;
        }

        .gallery-frame img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        /* Organic gallery wall - varied shapes filling the space */
        .gallery-frame:nth-child(1) { top: 1%; left: 3%; width: 44%; height: 22%; transform: rotate(-1.5deg); }
        .gallery-frame:nth-child(2) { top: 2%; right: 4%; width: 48%; height: 15%; transform: rotate(2deg); }
        .gallery-frame:nth-child(3) { top: 18%; right: 8%; width: 35%; height: 24%; transform: rotate(-1deg); }
        .gallery-frame:nth-child(4) { top: 26%; left: 6%; width: 52%; height: 14%; transform: rotate(1deg); }
        .gallery-frame:nth-child(5) { top: 42%; left: 2%; width: 38%; height: 20%; transform: rotate(-2deg); }
        .gallery-frame:nth-child(6) { top: 44%; right: 3%; width: 54%; height: 16%; transform: rotate(1.5deg); }
        .gallery-frame:nth-child(7) { top: 62%; right: 6%; width: 42%; height: 22%; transform: rotate(-0.5deg); }
        .gallery-frame:nth-child(8) { top: 64%; left: 5%; width: 46%; height: 13%; transform: rotate(2deg); }
        .gallery-frame:nth-child(9) { top: 79%; left: 8%; width: 36%; height: 19%; transform: rotate(-1.5deg); }
        .gallery-frame:nth-child(10) { top: 85%; right: 4%; width: 50%; height: 14%; transform: rotate(1deg); }

        @media (max-width: 1200px) {
            .image-panel {
                display: none;
            }
            .finance-panel {
                max-width: 100%;
                min-width: auto;
            }
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px 40px;
            background: url('../images/header-flowers.jpg') center center / cover no-repeat;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .header > * {
            position: relative;
            z-index: 1;
        }

        .header h1 {
            font-family: 'Cormorant Garamond', serif;
            font-weight: 300;
            font-size: 2rem;
            color: #fff;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .header-date {
            font-size: 0.85rem;
            color: rgba(255,255,255,0.9);
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .main-content {
            padding: 20px 24px;
        }

        /* Stats */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--bg-secondary);
            padding: 24px;
            border: 1px solid var(--border-color);
        }

        .stat-label {
            font-size: 0.65rem;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .stat-value {
            font-family: 'Cormorant Garamond', serif;
            font-size: 2rem;
            font-weight: 400;
        }

        .stat-value.revenue { color: #27ae60; }
        .stat-value.expense { color: #e74c3c; }
        .stat-value.profit { color: var(--accent-gold); }

        .stat-sublabel {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* Date Filter */
        .sticky-filters {
            position: sticky;
            top: 0;
            z-index: 40;
            background: var(--bg-primary);
            padding: 16px 24px 8px 24px;
        }

        .date-filter {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 12px 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px var(--shadow);
        }

        .filter-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        .filter-row:last-child {
            margin-bottom: 0;
        }

        .filter-label {
            font-size: 0.65rem;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: var(--text-muted);
            width: 45px;
            text-align: right;
        }

        .filter-boxes {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .filter-box {
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            font-family: 'Montserrat', sans-serif;
            font-size: 0.75rem;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 3px;
        }

        .filter-box:hover {
            border-color: #7a9e7a;
            color: #5a7a5a;
            background: #f5f9f5;
        }

        body.dark-mode .filter-box:hover {
            background: #3a4a3a;
            color: #8ebe8e;
        }

        .filter-box.active {
            background: #7a9e7a;
            border-color: #6a8e6a;
            color: #fff;
        }

        .filter-box.current {
            border: 2px solid var(--accent-gold);
            box-shadow: 0 0 0 1px rgba(181, 149, 106, 0.2);
        }

        .filter-box.current.active {
            border-color: var(--accent-gold);
            box-shadow: 0 0 0 2px rgba(181, 149, 106, 0.3);
        }

        /* Universal Search */
        .universal-search {
            margin-bottom: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 12px 24px;
            box-shadow: 0 2px 8px var(--shadow);
        }

        .universal-search input {
            width: 100%;
            max-width: 400px;
            padding: 10px 14px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.85rem;
            background: var(--input-bg);
            color: var(--text-primary);
        }

        .universal-search input:focus {
            outline: none;
            border-color: var(--accent-gold);
        }

        /* Consistent table columns - compact */
        .finance-table-header,
        .finance-table-row {
            display: grid;
            grid-template-columns: 70px 1fr 70px 80px;
            gap: 8px;
            padding: 10px 16px;
            align-items: center;
        }

        .finance-table-header {
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
            font-size: 0.6rem;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: var(--text-muted);
        }

        .finance-table-row {
            border-bottom: 1px solid var(--border-light);
            font-size: 0.8rem;
        }

        .finance-table-row:last-child {
            border-bottom: none;
        }

        .finance-table-row:hover {
            background: var(--bg-tertiary);
        }

        .finance-table-row .clickable {
            cursor: pointer;
        }

        .finance-table-row .clickable:hover {
            color: var(--accent-gold);
        }

        .row-date {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Section Subtotal */
        .section-subtotal {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 12px 24px;
            background: var(--bg-tertiary);
            border-top: 1px solid var(--border-color);
            font-size: 0.85rem;
            gap: 8px;
        }

        .subtotal-label {
            color: var(--text-muted);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .subtotal-value {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.2rem;
            font-weight: 500;
            min-width: 100px;
            text-align: right;
        }

        .subtotal-value.revenue { color: #27ae60; }
        .subtotal-value.pending { color: var(--accent-gold); }
        .subtotal-value.expense { color: #e74c3c; }

        /* Header subtotal (shown when collapsed) */
        .header-subtotal {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.1rem;
            margin-left: auto;
            margin-right: 16px;
        }

        .header-subtotal.revenue { color: #27ae60; }
        .header-subtotal.pending { color: var(--accent-gold); }
        .header-subtotal.expense { color: #e74c3c; }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--border-color);
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.85rem;
            color: var(--text-muted);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
            transition: all 0.2s;
        }

        .tab:hover { color: var(--text-primary); }
        .tab.active {
            color: var(--accent-gold);
            border-bottom-color: var(--accent-gold);
        }

        /* Content Panels */
        .panel { display: none; }
        .panel.active { display: block; }

        /* Table */
        .data-table {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
        }

        .table-header {
            display: grid;
            grid-template-columns: 120px 1fr 150px 120px 100px;
            gap: 16px;
            padding: 16px 24px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
            font-size: 0.65rem;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--text-muted);
        }

        .table-row {
            display: grid;
            grid-template-columns: 120px 1fr 150px 120px 100px;
            gap: 16px;
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-color);
            align-items: center;
            font-size: 0.9rem;
        }

        .table-row:last-child { border-bottom: none; }
        .table-row:hover { background: var(--bg-tertiary); }

        .row-date { color: var(--text-muted); }
        .row-amount { font-family: 'Cormorant Garamond', serif; font-size: 1.2rem; }
        .row-amount.revenue { color: #27ae60; }
        .row-amount.expense { color: #e74c3c; }

        .row-type {
            font-size: 0.7rem;
            padding: 4px 8px;
            background: var(--bg-tertiary);
            display: inline-block;
        }
        .row-type.invoice { background: #e8f5e9; color: #2e7d32; }
        .row-type.manual { background: #e3f2fd; color: #1565c0; }
        .row-type.expense { background: #ffebee; color: #c62828; }
        body.dark-mode .row-type.invoice { background: #1a3d1a; color: #7dce7d; }
        body.dark-mode .row-type.manual { background: #1a2d4a; color: #7da8ce; }
        body.dark-mode .row-type.expense { background: #3d1a1a; color: #ce7d7d; }
        .row-type.clickable:hover {
            opacity: 0.8;
            text-decoration: underline;
        }

        .remind-btn {
            font-size: 0.6rem;
            color: var(--accent-gold);
            cursor: pointer;
            padding: 2px 6px;
            border: 1px solid var(--accent-gold);
            border-radius: 3px;
            background: var(--bg-secondary);
            transition: all 0.2s;
        }

        .remind-btn:hover {
            background: var(--accent-gold);
            color: #fff;
            border-color: var(--accent-gold);
        }

        .row-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            flex-wrap: nowrap;
            min-width: 140px;
        }

        .action-btn {
            padding: 6px 12px;
            font-size: 0.7rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-btn:hover {
            border-color: var(--accent-gold);
            color: var(--accent-gold);
        }

        /* Add Button */
        .add-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: var(--accent-gold);
            color: #fff;
            border: none;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.85rem;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .add-btn:hover { background: var(--accent-gold-hover); }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--overlay);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: var(--modal-bg);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
        }

        .modal-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.5rem;
            font-weight: 400;
            margin-bottom: 24px;
            color: var(--text-primary);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 0.7rem;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            font-family: 'Montserrat', sans-serif;
            font-size: 0.9rem;
            background: var(--input-bg);
            color: var(--text-primary);
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--accent-gold);
        }

        /* Receipt Upload */
        .receipt-upload {
            border: 2px dashed var(--border-color);
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 20px;
        }

        .receipt-upload:hover { border-color: var(--accent-gold); }
        .receipt-upload.has-image { border-style: solid; border-color: #27ae60; }

        .receipt-upload-icon {
            font-size: 2rem;
            margin-bottom: 8px;
            color: var(--text-muted);
        }

        .receipt-upload-text {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .receipt-preview {
            max-width: 100%;
            max-height: 200px;
            margin-top: 16px;
            display: none;
        }

        .receipt-upload.has-image .receipt-preview { display: block; cursor: zoom-in; }
        .receipt-upload.has-image .receipt-upload-icon,
        .receipt-upload.has-image .receipt-upload-text { display: none; }

        /* Receipt Popup Window */
        .receipt-popup {
            display: none;
            position: fixed;
            top: 50px;
            right: 50px;
            width: 500px;
            height: 600px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            box-shadow: 0 10px 40px var(--shadow);
            z-index: 2000;
            flex-direction: column;
            resize: both;
            overflow: hidden;
            min-width: 300px;
            min-height: 300px;
            max-width: 90vw;
            max-height: 90vh;
        }
        .receipt-popup.active { display: flex; }
        .receipt-popup::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg, transparent 50%, #ccc 50%);
            cursor: se-resize;
        }
        .receipt-popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
            cursor: move;
        }
        .receipt-popup-title {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-primary);
        }
        .receipt-popup-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .receipt-popup-zoom-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            width: 28px;
            height: 28px;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .receipt-popup-zoom-btn:hover { background: var(--bg-hover); }
        .receipt-popup-close {
            background: none;
            border: none;
            font-size: 1.4rem;
            cursor: pointer;
            color: var(--text-secondary);
            margin-left: 8px;
        }
        .receipt-popup-close:hover { color: #e74c3c; }
        .receipt-popup-body {
            flex: 1;
            overflow: auto;
            padding: 10px;
            background: var(--bg-tertiary);
        }
        .receipt-popup-body img {
            display: block;
            cursor: grab;
        }
        .receipt-popup-body img:active {
            cursor: grabbing;
        }
        .receipt-popup-footer {
            padding: 8px 15px;
            background: var(--bg-tertiary);
            border-top: 1px solid var(--border-color);
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-align: center;
        }
        .zoom-level {
            font-size: 0.75rem;
            color: var(--text-secondary);
            min-width: 40px;
            text-align: center;
        }

        /* Show/hide hints based on screen size */
        .mobile-hint { display: none; }
        .desktop-hint { display: inline; }

        /* Allocation */
        .allocation-section {
            background: var(--bg-tertiary);
            padding: 20px;
            margin-bottom: 20px;
        }

        .allocation-title {
            font-size: 0.7rem;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        .allocation-row {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 8px;
        }

        .allocation-row select {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            font-family: 'Montserrat', sans-serif;
            font-size: 0.85rem;
            background: var(--input-bg);
            color: var(--text-primary);
        }

        .allocation-row input {
            width: 80px;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            text-align: center;
            font-family: 'Montserrat', sans-serif;
            background: var(--input-bg);
            color: var(--text-primary);
        }

        .allocation-row .remove-btn {
            padding: 6px 10px;
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-muted);
            cursor: pointer;
        }

        .allocation-row .remove-btn:hover { color: #e74c3c; border-color: #e74c3c; }

        .add-allocation-btn {
            font-size: 0.8rem;
            color: var(--accent-gold);
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px 0;
        }

        .add-allocation-btn:hover { text-decoration: underline; }

        /* Extracted Total */
        .extracted-total {
            background: #e8f5e9;
            padding: 16px 20px;
            margin-bottom: 20px;
            display: none;
        }

        .extracted-total.visible { display: block; }

        .extracted-total-label {
            font-size: 0.7rem;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: #2e7d32;
            margin-bottom: 4px;
        }

        .extracted-total-value {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.8rem;
            color: #2e7d32;
        }

        .extracted-note {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 8px;
        }

        /* Modal Actions */
        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid var(--border-color);
        }

        .btn {
            padding: 12px 24px;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.85rem;
            cursor: pointer;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: all 0.2s;
        }

        .btn:hover { border-color: var(--accent-gold); }
        .btn-primary {
            background: var(--accent-gold);
            color: #fff;
            border-color: var(--accent-gold);
        }
        .btn-primary:hover { background: var(--accent-gold-hover); }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 40px;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* Collapsible Sections */
        .collapsible-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 24px;
            cursor: pointer;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
            transition: background 0.2s;
        }

        .section-header:hover {
            background: var(--bg-hover);
        }

        .section-title-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .section-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.2rem;
            font-weight: 400;
            color: var(--text-primary);
        }

        .section-count {
            font-size: 0.75rem;
            color: var(--text-muted);
            background: var(--border-light);
            padding: 2px 10px;
            border-radius: 12px;
        }

        .section-toggle {
            font-size: 1.2rem;
            color: var(--text-muted);
            font-weight: 300;
            width: 20px;
            text-align: center;
        }

        .collapsible-section.collapsed .section-toggle .icon-minus {
            display: none;
        }

        .collapsible-section.collapsed .section-toggle .icon-plus {
            display: inline;
        }

        .section-toggle .icon-minus {
            display: inline;
        }

        .section-toggle .icon-plus {
            display: none;
        }

        .collapsible-section.collapsed .section-content {
            display: none;
        }

        .section-content {
            padding: 0;
        }

        .add-expense-inline {
            padding: 4px 12px;
            background: #7a9e7a;
            color: #fff;
            border: none;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.65rem;
            cursor: pointer;
            border-radius: 3px;
            margin-left: 10px;
            transition: all 0.2s;
        }

        .add-expense-inline:hover {
            background: #6a8e6a;
        }

        /* Summary Panel Styles */
        .summary-chart {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 32px 40px;
            margin-bottom: 24px;
        }

        .chart-bar-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .chart-bar-row {
            display: grid;
            grid-template-columns: 120px 1fr 100px;
            align-items: center;
            gap: 16px;
        }

        .chart-bar-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-align: right;
        }

        .chart-bar-track {
            height: 24px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
        }

        .chart-bar {
            height: 100%;
            border-radius: 4px;
            transition: width 0.6s ease-out;
            min-width: 4px;
        }

        .chart-bar.paid {
            background: linear-gradient(90deg, #27ae60, #2ecc71);
        }

        .chart-bar.sent {
            background: linear-gradient(90deg, #b5956a, #d4b896);
        }

        .chart-bar.expense {
            background: linear-gradient(90deg, #e74c3c, #ec7063);
        }

        .chart-bar-value {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.3rem;
            font-weight: 400;
            color: var(--text-primary);
        }

        .summary-net-card {
            background: var(--bg-secondary);
            border: 1px solid var(--accent-gold);
            padding: 32px;
            text-align: center;
        }

        body.dark-mode .summary-net-card {
            background: linear-gradient(to bottom, #2a2520, var(--bg-secondary));
        }

        .net-label {
            font-size: 0.65rem;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .net-value {
            font-family: 'Cormorant Garamond', serif;
            font-size: 3rem;
            font-weight: 400;
            color: #2c5545;
        }

        .net-sublabel {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 8px;
        }

        /* Report Panel */
        .report-controls {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 24px;
            margin-bottom: 24px;
        }

        .report-section {
            margin-bottom: 24px;
        }

        .report-section:last-child {
            margin-bottom: 0;
        }

        .report-section-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.1rem;
            font-weight: 400;
            margin-bottom: 16px;
            color: var(--text-primary);
        }

        .report-row {
            display: flex;
            gap: 16px;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        .report-field {
            flex: 1;
            min-width: 120px;
        }

        .report-field .form-label {
            display: block;
            font-size: 0.7rem;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .report-field .form-select,
        .report-field .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            font-family: 'Montserrat', sans-serif;
            font-size: 0.85rem;
            background: var(--input-bg);
            color: var(--text-primary);
        }

        .quarter-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .quarter-btn {
            padding: 10px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            font-family: 'Montserrat', sans-serif;
            font-size: 0.8rem;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .quarter-btn:hover {
            border-color: var(--accent-gold);
            color: var(--accent-gold);
        }

        .quarter-btn.active {
            background: var(--accent-gold);
            border-color: var(--accent-gold);
            color: #fff;
        }

        .btn-generate {
            padding: 10px 20px;
            background: #7a9e7a;
            border: none;
            color: #fff;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.8rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-generate:hover {
            background: #6a8e6a;
        }

        .report-output {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
        }

        .report-header {
            padding: 24px;
            border-bottom: 1px solid var(--border-color);
            text-align: center;
        }

        .report-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.5rem;
            font-weight: 400;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .report-period {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .report-summary-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1px;
            background: var(--border-color);
            border-bottom: 1px solid var(--border-color);
        }

        .report-card {
            background: var(--bg-secondary);
            padding: 24px;
            text-align: center;
        }

        .report-card-label {
            font-size: 0.65rem;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .report-card-value {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.8rem;
            font-weight: 400;
        }

        .report-card.revenue .report-card-value { color: #27ae60; }
        .report-card.expense .report-card-value { color: #e74c3c; }
        .report-card.profit .report-card-value { color: #2c5545; }

        .report-details {
            padding: 24px;
        }

        .report-detail-section {
            margin-bottom: 24px;
        }

        .report-detail-section:last-child {
            margin-bottom: 0;
        }

        .report-detail-title {
            font-size: 0.75rem;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        .report-table {
            border: 1px solid var(--border-color);
        }

        .report-table-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-light);
            font-size: 0.85rem;
            color: var(--text-primary);
        }

        .report-table-row:last-child {
            border-bottom: none;
        }

        .report-table-row.total {
            background: var(--bg-tertiary);
            font-weight: 500;
        }

        .report-actions {
            padding: 24px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .btn-export, .btn-print {
            padding: 12px 24px;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-export {
            background: var(--bg-secondary);
            border: 1px solid var(--accent-gold);
            color: var(--accent-gold);
        }

        .btn-export:hover {
            background: var(--accent-gold);
            color: #fff;
        }

        .btn-print {
            background: #333;
            border: 1px solid #333;
            color: #fff;
        }

        .btn-print:hover {
            background: #555;
            border-color: #555;
        }

        body.dark-mode .btn-print {
            background: #555;
            border-color: #555;
        }

        body.dark-mode .btn-print:hover {
            background: #666;
            border-color: #666;
        }

        @media (max-width: 600px) {
            .report-summary-cards {
                grid-template-columns: 1fr;
            }

            .report-card-value {
                font-size: 1.5rem;
            }

            .quarter-buttons {
                flex-wrap: wrap;
            }

            .quarter-btn {
                padding: 8px 12px;
                font-size: 0.75rem;
            }
        }

        @media (max-width: 600px) {
            .summary-chart {
                padding: 24px 20px;
            }

            .chart-bar-row {
                grid-template-columns: 80px 1fr 80px;
                gap: 10px;
            }

            .chart-bar-label {
                font-size: 0.7rem;
            }

            .chart-bar-value {
                font-size: 1rem;
            }

            .net-value {
                font-size: 2.2rem;
            }
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .stats-row { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 900px) {
            .sidebar { display: none; }
            .main { margin-left: 0; }
        }

        /* Mobile Navigation */
        .mobile-nav {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            z-index: 100;
            justify-content: space-between;
            align-items: center;
        }

        .mobile-nav a {
            color: var(--accent-gold);
            text-decoration: none;
            font-size: 0.85rem;
        }

        .mobile-nav span {
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .mobile-menu-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 4px 8px;
            color: var(--text-primary);
        }

        .mobile-menu {
            display: none;
            position: fixed;
            top: 48px;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 4px 12px var(--shadow);
            z-index: 99;
            flex-direction: column;
        }

        .mobile-menu.active {
            display: flex;
        }

        .mobile-menu a {
            padding: 14px 20px;
            border-bottom: 1px solid var(--border-light);
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.9rem;
        }

        .mobile-menu a:last-child {
            border-bottom: none;
        }

        .mobile-menu a.active {
            color: var(--accent-gold);
            background: var(--bg-tertiary);
        }

        /* Mobile Styles */
        @media (max-width: 600px) {
            .mobile-nav {
                display: flex;
            }

            .main {
                padding-top: 48px;
            }
            .header {
                padding: 16px 20px;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .header-date {
                font-size: 0.75rem;
            }

            .main-content {
                padding: 16px;
            }

            /* Stats - single column on mobile */
            .stats-row {
                grid-template-columns: 1fr;
                gap: 12px;
                margin-bottom: 20px;
            }

            .stat-card {
                padding: 16px;
            }

            .stat-value {
                font-size: 1.5rem;
            }

            /* Tabs - scrollable */
            .tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .tab {
                padding: 10px 16px;
                white-space: nowrap;
            }

            /* Add button and search */
            #panel-expenses > div:first-child {
                flex-direction: column;
                align-items: stretch;
            }

            #panel-expenses > div:first-child .add-btn {
                width: 100%;
            }

            #panel-expenses #expenseSearch {
                max-width: none;
                width: 100%;
            }

            /* Table - horizontal scroll */
            .data-table {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .table-header, .table-row {
                min-width: 700px;
            }

            .table-header {
                font-size: 0.6rem;
                padding: 12px 16px;
            }

            .table-row {
                font-size: 0.8rem;
                padding: 12px 16px;
            }

            /* Action buttons - stack on mobile */
            .row-actions {
                flex-direction: column;
                gap: 6px;
                min-width: auto;
            }

            .action-btn {
                padding: 8px 10px;
                font-size: 0.65rem;
            }

            /* Modal - fullscreen on mobile */
            /* Lock horizontal scroll on mobile */
            body {
                overflow-x: hidden;
            }

            .modal-overlay {
                align-items: flex-start;
                overflow-x: hidden;
            }

            .modal {
                width: 100%;
                max-width: 100%;
                min-height: 100vh;
                max-height: 100vh;
                padding: 20px;
                border-radius: 0;
                overflow-x: hidden;
                overflow-y: auto;
            }

            .modal-title {
                font-size: 1.3rem;
            }

            .form-input, .form-select, .form-textarea {
                font-size: 16px; /* Prevents iOS zoom on focus */
                padding: 14px 16px;
                max-width: 100%;
                box-sizing: border-box;
            }

            /* Prevent any element from causing horizontal overflow */
            .modal * {
                max-width: 100%;
                box-sizing: border-box;
            }

            /* Receipt upload - larger touch target */
            .receipt-upload {
                padding: 40px 20px;
            }

            .receipt-upload-icon {
                font-size: 3rem;
            }

            .receipt-upload-text {
                font-size: 1rem;
            }

            /* Extracted total box */
            .extracted-total {
                padding: 12px 16px;
            }

            .extracted-total-value {
                font-size: 1.4rem;
            }

            /* Allocation section */
            .allocation-section {
                padding: 16px;
            }

            .allocation-row {
                flex-wrap: wrap;
            }

            .allocation-row select {
                flex: 1 1 100%;
                margin-bottom: 8px;
            }

            .allocation-row input {
                width: 60px;
            }

            /* Modal actions - stack buttons */
            .modal-actions {
                flex-direction: column-reverse;
                gap: 10px;
            }

            .modal-actions .btn {
                width: 100%;
                padding: 14px;
            }

            /* Receipt popup - fullscreen on mobile */
            .receipt-popup {
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                width: 100% !important;
                height: 100% !important;
                max-width: 100vw;
                max-height: 100vh;
                resize: none;
            }

            .receipt-popup::after {
                display: none;
            }

            .receipt-popup-header {
                padding: 12px 16px;
            }

            .receipt-popup-zoom-btn {
                width: 36px;
                height: 36px;
                font-size: 1.2rem;
            }

            .receipt-popup-footer {
                font-size: 0.7rem;
            }

            /* Show mobile hints, hide desktop hints */
            .mobile-hint { display: inline; }
            .desktop-hint { display: none; }
        }

        /* PWA - Add to Home Screen support */
        @media (display-mode: standalone) {
            .header {
                padding-top: env(safe-area-inset-top, 20px);
            }
        }

        /* Kenna Branded Alert/Confirm */
        .kenna-alert-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4);
            z-index: 5000;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .kenna-alert-overlay.active {
            display: flex;
            opacity: 1;
        }
        .kenna-alert-box {
            background: #faf8f5;
            max-width: 420px;
            width: 90%;
            padding: 36px 32px 28px;
            text-align: center;
            border-top: 3px solid #b5956a;
            box-shadow: 0 8px 40px rgba(0,0,0,0.15);
            transform: translateY(-10px);
            transition: transform 0.3s ease;
        }
        .kenna-alert-overlay.active .kenna-alert-box {
            transform: translateY(0);
        }
        .kenna-alert-icon {
            font-size: 1.8rem;
            color: #b5956a;
            margin-bottom: 12px;
        }
        .kenna-alert-title {
            font-family: 'Cormorant Garamond', serif;
            font-size: 1.4rem;
            font-weight: 400;
            color: #1a1a1a;
            margin-bottom: 10px;
        }
        .kenna-alert-message {
            font-family: 'Montserrat', sans-serif;
            font-size: 0.85rem;
            font-weight: 300;
            color: #555;
            line-height: 1.6;
            margin-bottom: 24px;
        }
        .kenna-alert-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }
        .kenna-alert-btn {
            font-family: 'Montserrat', sans-serif;
            font-size: 0.75rem;
            font-weight: 400;
            letter-spacing: 1px;
            text-transform: uppercase;
            padding: 10px 28px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        .kenna-alert-btn.primary {
            background: #b5956a;
            color: #fff;
        }
        .kenna-alert-btn.primary:hover {
            background: #a07f55;
        }
        .kenna-alert-btn.secondary {
            background: transparent;
            color: #888;
            border: 1px solid #ddd;
        }
        .kenna-alert-btn.secondary:hover {
            border-color: #bbb;
            color: #555;
        }

        /* Kenna Toast Notification */
        .kenna-toast {
            position: fixed;
            top: 24px;
            right: 24px;
            background: #faf8f5;
            border-left: 3px solid #b5956a;
            padding: 16px 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.12);
            z-index: 5000;
            font-family: 'Montserrat', sans-serif;
            font-size: 0.85rem;
            font-weight: 300;
            color: #333;
            max-width: 380px;
            transform: translateX(120%);
            transition: transform 0.4s ease;
        }
        .kenna-toast.visible {
            transform: translateX(0);
        }
        .kenna-toast.error {
            border-left-color: #c0392b;
        }

    </style>
    <!-- ExcelJS for formatted Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="logo">
            <img src="../images/logo.png" alt="Kenna Giuzio Cake">
        </div>

        <nav class="nav-menu">
            <a href="/admin/in-studio.html" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                    <path d="M2 17l10 5 10-5"/>
                    <path d="M2 12l10 5 10-5"/>
                </svg>
                In Studio
            </a>
            <a href="/admin/calendar.html" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                    <line x1="16" y1="2" x2="16" y2="6"/>
                    <line x1="8" y1="2" x2="8" y2="6"/>
                    <line x1="3" y1="10" x2="21" y2="10"/>
                </svg>
                Calendar
            </a>
            <a href="/admin/contacts.html" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
                Contacts
            </a>
            <a href="/admin/communications.html" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                </svg>
                Communications
            </a>
            <a href="/admin/templates.html" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                    <polyline points="14 2 14 8 20 8"/>
                    <line x1="16" y1="13" x2="8" y2="13"/>
                    <line x1="16" y1="17" x2="8" y2="17"/>
                    <polyline points="10 9 9 9 8 9"/>
                </svg>
                Templates
            </a>

            <div class="nav-divider"></div>

            <a href="/admin/finances.html" class="nav-item active">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <line x1="18" y1="20" x2="18" y2="10"/>
                    <line x1="12" y1="20" x2="12" y2="4"/>
                    <line x1="6" y1="20" x2="6" y2="14"/>
                </svg>
                Finances
            </a>
            <a href="/admin/media.html" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                    <circle cx="8.5" cy="8.5" r="1.5"/>
                    <polyline points="21 15 16 10 5 21"/>
                </svg>
                Media
            </a>

            <div class="nav-divider"></div>

            <a href="/admin/settings.html" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                </svg>
                Settings
            </a>
            <a href="/admin/archive.html" class="nav-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <polyline points="21 8 21 21 3 21 3 8"/>
                    <rect x="1" y="3" width="22" height="5"/>
                    <line x1="10" y1="12" x2="14" y2="12"/>
                </svg>
                Archive
            </a>
        </nav>
        <!-- Dark Mode Toggle -->
        <div style="padding: 14px 30px; margin-top: auto;">
            <button onclick="toggleDarkMode()" id="darkModeBtn" style="display: flex; align-items: center; gap: 10px; width: 100%; padding: 10px 14px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; font-family: 'Montserrat', sans-serif; font-size: 0.8rem; color: var(--text-secondary); transition: all 0.2s;">
                <span id="darkModeIcon"></span>
                <span id="darkModeText">Night Mode</span>
            </button>
        </div>
    </aside>

    <!-- Mobile Nav (visible on small screens) -->
    <nav class="mobile-nav">
        <a href="/admin/in-studio.html"> In Studio</a>
        <span>Finances</span>
        <button class="mobile-menu-btn" onclick="toggleMobileMenu()"></button>
    </nav>

    <!-- Mobile Menu Dropdown -->
    <div class="mobile-menu" id="mobileMenu">
        <a href="/admin/in-studio.html" onclick="closeMobileMenu()">In Studio</a>
        <a href="/admin/contacts.html" onclick="closeMobileMenu()">Contacts</a>
        <a href="/admin/calendar.html" onclick="closeMobileMenu()">Calendar</a>
        <a href="/admin/finances.html" class="active" onclick="closeMobileMenu()">Finances</a>
    </div>

    <!-- Main Content -->
    <main class="main">
        <header class="header">
            <div>
                <h1>Finances</h1>
                <p class="header-date" id="headerDate"></p>
            </div>
        </header>
        <div class="main-content-wrapper">
            <div class="finance-panel">
                <!-- Sticky Filters -->
                <div class="sticky-filters">
                    <!-- Date Filter -->
                    <div class="date-filter">
                        <div class="filter-row">
                            <span class="filter-label">Year</span>
                            <div class="filter-boxes" id="yearBoxes">
                                <button class="filter-box" data-year="2025">2025</button>
                                <button class="filter-box" data-year="2026">2026</button>
                                <button class="filter-box" data-year="2027">2027</button>
                                <button class="filter-box" data-year="2028">2028</button>
                                <button class="filter-box" data-year="2029">2029</button>
                                <button class="filter-box" data-year="2030">2030</button>
                            </div>
                        </div>
                        <div class="filter-row">
                            <span class="filter-label">Month</span>
                            <div class="filter-boxes" id="monthBoxes">
                                <button class="filter-box" data-month="1">Jan</button>
                                <button class="filter-box" data-month="2">Feb</button>
                                <button class="filter-box" data-month="3">Mar</button>
                                <button class="filter-box" data-month="4">Apr</button>
                                <button class="filter-box" data-month="5">May</button>
                                <button class="filter-box" data-month="6">Jun</button>
                                <button class="filter-box" data-month="7">Jul</button>
                                <button class="filter-box" data-month="8">Aug</button>
                                <button class="filter-box" data-month="9">Sep</button>
                                <button class="filter-box" data-month="10">Oct</button>
                                <button class="filter-box" data-month="11">Nov</button>
                                <button class="filter-box" data-month="12">Dec</button>
                            </div>
                        </div>
                    </div>

                    <!-- Universal Search -->
                    <div class="universal-search">
                        <input type="text" id="universalSearch" placeholder="Search invoices and expenses..."
                               oninput="filterAll()">
                    </div>
                </div>

                <div class="main-content">
                <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" data-tab="all" onclick="switchTab('all')">All</button>
                <button class="tab" data-tab="summary" onclick="switchTab('summary')">Summary</button>
                <button class="tab" data-tab="report" onclick="switchTab('report')">Report</button>
            </div>

            <!-- All Panel - Collapsible Sections -->
            <div class="panel active" id="panel-all">
                <!-- Invoices Sent Section (Priority) -->
                <div class="collapsible-section" id="section-invoices-sent">
                    <div class="section-header" onclick="toggleSection('invoices-sent')">
                        <div class="section-title-row">
                            <span class="section-title">Invoices Sent</span>
                            <span class="section-count" id="invoicesSentCount">0</span>
                        </div>
                        <span class="header-subtotal pending" id="headerSubtotalSent">$0.00</span>
                        <span class="section-toggle"><span class="icon-minus"></span><span class="icon-plus">+</span></span>
                    </div>
                    <div class="section-content">
                        <div class="data-table" style="border: none;">
                            <div class="finance-table-header">
                                <div>Date</div>
                                <div>Event</div>
                                <div>Type</div>
                                <div style="text-align: right;">Amount</div>
                            </div>
                            <div id="invoicesSentList"></div>
                        </div>
                        <div class="section-subtotal">
                            <span class="subtotal-label">Subtotal</span>
                            <span class="subtotal-value pending" id="subtotalSent">$0.00</span>
                        </div>
                    </div>
                </div>

                <!-- Pending Verification Section -->
                <div class="collapsible-section" id="section-pending-verification">
                    <div class="section-header" onclick="toggleSection('pending-verification')">
                        <div class="section-title-row">
                            <span class="section-title">Pending Verification</span>
                            <span class="section-count" id="pendingVerificationCount">0</span>
                        </div>
                        <span class="header-subtotal pending" id="headerSubtotalPending">$0.00</span>
                        <span class="section-toggle"><span class="icon-minus"></span><span class="icon-plus">+</span></span>
                    </div>
                    <div class="section-content">
                        <div class="data-table" style="border: none;">
                            <div class="finance-table-header">
                                <div>Date</div>
                                <div>Client</div>
                                <div>Method</div>
                                <div style="text-align: right;">Amount</div>
                                <div style="text-align: center;">Action</div>
                            </div>
                            <div id="pendingVerificationList"></div>
                        </div>
                        <div class="section-subtotal">
                            <span class="subtotal-label">Subtotal</span>
                            <span class="subtotal-value pending" id="subtotalPending">$0.00</span>
                        </div>
                    </div>
                </div>

                <!-- Invoices Paid Section -->
                <div class="collapsible-section" id="section-invoices-paid">
                    <div class="section-header" onclick="toggleSection('invoices-paid')">
                        <div class="section-title-row">
                            <span class="section-title">Invoices Paid</span>
                            <span class="section-count" id="invoicesPaidCount">0</span>
                        </div>
                        <span class="header-subtotal revenue" id="headerSubtotalPaid">$0.00</span>
                        <span class="section-toggle"><span class="icon-minus"></span><span class="icon-plus">+</span></span>
                    </div>
                    <div class="section-content">
                        <div class="data-table" style="border: none;">
                            <div class="finance-table-header">
                                <div>Date</div>
                                <div>Event</div>
                                <div>Type</div>
                                <div style="text-align: right;">Amount</div>
                            </div>
                            <div id="invoicesPaidList"></div>
                        </div>
                        <div class="section-subtotal">
                            <span class="subtotal-label">Subtotal</span>
                            <span class="subtotal-value revenue" id="subtotalPaid">$0.00</span>
                        </div>
                    </div>
                </div>

                <!-- Expenses Section -->
                <div class="collapsible-section" id="section-expenses">
                    <div class="section-header" onclick="toggleSection('expenses', event)">
                        <div class="section-title-row">
                            <span class="section-title">Expenses</span>
                            <span class="section-count" id="expensesCount">0</span>
                            <button class="add-expense-inline" onclick="event.stopPropagation(); openExpenseModal();">+ Add</button>
                        </div>
                        <span class="header-subtotal expense" id="headerSubtotalExpenses">$0.00</span>
                        <span class="section-toggle"><span class="icon-minus"></span><span class="icon-plus">+</span></span>
                    </div>
                    <div class="section-content">
                        <div class="data-table" style="border: none;">
                            <div class="finance-table-header">
                                <div>Date</div>
                                <div>Vendor / Category</div>
                                <div>Type</div>
                                <div style="text-align: right;">Amount</div>
                            </div>
                            <div id="expensesList"></div>
                        </div>
                        <div class="section-subtotal">
                            <span class="subtotal-label">Subtotal</span>
                            <span class="subtotal-value expense" id="subtotalExpenses">$0.00</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Summary Panel -->
            <div class="panel" id="panel-summary">
                <!-- Bar Chart -->
                <div class="summary-chart">
                    <div class="chart-bar-container">
                        <div class="chart-bar-row">
                            <span class="chart-bar-label">Invoices Paid</span>
                            <div class="chart-bar-track">
                                <div class="chart-bar paid" id="chartBarPaid" style="width: 0%;"></div>
                            </div>
                            <span class="chart-bar-value" id="chartValuePaid">$0</span>
                        </div>
                        <div class="chart-bar-row">
                            <span class="chart-bar-label">Outstanding</span>
                            <div class="chart-bar-track">
                                <div class="chart-bar sent" id="chartBarSent" style="width: 0%;"></div>
                            </div>
                            <span class="chart-bar-value" id="chartValueSent">$0</span>
                        </div>
                        <div class="chart-bar-row">
                            <span class="chart-bar-label">Expenses</span>
                            <div class="chart-bar-track">
                                <div class="chart-bar expense" id="chartBarExpenses" style="width: 0%;"></div>
                            </div>
                            <span class="chart-bar-value" id="chartValueExpenses">$0</span>
                        </div>
                    </div>
                </div>

                <!-- Summary Cards -->
                <div class="summary-net-card">
                    <div class="net-label">Net Earnings</div>
                    <div class="net-value" id="summaryNet">$0</div>
                    <div class="net-sublabel">Paid invoices minus expenses</div>
                </div>
            </div>

            <!-- Report Panel -->
            <div class="panel" id="panel-report">
                <div class="report-controls">
                    <div class="report-section">
                        <h3 class="report-section-title">Tax Period</h3>
                        <div class="report-row">
                            <div class="report-field">
                                <label class="form-label">Year</label>
                                <select class="form-select" id="reportYear">
                                    <option value="2024">2024</option>
                                    <option value="2025">2025</option>
                                    <option value="2026" selected>2026</option>
                                    <option value="2027">2027</option>
                                </select>
                            </div>
                            <div class="report-field">
                                <label class="form-label">Quarter</label>
                                <div class="quarter-buttons">
                                    <button class="quarter-btn active" data-quarter="all">Full Year</button>
                                    <button class="quarter-btn" data-quarter="1">Q1</button>
                                    <button class="quarter-btn" data-quarter="2">Q2</button>
                                    <button class="quarter-btn" data-quarter="3">Q3</button>
                                    <button class="quarter-btn" data-quarter="4">Q4</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="report-section">
                        <h3 class="report-section-title">Custom Date Range</h3>
                        <div class="report-row">
                            <div class="report-field">
                                <label class="form-label">From</label>
                                <input type="date" class="form-input" id="reportFromDate">
                            </div>
                            <div class="report-field">
                                <label class="form-label">To</label>
                                <input type="date" class="form-input" id="reportToDate">
                            </div>
                            <button class="btn-generate" onclick="generateCustomReport()">Generate</button>
                        </div>
                    </div>
                </div>

                <div class="report-output" id="reportOutput">
                    <div class="report-header">
                        <h2 class="report-title">Tax Report</h2>
                        <p class="report-period" id="reportPeriodLabel">Full Year 2026</p>
                    </div>

                    <div class="report-summary-cards">
                        <div class="report-card revenue">
                            <div class="report-card-label">Total Revenue</div>
                            <div class="report-card-value" id="reportRevenue">$0.00</div>
                        </div>
                        <div class="report-card expense">
                            <div class="report-card-label">Total Expenses</div>
                            <div class="report-card-value" id="reportExpenses">$0.00</div>
                        </div>
                        <div class="report-card profit">
                            <div class="report-card-label">Net Profit</div>
                            <div class="report-card-value" id="reportProfit">$0.00</div>
                        </div>
                    </div>

                    <div class="report-details">
                        <div class="report-detail-section">
                            <h4 class="report-detail-title">Revenue Breakdown</h4>
                            <div class="report-table" id="reportRevenueTable"></div>
                        </div>

                        <div class="report-detail-section">
                            <h4 class="report-detail-title">Expense Breakdown by Category</h4>
                            <div class="report-table" id="reportExpenseTable"></div>
                        </div>
                    </div>

                    <div class="report-actions">
                        <button class="btn-export" onclick="exportReport()">Export to CSV</button>
                        <button class="btn-print" onclick="printReport()">Print Report</button>
                    </div>
                </div>
            </div>
            </div>
            </div>
            <div class="resize-handle" id="resizeHandle"></div>
            <div class="image-panel">
                <div class="gallery-wall">
                    <div class="gallery-frame"><img src="../images/cake-07.jpg" alt="Colorful peony bouquet" loading="lazy"></div>
                    <div class="gallery-frame"><img src="../images/cake-09.jpg" alt="Orange flower glass dome" loading="lazy"></div>
                    <div class="gallery-frame"><img src="../images/cake-21.jpg" alt="Autumn palette cake" loading="lazy"></div>
                    <div class="gallery-frame"><img src="../images/cake-24.jpg" alt="Burgundy roses" loading="lazy"></div>
                    <div class="gallery-frame"><img src="../images/cake-10.jpg" alt="Blue gold textured" loading="lazy"></div>
                    <div class="gallery-frame"><img src="../images/cake-13.jpg" alt="Rustic textured cake" loading="lazy"></div>
                    <div class="gallery-frame"><img src="../images/cake-19.jpg" alt="Elegant 5-tier" loading="lazy"></div>
                    <div class="gallery-frame"><img src="../images/cake-05.jpg" alt="Sculptural ruffles" loading="lazy"></div>
                    <div class="gallery-frame"><img src="../images/cake-14.jpg" alt="Pearl details" loading="lazy"></div>
                    <div class="gallery-frame"><img src="../images/cake-12.jpg" alt="Flowing flowers" loading="lazy"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Add Revenue Modal -->
    <div class="modal-overlay" id="revenueModal">
        <div class="modal">
            <h2 class="modal-title">Add Revenue</h2>
            <div class="form-group">
                <label class="form-label">Date</label>
                <input type="date" class="form-input" id="revenueDate">
            </div>
            <div class="form-group">
                <label class="form-label">Description</label>
                <input type="text" class="form-input" id="revenueDesc" placeholder="e.g., Smith Wedding deposit">
            </div>
            <div class="form-group">
                <label class="form-label">Amount</label>
                <input type="number" class="form-input" id="revenueAmount" placeholder="0.00" step="0.01">
            </div>
            <div class="form-group">
                <label class="form-label">Link to Client (Optional)</label>
                <select class="form-select" id="revenueClient">
                    <option value="">-- None --</option>
                </select>
            </div>
            <div class="modal-actions">
                <button class="btn" onclick="closeRevenueModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveRevenue()">Save Revenue</button>
            </div>
        </div>
    </div>

    <!-- Add Expense Modal -->
    <div class="modal-overlay" id="expenseModal">
        <div class="modal">
            <h2 class="modal-title">Add Expense</h2>

            <!-- Receipt Upload -->
            <div class="receipt-upload" id="receiptUpload" onclick="handleReceiptClick(event)">
                <div class="receipt-upload-icon"></div>
                <div class="receipt-upload-text">Drop receipt photo or click to upload<br><span style="font-size: 0.75rem; color: #999;">Tip: Clear, well-lit photos scan better</span></div>
                <img class="receipt-preview" id="receiptPreview" src="" alt="Receipt" onclick="openLightbox(event)">
                <div class="receipt-actions" id="receiptActions" style="display: none; margin-top: 8px;">
                    <span style="font-size: 0.75rem; color: #666;">Click image to enlarge</span>
                    <button type="button" style="margin-left: 12px; padding: 4px 12px; font-size: 0.75rem; background: #fff; border: 1px solid #ddd; cursor: pointer;" onclick="event.stopPropagation(); document.getElementById('receiptInput').click();">Change</button>
                </div>
            </div>
            <input type="file" id="receiptInput" accept="image/*" style="display: none;" onchange="handleReceiptUpload(event)">

            <!-- Extracted Total -->
            <div class="extracted-total" id="extractedTotal">
                <div class="extracted-total-label">Extracted Total</div>
                <div class="extracted-total-value" id="extractedValue">$0.00</div>
                <div class="extracted-note">Detected from receipt. You can edit below if needed.</div>
            </div>

            <div class="form-group">
                <label class="form-label">Date</label>
                <input type="date" class="form-input" id="expenseDate">
            </div>
            <div class="form-group">
                <label class="form-label">Vendor</label>
                <input type="text" class="form-input" id="expenseVendor" placeholder="e.g., Costco, Amazon, Safeway" list="vendorList" autocomplete="off">
                <datalist id="vendorList"></datalist>
            </div>
            <div class="form-group">
                <label class="form-label">Category</label>
                <select class="form-select" id="expenseCategory">
                    <option value="">-- Select Category --</option>
                    <option value="Supplies">Supplies (ingredients, boxes, decorations)</option>
                    <option value="Advertising">Advertising (social media, website)</option>
                    <option value="Travel/Mileage">Travel/Mileage (deliveries, supply runs)</option>
                    <option value="Office">Office (software, phone %)</option>
                    <option value="Insurance">Insurance (business liability)</option>
                    <option value="Legal/Professional">Legal/Professional</option>
                    <option value="Equipment">Equipment & Tools</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Amount</label>
                <input type="number" class="form-input" id="expenseAmount" placeholder="0.00" step="0.01">
            </div>

            <!-- Allocation -->
            <div class="allocation-section">
                <div class="allocation-title">Allocate To</div>
                <div id="allocationRows">
                    <div class="allocation-row">
                        <select class="allocation-select" onchange="updateAllocationTotal()">
                            <option value="overhead">General Overhead</option>
                        </select>
                        <input type="number" class="allocation-pct" value="100" min="0" max="100" onchange="updateAllocationTotal()">
                        <span>%</span>
                    </div>
                </div>
                <button class="add-allocation-btn" onclick="addAllocationRow()">+ Split to another project</button>
                <div id="allocationTotal" style="margin-top: 12px; font-size: 0.85rem; color: #27ae60;">Total: 100%</div>
            </div>

            <div class="modal-actions">
                <button class="btn" onclick="closeExpenseModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveExpense()">Save Expense</button>
            </div>
        </div>
    </div>

    <!-- Receipt Popup Window -->
    <div class="receipt-popup" id="receiptPopup">
        <div class="receipt-popup-header" id="receiptPopupHeader">
            <span class="receipt-popup-title">Receipt Image</span>
            <div class="receipt-popup-controls">
                <button class="receipt-popup-zoom-btn" onclick="zoomReceipt(-0.25)" title="Zoom Out"></button>
                <span class="zoom-level" id="zoomLevel">100%</span>
                <button class="receipt-popup-zoom-btn" onclick="zoomReceipt(0.25)" title="Zoom In">+</button>
                <button class="receipt-popup-zoom-btn" onclick="resetZoom()" title="Reset"></button>
                <button class="receipt-popup-close" onclick="closeReceiptPopup()">&times;</button>
            </div>
        </div>
        <div class="receipt-popup-body" id="receiptPopupBody">
            <img id="popupImage" src="" alt="Receipt">
        </div>
        <div class="receipt-popup-footer"><span class="desktop-hint">Use +/ to zoom  Drag header to move  Resize from corner</span><span class="mobile-hint">Pinch to zoom  Drag to pan</span></div>
    </div>

    <!-- API Client -->
    <script src="/js/api.js"></script>
    <script>
        // Dark Mode - check saved preference on load
        (function() {
            const darkMode = localStorage.getItem('kgc_dark_mode') === 'true';
            if (darkMode) {
                document.body.classList.add('dark-mode');
            }
            document.addEventListener('DOMContentLoaded', updateDarkModeButton);
        })();

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('kgc_dark_mode', isDark);
            updateDarkModeButton();
        }

        function updateDarkModeButton() {
            const isDark = document.body.classList.contains('dark-mode');
            const icon = document.getElementById('darkModeIcon');
            const text = document.getElementById('darkModeText');
            if (icon && text) {
                icon.textContent = isDark ? '' : '';
                text.textContent = isDark ? 'Day Mode' : 'Night Mode';
            }
        }

        let currentTab = 'all';
        let receiptImageData = null;
        let selectedYears = new Set();
        let selectedMonths = new Set();

        // Load clients from API and sync to localStorage
        async function loadClientsFromAPI() {
            try {
                const clients = await getClients();
                localStorage.setItem('kgc_clients', JSON.stringify(clients));
                populateClientSelect(); // Refresh client dropdowns
                console.log('Finances: Loaded', clients.length, 'clients from API');
            } catch (error) {
                console.log('Finances: Using localStorage fallback:', error.message);
            }
        }

        // Mobile menu toggle
        function toggleMobileMenu() {
            document.getElementById('mobileMenu').classList.toggle('active');
        }

        function closeMobileMenu() {
            document.getElementById('mobileMenu').classList.remove('active');
        }

        // Close mobile menu when clicking outside
        document.addEventListener('click', function(e) {
            const menu = document.getElementById('mobileMenu');
            const btn = document.querySelector('.mobile-menu-btn');
            if (!menu.contains(e.target) && !btn.contains(e.target)) {
                menu.classList.remove('active');
            }
        });

        // Initialize date filter with current year, mark years with unpaid invoices
        function initializeDateFilter() {
            const now = new Date();
            const currentYear = now.getFullYear();

            // Default to current year only, no months selected (shows full year)
            selectedYears.add(currentYear);

            // Check for unpaid invoices and update buttons with asterisks
            updateAsterisks();
            updateFilterUI();
        }

        function updateAsterisks() {
            const invoices = JSON.parse(localStorage.getItem('kgc_invoices') || '[]');
            const unpaidInvoices = invoices.filter(i => i.status === 'sent');

            // Find years with any unpaid invoices
            const yearsWithUnpaid = new Set();
            unpaidInvoices.forEach(inv => {
                const sentDate = new Date(inv.sentAt);
                yearsWithUnpaid.add(sentDate.getFullYear());
            });

            // Find months with unpaid invoices from any year
            const monthsWithUnpaid = new Set();
            unpaidInvoices.forEach(inv => {
                const sentDate = new Date(inv.sentAt);
                monthsWithUnpaid.add(sentDate.getMonth() + 1);
            });

            // Update year buttons with asterisks
            document.querySelectorAll('#yearBoxes .filter-box').forEach(box => {
                const year = parseInt(box.dataset.year);
                if (yearsWithUnpaid.has(year)) {
                    box.textContent = year + ' *';
                    box.title = 'Has unpaid invoices';
                } else {
                    box.textContent = year.toString();
                    box.title = '';
                }
            });

            // Update month buttons with asterisks (only for selected years)
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            document.querySelectorAll('#monthBoxes .filter-box').forEach(box => {
                const month = parseInt(box.dataset.month);
                if (monthsWithUnpaid.has(month)) {
                    box.textContent = monthNames[month - 1] + ' *';
                    box.title = 'Has unpaid invoices';
                } else {
                    box.textContent = monthNames[month - 1];
                    box.title = '';
                }
            });
        }

        function updateFilterUI() {
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth() + 1;

            // Update year boxes
            document.querySelectorAll('#yearBoxes .filter-box').forEach(box => {
                const year = parseInt(box.dataset.year);
                box.classList.toggle('active', selectedYears.has(year));
                box.classList.toggle('current', year === currentYear);
            });

            // Update month boxes
            document.querySelectorAll('#monthBoxes .filter-box').forEach(box => {
                const month = parseInt(box.dataset.month);
                box.classList.toggle('active', selectedMonths.has(month));
                box.classList.toggle('current', month === currentMonth);
            });
        }

        function toggleYear(year) {
            if (selectedYears.has(year)) {
                selectedYears.delete(year);
            } else {
                selectedYears.add(year);
            }
            updateAsterisks();
            updateFilterUI();
            loadData();
        }

        function toggleMonth(month) {
            if (selectedMonths.has(month)) {
                selectedMonths.delete(month);
            } else {
                selectedMonths.add(month);
            }
            updateAsterisks();
            updateFilterUI();
            loadData();
        }

        // Filter data by selected years/months
        function filterByDate(items, dateField) {
            if (selectedYears.size === 0) return [];

            return items.filter(item => {
                const dateStr = typeof dateField === 'function' ? dateField(item) : item[dateField];
                if (!dateStr) return false;

                const date = new Date(dateStr);
                const year = date.getFullYear();
                const month = date.getMonth() + 1;

                // If year matches and (no months selected OR month matches)
                return selectedYears.has(year) && (selectedMonths.size === 0 || selectedMonths.has(month));
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            updateHeaderDate();
            initializeDateFilter();
            setupFilterListeners();
            loadData();
            populateClientSelect();

            // Load clients from API in background
            loadClientsFromAPI();

            // Sync invoice statuses from API (catches payments made on other devices)
            syncInvoiceStatuses();
        });

        async function syncInvoiceStatuses() {
            try {
                const response = await fetch('https://sugar-backend-production.up.railway.app/api/invoices');
                if (!response.ok) return;
                const apiInvoices = await response.json();
                if (!Array.isArray(apiInvoices) || apiInvoices.length === 0) return;

                const localInvoices = JSON.parse(localStorage.getItem('kgc_invoices') || '[]');
                let updated = false;

                apiInvoices.forEach(api => {
                    const invoiceId = api.invoice_number || api.id;
                    const localIdx = localInvoices.findIndex(l => l.id === invoiceId);
                    if (localIdx >= 0) {
                        // Sync paid status
                        if (api.status === 'paid' && localInvoices[localIdx].status !== 'paid') {
                            localInvoices[localIdx].status = 'paid';
                            localInvoices[localIdx].paidAt = api.paid_at || new Date().toISOString();
                            updated = true;
                        }
                        // Sync pending_verification status (Zelle/check claims)
                        if (api.status === 'pending_verification' && localInvoices[localIdx].status === 'sent') {
                            localInvoices[localIdx].status = 'pending_verification';
                            localInvoices[localIdx].claimedAt = api.updated_at || new Date().toISOString();
                            // Sync payment method from API data
                            const apiData = typeof api.data === 'string' ? JSON.parse(api.data) : (api.data || {});
                            if (apiData.payment_method) {
                                localInvoices[localIdx].paymentMethod = apiData.payment_method;
                            }
                            updated = true;
                        }
                    }
                });

                if (updated) {
                    localStorage.setItem('kgc_invoices', JSON.stringify(localInvoices));
                    loadData(); // Refresh the page data
                }
            } catch (err) {
                // Silent fail - API sync is best-effort
            }
        }

        function setupFilterListeners() {
            document.querySelectorAll('#yearBoxes .filter-box').forEach(box => {
                box.addEventListener('click', () => toggleYear(parseInt(box.dataset.year)));
            });
            document.querySelectorAll('#monthBoxes .filter-box').forEach(box => {
                box.addEventListener('click', () => toggleMonth(parseInt(box.dataset.month)));
            });
        }

        function updateHeaderDate() {
            const now = new Date();
            document.getElementById('headerDate').textContent = now.toLocaleDateString('en-US', {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
            });

            // Set default dates
            const today = now.toISOString().split('T')[0];
            document.getElementById('revenueDate').value = today;
            document.getElementById('expenseDate').value = today;
        }

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.getElementById('panel-' + tab).classList.add('active');

            // Generate report when switching to report tab
            if (tab === 'report') {
                generateReport();
            }
        }

        // Report functionality
        let selectedQuarter = 'all';

        // Quarter button click handlers
        document.querySelectorAll('.quarter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.quarter-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                selectedQuarter = this.dataset.quarter;
                generateReport();
            });
        });

        // Year change handler
        document.getElementById('reportYear')?.addEventListener('change', generateReport);

        function getQuarterDates(year, quarter) {
            if (quarter === 'all') {
                return {
                    start: new Date(year, 0, 1),
                    end: new Date(year, 11, 31)
                };
            }
            const q = parseInt(quarter);
            const startMonth = (q - 1) * 3;
            return {
                start: new Date(year, startMonth, 1),
                end: new Date(year, startMonth + 3, 0)
            };
        }

        function generateReport() {
            const year = parseInt(document.getElementById('reportYear').value);
            const dates = getQuarterDates(year, selectedQuarter);

            // Update period label
            const periodLabel = selectedQuarter === 'all'
                ? `Full Year ${year}`
                : `Q${selectedQuarter} ${year} (${dates.start.toLocaleDateString('en-US', {month: 'short'})} - ${dates.end.toLocaleDateString('en-US', {month: 'short'})})`;
            document.getElementById('reportPeriodLabel').textContent = periodLabel;

            // Get data from localStorage
            const invoices = JSON.parse(localStorage.getItem('kgc_invoices') || '[]');
            const expenses = JSON.parse(localStorage.getItem('kgc_expenses') || '[]');

            // Filter invoices by date (paid invoices only for revenue)
            const paidInvoices = invoices.filter(inv => {
                if (inv.status !== 'paid' || !inv.paidAt) return false;
                const paidDate = new Date(inv.paidAt);
                return paidDate >= dates.start && paidDate <= dates.end;
            });

            // Filter expenses by date
            const filteredExpenses = expenses.filter(exp => {
                const expDate = new Date(exp.date);
                return expDate >= dates.start && expDate <= dates.end;
            });

            // Calculate totals (check both 'total' and 'amount' fields)
            const totalRevenue = paidInvoices.reduce((sum, inv) => sum + (inv.total || inv.amount || 0), 0);
            const totalExpenses = filteredExpenses.reduce((sum, exp) => sum + (exp.amount || 0), 0);
            const netProfit = totalRevenue - totalExpenses;

            // Update summary cards
            document.getElementById('reportRevenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('reportExpenses').textContent = formatCurrency(totalExpenses);
            document.getElementById('reportProfit').textContent = formatCurrency(netProfit);

            // Build revenue breakdown table
            const revenueTable = document.getElementById('reportRevenueTable');
            if (paidInvoices.length === 0) {
                revenueTable.innerHTML = '<div class="report-table-row" style="color: #999;">No revenue in this period</div>';
            } else {
                let revenueHtml = '';
                paidInvoices.forEach(inv => {
                    const date = new Date(inv.paidAt).toLocaleDateString('en-US', {month: 'short', day: 'numeric'});
                    const invAmount = inv.total || inv.amount || 0;
                    revenueHtml += `<div class="report-table-row">
                        <span>${date} - ${inv.clientName || 'Client'} (${inv.type || 'Invoice'})</span>
                        <span style="color: #27ae60;">${formatCurrency(invAmount)}</span>
                    </div>`;
                });
                revenueHtml += `<div class="report-table-row total">
                    <span>Total Revenue</span>
                    <span style="color: #27ae60;">${formatCurrency(totalRevenue)}</span>
                </div>`;
                revenueTable.innerHTML = revenueHtml;
            }

            // Build expense breakdown by category
            const expenseTable = document.getElementById('reportExpenseTable');
            if (filteredExpenses.length === 0) {
                expenseTable.innerHTML = '<div class="report-table-row" style="color: #999;">No expenses in this period</div>';
            } else {
                // Group by category
                const byCategory = {};
                filteredExpenses.forEach(exp => {
                    const cat = exp.category || 'Uncategorized';
                    if (!byCategory[cat]) byCategory[cat] = 0;
                    byCategory[cat] += exp.amount || 0;
                });

                let expenseHtml = '';
                Object.entries(byCategory).sort((a, b) => b[1] - a[1]).forEach(([cat, amount]) => {
                    expenseHtml += `<div class="report-table-row">
                        <span>${cat}</span>
                        <span style="color: #e74c3c;">${formatCurrency(amount)}</span>
                    </div>`;
                });
                expenseHtml += `<div class="report-table-row total">
                    <span>Total Expenses</span>
                    <span style="color: #e74c3c;">${formatCurrency(totalExpenses)}</span>
                </div>`;
                expenseTable.innerHTML = expenseHtml;
            }
        }

        function generateCustomReport() {
            const fromDate = document.getElementById('reportFromDate').value;
            const toDate = document.getElementById('reportToDate').value;

            if (!fromDate || !toDate) {
                alert('Please select both From and To dates');
                return;
            }

            const dates = {
                start: new Date(fromDate),
                end: new Date(toDate)
            };

            // Update period label
            const periodLabel = `${dates.start.toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'})} - ${dates.end.toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'})}`;
            document.getElementById('reportPeriodLabel').textContent = periodLabel;

            // Clear quarter selection
            document.querySelectorAll('.quarter-btn').forEach(b => b.classList.remove('active'));

            // Get data from localStorage
            const invoices = JSON.parse(localStorage.getItem('kgc_invoices') || '[]');
            const expenses = JSON.parse(localStorage.getItem('kgc_expenses') || '[]');

            // Filter invoices by date
            const paidInvoices = invoices.filter(inv => {
                if (inv.status !== 'paid' || !inv.paidAt) return false;
                const paidDate = new Date(inv.paidAt);
                return paidDate >= dates.start && paidDate <= dates.end;
            });

            // Filter expenses by date
            const filteredExpenses = expenses.filter(exp => {
                const expDate = new Date(exp.date);
                return expDate >= dates.start && expDate <= dates.end;
            });

            // Calculate and display (reuse logic from generateReport)
            const totalRevenue = paidInvoices.reduce((sum, inv) => sum + (inv.total || inv.amount || 0), 0);
            const totalExpenses = filteredExpenses.reduce((sum, exp) => sum + (exp.amount || 0), 0);
            const netProfit = totalRevenue - totalExpenses;

            document.getElementById('reportRevenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('reportExpenses').textContent = formatCurrency(totalExpenses);
            document.getElementById('reportProfit').textContent = formatCurrency(netProfit);

            // Build tables (same as generateReport)
            const revenueTable = document.getElementById('reportRevenueTable');
            if (paidInvoices.length === 0) {
                revenueTable.innerHTML = '<div class="report-table-row" style="color: #999;">No revenue in this period</div>';
            } else {
                let revenueHtml = '';
                paidInvoices.forEach(inv => {
                    const date = new Date(inv.paidAt).toLocaleDateString('en-US', {month: 'short', day: 'numeric'});
                    const invAmount = inv.total || inv.amount || 0;
                    revenueHtml += `<div class="report-table-row">
                        <span>${date} - ${inv.clientName || 'Client'} (${inv.type || 'Invoice'})</span>
                        <span style="color: #27ae60;">${formatCurrency(invAmount)}</span>
                    </div>`;
                });
                revenueHtml += `<div class="report-table-row total">
                    <span>Total Revenue</span>
                    <span style="color: #27ae60;">${formatCurrency(totalRevenue)}</span>
                </div>`;
                revenueTable.innerHTML = revenueHtml;
            }

            const expenseTable = document.getElementById('reportExpenseTable');
            if (filteredExpenses.length === 0) {
                expenseTable.innerHTML = '<div class="report-table-row" style="color: #999;">No expenses in this period</div>';
            } else {
                const byCategory = {};
                filteredExpenses.forEach(exp => {
                    const cat = exp.category || 'Uncategorized';
                    if (!byCategory[cat]) byCategory[cat] = 0;
                    byCategory[cat] += exp.amount || 0;
                });

                let expenseHtml = '';
                Object.entries(byCategory).sort((a, b) => b[1] - a[1]).forEach(([cat, amount]) => {
                    expenseHtml += `<div class="report-table-row">
                        <span>${cat}</span>
                        <span style="color: #e74c3c;">${formatCurrency(amount)}</span>
                    </div>`;
                });
                expenseHtml += `<div class="report-table-row total">
                    <span>Total Expenses</span>
                    <span style="color: #e74c3c;">${formatCurrency(totalExpenses)}</span>
                </div>`;
                expenseTable.innerHTML = expenseHtml;
            }
        }

        async function exportReport() {
            const period = document.getElementById('reportPeriodLabel').textContent;

            // Get the date range from current report
            const year = parseInt(document.getElementById('reportYear').value);
            const dates = getQuarterDates(year, selectedQuarter);
            const startDate = dates.start;
            const endDate = dates.end;

            // Get all invoices and expenses in range
            const invoices = JSON.parse(localStorage.getItem('kgc_invoices') || '[]');
            const allExpenses = JSON.parse(localStorage.getItem('kgc_expenses') || '[]');

            const paidInvoices = invoices.filter(inv => {
                if (inv.status !== 'paid' || !inv.paidAt) return false;
                const paidDate = new Date(inv.paidAt);
                return paidDate >= startDate && paidDate <= endDate;
            });

            const periodExpenses = allExpenses.filter(exp => {
                const expDate = new Date(exp.date);
                return expDate >= startDate && expDate <= endDate;
            });

            // Create workbook with ExcelJS
            const workbook = new ExcelJS.Workbook();
            workbook.creator = 'Kenna Giuzio Cake';
            workbook.created = new Date();

            const sheet = workbook.addWorksheet('Tax Report');

            // Define styles
            const titleStyle = { font: { bold: true, size: 16, color: { argb: 'FF1A1A1A' } } };
            const headerStyle = { font: { bold: true, size: 11 }, fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF5F5F5' } } };
            const sectionStyle = { font: { bold: true, size: 12, color: { argb: 'FFB5956A' } } };
            const dollarFormat = '"$"#,##0.00';
            const totalStyle = { font: { bold: true }, fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFEEE8E0' } } };
            const addRowStyle = { font: { italic: true, color: { argb: 'FF999999' } }, fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFF8F0' } } };

            // Set column widths
            sheet.columns = [
                { width: 14 },  // A
                { width: 22 },  // B
                { width: 28 },  // C
                { width: 14 },  // D
                { width: 14 },  // E
                { width: 14 },  // F
                { width: 16 },  // G
                { width: 25 }   // H
            ];

            let row = 1;

            // ===== HEADER =====
            sheet.getCell(`A${row}`).value = 'KENNA GIUZIO CAKE';
            sheet.getCell(`A${row}`).style = titleStyle;
            sheet.mergeCells(`A${row}:D${row}`);
            row++;

            sheet.getCell(`A${row}`).value = `Tax Report - ${period}`;
            sheet.getCell(`A${row}`).style = { font: { size: 12 } };
            row++;

            sheet.getCell(`A${row}`).value = `Generated: ${new Date().toLocaleDateString()}`;
            sheet.getCell(`A${row}`).style = { font: { size: 10, color: { argb: 'FF999999' } } };
            row += 2;

            // ===== SUMMARY SECTION =====
            sheet.getCell(`A${row}`).value = 'SUMMARY';
            sheet.getCell(`A${row}`).style = sectionStyle;
            row++;

            const summaryHeaderRow = row;
            sheet.getCell(`A${row}`).value = 'Metric';
            sheet.getCell(`B${row}`).value = 'Amount';
            sheet.getRow(row).eachCell(cell => { cell.style = headerStyle; });
            row++;

            // These will be updated with formulas after we know where totals are
            const summaryRevenueRow = row;
            sheet.getCell(`A${row}`).value = 'Total Revenue';
            sheet.getCell(`B${row}`).style = { numFmt: dollarFormat };
            row++;

            const summaryExpenseRow = row;
            sheet.getCell(`A${row}`).value = 'Total Expenses';
            sheet.getCell(`B${row}`).style = { numFmt: dollarFormat };
            row++;

            const summaryProfitRow = row;
            sheet.getCell(`A${row}`).value = 'Net Profit';
            sheet.getCell(`A${row}`).style = { font: { bold: true } };
            sheet.getCell(`B${row}`).style = { font: { bold: true }, numFmt: dollarFormat };
            row += 2;

            // ===== EXPENSES BY CATEGORY =====
            sheet.getCell(`A${row}`).value = 'EXPENSES BY CATEGORY';
            sheet.getCell(`A${row}`).style = sectionStyle;
            row++;

            sheet.getCell(`A${row}`).value = 'Category';
            sheet.getCell(`B${row}`).value = 'Amount';
            sheet.getRow(row).eachCell(cell => { cell.style = headerStyle; });
            row++;

            const expenseRowsEl = document.querySelectorAll('#reportExpenseTable .report-table-row');
            expenseRowsEl.forEach(rowEl => {
                const spans = rowEl.querySelectorAll('span');
                if (spans.length === 2) {
                    const cat = spans[0].textContent;
                    const amt = parseFloat(spans[1].textContent.replace('$', '').replace(',', '')) || 0;
                    sheet.getCell(`A${row}`).value = cat;
                    sheet.getCell(`B${row}`).value = amt;
                    sheet.getCell(`B${row}`).numFmt = dollarFormat;
                    row++;
                }
            });
            row += 2;

            // ===== REVENUE DETAILS =====
            sheet.getCell(`A${row}`).value = 'REVENUE DETAILS';
            sheet.getCell(`A${row}`).style = sectionStyle;
            row++;

            const revenueHeaderRow = row;
            ['Invoice #', 'Client', 'Event Type', 'Amount', 'Sent Date', 'Paid Date', 'Payment Method'].forEach((header, i) => {
                const col = String.fromCharCode(65 + i);
                sheet.getCell(`${col}${row}`).value = header;
                sheet.getCell(`${col}${row}`).style = headerStyle;
            });
            row++;

            const revenueStartRow = row;
            paidInvoices.forEach(inv => {
                sheet.getCell(`A${row}`).value = inv.invoiceNumber || inv.id || '';
                sheet.getCell(`B${row}`).value = inv.clientName || '';
                sheet.getCell(`C${row}`).value = inv.eventType || '';
                sheet.getCell(`D${row}`).value = inv.total || inv.amount || 0;
                sheet.getCell(`D${row}`).numFmt = dollarFormat;
                sheet.getCell(`E${row}`).value = inv.sentAt ? new Date(inv.sentAt).toLocaleDateString() : '';
                sheet.getCell(`F${row}`).value = inv.paidAt ? new Date(inv.paidAt).toLocaleDateString() : '';
                sheet.getCell(`G${row}`).value = inv.paymentMethod || '';
                row++;
            });

            // Add empty rows for manual entry
            for (let i = 0; i < 3; i++) {
                sheet.getCell(`A${row}`).value = i === 0 ? ' Add revenue here...' : '';
                sheet.getCell(`A${row}`).style = addRowStyle;
                sheet.getCell(`D${row}`).numFmt = dollarFormat;
                row++;
            }
            const revenueEndRow = row - 1;

            // Revenue Total
            sheet.getCell(`C${row}`).value = 'TOTAL REVENUE';
            sheet.getCell(`C${row}`).style = totalStyle;
            sheet.getCell(`D${row}`).value = { formula: `SUM(D${revenueStartRow}:D${revenueEndRow})` };
            sheet.getCell(`D${row}`).style = totalStyle;
            sheet.getCell(`D${row}`).numFmt = dollarFormat;
            const revenueTotalRow = row;
            row += 2;

            // ===== EXPENSE DETAILS =====
            sheet.getCell(`A${row}`).value = 'EXPENSE DETAILS';
            sheet.getCell(`A${row}`).style = sectionStyle;
            row++;

            const expenseHeaderRow = row;
            ['Date', 'Category', 'Description', 'Vendor', 'Amount', 'Payment Method', 'Receipt', 'Allocation'].forEach((header, i) => {
                const col = String.fromCharCode(65 + i);
                sheet.getCell(`${col}${row}`).value = header;
                sheet.getCell(`${col}${row}`).style = headerStyle;
            });
            row++;

            const subRowStyle = { font: { italic: true, size: 9, color: { argb: 'FF666666' } } };
            const expenseStartRow = row;
            periodExpenses.forEach(exp => {
                const allocations = exp.allocations || [];
                const hasMultipleAllocations = allocations.length > 1;

                // Main expense row
                sheet.getCell(`A${row}`).value = exp.date ? new Date(exp.date).toLocaleDateString() : '';
                sheet.getCell(`B${row}`).value = exp.category || '';
                sheet.getCell(`C${row}`).value = exp.description || '';
                sheet.getCell(`D${row}`).value = exp.vendor || '';
                sheet.getCell(`E${row}`).value = exp.amount || 0;
                sheet.getCell(`E${row}`).numFmt = dollarFormat;
                sheet.getCell(`F${row}`).value = exp.paymentMethod || '';
                sheet.getCell(`G${row}`).value = exp.receipt ? 'Yes' : 'No';

                // Show allocation info
                if (allocations.length === 1) {
                    sheet.getCell(`H${row}`).value = allocations[0].name || 'General';
                } else if (hasMultipleAllocations) {
                    sheet.getCell(`H${row}`).value = 'Split (see below)';
                } else {
                    sheet.getCell(`H${row}`).value = 'General Overhead';
                }
                row++;

                // If multiple allocations, add sublines showing the breakdown
                if (hasMultipleAllocations) {
                    allocations.forEach(alloc => {
                        const allocAmount = (exp.amount || 0) * (alloc.percent / 100);
                        sheet.getCell(`C${row}`).value = `     ${alloc.percent}% - ${alloc.name || 'Unknown'}`;
                        sheet.getCell(`C${row}`).style = subRowStyle;
                        sheet.getCell(`E${row}`).value = allocAmount;
                        sheet.getCell(`E${row}`).numFmt = dollarFormat;
                        sheet.getCell(`E${row}`).style = subRowStyle;
                        row++;
                    });
                }
            });

            // Add empty rows for manual entry
            for (let i = 0; i < 3; i++) {
                sheet.getCell(`A${row}`).value = i === 0 ? ' Add expense here...' : '';
                sheet.getCell(`A${row}`).style = addRowStyle;
                sheet.getCell(`E${row}`).numFmt = dollarFormat;
                row++;
            }
            const expenseEndRow = row - 1;

            // Expense Total
            sheet.getCell(`D${row}`).value = 'TOTAL EXPENSES';
            sheet.getCell(`D${row}`).style = totalStyle;
            sheet.getCell(`E${row}`).value = { formula: `SUM(E${expenseStartRow}:E${expenseEndRow})` };
            sheet.getCell(`E${row}`).style = totalStyle;
            sheet.getCell(`E${row}`).numFmt = dollarFormat;
            const expenseTotalRow = row;

            // Now update summary with formulas
            sheet.getCell(`B${summaryRevenueRow}`).value = { formula: `D${revenueTotalRow}` };
            sheet.getCell(`B${summaryExpenseRow}`).value = { formula: `E${expenseTotalRow}` };
            sheet.getCell(`B${summaryProfitRow}`).value = { formula: `B${summaryRevenueRow}-B${summaryExpenseRow}` };

            // Download the file
            const buffer = await workbook.xlsx.writeBuffer();
            const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `KGC-Tax-Report-${period.replace(/\s+/g, '-').replace(/[^\w-]/g, '')}.xlsx`;
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function printReport() {
            const reportContent = document.getElementById('reportOutput').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Tax Report - Kenna Giuzio Cake</title>
                    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500&family=Montserrat:wght@300;400;500&display=swap" rel="stylesheet">
                    <style>
                        body { font-family: 'Montserrat', sans-serif; padding: 40px; }
                        .report-header { text-align: center; margin-bottom: 30px; }
                        .report-title { font-family: 'Cormorant Garamond', serif; font-size: 2rem; margin-bottom: 8px; }
                        .report-period { color: #666; }
                        .report-summary-cards { display: flex; gap: 20px; margin-bottom: 30px; }
                        .report-card { flex: 1; text-align: center; padding: 20px; border: 1px solid #eee; }
                        .report-card-label { font-size: 0.7rem; text-transform: uppercase; color: #999; margin-bottom: 8px; }
                        .report-card-value { font-family: 'Cormorant Garamond', serif; font-size: 1.5rem; }
                        .report-card.revenue .report-card-value { color: #27ae60; }
                        .report-card.expense .report-card-value { color: #e74c3c; }
                        .report-card.profit .report-card-value { color: #2c5545; }
                        .report-detail-title { font-size: 0.8rem; text-transform: uppercase; color: #999; margin: 20px 0 10px; }
                        .report-table { border: 1px solid #eee; }
                        .report-table-row { display: flex; justify-content: space-between; padding: 10px 15px; border-bottom: 1px solid #f5f5f5; }
                        .report-table-row.total { background: #fafafa; font-weight: 500; }
                        .report-actions { display: none; }
                        @media print { body { padding: 20px; } }
                    </style>
                </head>
                <body>${reportContent}</body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        function toggleSection(sectionId, event) {
            if (event) event.stopPropagation();
            const section = document.getElementById('section-' + sectionId);
            section.classList.toggle('collapsed');
        }

        function loadData() {
            const revenue = JSON.parse(localStorage.getItem('kgc_revenue') || '[]');
            const allExpenses = JSON.parse(localStorage.getItem('kgc_expenses') || '[]');

            // Auto-populate revenue from paid invoices
            const invoices = JSON.parse(localStorage.getItem('kgc_invoices') || '[]');
            const allPaidInvoices = invoices.filter(i => i.status === 'paid');
            const allSentInvoices = invoices.filter(i => i.status === 'sent');
            const allPendingInvoices = invoices.filter(i => i.status === 'pending_verification');

            // Merge invoice revenue (avoid duplicates by checking invoiceId)
            const existingInvoiceIds = revenue.filter(r => r.invoiceId).map(r => r.invoiceId);
            allPaidInvoices.forEach(inv => {
                if (!existingInvoiceIds.includes(inv.id)) {
                    revenue.push({
                        id: 'inv-' + inv.id,
                        invoiceId: inv.id,
                        date: inv.paidAt ? inv.paidAt.split('T')[0] : new Date().toISOString().split('T')[0],
                        description: inv.clientName + ' - ' + (inv.type === 'tasting' ? 'Tasting' : inv.type === 'deposit' ? 'Deposit' : 'Payment'),
                        amount: inv.amount,
                        source: 'invoice',
                        clientId: inv.clientId
                    });
                }
            });
            localStorage.setItem('kgc_revenue', JSON.stringify(revenue));

            // Filter by selected dates
            const sentInvoices = filterByDate(allSentInvoices, i => i.sentAt);
            const paidInvoices = filterByDate(allPaidInvoices, i => i.paidAt);
            const pendingInvoices = filterByDate(allPendingInvoices, i => i.sentAt || i.claimedAt);
            const expenses = filterByDate(allExpenses, 'date');

            // Calculate totals for filtered data
            const sentAmount = sentInvoices.reduce((sum, i) => sum + parseFloat(i.amount || 0), 0);
            const paidAmount = paidInvoices.reduce((sum, i) => sum + parseFloat(i.amount || 0), 0);
            const totalExpenses = expenses.reduce((sum, e) => sum + parseFloat(e.amount || 0), 0);

            // Pending verification totals
            const pendingAmount = pendingInvoices.reduce((sum, i) => sum + parseFloat(i.amount || 0), 0);

            // Update section counts
            document.getElementById('invoicesSentCount').textContent = sentInvoices.length;
            document.getElementById('invoicesPaidCount').textContent = paidInvoices.length;
            document.getElementById('pendingVerificationCount').textContent = pendingInvoices.length;
            document.getElementById('expensesCount').textContent = expenses.length;

            // Update subtotals (both in section footer and header)
            document.getElementById('subtotalSent').textContent = formatCurrency(sentAmount);
            document.getElementById('subtotalPaid').textContent = formatCurrency(paidAmount);
            document.getElementById('subtotalExpenses').textContent = formatCurrency(totalExpenses);

            document.getElementById('subtotalPending').textContent = formatCurrency(pendingAmount);
            document.getElementById('headerSubtotalSent').textContent = formatCurrency(sentAmount);
            document.getElementById('headerSubtotalPaid').textContent = formatCurrency(paidAmount);
            document.getElementById('headerSubtotalPending').textContent = formatCurrency(pendingAmount);
            document.getElementById('headerSubtotalExpenses').textContent = formatCurrency(totalExpenses);

            // Update summary bar chart
            const maxAmount = Math.max(paidAmount, sentAmount, totalExpenses, 1);

            document.getElementById('chartBarPaid').style.width = (paidAmount / maxAmount * 100) + '%';
            document.getElementById('chartValuePaid').textContent = formatCurrency(paidAmount);

            document.getElementById('chartBarSent').style.width = (sentAmount / maxAmount * 100) + '%';
            document.getElementById('chartValueSent').textContent = formatCurrency(sentAmount);

            document.getElementById('chartBarExpenses').style.width = (totalExpenses / maxAmount * 100) + '%';
            document.getElementById('chartValueExpenses').textContent = formatCurrency(totalExpenses);

            const netEarnings = paidAmount - totalExpenses;
            const netEl = document.getElementById('summaryNet');
            netEl.textContent = formatCurrency(Math.abs(netEarnings));
            if (netEarnings < 0) {
                netEl.textContent = '-' + netEl.textContent;
                netEl.style.color = '#e74c3c';
            } else {
                netEl.style.color = '#2c5545';
            }

            // Store for universal search filtering
            allSentInvoicesData = sentInvoices;
            allPaidInvoicesData = paidInvoices;
            allExpensesData = expenses;

            renderInvoicesSent(sentInvoices);
            renderPendingVerification(pendingInvoices);
            renderInvoicesPaid(paidInvoices);
            renderExpenses(expenses);

            // Hide pending section if empty
            document.getElementById('section-pending-verification').style.display = pendingInvoices.length > 0 ? '' : 'none';

            // Clear search when data reloads
            document.getElementById('universalSearch').value = '';
        }

        function renderInvoicesSent(items) {
            const container = document.getElementById('invoicesSentList');
            if (items.length === 0) {
                container.innerHTML = '';
                return;
            }
            const sorted = [...items].sort((a, b) => new Date(b.sentAt || 0) - new Date(a.sentAt || 0));
            container.innerHTML = sorted.map(item => {
                const eventName = item.eventType ? `${item.clientName} ${item.eventType}` : item.clientName || '-';
                return `
                <div class="finance-table-row">
                    <div class="row-date">${formatDate(item.sentAt?.split('T')[0])}</div>
                    <div>
                        <span class="clickable" onclick="openInvoice('${item.id}')">${eventName}</span>
                        <span class="remind-btn" onclick="event.stopPropagation(); sendReminder('${item.id}', '${item.clientId}')" style="margin-left: 12px;">remind</span>
                    </div>
                    <div><span class="row-type" style="background: #f5eee3; color: #8b7355;">${item.type === 'tasting' ? 'Tasting' : item.type === 'deposit' ? 'Deposit' : 'Payment'}</span></div>
                    <div style="text-align: right; color: #b5956a; font-family: 'Cormorant Garamond', serif; font-size: 1.1rem;">${formatCurrency(item.amount)}</div>
                </div>
            `;}).join('');
        }

        function renderPendingVerification(items) {
            const container = document.getElementById('pendingVerificationList');
            if (items.length === 0) {
                container.innerHTML = '';
                return;
            }
            const sorted = [...items].sort((a, b) => new Date(b.claimedAt || b.sentAt || 0) - new Date(a.claimedAt || a.sentAt || 0));
            container.innerHTML = sorted.map(item => {
                const eventName = item.clientName || 'Unknown Client';
                const method = (item.paymentMethod || 'zelle').charAt(0).toUpperCase() + (item.paymentMethod || 'zelle').slice(1);
                return `
                <div class="finance-table-row" style="align-items: center;">
                    <div class="row-date">${formatDate((item.claimedAt || item.sentAt || '').split('T')[0])}</div>
                    <div class="clickable" onclick="openInvoice('${item.id}')">${eventName}</div>
                    <div><span class="row-type" style="background: #fff3cd; color: #856404;">${method}</span></div>
                    <div style="text-align: right; color: #b5956a; font-family: 'Cormorant Garamond', serif; font-size: 1.1rem;">${formatCurrency(item.amount)}</div>
                    <div style="text-align: center;">
                        <button onclick="verifyOfflinePayment('${item.id}')" style="padding: 6px 16px; background: #27ae60; color: white; border: none; border-radius: 4px; font-family: 'Montserrat', sans-serif; font-size: 0.7rem; cursor: pointer; letter-spacing: 0.5px; text-transform: uppercase;">Verify</button>
                    </div>
                </div>
            `;}).join('');
        }

        async function verifyOfflinePayment(invoiceId) {
            const invoices = JSON.parse(localStorage.getItem('kgc_invoices') || '[]');
            const invoice = invoices.find(i => i.id === invoiceId);
            if (!invoice) { kennaToast('Invoice not found', { type: 'error' }); return; }

            const clients = JSON.parse(localStorage.getItem('kgc_clients') || '[]');
            const client = clients.find(c => String(c.id) === String(invoice.clientId));
            const clientName = invoice.clientName || (client ? client.name : 'this client');
            const amount = '$' + parseFloat(invoice.amount || 0).toFixed(2);

            const confirmed = await kennaConfirm(
                'Verify Payment',
                `Mark ${amount} from ${clientName} as verified? A confirmation email will be sent to the client.`,
                { confirmText: 'Verify', cancelText: 'Cancel' }
            );
            if (!confirmed) return;

            try {
                const resp = await fetch('https://sugar-backend-production.up.railway.app/api/payments/offline-verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        invoice_id: invoice.invoiceNumber || invoiceId,
                        invoice_type: invoice.type || 'tasting',
                        client_id: invoice.clientId,
                        client_name: invoice.clientName || (client ? client.name : ''),
                        client_email: invoice.clientEmail || (client ? client.email : ''),
                        amount: invoice.amount,
                        payment_method: invoice.paymentMethod || 'zelle'
                    })
                });
                const data = await resp.json();

                if (data.success) {
                    invoice.status = 'paid';
                    invoice.paidAt = new Date().toISOString();
                    localStorage.setItem('kgc_invoices', JSON.stringify(invoices));

                    if (client && invoice.type === 'tasting') {
                        client.tastingPaid = true;
                        client.tastingPaidDate = new Date().toISOString();
                        localStorage.setItem('kgc_clients', JSON.stringify(clients));
                    }

                    loadData();
                    kennaToast('Payment verified. Confirmation email sent to ' + clientName + '.');
                } else {
                    kennaToast('Error: ' + (data.error || 'Verification failed'), { type: 'error' });
                }
            } catch (err) {
                console.error('Verify error:', err);
                kennaToast('Connection error. Please try again.', { type: 'error' });
            }
        }

        function renderInvoicesPaid(items) {
            const container = document.getElementById('invoicesPaidList');
            if (items.length === 0) {
                container.innerHTML = '';
                return;
            }
            const sorted = [...items].sort((a, b) => new Date(b.paidAt || 0) - new Date(a.paidAt || 0));
            container.innerHTML = sorted.map(item => {
                const eventName = item.eventType ? `${item.clientName} ${item.eventType}` : item.clientName || '-';
                return `
                <div class="finance-table-row">
                    <div class="row-date">${formatDate(item.paidAt?.split('T')[0])}</div>
                    <div class="clickable" onclick="openInvoice('${item.id}')">${eventName}</div>
                    <div><span class="row-type" style="background: #e8ede5; color: #5a6b52;">${item.type === 'tasting' ? 'Tasting' : item.type === 'deposit' ? 'Deposit' : 'Payment'}</span></div>
                    <div style="text-align: right; color: #27ae60; font-family: 'Cormorant Garamond', serif; font-size: 1.1rem;">${formatCurrency(item.amount)}</div>
                </div>
            `;}).join('');
        }

        function renderExpenses(items) {
            const container = document.getElementById('expensesList');
            if (items.length === 0) {
                container.innerHTML = '';
                return;
            }
            // Store for filtering
            window.allExpenses = items;
            renderFilteredExpenses(items);
        }

        function renderFilteredExpenses(items) {
            const container = document.getElementById('expensesList');
            const sorted = [...items].sort((a, b) => new Date(b.date) - new Date(a.date));

            if (sorted.length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = sorted.map(item => {
                const vendorDisplay = item.vendor || item.description || '-';
                const categoryDisplay = item.category || 'Expense';
                return `
                <div class="finance-table-row">
                    <div class="row-date clickable" onclick="editExpense('${item.id}')">${formatDate(item.date)}</div>
                    <div>
                        <span class="clickable" onclick="editExpense('${item.id}')">${vendorDisplay}</span>
                        <span style="display: block; font-size: 0.75rem; color: #999;">${categoryDisplay}</span>
                    </div>
                    <div>${item.receiptImage ? '<span style="color: #999;"></span>' : ''}<span class="row-type" style="background: #ffebee; color: #c62828;">Expense</span></div>
                    <div style="text-align: right; color: #e74c3c; font-family: 'Cormorant Garamond', serif; font-size: 1.1rem;">-${formatCurrency(item.amount)}</div>
                </div>
            `;}).join('');
        }

        function populateClientSelect() {
            const clients = JSON.parse(localStorage.getItem('kgc_clients') || '[]');
            const activeClients = clients.filter(c => c.status !== 'contact' && c.status !== 'archived');

            // Revenue modal client select
            const revenueSelect = document.getElementById('revenueClient');
            revenueSelect.innerHTML = '<option value="">-- None --</option>' +
                activeClients.map(c => `<option value="${c.id}">${c.name}${c.eventType ? ' - ' + c.eventType : ''}</option>`).join('');

            // Expense allocation options
            updateAllocationOptions();
        }

        function updateAllocationOptions() {
            const clients = JSON.parse(localStorage.getItem('kgc_clients') || '[]');
            const activeClients = clients.filter(c =>
                c.status === 'booked' || c.status === 'Signed' || c.status === 'proposal' || c.status === 'tasting'
            );

            const options = '<option value="overhead">General Overhead</option>' +
                activeClients.map(c => `<option value="${c.id}">${c.name}${c.eventType ? ' ' + c.eventType : ''}</option>`).join('');

            document.querySelectorAll('.allocation-select').forEach(select => {
                const currentValue = select.value;
                select.innerHTML = options;
                if (currentValue) select.value = currentValue;
            });
        }

        // Revenue Modal
        function openRevenueModal() {
            document.getElementById('revenueModal').classList.add('active');
            document.getElementById('revenueDesc').value = '';
            document.getElementById('revenueAmount').value = '';
            document.getElementById('revenueClient').value = '';
        }

        function closeRevenueModal() {
            document.getElementById('revenueModal').classList.remove('active');
        }

        function saveRevenue() {
            const date = document.getElementById('revenueDate').value;
            const desc = document.getElementById('revenueDesc').value;
            const amount = parseFloat(document.getElementById('revenueAmount').value);
            const clientId = document.getElementById('revenueClient').value;

            if (!date || !amount) {
                alert('Please enter date and amount');
                return;
            }

            const revenue = JSON.parse(localStorage.getItem('kgc_revenue') || '[]');
            revenue.push({
                id: 'rev-' + Date.now(),
                date: date,
                description: desc,
                amount: amount,
                source: 'manual',
                clientId: clientId || null
            });
            localStorage.setItem('kgc_revenue', JSON.stringify(revenue));

            closeRevenueModal();
            loadData();
        }

        // Populate vendor autocomplete list
        function updateVendorList() {
            const expenses = JSON.parse(localStorage.getItem('kgc_expenses') || '[]');

            // Get unique vendors from past expenses
            const usedVendors = [...new Set(expenses.map(e => e.vendor).filter(v => v))];

            // Common vendors to always show
            const commonVendors = [
                'Amazon', 'Costco', 'Walmart', 'Target', 'Home Depot', 'Lowes',
                'Safeway', 'Kroger', 'Whole Foods', 'Trader Joes', 'Michaels',
                'Joann', 'Cash & Carry', 'Restaurant Depot', 'Smart Foodservice',
                'Office Depot', 'Staples', 'Dollar Tree', 'Winco'
            ];

            // Combine and dedupe
            const allVendors = [...new Set([...usedVendors, ...commonVendors])].sort();

            const datalist = document.getElementById('vendorList');
            datalist.innerHTML = allVendors.map(v => `<option value="${v}">`).join('');
        }

        // Expense Modal
        function openExpenseModal() {
            editingExpenseId = null; // Reset edit mode

            document.getElementById('expenseModal').classList.add('active');

            // Scroll modal to top
            const modal = document.querySelector('#expenseModal .modal');
            if (modal) modal.scrollTop = 0;

            document.getElementById('expenseVendor').value = '';
            document.getElementById('expenseCategory').value = '';
            document.getElementById('expenseAmount').value = '';
            receiptImageData = null;
            document.getElementById('receiptPreview').src = '';
            document.getElementById('receiptUpload').classList.remove('has-image');
            document.getElementById('receiptActions').style.display = 'none';
            document.getElementById('extractedTotal').classList.remove('visible');

            // Reset modal title and button for new expense
            document.querySelector('#expenseModal .modal-title').textContent = 'Add Expense';
            document.querySelector('#expenseModal .btn-primary').textContent = 'Save Expense';

            // Populate vendor suggestions
            updateVendorList();

            // Reset allocation
            document.getElementById('allocationRows').innerHTML = `
                <div class="allocation-row">
                    <select class="allocation-select" onchange="updateAllocationTotal()">
                        <option value="overhead">General Overhead</option>
                    </select>
                    <input type="number" class="allocation-pct" value="100" min="0" max="100" onchange="updateAllocationTotal()">
                    <span>%</span>
                </div>
            `;
            updateAllocationOptions();
        }

        function closeExpenseModal() {
            document.getElementById('expenseModal').classList.remove('active');
        }

        // Compress image to fit in localStorage
        function compressImage(dataUrl, maxWidth, quality) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    // Scale down if too wide
                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    // Compress as JPEG
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
                img.src = dataUrl;
            });
        }

        function handleReceiptUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                const originalImage = e.target.result;

                // Compress image for localStorage storage (~100-200KB instead of 5MB+)
                receiptImageData = await compressImage(originalImage, 800, 0.6);
                document.getElementById('receiptPreview').src = receiptImageData;
                document.getElementById('receiptUpload').classList.add('has-image');
                document.getElementById('receiptActions').style.display = 'block';

                // Show extracting message
                document.getElementById('extractedTotal').classList.add('visible');
                document.getElementById('extractedValue').textContent = 'Scanning receipt...';
                document.getElementById('extractedTotal').querySelector('.extracted-note').textContent =
                    'Using OCR to extract details. This may take a few seconds...';

                // Use Tesseract.js for OCR (use original quality for better recognition)
                Tesseract.recognize(originalImage, 'eng', {
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            const pct = Math.round(m.progress * 100);
                            document.getElementById('extractedValue').textContent = `Scanning... ${pct}%`;
                        }
                    }
                }).then(({ data: { text } }) => {
                    console.log('=== OCR RAW TEXT ===');
                    console.log(text);
                    console.log('=== END OCR TEXT ===');

                    // Extract data from OCR text
                    const extracted = extractReceiptData(text);
                    console.log('Extracted data:', extracted);

                    // Build summary of all 3 items - show what was found and what wasn't
                    let statusItems = [];

                    // Vendor
                    if (extracted.vendor) {
                        document.getElementById('expenseVendor').value = extracted.vendor;
                        statusItems.push(' Vendor: ' + extracted.vendor);
                    } else {
                        statusItems.push(' Vendor: not detected');
                    }

                    // Guess category based on item keywords in OCR text
                    const category = guessCategory(extracted.vendor, text);
                    if (category) {
                        document.getElementById('expenseCategory').value = category;
                        statusItems.push(' Category: ' + category + ' (guessed)');
                    } else {
                        statusItems.push(' Category: select manually');
                    }


                    // Amount
                    if (extracted.amount) {
                        document.getElementById('extractedValue').textContent = formatCurrency(extracted.amount);
                        document.getElementById('expenseAmount').value = extracted.amount.toFixed(2);
                        statusItems.push(' Amount: ' + formatCurrency(extracted.amount));
                    } else {
                        document.getElementById('extractedValue').textContent = 'Not detected';
                        statusItems.push(' Amount: not detected');
                    }

                    // Date
                    if (extracted.date) {
                        document.getElementById('expenseDate').value = extracted.date;
                        statusItems.push(' Date: ' + formatDate(extracted.date));
                    } else {
                        statusItems.push(' Date: not detected');
                    }

                    // Update status message
                    document.getElementById('extractedTotal').querySelector('.extracted-note').innerHTML =
                        statusItems.join('<br>') + '<br><span style="color: #666; font-size: 0.7rem;">Edit fields below as needed</span>';
                }).catch(err => {
                    console.error('OCR Error:', err);
                    document.getElementById('extractedValue').textContent = 'Scan failed';
                    document.getElementById('extractedTotal').querySelector('.extracted-note').textContent =
                        'Could not read receipt. Please enter details manually.';
                });
            };
            reader.readAsDataURL(file);
        }

        function extractReceiptData(text) {
            const result = { amount: null, vendor: null, date: null };
            const lines = text.toUpperCase();

            // Known vendors to look for
            const vendors = [
                { pattern: /AMAZON/i, name: 'Amazon' },
                { pattern: /COSTCO/i, name: 'Costco' },
                { pattern: /WALMART/i, name: 'Walmart' },
                { pattern: /TARGET/i, name: 'Target' },
                { pattern: /HOME\s*DEPOT|THE\s*HOME\s*DEPOT/i, name: 'Home Depot' },
                { pattern: /LOWE'?S/i, name: 'Lowes' },
                { pattern: /SAFEWAY/i, name: 'Safeway' },
                { pattern: /KROGER/i, name: 'Kroger' },
                { pattern: /WHOLE FOODS/i, name: 'Whole Foods' },
                { pattern: /TRADER JOE/i, name: 'Trader Joes' },
                { pattern: /MICHAELS/i, name: 'Michaels' },
                { pattern: /JOANN/i, name: 'Joann' },
                { pattern: /CASH.*CARRY/i, name: 'Cash & Carry' },
                { pattern: /RESTAURANT DEPOT/i, name: 'Restaurant Depot' },
                { pattern: /SMART.*FOODSERVICE/i, name: 'Smart Foodservice' },
                { pattern: /OFFICE DEPOT/i, name: 'Office Depot' },
                { pattern: /STAPLES/i, name: 'Staples' },
            ];

            for (const v of vendors) {
                if (v.pattern.test(text)) {
                    result.vendor = v.name;
                    break;
                }
            }

            // Look for total amount INCLUDING TAX
            // Priority: Total before tax + Tax = actual expense (ignore gift card reductions)

            let totalBeforeTax = null;
            let taxAmount = null;
            let grandTotal = null;

            // Look for "Total before tax" - this is the key amount on Amazon
            const beforeTaxMatch = text.match(/TOTAL\s*BEFORE\s*TAX[:\s]*\$?([\d,]+\.?\d*)/i);
            if (beforeTaxMatch) {
                totalBeforeTax = parseFloat(beforeTaxMatch[1].replace(/,/g, ''));
                console.log('Found Total before tax:', totalBeforeTax);
            }

            // Look for tax amount - be specific to avoid false matches
            // First, collect ALL dollar amounts from the text
            const allDollarAmounts = [];
            const dollarRegex = /\$\s*([\d,]+\.\d{2})/g;
            let dollarMatch;
            while ((dollarMatch = dollarRegex.exec(text)) !== null) {
                allDollarAmounts.push(parseFloat(dollarMatch[1].replace(/,/g, '')));
            }
            console.log('All dollar amounts found:', allDollarAmounts);

            // Tax patterns - look for specific tax keywords
            const taxPatterns = [
                /ESTIMATED\s*TAX[^$]*\$\s*([\d,]+\.?\d*)/i,
                /TAX\s*TO\s*BE\s*COLLECTED[^$]*\$\s*([\d,]+\.?\d*)/i,
                /SALES\s*TAX[^$]*\$\s*([\d,]+\.?\d*)/i,
            ];

            for (const pattern of taxPatterns) {
                const match = text.match(pattern);
                if (match) {
                    const amt = parseFloat(match[1].replace(/,/g, ''));
                    // Tax sanity check: should be > 0, < $500, and less than the subtotal if we have one
                    const maxReasonableTax = totalBeforeTax ? totalBeforeTax * 0.15 : 500;
                    if (amt > 0 && amt <= maxReasonableTax) {
                        taxAmount = amt;
                        console.log('Found Tax:', taxAmount);
                        break;
                    }
                }
            }

            // If no tax found yet, look for small amounts that could be tax
            // Tax is usually under 15% of the total
            if (!taxAmount && totalBeforeTax) {
                const possibleTaxAmounts = allDollarAmounts.filter(amt =>
                    amt > 0 && amt < totalBeforeTax * 0.15 && amt !== totalBeforeTax
                );
                if (possibleTaxAmounts.length > 0) {
                    // Take the largest one that's still under 15%
                    possibleTaxAmounts.sort((a, b) => b - a);
                    taxAmount = possibleTaxAmounts[0];
                    console.log('Inferred Tax from amounts:', taxAmount);
                }
            }

            // Look for Grand Total
            const grandTotalMatch = text.match(/GRAND\s*TOTAL[:\s]*\$?([\d,]+\.?\d*)/i);
            if (grandTotalMatch) {
                grandTotal = parseFloat(grandTotalMatch[1].replace(/,/g, ''));
                console.log('Found Grand Total:', grandTotal);
            }

            console.log('Before main logic - totalBeforeTax:', totalBeforeTax, 'taxAmount:', taxAmount, 'grandTotal:', grandTotal);

            // MAIN LOGIC: Calculate actual expense
            // If we have total before tax + tax, that's the actual expense
            if (totalBeforeTax !== null && taxAmount !== null) {
                const calculatedTotal = totalBeforeTax + taxAmount;

                // If grand total exists and is LESS than calculated (gift card/discount applied)
                // OR grand total is 0 or missing, use the calculated amount
                if (grandTotal === null || grandTotal === 0 || grandTotal < calculatedTotal) {
                    result.amount = calculatedTotal;
                } else {
                    // Grand total matches or is higher - use it
                    result.amount = grandTotal;
                }
            } else if (totalBeforeTax !== null) {
                // Have total before tax but no tax found - use it (might be tax-free)
                result.amount = totalBeforeTax;
            } else if (grandTotal !== null && grandTotal > 0) {
                // Only have grand total and it's not zero
                result.amount = grandTotal;
            }

            // If still no amount, try other patterns
            if (!result.amount) {
                const otherPatterns = [
                    /ORDER\s*TOTAL[:\s]*\$?([\d,]+\.?\d*)/i,
                    /ITEM\s*TOTAL[:\s]*\$?([\d,]+\.?\d*)/i,
                    /TOTAL\s*DUE[:\s]*\$?([\d,]+\.?\d*)/i,
                    /AMOUNT\s*DUE[:\s]*\$?([\d,]+\.?\d*)/i,
                    /BALANCE\s*DUE[:\s]*\$?([\d,]+\.?\d*)/i,
                ];
                for (const pattern of otherPatterns) {
                    const match = text.match(pattern);
                    if (match) {
                        const amt = parseFloat(match[1].replace(/,/g, ''));
                        if (amt > 0 && amt < 100000) {
                            result.amount = amt;
                            break;
                        }
                    }
                }
            }

            // Last resort for non-Amazon receipts: find the largest dollar amount
            if (!result.amount) {
                const allAmounts = [];
                let match;
                const dollarPattern = /\$\s*([\d,]+\.\d{2})/g;
                while ((match = dollarPattern.exec(text)) !== null) {
                    const amt = parseFloat(match[1].replace(/,/g, ''));
                    if (amt > 0 && amt < 100000) {
                        allAmounts.push(amt);
                    }
                }
                if (allAmounts.length > 0) {
                    // Sort and take largest (usually the total)
                    allAmounts.sort((a, b) => b - a);
                    result.amount = allAmounts[0];
                }
            }

            // Look for date - try various patterns
            const monthMap = { JAN: '01', FEB: '02', MAR: '03', APR: '04', MAY: '05', JUN: '06',
                              JUL: '07', AUG: '08', SEP: '09', OCT: '10', NOV: '11', DEC: '12' };

            // Pattern 1: "Order placed January 24, 2026" or "January 24, 2026"
            const monthNamePattern = /(JAN(?:UARY)?|FEB(?:RUARY)?|MAR(?:CH)?|APR(?:IL)?|MAY|JUN(?:E)?|JUL(?:Y)?|AUG(?:UST)?|SEP(?:TEMBER)?|OCT(?:OBER)?|NOV(?:EMBER)?|DEC(?:EMBER)?)\s+(\d{1,2}),?\s*(20\d{2})/i;
            let dateMatch = text.match(monthNamePattern);
            if (dateMatch) {
                const monthAbbr = dateMatch[1].toUpperCase().substring(0, 3);
                const m = monthMap[monthAbbr];
                const d = dateMatch[2].padStart(2, '0');
                const y = dateMatch[3];
                if (m) result.date = `${y}-${m}-${d}`;
            }

            // Pattern 2: MM/DD/YYYY or MM-DD-YYYY
            if (!result.date) {
                const numericPattern = /(\d{1,2})[\/\-](\d{1,2})[\/\-](20\d{2})/;
                dateMatch = text.match(numericPattern);
                if (dateMatch) {
                    const m = dateMatch[1].padStart(2, '0');
                    const d = dateMatch[2].padStart(2, '0');
                    const y = dateMatch[3];
                    result.date = `${y}-${m}-${d}`;
                }
            }

            // Pattern 3: MM/DD/YY (2-digit year)
            if (!result.date) {
                const shortYearPattern = /(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2})(?!\d)/;
                dateMatch = text.match(shortYearPattern);
                if (dateMatch) {
                    const m = dateMatch[1].padStart(2, '0');
                    const d = dateMatch[2].padStart(2, '0');
                    const y = '20' + dateMatch[3];
                    result.date = `${y}-${m}-${d}`;
                }
            }

            // Pattern 4: YYYY-MM-DD (ISO format)
            if (!result.date) {
                const isoPattern = /(20\d{2})-(\d{2})-(\d{2})/;
                dateMatch = text.match(isoPattern);
                if (dateMatch) {
                    result.date = `${dateMatch[1]}-${dateMatch[2]}-${dateMatch[3]}`;
                }
            }

            return result;
        }

        function handleReceiptClick(event) {
            // If clicking on the preview image, don't open file picker
            if (event.target.classList.contains('receipt-preview')) {
                return;
            }
            document.getElementById('receiptInput').click();
        }

        function openLightbox(event) {
            event.stopPropagation();
            if (receiptImageData) {
                document.getElementById('popupImage').src = receiptImageData;
                document.getElementById('popupImage').classList.remove('zoomed');
                document.getElementById('receiptPopup').classList.add('active');
            }
        }

        let currentZoom = 1;
        let originalWidth = null;

        function closeReceiptPopup() {
            document.getElementById('receiptPopup').classList.remove('active');
            resetZoom();
        }

        function zoomReceipt(delta) {
            currentZoom = Math.max(0.5, Math.min(5, currentZoom + delta));
            applyZoom();
        }

        function resetZoom() {
            currentZoom = 1;
            applyZoom();
            // Reset scroll position
            const body = document.getElementById('receiptPopupBody');
            body.scrollLeft = 0;
            body.scrollTop = 0;
        }

        function applyZoom() {
            const img = document.getElementById('popupImage');
            const body = document.getElementById('receiptPopupBody');

            // Store original width on first load
            if (!originalWidth && img.naturalWidth) {
                originalWidth = img.naturalWidth;
            }

            // Use actual width change instead of transform for proper scrolling
            if (originalWidth) {
                img.style.width = (originalWidth * currentZoom) + 'px';
                img.style.maxWidth = 'none';
                img.style.transform = 'none';
            }

            document.getElementById('zoomLevel').textContent = Math.round(currentZoom * 100) + '%';
        }

        // Reset original width when new image loaded
        document.getElementById('popupImage')?.addEventListener('load', function() {
            originalWidth = this.naturalWidth;
            applyZoom();
        });

        // Mouse wheel zoom
        document.getElementById('receiptPopupBody')?.addEventListener('wheel', function(e) {
            if (document.getElementById('receiptPopup').classList.contains('active')) {
                e.preventDefault();
                const delta = e.deltaY > 0 ? -0.1 : 0.1;
                zoomReceipt(delta);
            }
        }, { passive: false });

        // Pinch-to-zoom for mobile
        (function() {
            const body = document.getElementById('receiptPopupBody');
            let initialDistance = 0;
            let initialZoom = 1;

            body?.addEventListener('touchstart', (e) => {
                if (e.touches.length === 2) {
                    initialDistance = Math.hypot(
                        e.touches[0].pageX - e.touches[1].pageX,
                        e.touches[0].pageY - e.touches[1].pageY
                    );
                    initialZoom = currentZoom;
                }
            }, { passive: true });

            body?.addEventListener('touchmove', (e) => {
                if (e.touches.length === 2) {
                    const currentDistance = Math.hypot(
                        e.touches[0].pageX - e.touches[1].pageX,
                        e.touches[0].pageY - e.touches[1].pageY
                    );
                    const scale = currentDistance / initialDistance;
                    currentZoom = Math.max(0.5, Math.min(5, initialZoom * scale));
                    applyZoom();
                }
            }, { passive: true });
        })();

        // Image panning (drag to move when zoomed) - supports both mouse and touch
        (function() {
            const body = document.getElementById('receiptPopupBody');
            const img = document.getElementById('popupImage');
            let isPanning = false;
            let startX, startY, scrollLeft, scrollTop;

            // Mouse events
            img?.addEventListener('mousedown', (e) => {
                isPanning = true;
                img.style.cursor = 'grabbing';
                startX = e.pageX - body.offsetLeft;
                startY = e.pageY - body.offsetTop;
                scrollLeft = body.scrollLeft;
                scrollTop = body.scrollTop;
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (!isPanning) return;
                const x = e.pageX - body.offsetLeft;
                const y = e.pageY - body.offsetTop;
                const walkX = (x - startX) * 1.5;
                const walkY = (y - startY) * 1.5;
                body.scrollLeft = scrollLeft - walkX;
                body.scrollTop = scrollTop - walkY;
            });

            document.addEventListener('mouseup', () => {
                isPanning = false;
                if (img) img.style.cursor = 'grab';
            });

            // Touch events for mobile panning
            img?.addEventListener('touchstart', (e) => {
                if (e.touches.length === 1) {
                    isPanning = true;
                    startX = e.touches[0].pageX - body.offsetLeft;
                    startY = e.touches[0].pageY - body.offsetTop;
                    scrollLeft = body.scrollLeft;
                    scrollTop = body.scrollTop;
                }
            }, { passive: true });

            document.addEventListener('touchmove', (e) => {
                if (!isPanning || e.touches.length !== 1) return;
                const x = e.touches[0].pageX - body.offsetLeft;
                const y = e.touches[0].pageY - body.offsetTop;
                const walkX = (x - startX) * 1.5;
                const walkY = (y - startY) * 1.5;
                body.scrollLeft = scrollLeft - walkX;
                body.scrollTop = scrollTop - walkY;
            }, { passive: true });

            document.addEventListener('touchend', () => {
                isPanning = false;
            });
        })();

        // Close popup with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeReceiptPopup();
            }
        });

        // Make popup draggable with bounds checking
        (function() {
            const popup = document.getElementById('receiptPopup');
            const header = document.getElementById('receiptPopupHeader');
            let isDragging = false;
            let offsetX, offsetY;

            header.addEventListener('mousedown', (e) => {
                if (e.target.tagName === 'BUTTON') return; // Don't drag when clicking buttons
                isDragging = true;
                offsetX = e.clientX - popup.offsetLeft;
                offsetY = e.clientY - popup.offsetTop;
                popup.style.transition = 'none';
            });

            document.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    let newX = e.clientX - offsetX;
                    let newY = e.clientY - offsetY;

                    // Keep popup within viewport bounds
                    const minY = 10; // Don't let it go above this
                    const maxY = window.innerHeight - 50; // Keep header visible
                    const minX = -popup.offsetWidth + 100; // Keep some visible on left
                    const maxX = window.innerWidth - 100; // Keep some visible on right

                    newX = Math.max(minX, Math.min(maxX, newX));
                    newY = Math.max(minY, Math.min(maxY, newY));

                    popup.style.left = newX + 'px';
                    popup.style.top = newY + 'px';
                    popup.style.right = 'auto';
                }
            });

            document.addEventListener('mouseup', () => {
                isDragging = false;
                popup.style.transition = '';
            });
        })();

        function addAllocationRow() {
            const container = document.getElementById('allocationRows');
            const row = document.createElement('div');
            row.className = 'allocation-row';
            row.innerHTML = `
                <select class="allocation-select" onchange="updateAllocationTotal()">
                    <option value="overhead">General Overhead</option>
                </select>
                <input type="number" class="allocation-pct" value="0" min="0" max="100" onchange="updateAllocationTotal()">
                <span>%</span>
                <button class="remove-btn" onclick="this.parentElement.remove(); updateAllocationTotal()"></button>
            `;
            container.appendChild(row);
            updateAllocationOptions();
        }

        function updateAllocationTotal() {
            const rows = document.querySelectorAll('.allocation-row');
            let total = 0;
            rows.forEach(row => {
                total += parseInt(row.querySelector('.allocation-pct').value) || 0;
            });

            // Update visual indicator
            const totalEl = document.getElementById('allocationTotal');
            totalEl.textContent = 'Total: ' + total + '%';
            if (total === 100) {
                totalEl.style.color = '#27ae60';
            } else {
                totalEl.style.color = '#e74c3c';
            }
        }

        function saveExpense() {
            try {
                const date = document.getElementById('expenseDate').value;
                const vendor = document.getElementById('expenseVendor').value;
                const category = document.getElementById('expenseCategory').value;
                const amountStr = document.getElementById('expenseAmount').value;
                const amount = parseFloat(amountStr);

                // Validate required fields with clear feedback
                const missing = [];
                if (!date) missing.push('Date');
                if (!amountStr || isNaN(amount) || amount <= 0) missing.push('Amount');

                if (missing.length > 0) {
                    // Highlight missing fields
                    if (!date) document.getElementById('expenseDate').style.borderColor = '#e74c3c';
                    if (!amountStr || isNaN(amount)) document.getElementById('expenseAmount').style.borderColor = '#e74c3c';

                    alert('Please fill in: ' + missing.join(', '));
                    return;
                }

                // Reset border colors
                document.getElementById('expenseDate').style.borderColor = '';
                document.getElementById('expenseAmount').style.borderColor = '';

                // Check allocation totals to 100%
                let totalPct = 0;
                document.querySelectorAll('.allocation-pct').forEach(input => {
                    totalPct += parseInt(input.value) || 0;
                });

                if (totalPct !== 100) {
                    alert('Allocation must equal 100% (currently ' + totalPct + '%)');
                    return;
                }

                // Gather allocations
                const allocations = [];
                const clients = JSON.parse(localStorage.getItem('kgc_clients') || '[]');
                document.querySelectorAll('.allocation-row').forEach(row => {
                    const select = row.querySelector('.allocation-select');
                    const pct = parseInt(row.querySelector('.allocation-pct').value) || 0;
                    if (pct > 0) {
                        const clientId = select.value;
                        const client = clients.find(c => String(c.id) === clientId);
                        allocations.push({
                            clientId: clientId,
                            name: clientId === 'overhead' ? 'General Overhead' : (client ? client.name : 'Unknown'),
                            percent: pct
                        });
                    }
                });

                const expenses = JSON.parse(localStorage.getItem('kgc_expenses') || '[]');

                if (editingExpenseId) {
                    // Edit existing expense
                    const index = expenses.findIndex(e => e.id === editingExpenseId);
                    if (index !== -1) {
                        expenses[index] = {
                            ...expenses[index],
                            date: date,
                            vendor: vendor,
                            category: category,
                            amount: amount,
                            allocations: allocations,
                            receiptImage: receiptImageData
                        };
                    }
                } else {
                    // Add new expense
                    expenses.push({
                        id: 'exp-' + Date.now(),
                        date: date,
                        vendor: vendor,
                        category: category,
                        amount: amount,
                        allocations: allocations,
                        receiptImage: receiptImageData
                    });
                }

                localStorage.setItem('kgc_expenses', JSON.stringify(expenses));

                closeExpenseModal();
                loadData();

                // Show success feedback (brief toast)
                const toast = document.createElement('div');
                toast.textContent = editingExpenseId ? ' Expense updated' : ' Expense saved';
                toast.style.cssText = 'position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#b5956a;color:#fff;padding:12px 24px;border-radius:4px;z-index:9999;font-size:0.9rem;';
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 2000);

                editingExpenseId = null;
            } catch (err) {
                alert('Error saving: ' + err.message);
                console.error('Save error:', err);
            }
        }

        function deleteItem(id, type) {
            if (!confirm('Delete this ' + type + '?')) return;

            if (type === 'revenue') {
                const items = JSON.parse(localStorage.getItem('kgc_revenue') || '[]');
                const filtered = items.filter(i => i.id !== id);
                localStorage.setItem('kgc_revenue', JSON.stringify(filtered));
            } else {
                const items = JSON.parse(localStorage.getItem('kgc_expenses') || '[]');
                const filtered = items.filter(i => i.id !== id);
                localStorage.setItem('kgc_expenses', JSON.stringify(filtered));
            }
            loadData();
        }

        function guessCategory(vendor, ocrText) {
            const text = (ocrText || '').toLowerCase();

            // First, look at the ITEM/PRODUCT in the OCR text to guess category

            // Ingredients & Supplies keywords (check FIRST before equipment)
            if (/flour|sugar|butter|vanilla|chocolate|cocoa|fondant|gum paste|food color|sprinkles|eggs|cream|milk|baking|frosting|icing|extract|gelatin|corn starch|powdered sugar|cake mix|shortening|spice|cinnamon|nutmeg|ginger|salt|yeast|oil|honey|syrup|almond|lemon|orange|fruit|berry|nuts|pecan|walnut|caramel|coffee|espresso|liquor|rum|brandy|food|grocery|produce/i.test(text)) {
                return 'Ingredients & Supplies';
            }

            // Equipment & Tools keywords
            if (/\bmixer\b|stand mixer|whisk|spatula|pan\b|mold|turntable|piping|nozzle|scraper|thermometer|scale\b|oven|torch|airbrush|cutter|roller\b|dowel|knife|bench scraper|timer|kitchenaid|cuisinart/i.test(text)) {
                return 'Equipment & Tools';
            }

            // Packaging & Presentation keywords
            if (/box|cake box|ribbon|board|drum|doily|topper|pillar|stand|display|cellophane|wrap|bag|tissue|label|sticker|tag/i.test(text)) {
                return 'Packaging & Presentation';
            }

            // Office & Admin keywords
            if (/printer|ink|paper|computer|laptop|phone|software|subscription|quickbooks|canva|adobe|office|binder|folder|pen|notebook/i.test(text)) {
                return 'Office & Admin';
            }

            // Marketing & Advertising keywords
            if (/business card|flyer|banner|sign|photo|camera|lighting|backdrop|ad|advertisement|promotion|website|domain|hosting/i.test(text)) {
                return 'Marketing & Advertising';
            }

            // If no item keywords found, fall back to vendor-based guess
            const v = (vendor || '').toLowerCase();

            // Grocery/Food stores  Ingredients
            if (/costco|safeway|kroger|whole foods|trader joe|cash.*carry|restaurant depot|smart.*foodservice|grocery/i.test(v)) {
                return 'Ingredients & Supplies';
            }

            // Hardware stores  Equipment
            if (/home depot|lowes|harbor freight/i.test(v)) {
                return 'Equipment & Tools';
            }

            // Craft stores  Packaging
            if (/michaels|joann|hobby lobby|uline|paper mart/i.test(v)) {
                return 'Packaging & Presentation';
            }

            // Office stores  Office
            if (/office depot|staples/i.test(v)) {
                return 'Office & Admin';
            }

            // Print/Marketing vendors
            if (/vistaprint|moo|facebook|google|instagram/i.test(v)) {
                return 'Marketing & Advertising';
            }

            return null; // Can't guess - user must select
        }

        // Universal search across invoices and expenses
        let allSentInvoicesData = [];
        let allPaidInvoicesData = [];
        let allExpensesData = [];

        function filterAll() {
            const searchTerm = document.getElementById('universalSearch').value.toLowerCase().trim();

            if (!searchTerm) {
                // No search term - show all filtered data
                renderInvoicesSent(allSentInvoicesData);
                renderInvoicesPaid(allPaidInvoicesData);
                renderFilteredExpenses(allExpensesData);
                return;
            }

            // Filter sent invoices
            const filteredSent = allSentInvoicesData.filter(item => {
                const eventName = ((item.clientName || '') + ' ' + (item.eventType || '')).toLowerCase();
                const date = formatDate(item.sentAt?.split('T')[0]).toLowerCase();
                const amount = formatCurrency(item.amount).toLowerCase();
                const type = item.type?.toLowerCase() || '';
                return eventName.includes(searchTerm) || date.includes(searchTerm) ||
                       amount.includes(searchTerm) || type.includes(searchTerm);
            });

            // Filter paid invoices
            const filteredPaid = allPaidInvoicesData.filter(item => {
                const eventName = ((item.clientName || '') + ' ' + (item.eventType || '')).toLowerCase();
                const date = formatDate(item.paidAt?.split('T')[0]).toLowerCase();
                const amount = formatCurrency(item.amount).toLowerCase();
                const type = item.type?.toLowerCase() || '';
                return eventName.includes(searchTerm) || date.includes(searchTerm) ||
                       amount.includes(searchTerm) || type.includes(searchTerm);
            });

            // Filter expenses
            const filteredExpenses = allExpensesData.filter(item => {
                const vendor = (item.vendor || item.description || '').toLowerCase();
                const category = (item.category || '').toLowerCase();
                const date = formatDate(item.date).toLowerCase();
                const amount = formatCurrency(item.amount).toLowerCase();
                return vendor.includes(searchTerm) || category.includes(searchTerm) ||
                       date.includes(searchTerm) || amount.includes(searchTerm);
            });

            renderInvoicesSent(filteredSent);
            renderInvoicesPaid(filteredPaid);
            renderFilteredExpenses(filteredExpenses);
        }

        function viewReceipt(expenseId) {
            const expenses = JSON.parse(localStorage.getItem('kgc_expenses') || '[]');
            const expense = expenses.find(e => e.id === expenseId);
            if (expense && expense.receiptImage) {
                document.getElementById('popupImage').src = expense.receiptImage;
                document.getElementById('popupImage').classList.remove('zoomed');
                document.getElementById('popupImage').style.transform = 'scale(1)';
                document.getElementById('receiptPopup').classList.add('active');
            }
        }

        let editingExpenseId = null;

        function editExpense(expenseId) {
            const expenses = JSON.parse(localStorage.getItem('kgc_expenses') || '[]');
            const expense = expenses.find(e => e.id === expenseId);
            if (!expense) return;

            editingExpenseId = expenseId;

            // Populate the modal with expense data
            document.getElementById('expenseDate').value = expense.date || '';
            document.getElementById('expenseVendor').value = expense.vendor || expense.description || '';
            document.getElementById('expenseCategory').value = expense.category || '';
            document.getElementById('expenseAmount').value = expense.amount || '';

            // Show receipt if exists
            if (expense.receiptImage) {
                receiptImageData = expense.receiptImage;
                document.getElementById('receiptPreview').src = expense.receiptImage;
                document.getElementById('receiptUpload').classList.add('has-image');
                document.getElementById('receiptActions').style.display = 'block';
            } else {
                receiptImageData = null;
                document.getElementById('receiptPreview').src = '';
                document.getElementById('receiptUpload').classList.remove('has-image');
                document.getElementById('receiptActions').style.display = 'none';
            }

            document.getElementById('extractedTotal').classList.remove('visible');

            // Update modal title and button
            document.querySelector('#expenseModal .modal-title').textContent = 'Edit Expense';
            document.querySelector('#expenseModal .btn-primary').textContent = 'Save Changes';

            // Update vendor suggestions
            updateVendorList();
            updateAllocationOptions();

            document.getElementById('expenseModal').classList.add('active');
        }

        function formatCurrency(amount) {
            return '$' + parseFloat(amount || 0).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr + 'T00:00:00');
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function openInvoice(invoiceId) {
            if (invoiceId) {
                window.location.href = '/invoices/tasting-invoice.html?invoiceId=' + invoiceId + '&from=finances';
            }
        }

        function sendReminder(invoiceId, clientId) {
            // Get client and invoice info
            const clients = JSON.parse(localStorage.getItem('kgc_clients') || '[]');
            const invoices = JSON.parse(localStorage.getItem('kgc_invoices') || '[]');
            const invoice = invoices.find(i => i.id === invoiceId);
            const client = clients.find(c => c.id === clientId);

            if (!invoice || !client) {
                alert('Could not find invoice or client information');
                return;
            }

            // Log to communication
            if (!client.communications) client.communications = [];
            client.communications.push({
                date: new Date().toISOString(),
                type: 'reminder',
                note: `Payment reminder sent for ${invoice.type === 'tasting' ? 'Tasting' : invoice.type === 'deposit' ? 'Deposit' : 'Payment'} invoice - ${formatCurrency(invoice.amount)}`
            });

            // Save updated client
            const clientIndex = clients.findIndex(c => c.id === clientId);
            if (clientIndex !== -1) {
                clients[clientIndex] = client;
                localStorage.setItem('kgc_clients', JSON.stringify(clients));
            }

            alert('Reminder logged to communication history for ' + client.name);
        }

        // Drag and drop for receipt
        const uploadArea = document.getElementById('receiptUpload');
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#b5956a';
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.style.borderColor = '#ddd';
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#ddd';
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                document.getElementById('receiptInput').files = e.dataTransfer.files;
                handleReceiptUpload({ target: { files: [file] } });
            }
        });

        // Resize handle functionality
        (function() {
            const resizeHandle = document.getElementById('resizeHandle');
            const financePanel = document.querySelector('.finance-panel');
            const imagePanel = document.querySelector('.image-panel');
            const mainWrapper = document.querySelector('.main-content-wrapper');

            if (!resizeHandle || !financePanel || !imagePanel) return;

            let isDragging = false;
            let startX = 0;
            let startWidth = 0;

            // Load saved width from localStorage
            const savedWidth = localStorage.getItem('kgc_finance_panel_width');
            if (savedWidth) {
                financePanel.style.width = savedWidth + 'px';
            }

            resizeHandle.addEventListener('mousedown', (e) => {
                isDragging = true;
                startX = e.clientX;
                startWidth = financePanel.offsetWidth;
                resizeHandle.classList.add('dragging');
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;

                const delta = e.clientX - startX;
                const newWidth = startWidth + delta;
                const wrapperWidth = mainWrapper.offsetWidth;

                // Constrain width: min 400px, max (wrapper - 200px for gallery)
                const minWidth = 400;
                const maxWidth = wrapperWidth - 200;

                if (newWidth >= minWidth && newWidth <= maxWidth) {
                    financePanel.style.width = newWidth + 'px';
                }
            });

            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    resizeHandle.classList.remove('dragging');
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';

                    // Save width to localStorage
                    localStorage.setItem('kgc_finance_panel_width', financePanel.offsetWidth);
                }
            });

            // Touch support for tablets
            resizeHandle.addEventListener('touchstart', (e) => {
                isDragging = true;
                startX = e.touches[0].clientX;
                startWidth = financePanel.offsetWidth;
                resizeHandle.classList.add('dragging');
                e.preventDefault();
            });

            document.addEventListener('touchmove', (e) => {
                if (!isDragging) return;

                const delta = e.touches[0].clientX - startX;
                const newWidth = startWidth + delta;
                const wrapperWidth = mainWrapper.offsetWidth;

                const minWidth = 400;
                const maxWidth = wrapperWidth - 200;

                if (newWidth >= minWidth && newWidth <= maxWidth) {
                    financePanel.style.width = newWidth + 'px';
                }
            });

            document.addEventListener('touchend', () => {
                if (isDragging) {
                    isDragging = false;
                    resizeHandle.classList.remove('dragging');
                    localStorage.setItem('kgc_finance_panel_width', financePanel.offsetWidth);
                }
            });
        })();

    </script>

    <!-- Kenna Branded Alert/Confirm -->
    <div class="kenna-alert-overlay" id="kennaAlertOverlay">
        <div class="kenna-alert-box">
            <div class="kenna-alert-icon" id="kennaAlertIcon"></div>
            <div class="kenna-alert-title" id="kennaAlertTitle"></div>
            <div class="kenna-alert-message" id="kennaAlertMessage"></div>
            <div class="kenna-alert-buttons" id="kennaAlertButtons"></div>
        </div>
    </div>

    <script>
        // Kenna-branded confirm dialog (returns a Promise)
        function kennaConfirm(title, message, { confirmText = 'Confirm', cancelText = 'Cancel', icon = '' } = {}) {
            return new Promise(resolve => {
                const overlay = document.getElementById('kennaAlertOverlay');
                document.getElementById('kennaAlertIcon').textContent = icon;
                document.getElementById('kennaAlertTitle').textContent = title;
                document.getElementById('kennaAlertMessage').textContent = message;

                const btnHtml = `
                    <button class="kenna-alert-btn secondary" id="kennaAlertCancel">${cancelText}</button>
                    <button class="kenna-alert-btn primary" id="kennaAlertConfirm">${confirmText}</button>
                `;
                document.getElementById('kennaAlertButtons').innerHTML = btnHtml;

                // Force reflow then show
                overlay.style.display = 'flex';
                requestAnimationFrame(() => overlay.classList.add('active'));

                function close(result) {
                    overlay.classList.remove('active');
                    setTimeout(() => { overlay.style.display = 'none'; }, 300);
                    resolve(result);
                }

                document.getElementById('kennaAlertConfirm').onclick = () => close(true);
                document.getElementById('kennaAlertCancel').onclick = () => close(false);
                overlay.onclick = (e) => { if (e.target === overlay) close(false); };
            });
        }

        // Kenna-branded toast notification (auto-dismisses)
        function kennaToast(message, { type = 'success', duration = 4000 } = {}) {
            // Remove existing toast
            const existing = document.querySelector('.kenna-toast');
            if (existing) existing.remove();

            const toast = document.createElement('div');
            toast.className = 'kenna-toast' + (type === 'error' ? ' error' : '');
            toast.textContent = message;
            document.body.appendChild(toast);

            requestAnimationFrame(() => toast.classList.add('visible'));

            setTimeout(() => {
                toast.classList.remove('visible');
                setTimeout(() => toast.remove(), 400);
            }, duration);
        }
    </script>
</body>
</html>
